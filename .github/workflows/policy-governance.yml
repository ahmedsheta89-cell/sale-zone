name: Policy Governance

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

jobs:
  policy-governance:
    name: policy-governance
    runs-on: ubuntu-latest
    steps:
      - name: Enforce policy-change title for policy updates
        uses: actions/github-script@v7
        with:
          script: |
            const requiredPrefix = 'policy-change:';
            const watchedFiles = new Set([
              'monitoring/admin-function-policy.json',
              'tools/generate-admin-function-registry.js'
            ]);

            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull request payload found; skipping.');
              return;
            }

            const changedFiles = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            const touchedPolicyFiles = changedFiles.filter((file) => watchedFiles.has(file.filename));
            if (touchedPolicyFiles.length === 0) {
              core.info('No policy governance files changed.');
              return;
            }

            const title = String(pr.title || '').trim();
            if (!title.toLowerCase().startsWith(requiredPrefix)) {
              const filesList = touchedPolicyFiles.map((file) => file.filename).join(', ');
              core.setFailed(`PR title must start with "${requiredPrefix}" when policy files change. Changed: ${filesList}`);
              return;
            }

            core.info(`Policy governance check passed for title: "${title}"`);
