name: Deploy Firestore Rules

on:
  workflow_dispatch:
    inputs:
      target_sha:
        description: "Commit SHA to deploy Firestore rules from"
        required: true
        type: string
      reason:
        description: "Why this rules deployment is requested"
        required: true
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-firestore-rules
  cancel-in-progress: false

jobs:
  deploy-firestore-rules:
    name: deploy-firestore-rules
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout target SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_sha }}

      - name: Verify checkout SHA matches target
        id: verify_sha
        run: |
          set -euo pipefail
          actual_sha="$(git rev-parse HEAD)"
          target_sha="${{ github.event.inputs.target_sha }}"
          if [[ "$actual_sha" != "$target_sha" ]]; then
            echo "::error::Checkout SHA mismatch (actual=$actual_sha, target=$target_sha)"
            exit 1
          fi
          echo "actual_sha=$actual_sha" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Validate OIDC federation secrets
        env:
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
        run: |
          set -euo pipefail
          missing=0

          if [[ -z "${GCP_WORKLOAD_IDENTITY_PROVIDER:-}" ]]; then
            echo "::error::Missing secret: GCP_WORKLOAD_IDENTITY_PROVIDER"
            missing=1
          fi

          if [[ -z "${GCP_SERVICE_ACCOUNT_EMAIL:-}" ]]; then
            echo "::error::Missing secret: GCP_SERVICE_ACCOUNT_EMAIL"
            missing=1
          fi

          if [[ "$missing" -ne 0 ]]; then
            echo "::error::Configure GitHub OIDC -> GCP Workload Identity Federation and rerun."
            echo "::error::Static credential secrets (FIREBASE_SERVICE_ACCOUNT / FIREBASE_TOKEN) are intentionally not used."
            exit 1
          fi

      - name: Authenticate to Google Cloud (OIDC/WIF)
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          create_credentials_file: true

      - name: Deploy firestore.rules
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          set -euo pipefail
          project_id="${FIREBASE_PROJECT_ID:-sale-zone-601f0}"
          firebase deploy --only firestore:rules --project "$project_id" --non-interactive

      - name: Deployment summary
        run: |
          {
            echo "## Firestore Rules Deployment"
            echo "- target_sha: \`${{ github.event.inputs.target_sha }}\`"
            echo "- actual_sha: \`${{ steps.verify_sha.outputs.actual_sha }}\`"
            echo "- deployed_rules_file: \`firestore.rules\`"
            echo "- reason: ${{ github.event.inputs.reason }}"
            echo "- timestamp_utc: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "- auth_mode: \`oidc_wif\`"
          } >> "$GITHUB_STEP_SUMMARY"
