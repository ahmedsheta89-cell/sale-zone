name: Deploy Firestore Rules

on:
  workflow_dispatch:
    inputs:
      target_sha:
        description: "Commit SHA to deploy Firestore rules from"
        required: true
        type: string
      reason:
        description: "Why this rules deployment is requested"
        required: true
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-firestore-rules
  cancel-in-progress: false

jobs:
  deploy-firestore-rules:
    name: deploy-firestore-rules
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Validate required secrets
        run: |
          set -euo pipefail
          missing=0
          if [[ -z "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}" ]]; then
            echo "::error::Missing secret: GCP_WORKLOAD_IDENTITY_PROVIDER"
            missing=1
          fi
          if [[ -z "${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}" ]]; then
            echo "::error::Missing secret: GCP_SERVICE_ACCOUNT_EMAIL"
            missing=1
          fi
          if [[ "$missing" -ne 0 ]]; then
            exit 1
          fi

      - name: Normalize identity secrets
        id: identity
        run: |
          set -euo pipefail

          provider_raw="${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"
          service_account_raw="${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}"

          provider="$(printf '%s' "$provider_raw" | tr -d '[:space:]')"
          service_account="$(printf '%s' "$service_account_raw" | tr -d '[:space:]')"

          if [[ -z "$provider" || "$provider" != projects/*/locations/global/workloadIdentityPools/*/providers/* ]]; then
            echo "::error::Invalid GCP_WORKLOAD_IDENTITY_PROVIDER format."
            echo "::error::Expected: projects/<number>/locations/global/workloadIdentityPools/<pool>/providers/<provider>"
            exit 1
          fi

          if [[ ! "$service_account" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.iam\.gserviceaccount\.com$ ]]; then
            echo "::error::Invalid GCP_SERVICE_ACCOUNT_EMAIL format."
            echo "::error::Expected: <name>@<project>.iam.gserviceaccount.com"
            exit 1
          fi

          echo "::add-mask::$provider"
          echo "::add-mask::$service_account"

          echo "provider=$provider" >> "$GITHUB_OUTPUT"
          echo "service_account=$service_account" >> "$GITHUB_OUTPUT"

      - name: Resolve project id
        id: project
        run: |
          set -euo pipefail
          raw="${{ secrets.FIREBASE_PROJECT_ID }}"
          project_id="$(printf '%s' "${raw:-sale-zone-601f0}" | tr -d '[:space:]')"
          if [[ -z "$project_id" || ! "$project_id" =~ ^[a-z0-9-]+$ ]]; then
            echo "::error::Invalid FIREBASE_PROJECT_ID: '$project_id'"
            exit 1
          fi
          echo "project_id=$project_id" >> "$GITHUB_OUTPUT"

      - name: Checkout target SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_sha }}
          fetch-depth: 1

      - name: Verify checkout SHA matches target
        id: verify_sha
        run: |
          set -euo pipefail
          actual_sha="$(git rev-parse HEAD)"
          target_sha="${{ github.event.inputs.target_sha }}"
          if [[ "$actual_sha" != "$target_sha" ]]; then
            echo "::error::Checkout SHA mismatch (actual=$actual_sha, target=$target_sha)"
            exit 1
          fi
          echo "actual_sha=$actual_sha" >> "$GITHUB_OUTPUT"

      - name: Validate firestore.rules exists
        run: |
          set -euo pipefail
          test -f firestore.rules || { echo "::error::firestore.rules not found"; exit 1; }

      - name: Authenticate to Google Cloud (OIDC/WIF)
        id: auth
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ steps.identity.outputs.provider }}
          service_account: ${{ steps.identity.outputs.service_account }}
          token_format: access_token

      - name: Fail with auth guidance
        if: ${{ steps.auth.outcome == 'failure' }}
        run: |
          echo "::error::OIDC/WIF authentication failed."
          echo "::error::Check that the service account exists and matches GCP_SERVICE_ACCOUNT_EMAIL exactly."
          echo "::error::Check roles/iam.workloadIdentityUser binding for your workload identity principalSet."
          exit 1

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: firebase,alpha

      - name: Verify active identity
        run: |
          set -euo pipefail
          gcloud auth list
          gcloud auth list --filter=status:ACTIVE --format="value(account)"

      - name: Deploy Firestore Rules
        id: deploy
        run: |
          set -euo pipefail
          project_id="${{ steps.project.outputs.project_id }}"
          target_sha="${{ github.event.inputs.target_sha }}"
          reason="${{ github.event.inputs.reason }}"

          echo "Project: $project_id"
          echo "SHA: $target_sha"
          echo "Reason: $reason"

          ruleset_name="$(gcloud firebase rulesets create firestore.rules \
            --project="$project_id" \
            --format='value(name)')"

          if gcloud firebase releases describe cloud.firestore --project="$project_id" >/dev/null 2>&1; then
            release_name="$(gcloud firebase releases update cloud.firestore \
              --ruleset="$ruleset_name" \
              --project="$project_id" \
              --format='value(name)')"
          else
            release_name="$(gcloud firebase releases create cloud.firestore \
              --ruleset="$ruleset_name" \
              --project="$project_id" \
              --format='value(name)')"
          fi

          echo "ruleset_name=$ruleset_name" >> "$GITHUB_OUTPUT"
          echo "release_name=$release_name" >> "$GITHUB_OUTPUT"

      - name: Deployment summary
        if: always()
        run: |
          {
            echo "## Firestore Rules Deployment"
            echo "- status: ${{ job.status }}"
            echo "- auth_mode: oidc_wif_gcloud_firebase"
            echo "- project_id: ${{ steps.project.outputs.project_id }}"
            echo "- target_sha: \`${{ github.event.inputs.target_sha }}\`"
            echo "- actual_sha: \`${{ steps.verify_sha.outputs.actual_sha }}\`"
            echo "- ruleset_name: \`${{ steps.deploy.outputs.ruleset_name }}\`"
            echo "- release_name: \`${{ steps.deploy.outputs.release_name }}\`"
            echo "- reason: ${{ github.event.inputs.reason }}"
            echo "- timestamp_utc: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } >> "$GITHUB_STEP_SUMMARY"
