<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A1128">
    <meta name="description" content="Sale Zone Store Admin - لوحة التحكم">
    <meta name="firebase-app-check-site-key" content="">
    <link rel="icon" href="./icon-192.png">
    <link rel="shortcut icon" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <title>لوحة التحكم | Sale Zone Store</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"></script>
    <!-- Error Detection System -->
    <script src="ERROR_DETECTION_SYSTEM.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-api.js"></script>
    <script src="firebase-data.js"></script>
    <script src="auth-utils.js"></script>
    <script src="security-utils.js"></script>
    <script src="core/logger.js"></script>
    <script src="enhancement-utils.js"></script>
    <script src="storage-keys.js"></script>
    <script src="cloudinary-service.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F4E4BC;
            --gold-dark: #B8960C;
            --navy: #0A1128;
            --navy-light: #1A2744;
            --burgundy: #800020;
            --cream: #FAF8F3;
            --white: #FFFFFF;
            --success: #50C878;
            --error: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
            --font-display: 'Playfair Display', serif;
            --font-arabic: 'Almarai', sans-serif;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
            --transition: all 0.3s ease;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; }
        body { font-family: var(--font-arabic); background: #f5f6fa; min-height: 100vh; text-rendering: optimizeLegibility; overscroll-behavior: none; touch-action: manipulation; }
        button { min-height: 44px; }
        input, textarea, select { font-size: 16px; }

        /* Login */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--navy), var(--navy-light));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: var(--white);
            border-radius: 20px;
            padding: 40px 35px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        .login-logo { font-size: 50px; margin-bottom: 15px; }
        .login-title { font-family: var(--font-display); font-size: 24px; color: var(--navy); margin-bottom: 8px; }
        .login-subtitle { color: #666; margin-bottom: 25px; font-size: 14px; }
        .login-form .form-group { margin-bottom: 18px; text-align: right; }
        .login-form label { display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px; font-size: 13px; }
        .login-form input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: var(--transition);
        }
        .login-form input:focus { border-color: var(--gold); outline: none; }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212,175,55,0.4); }
        .login-error { background: #fee; color: var(--error); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; font-size: 13px; }
        .back-link { margin-top: 20px; color: var(--gold-dark); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; font-size: 13px; }

        /* Dashboard */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.active { display: flex; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--navy), var(--navy-light));
            min-height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logo { font-family: var(--font-display); font-size: 20px; color: var(--gold); }
        .sidebar-subtitle { font-size: 11px; color: var(--gold-light); margin-top: 3px; }
        .sidebar-menu { padding: 15px 0; }
        .menu-section { padding: 0 12px; margin-bottom: 8px; }
        .menu-section-title {
            font-size: 10px;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 12px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 3px;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            font-size: 13px;
            font-family: var(--font-arabic);
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: var(--white); }
        .menu-item.active { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); }
        .menu-item .badge {
            margin-right: auto;
            background: var(--burgundy);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        /* Main */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--white);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            gap: 12px;
        }
        .page-title {
            font-family: var(--font-display);
            font-size: 20px;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .top-bar-actions { display: flex; align-items: center; gap: 10px; }
        .admin-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--cream);
            border-radius: 20px;
            font-size: 13px;
        }
        .admin-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 12px;
        }
        .logout-btn {
            background: var(--error);
            color: var(--white);
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }
        .logout-btn:hover { background: #c0392b; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 3px;
        }
        .stat-card.products::before { background: var(--gold); }
        .stat-card.orders::before { background: var(--success); }
        .stat-card.users::before { background: var(--info); }
        .stat-card.revenue::before { background: var(--burgundy); }
        .stat-card.loyalty::before { background: var(--warning); }
        .stat-icon { font-size: 28px; margin-bottom: 8px; }
        .stat-value { font-size: 26px; font-weight: 800; color: var(--navy); }
        .stat-label { font-size: 12px; color: #666; }

        /* Section Card */
        .section-card {
            background: var(--white);
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 18px;
            overflow: hidden;
        }
        .section-header {
            padding: 15px 18px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); }
        .btn-gold:hover { box-shadow: 0 4px 15px rgba(212,175,55,0.4); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-info { background: var(--info); color: var(--white); }
        .btn-warning { background: #f0ad4e; color: var(--white); }
        .btn-danger { background: var(--error); color: var(--white); }
        .btn-navy { background: var(--navy); color: var(--white); }
        .section-body { padding: 18px; }

        /* Tables */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .data-table th, .data-table td {
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .data-table th { background: var(--cream); font-weight: 700; color: var(--navy); }
        .data-table tbody tr:hover { background: var(--cream); }
        .product-cell { display: flex; align-items: center; gap: 10px; }
        .product-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: var(--white);
        }
        .status-pending { background: var(--warning); color: #333; }
        .status-confirmed { background: var(--info); }
        .status-processing { background: #9b59b6; }
        .status-shipped { background: #3498db; }
        .status-delivered { background: var(--success); }
        .status-completed { background: var(--success); }
        .status-cancelled { background: var(--error); }
        .status-hidden { background: #6c757d; }
        .status-published { background: var(--success); }
        .batch-chip {
            display: inline-block;
            max-width: 130px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: rgba(10,17,40,0.07);
            color: var(--navy);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }
        .action-btns { display: flex; gap: 5px; }
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition);
        }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.view { background: rgba(23,162,184,0.15); color: var(--info); }
        .action-btn.edit { background: rgba(212,175,55,0.15); color: var(--gold-dark); }
        .action-btn.delete { background: rgba(220,53,69,0.15); color: var(--error); }
        .action-btn.publish { background: rgba(80,200,120,0.16); color: #18814a; }
        .action-btn.hide { background: rgba(108,117,125,0.16); color: #5f6a72; }

        .wizard-steps {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        .wizard-step {
            text-align: center;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 6px 4px;
            font-size: 11px;
            color: #666;
            background: #fafafa;
        }
        .wizard-step.active {
            border-color: var(--gold);
            background: rgba(212,175,55,0.12);
            color: var(--navy);
            font-weight: 700;
        }
        .wizard-panel { display: none; }
        .wizard-panel.active { display: block; }
        .wizard-preview {
            max-height: 240px;
            overflow: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 8px;
            background: #fff;
            margin-top: 8px;
            direction: ltr;
            font-size: 11px;
        }
        .wizard-progress {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: #efefef;
            overflow: hidden;
            margin-top: 10px;
        }
        .wizard-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            transition: width 0.2s ease;
        }
        .wizard-report {
            background: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            max-height: 180px;
            overflow: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }

        /* Content Section */
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
        }
        .chart-title { font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 12px; }
        .chart-container { height: 250px; position: relative; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: var(--transition);
        }
        .modal.large { max-width: 700px; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header {
            padding: 18px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        .modal-header h2 { font-size: 18px; color: var(--navy); display: flex; align-items: center; gap: 8px; }
        .close-modal {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }
        .close-modal:hover { background: #ddd; transform: rotate(90deg); }
        .modal-body{
          padding: 18px;
          max-height: 80vh;      /* أقصى ارتفاع 80% من الشاشة */
          overflow-y: auto;      /* فعل التمرير داخل المودال */
          padding-bottom: 30px;  /* مساحة تحت للزر */
}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-family: var(--font-arabic);
            transition: var(--transition);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--gold);
            outline: none;
        }
        .form-group textarea { resize: vertical; min-height: 70px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        .submit-btn:hover { box-shadow: 0 4px 15px rgba(212,175,55,0.4); }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 18px;
        }
        .settings-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
        }
        .settings-card h3 {
            font-size: 15px;
            color: var(--navy);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--cream);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .danger-zone { border: 2px solid var(--error); }
        .danger-zone h3 { color: var(--error); }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px 18px;
            background: var(--cream);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--navy);
            font-size: 12px;
            transition: var(--transition);
        }
        .tab-btn.active { background: var(--gold); color: var(--white); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Order Details */
        .order-detail-section {
            background: var(--cream);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .order-detail-section h4 {
            font-size: 14px;
            color: var(--navy);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 13px;
        }
        .order-item:last-child { border-bottom: none; }
        .order-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 800;
            color: var(--navy);
            padding-top: 12px;
            border-top: 2px solid var(--gold);
            margin-top: 10px;
        }

        /* Notifications */
        .notifications-container {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 320px;
        }
        .notification {
            background: var(--white);
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.4s ease;
            border-right: 4px solid;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        .notification.success { border-right-color: var(--success); }
        .notification.error { border-right-color: var(--error); }
        .notification-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--white);
        }
        .notification.success .notification-icon { background: var(--success); }
        .notification.error .notification-icon { background: var(--error); }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 700; font-size: 12px; color: var(--navy); }
        .notification-message { font-size: 11px; color: #666; }
        .notification-close { background: transparent; border: none; color: #999; font-size: 14px; cursor: pointer; }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state-icon { font-size: 50px; margin-bottom: 12px; opacity: 0.5; }

        /* Mobile */
        .mobile-menu-btn {
            display: none;
            background: var(--gold);
            color: var(--white);
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .overlay.active { display: block; }

        @media (max-width: 1024px) {
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; }
        }
        @media (max-width: 768px) {
            .main-content { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-value { font-size: 20px; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .modal-overlay { align-items: flex-end; padding: 10px; }
            .modal { max-width: 100%; max-height: 92dvh; border-radius: 16px; }
            .modal-body { padding: 16px; }
            .close-modal { top: 10px; left: 10px; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .settings-grid { grid-template-columns: 1fr; }
            .modal-header h2 { font-size: 16px; }
            .modal-body { padding: 14px; }
        }

        /* Status Select */
        .status-select {
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: var(--white);
        }
        .status-select:focus { border-color: var(--gold); outline: none; }

        /* Color Input */
        input[type="color"] {
            width: 50px;
            height: 35px;
            padding: 2px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Loyalty Cards */
        .loyalty-card {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 14px;
            padding: 20px;
            color: var(--white);
            text-align: center;
            margin-bottom: 15px;
        }
        .loyalty-value { font-size: 36px; font-weight: 800; }
        .loyalty-label { font-size: 13px; opacity: 0.9; }

        .user-points-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--cream);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .user-points-info { display: flex; align-items: center; gap: 10px; }
        .user-points-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--navy);
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .user-points-actions { display: flex; gap: 6px; }
        .points-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }
        .points-btn.add { background: var(--success); color: white; }
        .points-btn.sub { background: var(--error); color: white; }

        /* Internal Support Chat */
        .support-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 14px;
            min-height: 560px;
        }
        .support-threads-panel,
        .support-messages-panel {
            background: var(--white);
            border: 1px solid #e9ebf0;
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 520px;
        }
        .support-panel-header {
            padding: 12px 14px;
            border-bottom: 1px solid #eceff5;
            background: #fafbff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .support-thread-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .support-thread-item {
            border: 1px solid #e5e8ef;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all .15s ease;
            background: #fff;
        }
        .support-thread-item.active {
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, .15);
            background: #fffdf6;
        }
        .support-thread-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            font-size: 11px;
            color: #777;
            margin-top: 6px;
        }
        .support-unread-badge {
            min-width: 20px;
            height: 20px;
            border-radius: 999px;
            padding: 0 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--error);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
        }
        .support-messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f8f9fc;
        }
        .support-message {
            max-width: 80%;
            padding: 10px 12px;
            border-radius: 10px;
            line-height: 1.5;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .support-message.customer {
            align-self: flex-start;
            background: #fff;
            border: 1px solid #e3e6ee;
            color: #24304a;
        }
        .support-message.admin {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: #fff;
        }
        .support-message-meta {
            margin-top: 4px;
            font-size: 10px;
            opacity: 0.8;
        }
        .support-composer {
            border-top: 1px solid #eceff5;
            padding: 10px;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: #fff;
        }
        .support-composer textarea {
            resize: vertical;
            min-height: 44px;
            max-height: 140px;
        }
        @media (max-width: 1024px) {
            .support-layout { grid-template-columns: 1fr; }
            .support-threads-panel, .support-messages-panel { min-height: 380px; }
        }
    </style>
</head>
<body>
    <div class="notifications-container" id="notificationsContainer"></div>

    <!-- Login -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">🔐</div>
            <h1 class="login-title">لوحة التحكم</h1>
            <p class="login-subtitle">Sale Zone Store</p>
            <div class="login-error" id="loginError">بيانات الدخول غير صحيحة</div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>📧 البريد الإلكتروني</label>
                    <input type="email" id="adminEmail" required placeholder="أدخل البريد الإلكتروني">
                </div>
                <div class="form-group">
                    <label>🔑 كلمة المرور</label>
                    <input type="password" id="adminPassword" required placeholder="أدخل كلمة المرور">
                </div>
                <button type="submit" class="login-btn">دخول</button>
                <button type="button" class="login-btn" style="margin-top: 10px; background: #1A2744;" onclick="sendVerificationLink()">
                    إرسال رابط التحقق
                </button>
                <button type="button" class="login-btn" style="margin-top: 10px; background: #800020;" onclick="sendPasswordReset()">
                    نسيت كلمة المرور
                </button>
            </form>
            <a href="index.html" class="back-link">← العودة للمتجر</a>
            <a href="متجر_2.HTML" class="back-link" style="margin-right: 20px;">🛍️ عرض المتجر</a>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Sale Zone</div>
                <div class="sidebar-subtitle">لوحة التحكم</div>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">الرئيسية</div>
                    <button class="menu-item active" onclick="showSection('overview')">📊 نظرة عامة</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">الإدارة</div>
                    <button class="menu-item" onclick="showSection('products')">📦 المنتجات <span class="badge" id="productsCount">0</span></button>
                    <button class="menu-item" onclick="showSection('suppliers')">🏭 الموردين <span class="badge" id="suppliersCount">0</span></button>
                    <button class="menu-item" onclick="showSection('orders')">🛍️ الطلبات <span class="badge" id="ordersCount">0</span></button>
                    <button class="menu-item" onclick="showSection('banners')">🎠 البانرات</button>
                    <button class="menu-item" onclick="showSection('coupons')">🎫 الكوبونات</button>
                    <button class="menu-item" onclick="showSection('users')">👥 العملاء</button>
                    <button class="menu-item" onclick="showSection('support')">💬 الدردشة الداخلية <span class="badge" id="supportUnreadCount">0</span></button>
                    <button class="menu-item" onclick="showSection('loyalty')">💎 نقاط الولاء</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">التقارير</div>
                    <button class="menu-item" onclick="showSection('reports')">📈 التقارير</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">الإعدادات</div>
                    <button class="menu-item" onclick="showSection('storeSettings')">🏪 المتجر</button>
                    <button class="menu-item" onclick="showSection('settings')">⚙️ النظام</button>
                    <a href="متجر_2.HTML" class="menu-item">🛍️ عرض المتجر</a>
                    <a href="index.html" class="menu-item">🏠 الصفحة الرئيسية</a>
                </div>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                    <h1 class="page-title" id="pageTitle">📊 نظرة عامة</h1>
                </div>
                <div class="top-bar-actions">
                    <div class="admin-info">
                        <div class="admin-avatar">م</div>
                        <span>المدير</span>
                    </div>
                    <button class="logout-btn" onclick="adminLogout()">🚪 خروج</button>
                </div>
            </div>
            <!-- Overview -->
            <section class="content-section active" id="overviewSection">
                <div class="stats-grid">
                    <div class="stat-card products">
                        <div class="stat-icon">📦</div>
                        <div class="stat-value" id="statProducts">0</div>
                        <div class="stat-label">منتج</div>
                    </div>
                    <div class="stat-card orders">
                        <div class="stat-icon">🛍️</div>
                        <div class="stat-value" id="statOrders">0</div>
                        <div class="stat-label">طلب</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-icon">👥</div>
                        <div class="stat-value" id="statUsers">0</div>
                        <div class="stat-label">عميل</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon">💰</div>
                        <div class="stat-value" id="statRevenue">0</div>
                        <div class="stat-label">إيرادات (ج.م)</div>
                    </div>
                    <div class="stat-card loyalty">
                        <div class="stat-icon">💎</div>
                        <div class="stat-value" id="statLoyalty">0</div>
                        <div class="stat-label">نقاط ولاء</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">📈 المبيعات</div>
                        <div class="chart-container"><canvas id="salesChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">📊 الأقسام</div>
                        <div class="chart-container"><canvas id="categoriesChart"></canvas></div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🕐 آخر الطلبات</h3>
                        <button class="btn btn-gold" onclick="showSection('orders')">عرض الكل</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>رقم</th><th>العميل</th><th>المبلغ</th><th>الحالة</th><th>التاريخ</th></tr></thead>
                                <tbody id="recentOrdersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products -->
            <section class="content-section" id="productsSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">📦 المنتجات</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="openProductModal()">➕ إضافة</button>
                            <button class="btn btn-navy" onclick="openAddCategoryPrompt()">🏷️ قسم جديد</button>
                            <button class="btn btn-success" onclick="exportProductsExcel()">📤 Excel</button>
                            <button class="btn btn-info" onclick="openImportWizard()">📥 استيراد مرن</button>
                            <button class="btn btn-navy" onclick="publishBatchPrompt()">🚀 نشر دفعة</button>
                            <button class="btn btn-warning" onclick="setAllProductsVisibility(false)">🙈 إخفاء الكل</button>
                            <button class="btn btn-danger" onclick="deleteAllProducts()">🧨 مسح الكل</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="form-row" style="margin-bottom:12px;">
                            <div class="form-group">
                                <label>بحث</label>
                                <input type="text" id="adminProductSearch" placeholder="اسم / كود / وصف" oninput="renderProductsTable()">
                            </div>
                            <div class="form-group">
                                <label>المورد</label>
                                <select id="adminProductSupplierFilter" onchange="renderProductsTable()">
                                    <option value="">كل الموردين</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>الحالة</label>
                                <select id="adminProductStatusFilter" onchange="renderProductsTable()">
                                    <option value="all">الكل</option>
                                    <option value="published">منشور</option>
                                    <option value="hidden">مخفي</option>
                                </select>
                            </div>
                            <div class="form-group" style="display:flex;align-items:end;gap:8px;">
                                <button type="button" class="btn btn-info" onclick="saveProductFilterView()">💾 حفظ العرض</button>
                                <button type="button" class="btn btn-navy" onclick="loadProductFilterView()">📂 تحميل</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>المنتج</th><th>القسم</th><th>المورد</th><th>التكلفة</th><th>السعر</th><th>الربح</th><th>الحالة</th><th>الدفعة</th><th>إجراءات</th></tr></thead>
                                <tbody id="productsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders -->
            <section class="content-section" id="ordersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🛍️ الطلبات</h3>
                        <div class="header-actions">
                            <button class="btn btn-success" onclick="exportOrdersExcel()">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>رقم</th><th>العميل</th><th>الهاتف</th><th>المبلغ</th><th>الحالة</th><th>التاريخ</th><th>إجراءات</th></tr></thead>
                                <tbody id="ordersTable"></tbody>
                            </table>
                        </div>
                        <div id="ordersPagination" style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap;">
                            <span id="ordersPaginationMeta" style="font-size:12px;color:#666;">0 طلب</span>
                            <div style="display:flex;gap:8px;">
                                <button type="button" class="btn btn-light" onclick="loadOrdersPage({ reset: true, showToast: true })">↻ إعادة تحميل</button>
                                <button type="button" class="btn btn-navy" id="ordersLoadMoreBtn" onclick="loadOrdersPage({ reset: false, showToast: false })" disabled>تحميل المزيد</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Banners -->
            <section class="content-section" id="bannersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🎠 البانرات</h3>
                        <button class="btn btn-gold" onclick="openModal('bannerModal')">➕ إضافة</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>أيقونة</th><th>العنوان</th><th>النص</th><th>القسم</th><th>إجراءات</th></tr></thead>
                                <tbody id="bannersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Coupons -->
            <section class="content-section" id="couponsSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🎫 الكوبونات</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="openModal('couponModal')">➕ إضافة</button>
                            <button class="btn btn-success" onclick="exportCouponsExcel()">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>الكود</th><th>الوصف</th><th>النوع</th><th>القيمة</th><th>إجراءات</th></tr></thead>
                                <tbody id="couponsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users -->
            <section class="content-section" id="usersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">👥 العملاء</h3>
                        <div class="header-actions">
                            <button class="btn btn-info" onclick="syncCustomersFromFirebaseNow()">🔄 تحديث العملاء</button>
                            <button class="btn btn-success" onclick="exportUsersExcel()">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>الاسم</th><th>الهاتف</th><th>البريد</th><th>النقاط</th><th>التسجيل</th><th>إجراءات</th></tr></thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                        <div id="usersPagination" style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap;">
                            <span id="usersPaginationMeta" style="font-size:12px;color:#666;">0 عميل</span>
                            <div style="display:flex;gap:8px;">
                                <button type="button" class="btn btn-light" onclick="loadCustomersPage({ reset: true, showToast: true })">↻ إعادة تحميل</button>
                                <button type="button" class="btn btn-navy" id="usersLoadMoreBtn" onclick="loadCustomersPage({ reset: false, showToast: false })" disabled>تحميل المزيد</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Support -->
            <section class="content-section" id="supportSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">💬 الدردشة الداخلية</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="refreshSupportThreads()" id="refreshSupportThreadsBtn">🔄 تحديث</button>
                            <button class="btn btn-danger" onclick="closeActiveSupportThread()" id="closeSupportThreadBtn" disabled>🔒 إغلاق المحادثة</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div id="supportAccessNotice" style="display:none;margin-bottom:12px;padding:10px 12px;border-radius:10px;background:#fff4e5;color:#8a4b08;font-size:12px;font-weight:600;"></div>
                        <div class="support-layout">
                            <div class="support-threads-panel">
                                <div class="support-panel-header">
                                    <strong>المحادثات</strong>
                                    <span id="supportThreadsMeta" style="font-size:11px;color:#666;">0 محادثة</span>
                                </div>
                                <div class="support-thread-list" id="supportThreadsList">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">💬</div>
                                        <p>لا توجد محادثات دعم</p>
                                    </div>
                                </div>
                            </div>
                            <div class="support-messages-panel">
                                <div class="support-panel-header">
                                    <strong id="supportActiveThreadTitle">اختر محادثة</strong>
                                    <span id="supportActiveThreadStatus" class="status-badge status-pending">-</span>
                                </div>
                                <div class="support-messages-list" id="supportMessagesList">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">📨</div>
                                        <p>اختر محادثة من القائمة</p>
                                    </div>
                                </div>
                                <div class="support-composer">
                                    <textarea id="supportReplyInput" placeholder="اكتب ردك هنا..." disabled></textarea>
                                    <button class="btn btn-navy" onclick="sendSupportReply()" id="supportReplyBtn" disabled>إرسال</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Loyalty -->
            <section class="content-section" id="loyaltySection">
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="loyalty-card">
                        <div class="loyalty-value" id="totalLoyalty">0</div>
                        <div class="loyalty-label">💎 إجمالي النقاط</div>
                    </div>
                    <div class="loyalty-card" style="background: linear-gradient(135deg, var(--burgundy), #a00030);">
                        <div class="loyalty-value" id="loyaltyRate">5</div>
                        <div class="loyalty-label">% نسبة الاكتساب</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">⚙️ إعدادات الولاء</h3>
                    </div>
                    <div class="section-body">
                        <form onsubmit="saveLoyaltySettings(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>نسبة الاكتساب (%)</label>
                                    <input type="number" id="loyaltyRateInput" min="1" max="50" value="5">
                                </div>
                                <div class="form-group">
                                    <label>قيمة النقطة (ج.م)</label>
                                    <input type="number" id="pointValueInput" min="0.01" step="0.01" value="0.1">
                                </div>
                            </div>
                            <button type="submit" class="submit-btn" style="max-width: 200px;">💾 حفظ</button>
                        </form>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">👥 نقاط العملاء</h3>
                        <button class="btn btn-gold" onclick="openModal('pointsModal')">➕ إضافة نقاط</button>
                    </div>
                    <div class="section-body" id="loyaltyUsersList"></div>
                </div>
            </section>

            <!-- Reports -->
            <section class="content-section" id="reportsSection">
                <div class="settings-grid">
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">📦 المنتجات</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">تصدير جميع المنتجات</p>
                            <button class="btn btn-success" onclick="exportProductsExcel()" style="width: 100%;">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">🛍️ الطلبات</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">تصدير جميع الطلبات</p>
                            <button class="btn btn-success" onclick="exportOrdersExcel()" style="width: 100%;">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">👥 العملاء</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">تصدير بيانات العملاء</p>
                            <button class="btn btn-success" onclick="exportUsersExcel()" style="width: 100%;">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">📊 تقرير شامل</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">جميع البيانات</p>
                            <button class="btn btn-success" onclick="exportFullReport()" style="width: 100%;">📤 تقرير شامل</button>
                        </div>
                    </div>
                </div>

                <div class="section-card" style="margin-top: 20px;">
                    <div class="section-header">
                        <h3 class="section-title">📱 سجل أخطاء الأجهزة</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="refreshClientErrorLogs()">🔄 تحديث</button>
                            <button class="btn btn-success" onclick="exportClientErrorsExcel()">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <p id="clientErrorsMeta" style="color: #666; margin-bottom: 12px; font-size: 13px;">آخر 50 خطأ من الموبايل/التابلت/المتصفح</p>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الوقت</th>
                                        <th>النوع</th>
                                        <th>الرسالة</th>
                                        <th>الصفحة</th>
                                        <th>الجهاز</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="clientErrorLogsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section-card" style="margin-top: 20px;">
                    <div class="section-header">
                        <h3 class="section-title">🛰️ التشغيل اللحظي للمتجر</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="refreshStoreOperationsNow()">🔄 تحديث</button>
                            <span id="storeOpsLiveBadge" class="status-badge status-confirmed">LIVE</span>
                        </div>
                    </div>
                    <div class="section-body">
                        <div id="storeOpsAccessNotice" style="display:none;margin-bottom:12px;padding:10px 12px;border-radius:10px;background:#fff4e5;color:#8a4b08;font-size:12px;font-weight:600;"></div>
                        <div class="stats-grid" style="margin-bottom: 14px;">
                            <div class="stat-card users">
                                <div class="stat-icon">🟢</div>
                                <div class="stat-value" id="liveSessionsCount">0</div>
                                <div class="stat-label">جلسات أونلاين</div>
                            </div>
                            <div class="stat-card orders">
                                <div class="stat-icon">📡</div>
                                <div class="stat-value" id="storeEventsCount">0</div>
                                <div class="stat-label">أحداث مباشرة</div>
                            </div>
                            <div class="stat-card revenue">
                                <div class="stat-icon">⏱️</div>
                                <div class="stat-value" id="lastStoreEventAt">-</div>
                                <div class="stat-label">آخر حدث</div>
                            </div>
                        </div>

                        <p id="liveSessionsMeta" style="color: #666; margin-bottom: 12px; font-size: 13px;">لا توجد جلسات مباشرة حالياً.</p>

                        <div class="table-container" style="margin-bottom: 14px;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الجلسة</th>
                                        <th>الجهاز</th>
                                        <th>العميل</th>
                                        <th>الصفحة</th>
                                        <th>آخر نبضة</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="liveSessionsTable"></tbody>
                            </table>
                        </div>

                        <p id="storeEventsMeta" style="color: #666; margin-bottom: 12px; font-size: 13px;">آخر 100 حدث تشغيلي من المتجر.</p>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الوقت</th>
                                        <th>المستوى</th>
                                        <th>النوع</th>
                                        <th>الرسالة</th>
                                        <th>المصدر</th>
                                        <th>تفاصيل</th>
                                    </tr>
                                </thead>
                                <tbody id="storeEventsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section-card" style="margin-top: 20px;">
                    <div class="section-header">
                        <h3 class="section-title">🧭 مراقبة وظائف الأدمن</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="refreshAdminFunctionMonitorView()">🔄 تحديث</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="stats-grid" style="margin-bottom: 14px;">
                            <div class="stat-card">
                                <div class="stat-icon">🧩</div>
                                <div class="stat-value" id="adminFunctionsTotal">0</div>
                                <div class="stat-label">إجمالي الدوال</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">🚨</div>
                                <div class="stat-value" id="adminFunctionsCritical">0</div>
                                <div class="stat-label">دوال حرجة</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">🛒</div>
                                <div class="stat-value" id="adminFunctionsStoreDirect">0</div>
                                <div class="stat-label">تأثير مباشر على المتجر</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">📱</div>
                                <div class="stat-value" id="adminFunctionsMobileDirect">0</div>
                                <div class="stat-label">تأثير مباشر على الموبايل</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">⛔</div>
                                <div class="stat-value" id="adminFunctionsFailures">0</div>
                                <div class="stat-label">حالات فشل حرجة</div>
                            </div>
                        </div>

                        <p id="adminFunctionsMeta" style="color: #666; margin-bottom: 12px; font-size: 13px;">
                            جارٍ تحميل سجل وظائف الأدمن...
                        </p>
                        <p id="adminFunctionsImpactSummary" style="color: #666; margin-bottom: 6px; font-size: 12px;">
                            تأثير المتجر/الموبايل: جارٍ التحميل...
                        </p>
                        <p id="adminFunctionsPersistenceSummary" style="color: #666; margin-bottom: 12px; font-size: 12px;">
                            نمط الحفظ: جارٍ التحميل...
                        </p>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label>بحث بالاسم</label>
                                <input type="text" id="adminFunctionsSearch" placeholder="مثال: saveProduct" oninput="applyAdminFunctionFilters()">
                            </div>
                            <div class="form-group">
                                <label>المستوى</label>
                                <select id="adminFunctionsLevelFilter" onchange="applyAdminFunctionFilters()">
                                    <option value="">الكل</option>
                                    <option value="critical">حرج</option>
                                    <option value="warning">تحذيري</option>
                                    <option value="info">معلوماتي</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>القسم</label>
                                <select id="adminFunctionsGroupFilter" onchange="applyAdminFunctionFilters()">
                                    <option value="">الكل</option>
                                    <option value="products">المنتجات</option>
                                    <option value="orders">الطلبات</option>
                                    <option value="banners">البانرات</option>
                                    <option value="coupons">الكوبونات</option>
                                    <option value="users">العملاء</option>
                                    <option value="support">الدعم</option>
                                    <option value="loyalty">الولاء</option>
                                    <option value="settings">الإعدادات</option>
                                    <option value="reports">التقارير</option>
                                    <option value="system">النظام</option>
                                    <option value="utility">مساعدة</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label>تأثير المتجر</label>
                                <select id="adminFunctionsStoreImpactFilter" onchange="applyAdminFunctionFilters()">
                                    <option value="">الكل</option>
                                    <option value="direct">مباشر</option>
                                    <option value="indirect">غير مباشر</option>
                                    <option value="none">لا يوجد</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>تأثير الموبايل</label>
                                <select id="adminFunctionsMobileImpactFilter" onchange="applyAdminFunctionFilters()">
                                    <option value="">الكل</option>
                                    <option value="direct">مباشر</option>
                                    <option value="indirect">غير مباشر</option>
                                    <option value="none">لا يوجد</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>نمط التخزين</label>
                                <select id="adminFunctionsPersistenceFilter" onchange="applyAdminFunctionFilters()">
                                    <option value="">الكل</option>
                                    <option value="firebase_online">أونلاين</option>
                                    <option value="hybrid">هجين</option>
                                    <option value="local_temporary">محلي مؤقت</option>
                                    <option value="memory_only">ذاكرة فقط</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الدالة</th>
                                        <th>المستوى</th>
                                        <th>الحالة</th>
                                        <th>السبب العام</th>
                                        <th>القسم</th>
                                        <th>تأثير المتجر</th>
                                        <th>تأثير الموبايل</th>
                                        <th>نمط التخزين</th>
                                    </tr>
                                </thead>
                                <tbody id="adminFunctionsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="content-section" id="suppliersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🏭 الموردين</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="openSupplierModal()">➕ إضافة مورد</button>
                            <button class="btn btn-info" onclick="assignSupplierToSelectionPrompt()">🔗 تعيين مورد</button>
                            <button class="btn btn-success" onclick="recalculateSupplierPrompt()">🧮 إعادة تسعير</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>الاسم</th><th>الكود</th><th>الهامش الافتراضي</th><th>التواصل</th><th>الحالة</th><th>إجراءات</th></tr></thead>
                                <tbody id="suppliersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Store Settings -->
            <section class="content-section" id="storeSettingsSection">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('general')">⚙️ عام</button>
                    <button class="tab-btn" onclick="switchTab('topbar')">📢 الشريط</button>
                    <button class="tab-btn" onclick="switchTab('footer')">🦶 الفوتر</button>
                    <button class="tab-btn" onclick="switchTab('contact')">📞 التواصل</button>
                </div>

                <div class="tab-content active" id="generalTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveGeneralSettings(event)">
                                <div class="form-group">
                                    <label>🏪 اسم المتجر</label>
                                    <input type="text" id="storeName" placeholder="Sale Zone Store">
                                </div>
                                <div class="form-group">
                                    <label>💬 الشعار</label>
                                    <input type="text" id="storeTagline" placeholder="التسوق الفاخر الذكي">
                                </div>
                                <div class="form-group">
                                    <label>📝 الوصف</label>
                                    <textarea id="storeDescription"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>💬 إعدادات FAQ Bot (JSON)</label>
                                    <textarea id="storeFaqIntents" rows="5" placeholder='[{"keywords":["شحن","توصيل"],"response":"التوصيل مجاني فوق 500 ج.م"}]'></textarea>
                                    <small style="color:#777;">اختياري: مصفوفة عناصر تحتوي keywords و response.</small>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>tawk.to Property ID (اختياري)</label>
                                        <input type="text" id="tawkPropertyId" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
                                    </div>
                                    <div class="form-group">
                                        <label>tawk.to Widget ID (اختياري)</label>
                                        <input type="text" id="tawkWidgetId" placeholder="1xxxxxxxx">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="tawkEnabled"> تفعيل tawk.to (مجاني)</label>
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="topbarTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveTopBarSettings(event)">
                                <div class="form-group">
                                    <label>📝 النص المتحرك</label>
                                    <textarea id="topBarText" rows="2"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>🎨 لون الخلفية</label>
                                        <input type="color" id="topBarBgColor" value="#0A1128">
                                    </div>
                                    <div class="form-group">
                                        <label>🎨 لون النص</label>
                                        <input type="color" id="topBarTextColor" value="#F4E4BC">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="topBarEnabled" checked> تفعيل الشريط</label>
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="footerTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveFooterSettings(event)">
                                <div class="form-group">
                                    <label>📖 عن المتجر</label>
                                    <textarea id="footerAbout" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>⏰ أيام الأسبوع</label>
                                    <input type="text" id="workingHoursWeekdays" placeholder="السبت - الخميس: 9 ص - 10 م">
                                </div>
                                <div class="form-group">
                                    <label>⏰ الجمعة</label>
                                    <input type="text" id="workingHoursFriday" placeholder="الجمعة: 2 م - 10 م">
                                </div>
                                <div class="form-group">
                                    <label>📝 ملاحظة</label>
                                    <input type="text" id="workingHoursNote" placeholder="🔔 خدمة 24/7">
                                </div>
                                <div class="form-group">
                                    <label>©️ حقوق النشر</label>
                                    <input type="text" id="copyrightText">
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="contactTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveContactSettings(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>📞 الهاتف</label>
                                        <input type="tel" id="contactPhone" placeholder="01018108979">
                                    </div>
                                    <div class="form-group">
                                        <label>💬 واتساب</label>
                                        <input type="tel" id="contactWhatsapp" placeholder="01018108979">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>📧 الإيميل</label>
                                        <input type="email" id="contactEmail">
                                    </div>
                                    <div class="form-group">
                                        <label>📍 العنوان</label>
                                        <input type="text" id="contactAddress">
                                    </div>
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Settings -->
            <section class="content-section" id="settingsSection">
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>🔐 كلمة المرور</h3>
                        <form onsubmit="changeAdminPassword(event)">
                            <div class="form-group">
                                <label>الحالية</label>
                                <input type="password" id="currentAdminPass" required>
                            </div>
                            <div class="form-group">
                                <label>الجديدة</label>
                                <input type="password" id="newAdminPass" required>
                            </div>
                            <div class="form-group">
                                <label>تأكيد</label>
                                <input type="password" id="confirmAdminPass" required>
                            </div>
                            <button type="submit" class="submit-btn">🔑 تغيير</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3>💾 النسخ الاحتياطي</h3>
                        <button class="btn btn-gold" onclick="exportAllDataJSON()" style="width: 100%; margin-bottom: 10px;">📤 تصدير JSON</button>
                        <input type="file" id="importJSONFile" accept=".json" onchange="importAllDataJSON(event)" style="display:none">
                        <button class="btn btn-info" onclick="document.getElementById('importJSONFile').click()" style="width: 100%;">📥 استيراد JSON</button>
                    </div>

                    <div class="settings-card">
                        <h3>🧹 تنظيف الصور الخارجية</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">
                            استبدال جميع الروابط الخارجية للصور بـ Placeholders محلية لتجنب مشاكل ORB/CORS.
                        </p>
                        <button class="btn btn-gold" onclick="sanitizeAllImages()" style="width: 100%;">✅ تنظيف صور المنتجات والبانرات</button>
                    </div>

                    <div class="settings-card">
                        <h3>🧪 فحص قبل النشر</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">
                            فحص سريع يمنع تكرار أخطاء العربية والترميز قبل أي رفع.
                        </p>
                        <button class="btn btn-info" onclick="runPreflightCheck()" style="width: 100%;">🔍 تشغيل الفحص</button>
                    </div>

                    <div class="settings-card">
                        <h3>🧨 حذف البيانات التجريبية</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">
                            يحذف فقط العناصر التي تم إنشاؤها افتراضيًا (صور Placeholder + أسماء/أكواد معروفة).
                        </p>
                        <button class="btn btn-danger" onclick="purgeSampleData()" style="width: 100%;">🗑️ حذف التجريبية الآن</button>
                    </div>

                    <div class="settings-card">
                        <h3>🧬 ترحيل Schema المنتجات</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">
                            Backfill آمن: التكلفة = السعر، الهامش = 0، وسعر البيع = السعر مع إنشاء searchTokens.
                        </p>
                        <button class="btn btn-info" onclick="runProductsSchemaMigration()" style="width: 100%;">🚀 تشغيل الترحيل الآن</button>
                    </div>

                    <div class="settings-card danger-zone">
                        <h3>⚠️ منطقة الخطر</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">لا يمكن التراجع عن هذه الإجراءات!</p>
                        <button class="btn btn-danger" onclick="clearAllData()" style="width: 100%;">🗑️ حذف الكل</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

<!-- Modals -->
<!-- Preflight Modal -->
<div class="modal-overlay" id="preflightModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2>🧪 تقرير فحص قبل النشر</h2>
      <button class="close-modal" onclick="closeModal('preflightModal')">✕</button>
    </div>
    <div class="modal-body">
      <pre id="preflightOutput" style="white-space: pre-wrap; font-size: 13px; color: #333; background: #f7f7f7; padding: 12px; border-radius: 8px; border: 1px solid #eee;"></pre>
      <button class="btn btn-gold" onclick="copyPreflightReport()" style="width: 100%; margin-top: 10px;">📋 نسخ التقرير</button>
    </div>
  </div>
</div>

<!-- Import Wizard Modal -->
<div class="modal-overlay" id="importWizardModal">
  <div class="modal" style="max-width: 960px;">
    <div class="modal-header">
      <h2>📥 استيراد Excel مرن</h2>
      <button class="close-modal" onclick="closeModal('importWizardModal')">✕</button>
    </div>
    <div class="modal-body">
      <div class="wizard-steps" id="importWizardSteps">
        <div class="wizard-step active" data-step="1">1) ملف/شيت</div>
        <div class="wizard-step" data-step="2">2) Header</div>
        <div class="wizard-step" data-step="3">3) Mapping</div>
        <div class="wizard-step" data-step="4">4) التحقق</div>
        <div class="wizard-step" data-step="5">5) التنفيذ</div>
      </div>

      <div class="wizard-panel active" id="wizardStep1">
        <div class="form-row">
          <div class="form-group">
            <label>ملف Excel *</label>
            <input type="file" id="wizardFileInput" accept=".xlsx,.xls,.csv" onchange="parseWorkbook(event)">
          </div>
          <div class="form-group">
            <label>الشيت *</label>
            <select id="wizardSheetSelect" onchange="selectImportSheet(this.value)"></select>
          </div>
        </div>
        <div class="wizard-report" id="wizardFileValidation" style="margin-bottom:12px;">سيتم اختبار الملف تلقائيًا بعد اختياره.</div>
        <div class="wizard-preview" id="wizardSheetPreview">اختر ملفًا لعرض المعاينة.</div>
      </div>

      <div class="wizard-panel" id="wizardStep2">
        <div class="form-row">
          <div class="form-group">
            <label>سطر العناوين (Header Row)</label>
            <input type="number" id="wizardHeaderRowInput" min="1" value="1" onchange="setHeaderRowManual()">
          </div>
          <div class="form-group">
            <label>اقتراح تلقائي</label>
            <input type="text" id="wizardHeaderHint" readonly>
          </div>
        </div>
        <div class="wizard-preview" id="wizardHeaderPreview"></div>
      </div>

      <div class="wizard-panel" id="wizardStep3">
        <div class="form-row">
          <div class="form-group">
            <label>عمود الاسم *</label>
            <select id="mapNameCol"></select>
          </div>
          <div class="form-group">
            <label>عمود السعر *</label>
            <select id="mapPriceCol"></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>عمود الوصف</label>
            <select id="mapDescCol"></select>
          </div>
          <div class="form-group">
            <label>عمود القسم</label>
            <select id="mapCategoryCol"></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>عمود الصورة</label>
            <select id="mapImageCol"></select>
          </div>
          <div class="form-group">
            <label>عمود السعر القديم</label>
            <select id="mapOldPriceCol"></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>عمود الكود</label>
            <select id="mapCodeCol"></select>
          </div>
          <div class="form-group">
            <label>عمود المخزون</label>
            <select id="mapStockCol"></select>
          </div>
        </div>
      </div>

      <div class="wizard-panel" id="wizardStep4">
        <div class="wizard-report" id="wizardValidationReport">لا يوجد تقرير بعد.</div>
      </div>

      <div class="wizard-panel" id="wizardStep5">
        <div class="form-row">
          <div class="form-group">
            <label>مصدر الاستيراد</label>
            <input type="text" id="wizardImportSource" readonly>
          </div>
          <div class="form-group">
            <label>حالة المنتجات الجديدة</label>
            <input type="text" value="مخفي افتراضيًا (نشر يدوي)" readonly>
          </div>
        </div>
        <div class="wizard-progress">
          <div class="wizard-progress-fill" id="wizardProgressFill"></div>
        </div>
        <div style="margin-top:8px;font-size:12px;color:#666" id="wizardProgressText">جاهز للتنفيذ.</div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
        <button class="btn btn-info" id="wizardPrevBtn" onclick="prevImportWizardStep()" disabled>السابق</button>
        <button class="btn btn-gold" id="wizardNextBtn" onclick="nextImportWizardStep()">التالي</button>
        <button class="btn btn-success" id="wizardCommitBtn" onclick="commitImportBatch()" style="display:none;">تنفيذ الاستيراد</button>
      </div>
    </div>
  </div>
</div>

<!-- Product Modal -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="productModalTitle">➕ منتج جديد</h2>
      <button class="close-modal" onclick="closeModal('productModal')">✕</button>
    </div>

    <div class="modal-body">
      <form onsubmit="saveProduct(event)">
        <input type="hidden" id="productId">

        <div class="form-group">
          <label>اسم المنتج *</label>
          <input type="text" id="productName" required>
        </div>

        <div class="form-group">
          <label>الوصف *</label>
          <textarea id="productDesc" required></textarea>
        </div>

        <div class="form-group">
          <label>القسم *</label>
          <select id="productCategory" required>
            <option value="">اختر</option>
            <option value="hair-care">💇‍♀️ شعر</option>
            <option value="skin-care">🧴 بشرة</option>
            <option value="baby-care">👶 طفل</option>
            <option value="supplements">💊 مكملات</option>
            <option value="medical">🏥 طبي</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>المورد</label>
            <select id="productSupplierId" onchange="handleProductSupplierChange()">
              <option value="">بدون مورد</option>
            </select>
          </div>
          <div class="form-group">
            <label>الكود</label>
            <input type="text" id="productCode">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>التكلفة *</label>
            <input type="number" id="productCostPrice" required min="0" step="0.01" oninput="recalculateProductPricingFromForm()">
          </div>
          <div class="form-group">
            <label>الهامش % *</label>
            <input type="number" id="productMarginPercent" required min="0" max="1000" step="0.01" oninput="recalculateProductPricingFromForm()">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>سعر البيع *</label>
            <input type="number" id="productPrice" required min="0" step="0.01" oninput="markManualSellPriceOverride()">
          </div>
          <div class="form-group">
            <label>السعر القديم</label>
            <input type="number" id="productOldPrice" min="0" step="0.01">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ربح متوقع</label>
            <input type="number" id="productProfitValue" readonly>
          </div>
          <div class="form-group">
            <label>هامش الربح الفعلي %</label>
            <input type="number" id="productProfitMarginActual" readonly>
          </div>
        </div>

        <div class="form-group">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="productManualPriceOverride" onchange="recalculateProductPricingFromForm()">
            تثبيت سعر البيع يدويًا (عدم إعادة حسابه تلقائيًا)
          </label>
          <input type="text" id="productManualPriceReason" placeholder="سبب التثبيت اليدوي (اختياري)" style="margin-top:8px;">
        </div>

        <!-- ============ صورة المنتج (رفع أو رابط) ============ -->
        <div class="form-group">
          <label>🖼️ صورة المنتج</label>

          <!-- رفع من الجهاز -->
          <input type="file" id="imgFile" accept="image/*" style="display:none" onchange="uploadAndPreview(this)">
          <button type="button"
                  onclick="document.getElementById('imgFile').click()"
                  style="background:#D4AF37;color:white;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;">
            📁 رفع من الجهاز
          </button>

          <div id="imgPreview" style="margin-top:10px;"></div>

          <!-- أو رابط -->
          <div style="margin:10px 0;color:#999;text-align:center;">— أو أدخل رابط —</div>
          <input type="url" id="manualImg" placeholder="https://..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;direction:ltr;">

          <!-- رابط نهائي (يتم تعبئته تلقائياً بعد الرفع) -->
          <input type="hidden" id="finalImg">
        </div>
        <!-- =================================================== -->

        <div class="form-group">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="productIsPublished" checked>
            إظهار المنتج في المتجر
          </label>
          <small style="color:#777;">يمكنك إخفاء المنتج الآن ثم نشره لاحقًا بعد المراجعة.</small>
        </div>

        <!-- زر حفظ المنتج (اللي كان ناقص) -->
        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee; text-align: center;">
          <button type="submit" class="submit-btn" style="min-width: 220px; font-size: 16px; font-weight: bold;">
            💾 حفظ المنتج
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

<!-- Supplier Modal -->
<div class="modal-overlay" id="supplierModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="supplierModalTitle">🏭 مورد جديد</h2>
      <button class="close-modal" onclick="closeModal('supplierModal')">✕</button>
    </div>
    <div class="modal-body">
      <form onsubmit="saveSupplier(event)">
        <input type="hidden" id="supplierId">
        <div class="form-row">
          <div class="form-group">
            <label>اسم المورد *</label>
            <input type="text" id="supplierName" required>
          </div>
          <div class="form-group">
            <label>كود المورد *</label>
            <input type="text" id="supplierCode" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>مسؤول التواصل</label>
            <input type="text" id="supplierContactName">
          </div>
          <div class="form-group">
            <label>رقم الهاتف</label>
            <input type="tel" id="supplierPhone">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>الهامش الافتراضي %</label>
            <input type="number" id="supplierDefaultMargin" min="0" max="1000" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px;margin-top:28px;">
              <input type="checkbox" id="supplierActive" checked>
              مورد نشط
            </label>
          </div>
        </div>
        <div class="form-group">
          <label>ملاحظات</label>
          <textarea id="supplierNotes"></textarea>
        </div>
        <div style="margin-top: 20px; text-align: center;">
          <button type="submit" class="submit-btn">💾 حفظ المورد</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- Banner Modal -->
    <div class="modal-overlay" id="bannerModal">
        <div class="modal">
            <div class="modal-header">
                <h2>➕ بانر جديد</h2>
                <button class="close-modal" onclick="closeModal('bannerModal')">✕</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveBanner(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>الأيقونة</label>
                            <input type="text" id="bannerIcon" placeholder="🎉">
                        </div>
                        <div class="form-group">
                            <label>القسم</label>
                            <select id="bannerCategory">
                                <option value="all">الكل</option>
                                <option value="hair-care">شعر</option>
                                <option value="skin-care">بشرة</option>
                                <option value="baby-care">طفل</option>
                                <option value="supplements">مكملات</option>
                                <option value="medical">طبي</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>العنوان *</label>
                        <input type="text" id="bannerTitle" required>
                    </div>
                    <div class="form-group">
                        <label>النص</label>
                        <input type="text" id="bannerText">
                    </div>
                    <div class="form-group">
                        <label>نص الزر</label>
                        <input type="text" id="bannerBtn" placeholder="تسوق الآن">
                    </div>
                    <button type="submit" class="submit-btn">💾 حفظ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div class="modal-overlay" id="couponModal">
        <div class="modal">
            <div class="modal-header">
                <h2>➕ كوبون جديد</h2>
                <button class="close-modal" onclick="closeModal('couponModal')">✕</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveCoupon(event)">
                    <div class="form-group">
                        <label>الكود *</label>
                        <input type="text" id="couponCode" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>الوصف *</label>
                        <input type="text" id="couponDesc" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>النوع *</label>
                            <select id="couponType" required>
                                <option value="percentage">نسبة %</option>
                                <option value="fixed">مبلغ ثابت</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>القيمة *</label>
                            <input type="number" id="couponValue" required min="1">
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">💾 حفظ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal large">
            <div class="modal-header">
                <h2>📦 تفاصيل الطلب</h2>
                <button class="close-modal" onclick="closeModal('orderModal')">✕</button>
            </div>
            <div class="modal-body" id="orderModalBody"></div>
        </div>
    </div>

    <!-- Points Modal -->
    <div class="modal-overlay" id="pointsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>💎 إضافة/خصم نقاط</h2>
                <button class="close-modal" onclick="closeModal('pointsModal')">✕</button>
            </div>
            <div class="modal-body">
                <form onsubmit="handlePointsAction(event)">
                    <div class="form-group">
                        <label>العميل *</label>
                        <select id="pointsUserId" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>العملية *</label>
                            <select id="pointsAction" required>
                                <option value="add">➕ إضافة</option>
                                <option value="subtract">➖ خصم</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>النقاط *</label>
                            <input type="number" id="pointsAmount" required min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>السبب</label>
                        <input type="text" id="pointsReason">
                    </div>
                    <button type="submit" class="submit-btn">✅ تنفيذ</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // Data Store
        // ============================================
        let products = [];
        let orders = [];
        let coupons = [];
        let banners = [];
        let users = [];
        let suppliers = [];
        let customersPageCursor = '';
        let customersHasMore = false;
        let customersTotalLoaded = 0;
        let customersPageSize = 20;
        let customersLoading = false;
        let ordersPageCursor = '';
        let ordersHasMore = false;
        let ordersTotalLoaded = 0;
        let ordersPageSize = 50;
        let ordersLoading = false;
        let clientErrorLogs = [];
        let storeEvents = [];
        let liveSessions = [];
        let adminFunctionRegistry = [];
        let adminFunctionRegistryFiltered = [];
        let adminFunctionRegistryMeta = null;
        let supportThreads = [];
        let supportMessages = [];
        let activeSupportThreadId = '';
        let supportThreadsUnsubscribe = null;
        let supportMessagesUnsubscribe = null;
        let supportAccess = {
            denied: false,
            reason: '',
            source: '',
            notifiedReason: ''
        };
        let storeOpsAccess = {
            denied: false,
            reason: '',
            source: '',
            notifiedReason: ''
        };
        let storeEventsUnsubscribe = null;
        let liveSessionsUnsubscribe = null;
        const warningLogOnce = new Set();
        // 🔐 تحسين الأمان: كلمة مرور قوية افتراضياً
        // ⚠️ يُنصح بتغييرها فوراً بعد أول تسجيل دخول
        let adminPassword = null;
        let storeSettings = {
            name: 'Sale Zone Store',
            tagline: 'التسوق الفاخر الذكي',
            description: '',
            topBar: { enabled: true, text: '🎉 خصومات حصرية!', bgColor: '#0A1128', textColor: '#F4E4BC' },
            contact: { phone: '01018108979', whatsapp: '01018108979', email: 'info@salezone.com', address: 'مصر' },
            footer: { about: '', workingHoursWeekdays: 'السبت - الخميس: 9 ص - 10 م', workingHoursFriday: 'الجمعة: 2 م - 10 م', workingHoursNote: '🔔 خدمة 24/7', copyright: '© 2026 Sale Zone Store ❤️' },
            loyalty: { rate: 5, pointValue: 0.1 },
            customCategories: [],
            faqIntents: [],
            chatSupport: { enableTawk: false, tawkPropertyId: '', tawkWidgetId: '' }
        };
        let salesChart, categoriesChart;
        const PENDING_PRODUCT_OPS_KEY = 'sale_zone_pending_ops';
        const PRODUCT_SAVED_FILTERS_KEY = 'sale_zone_admin_saved_product_filters';
        const MAX_ADMIN_PRODUCTS_LOCAL_CACHE = 800;
        const DEFAULT_PRODUCT_IMAGE = './assets/placeholder.svg';
        let pendingProductOps = [];
        let pendingOpsInFlight = false;
        let importWizardState = null;
        const IMPORT_WIZARD_FIELDS = [
            { key: 'name', label: 'الاسم', required: true },
            { key: 'price', label: 'السعر', required: true },
            { key: 'desc', label: 'الوصف', required: false },
            { key: 'category', label: 'القسم', required: false },
            { key: 'image', label: 'الصورة', required: false },
            { key: 'oldPrice', label: 'السعر القديم', required: false },
            { key: 'code', label: 'الكود', required: false },
            { key: 'stock', label: 'المخزون', required: false }
        ];
        const IMPORT_HEADER_SYNONYMS = {
            name: ['name', 'product', 'product name', 'اسم', 'اسم المنتج', 'الصنف', 'المنتج'],
            price: ['price', 'retail', 'selling', 'sale price', 'سعر', 'السعر', 'سعر البيع', 'سعر القطاعي'],
            desc: ['description', 'desc', 'details', 'الوصف', 'تفاصيل', 'مواصفات'],
            category: ['category', 'class', 'section', 'القسم', 'التصنيف', 'الفئه', 'الفئة'],
            image: ['image', 'img', 'photo', 'url', 'link', 'الصوره', 'الصورة', 'رابط الصورة'],
            oldPrice: ['old price', 'mrp', 'before', 'list price', 'السعر القديم', 'قبل الخصم', 'سعر قبل'],
            code: ['code', 'sku', 'barcode', 'item code', 'الكود', 'باركود', 'رمز'],
            stock: ['stock', 'qty', 'quantity', 'inventory', 'المخزون', 'الكميه', 'الكمية']
        };

        function normalizeArabicHeader(text) {
            return String(text || '')
                .trim()
                .toLowerCase()
                .replace(/[\u064b-\u065f]/g, '')
                .replace(/[أإآ]/g, 'ا')
                .replace(/[ة]/g, 'ه')
                .replace(/[ى]/g, 'ي')
                .replace(/[^a-z0-9\u0621-\u064a\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function inferCategory(value) {
            const v = normalizeArabicHeader(value);
            if (!v) return 'supplements';
            if (/(hair|شعر)/.test(v)) return 'hair-care';
            if (/(skin|بشره|بشرة)/.test(v)) return 'skin-care';
            if (/(baby|طفل|اطفال)/.test(v)) return 'baby-care';
            if (/(med|medical|طبي|اجهزه|اجهزة)/.test(v)) return 'medical';
            if (/(supplement|vit|مكمل|فيتامين|جمله|جملة)/.test(v)) return 'supplements';
            return 'supplements';
        }

        function parseMoney(value) {
            if (typeof value === 'number' && Number.isFinite(value)) return value;
            const raw = String(value == null ? '' : value).trim();
            if (!raw) return NaN;
            const normalized = raw.replace(/[^\d.,-]/g, '').replace(/,/g, '.');
            const parsed = parseFloat(normalized);
            return Number.isFinite(parsed) ? parsed : NaN;
        }

        function makeImportBatchId() {
            return `batch_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
        }

        function resolveProductPricingFields(source, defaults = {}) {
            const rawSource = source && typeof source === 'object' ? source : {};
            const rawDefaults = defaults && typeof defaults === 'object' ? defaults : {};
            const effective = {
                price: rawSource.price,
                costPrice: Object.prototype.hasOwnProperty.call(rawSource, 'costPrice') ? rawSource.costPrice : rawDefaults.costPrice,
                marginPercent: Object.prototype.hasOwnProperty.call(rawSource, 'marginPercent') ? rawSource.marginPercent : rawDefaults.marginPercent,
                sellPrice: Object.prototype.hasOwnProperty.call(rawSource, 'sellPrice') ? rawSource.sellPrice : rawDefaults.sellPrice,
                manualPriceOverride: Object.prototype.hasOwnProperty.call(rawSource, 'manualPriceOverride') ? rawSource.manualPriceOverride : rawDefaults.manualPriceOverride,
                manualPriceReason: Object.prototype.hasOwnProperty.call(rawSource, 'manualPriceReason') ? rawSource.manualPriceReason : rawDefaults.manualPriceReason
            };

            if (typeof normalizePricingFields === 'function') {
                return normalizePricingFields(effective);
            }

            const costPrice = Math.max(0, Number(parseMoney(effective.costPrice)));
            const marginPercent = Math.max(0, Math.min(1000, Number(parseMoney(effective.marginPercent))));
            const manualPriceOverride = effective.manualPriceOverride === true;
            const autoSellPrice = Number((costPrice * (1 + (marginPercent / 100))).toFixed(2));
            const requestedSellPrice = Number(Number(parseMoney(effective.sellPrice)).toFixed(2));
            const sellPrice = manualPriceOverride && Number.isFinite(requestedSellPrice) ? Math.max(0, requestedSellPrice) : autoSellPrice;
            const profitValue = Number((sellPrice - costPrice).toFixed(2));
            const profitMarginActual = sellPrice > 0 ? Number(((profitValue / sellPrice) * 100).toFixed(2)) : 0;

            return {
                costPrice,
                marginPercent,
                sellPrice,
                price: sellPrice,
                profitValue,
                profitMarginActual,
                manualPriceOverride,
                manualPriceReason: String(effective.manualPriceReason || '').trim()
            };
        }

        function buildProductSearchTokensSafe(source) {
            if (typeof buildProductSearchTokens === 'function') {
                return buildProductSearchTokens(source);
            }
            return [];
        }

        function normalizeProductForStorage(product, defaults = {}) {
            const source = product && typeof product === 'object' ? product : {};
            const nowIso = new Date().toISOString();
            const isPublished = Object.prototype.hasOwnProperty.call(source, 'isPublished')
                ? source.isPublished !== false
                : (defaults.isPublished !== false);
            const pricing = resolveProductPricingFields(source, defaults);

            return {
                id: String(source.id || ''),
                name: String(source.name || '').trim(),
                desc: String(source.desc || ''),
                category: inferCategory(source.category || defaults.category || ''),
                supplierId: String(source.supplierId || defaults.supplierId || ''),
                supplierName: String(source.supplierName || defaults.supplierName || ''),
                supplierCode: String(source.supplierCode || defaults.supplierCode || ''),
                ...pricing,
                oldPrice: Number.isFinite(parseMoney(source.oldPrice)) ? parseMoney(source.oldPrice) : null,
                image: sanitizeImageUrl(source.image || DEFAULT_PRODUCT_IMAGE),
                rating: Number.isFinite(Number(source.rating)) ? Number(source.rating) : 4.5,
                ratingCount: Number.isFinite(Number(source.ratingCount)) ? Number(source.ratingCount) : 0,
                code: String(source.code || ''),
                stock: Number.isFinite(Number(source.stock)) ? Number(source.stock) : -1,
                searchTokens: Array.isArray(source.searchTokens) && source.searchTokens.length
                    ? source.searchTokens
                    : buildProductSearchTokensSafe({ ...defaults, ...source, ...pricing }),
                isPublished,
                visibilityState: isPublished ? 'published' : 'hidden',
                importBatchId: String(source.importBatchId || defaults.importBatchId || ''),
                importSource: String(source.importSource || defaults.importSource || ''),
                createdAt: source.createdAt || defaults.createdAt || nowIso,
                updatedAt: nowIso
            };
        }

        function ensureProductsSchema(list) {
            return (Array.isArray(list) ? list : [])
                .map((p) => normalizeProductForStorage(p, { isPublished: true }))
                .filter((p) => p.name && p.price >= 0);
        }

        function ensureSuppliersSchema(list) {
            const nowIso = new Date().toISOString();
            return (Array.isArray(list) ? list : []).map((item) => ({
                id: String(item && item.id || ''),
                name: String(item && item.name || '').trim(),
                code: String(item && item.code || '').trim().toUpperCase(),
                contactName: String(item && item.contactName || '').trim(),
                phone: String(item && item.phone || '').trim(),
                notes: String(item && item.notes || '').trim(),
                defaultMarginPercent: Number.isFinite(Number(item && item.defaultMarginPercent)) ? Number(item.defaultMarginPercent) : 0,
                active: item && item.active !== false,
                createdAt: String(item && item.createdAt || nowIso),
                updatedAt: String(item && item.updatedAt || nowIso)
            })).filter((item) => item.name.length > 0);
        }

        function loadPendingProductOps() {
            try {
                const parsed = JSON.parse(localStorage.getItem(PENDING_PRODUCT_OPS_KEY) || '[]');
                pendingProductOps = Array.isArray(parsed) ? parsed : [];
            } catch (_) {
                pendingProductOps = [];
            }
        }

        function persistPendingProductOps() {
            localStorage.setItem(PENDING_PRODUCT_OPS_KEY, JSON.stringify(pendingProductOps));
        }

        function getPendingOpEffectiveId(rawId) {
            const requestedId = String(rawId || '').trim();
            if (!requestedId) return '';
            const mapped = products.find((p) => String(p.id) === requestedId);
            return mapped ? String(mapped.id) : requestedId;
        }

        function patchPendingAddByTempId(tempId, updater) {
            if (!tempId || typeof updater !== 'function') return false;
            let changed = false;
            for (const op of pendingProductOps) {
                if (op.type !== 'add') continue;
                const opTempId = String(op.payload && op.payload.tmpId || '');
                if (opTempId !== String(tempId)) continue;
                const original = op.payload.product || {};
                const updated = updater({ ...original });
                if (updated && typeof updated === 'object') {
                    op.payload.product = updated;
                    changed = true;
                }
            }
            if (changed) persistPendingProductOps();
            return changed;
        }

        function enqueuePendingProductOp(type, payload) {
            const op = {
                id: `op_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,
                type: String(type || ''),
                payload: payload && typeof payload === 'object' ? payload : {},
                createdAt: new Date().toISOString()
            };
            pendingProductOps.push(op);
            persistPendingProductOps();
            return op;
        }

        async function applyProductOpOnline(op) {
            const type = String(op && op.type || '');
            const payload = op && op.payload ? op.payload : {};

            if (type === 'add') {
                if (typeof addProduct !== 'function') throw new Error('addProduct unavailable');
                const createdId = await addProduct(payload.product);
                const tmpId = String(payload.tmpId || '');
                if (tmpId) {
                    const idx = products.findIndex((p) => String(p.id) === tmpId);
                    if (idx !== -1) {
                        products[idx] = normalizeProductForStorage({ ...products[idx], ...payload.product, id: createdId });
                    }
                    pendingProductOps.forEach((pendingOp) => {
                        if (!pendingOp || !pendingOp.payload) return;
                        if (String(pendingOp.payload.id || '') === tmpId) {
                            pendingOp.payload.id = String(createdId);
                        }
                        if (String(pendingOp.payload.tmpId || '') === tmpId) {
                            pendingOp.payload.tmpId = String(createdId);
                        }
                    });
                }
                return;
            }

            if (type === 'update') {
                if (typeof updateProduct !== 'function') throw new Error('updateProduct unavailable');
                await updateProduct(getPendingOpEffectiveId(payload.id), payload.data || {});
                return;
            }

            if (type === 'delete') {
                if (typeof deleteProductFromFirebase !== 'function') throw new Error('deleteProductFromFirebase unavailable');
                await deleteProductFromFirebase(getPendingOpEffectiveId(payload.id));
                return;
            }

            if (type === 'visibility') {
                const targetId = getPendingOpEffectiveId(payload.id);
                if (typeof updateProductVisibility === 'function') {
                    await updateProductVisibility(targetId, payload.isPublished !== false);
                } else if (typeof updateProduct === 'function') {
                    await updateProduct(targetId, {
                        isPublished: payload.isPublished !== false,
                        visibilityState: payload.isPublished !== false ? 'published' : 'hidden'
                    });
                } else {
                    throw new Error('visibility update API unavailable');
                }
                return;
            }

            throw new Error(`Unknown op type: ${type}`);
        }

        async function flushPendingProductOps() {
            if (pendingOpsInFlight) return;
            if (!navigator.onLine) return;
            if (!pendingProductOps.length) return;

            pendingOpsInFlight = true;
            try {
                const remaining = [];
                for (const op of pendingProductOps) {
                    try {
                        await applyProductOpOnline(op);
                    } catch (error) {
                        remaining.push(op);
                        console.warn('Pending op failed:', op.type, error);
                    }
                }
                pendingProductOps = remaining;
                persistPendingProductOps();
                saveProducts();
                renderProductsTable();
                updateStats();
            } finally {
                pendingOpsInFlight = false;
            }
        }

        // ============================================
        // Version Sync (Force fresh rollout on all devices)
        // ============================================
        async function checkAppVersionAndRefresh() {
            try {
                const res = await fetch(`./version.json?t=${Date.now()}`, { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                const incomingVersion = String(data?.version || '').trim();
                if (!incomingVersion) return;

                const storageKey = 'salezone_app_version';
                const currentVersion = localStorage.getItem(storageKey);
                if (!currentVersion) {
                    localStorage.setItem(storageKey, incomingVersion);
                    return;
                }
                if (currentVersion !== incomingVersion) {
                    localStorage.setItem(storageKey, incomingVersion);
                    // Hard refresh on version change: clear SW caches + stale synced data.
                    try {
                        ['sale_zone_products', 'sale_zone_coupons', 'sale_zone_banners', 'sale_zone_settings', 'sale_zone_last_update']
                            .forEach((k) => localStorage.removeItem(k));
                    } catch (_) {}
                    try {
                        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
                        }
                    } catch (_) {}
                    window.location.reload();
                }
            } catch (_) {}
        }

        // ============================================
        // ServiceWorker Auto Update (Admin)
        // ============================================
        function setupServiceWorkerAutoUpdate() {
            if (!('serviceWorker' in navigator)) {
                return;
            }

            const swHost = (window.location && window.location.hostname) || '';
            const isLocalDevHost = /^(localhost|127(?:\.\d{1,3}){3}|0\.0\.0\.0|::1|\[::1\]|10(?:\.\d{1,3}){3}|192\.168(?:\.\d{1,3}){2}|172\.(1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})$/i.test(swHost) || swHost.endsWith('.local');
            const disableServiceWorker = isLocalDevHost || new URLSearchParams(window.location.search).get('nosw') === '1';

            if (disableServiceWorker) {
                navigator.serviceWorker.getRegistrations()
                    .then(registrations => Promise.all(registrations.map(reg => reg.unregister())))
                    .then(() => {
                        console.log('Local dev mode - ServiceWorker disabled in admin to prevent stale cache');
                    })
                    .catch(() => undefined);
                return;
            }

            let swRefreshing = false;
            const requestRefresh = () => {
                if (swRefreshing) return;
                swRefreshing = true;
                window.location.reload();
            };

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                requestRefresh();
            });

            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_UPDATED' && navigator.serviceWorker.controller) {
                    requestRefresh();
                }
            });

            navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                .then(registration => {
                    const updateNow = () => registration.update().catch(() => undefined);
                    updateNow();
                    setInterval(updateNow, 60 * 60 * 1000);
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') updateNow();
                    });

                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }

                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (!newWorker) return;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (registration.waiting) {
                                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                                }
                                if (navigator.serviceWorker.controller) {
                                    requestRefresh();
                                }
                            }
                        });
                    });
                })
                .catch(() => undefined);
        }

        // ============================================
        // Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            setupAutoTooltips();
            window.addEventListener('pageshow', (event) => {
                if (event.persisted) {
                    window.location.reload();
                }
            });
            loadPendingProductOps();
            window.addEventListener('online', () => {
                flushPendingProductOps();
            });
            await checkAppVersionAndRefresh();
            // Periodic version check to keep mobile/PWA clients aligned without manual cache clearing.
            setInterval(checkAppVersionAndRefresh, 10 * 60 * 1000);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') checkAppVersionAndRefresh();
            });
            setupServiceWorkerAutoUpdate();
            await checkAdminSession();
        });

        // ============================================
        // Data Management
        // ============================================
        // 🔥 Firebase + LocalStorage Hybrid Data Loading
        async function loadAllData() {
            try {
                // محاولة تحميل من Firebase أولاً
                     if (typeof getAllProducts === 'function') {
                     console.log('🔥 Admin: Loading from Firebase...');
                     const fbProducts = await getAllProducts();
                     const fbCoupons = await getAllCoupons();
                     const fbBanners = await getAllBanners();
                     const fbSuppliers = typeof getSuppliers === 'function' ? await getSuppliers() : null;
                     let fbSupportThreads = null;
                    if (typeof getSupportThreads === 'function') {
                        try {
                            await requireAdminPermission();
                            fbSupportThreads = await getSupportThreads(150, { strict: true });
                            clearSupportAccessState();
                        } catch (supportError) {
                            const denied = handleSupportAccessError(supportError, 'loadAllData.getSupportThreads');
                            if (!denied) {
                                console.warn('support preload warning:', supportError);
                            }
                            fbSupportThreads = [];
                        }
                    }

                    const cachedAdminProducts = getStorageData('PRODUCTS_ADMIN');
                    const cachedStoreProducts = getStorageData('PRODUCTS');
                     products = Array.isArray(fbProducts)
                         ? fbProducts
                         : (Array.isArray(cachedAdminProducts) ? cachedAdminProducts : (Array.isArray(cachedStoreProducts) ? cachedStoreProducts : []));
                     const cachedOrders = getStorageData('ORDERS');
                     orders = Array.isArray(cachedOrders) ? cachedOrders : [];
                     ordersPageCursor = '';
                     ordersHasMore = false;
                     ordersTotalLoaded = Array.isArray(orders) ? orders.length : 0;
                     users = [];
                     coupons = Array.isArray(fbCoupons) ? fbCoupons : (getStorageData('COUPONS') || []);
                     banners = Array.isArray(fbBanners) ? fbBanners : (getStorageData('BANNERS') || []);
                     suppliers = Array.isArray(fbSuppliers) ? fbSuppliers : (getStorageData('SUPPLIERS') || []);
                     supportThreads = Array.isArray(fbSupportThreads) ? fbSupportThreads : [];
                    
                    const settings = await getSettings();
                    if (settings) storeSettings = { ...storeSettings, ...settings };
                    clientErrorLogs = (typeof getClientErrorLogs === 'function')
                        ? (await getClientErrorLogs(50) || [])
                        : [];
                    
                    console.log('✅ Admin data loaded from Firebase');
                    console.log('📦 Products:', products.length);
                    console.log('📦 Product IDs:', products.map(p => p.id));
                    console.log('🛍️ Orders:', orders.length);
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (error) {
                console.warn('⚠️ Firebase error, using localStorage:', error);
                // Fallback to localStorage
                const cachedAdminProducts = getStorageData('PRODUCTS_ADMIN');
                const cachedStoreProducts = getStorageData('PRODUCTS');
                products = Array.isArray(cachedAdminProducts) ? cachedAdminProducts : (Array.isArray(cachedStoreProducts) ? cachedStoreProducts : []);
                orders = getStorageData('ORDERS') || [];
                coupons = getStorageData('COUPONS') || [];
                banners = getStorageData('BANNERS') || [];
                users = [];
                suppliers = getStorageData('SUPPLIERS') || [];
                supportThreads = [];
                try {
                    const localErrors = JSON.parse(localStorage.getItem('adminErrors') || '[]');
                    clientErrorLogs = localErrors.slice(-50).reverse().map((err, idx) => ({
                        id: `local_${idx}`,
                        type: err.type || 'CLIENT_ERROR',
                        message: err.message || 'Unknown error',
                        source: err.filename || err.url || '',
                        timestamp: err.timestamp || new Date().toISOString(),
                        context: {
                            page: err.url || '',
                            userAgent: err.userAgent || '',
                            online: navigator.onLine,
                            viewport: { width: window.innerWidth || 0, height: window.innerHeight || 0 }
                        }
                    }));
                } catch (_) {
                    clientErrorLogs = [];
                }
            }

            products = ensureProductsSchema(products);
            suppliers = ensureSuppliersSchema(suppliers);
            saveProducts();
            saveSuppliers();
            renderProductCategoryOptions();
            updateSupportAccessUi();
            await loadCustomersPage({ reset: true, showToast: false }).catch((error) => {
                console.warn('customers initial page load warning:', error);
            });
            
            // كلمة المرور دائماً من localStorage
            const saved = getStorageData('SETTINGS');
            if (saved) storeSettings = { ...storeSettings, ...saved };
            
            // Data loaded, rendering will be done by initDashboard()
        }

        function saveProducts() {
            const source = Array.isArray(products) ? products : [];
            if (source.length > MAX_ADMIN_PRODUCTS_LOCAL_CACHE) {
                const compact = source.slice(0, MAX_ADMIN_PRODUCTS_LOCAL_CACHE).map((item) => ({
                    id: item.id,
                    name: item.name,
                    code: item.code || '',
                    category: item.category || '',
                    price: Number(item.price || 0),
                    isPublished: item.isPublished !== false,
                    updatedAt: item.updatedAt || '',
                    image: item.image || './assets/placeholder.svg'
                }));
                setStorageData('PRODUCTS_ADMIN', compact);
                console.log(`[INFO] Admin products cache compacted: ${compact.length}/${source.length}`);
                return;
            }
            setStorageData('PRODUCTS_ADMIN', source);
        }
        function saveOrders() {
            const source = Array.isArray(orders) ? orders : [];
            const compact = source.length > 400 ? source.slice(0, 400) : source;
            setStorageData('ORDERS', compact);
        }
        function saveCoupons() { setStorageData('COUPONS', coupons); }
        function saveBanners() { setStorageData('BANNERS', banners); }
        function saveUsers() { users = Array.isArray(users) ? users : []; }
        function saveSuppliers() { setStorageData('SUPPLIERS', suppliers); }
        function saveAdminPassword() {}
        function logAdmin(level, code, message, meta) {
            try {
                if (window.logger && typeof window.logger[level] === 'function') {
                    window.logger[level](code, message, 'admin.panel', meta || {});
                    return;
                }
            } catch (_) {}
            const writer = (console && typeof console[level] === 'function') ? console[level].bind(console) : console.log.bind(console);
            if (typeof meta === 'undefined') writer(`[${code}] ${message}`);
            else writer(`[${code}] ${message}`, meta);
        }
        function saveStoreSettings() {
            setStorageData('SETTINGS', storeSettings);
            if (navigator.onLine === true && typeof saveSettings === 'function') {
                saveSettings(storeSettings).catch((error) => {
                    logAdmin('warn', 'ADMIN_SETTINGS_SYNC_WARN', 'Store settings Firebase sync warning', { error: error && error.message ? String(error.message) : String(error) });
                });
            }
        }

        // ============================================
        // Auth
        // ============================================
        function hasAdminClaimFromTokenResult(token) {
          return token?.claims?.admin === true || token?.claims?.role === 'admin';
        }

        async function requireAdminPermission() {
          if (!firebase || !firebase.auth) throw new Error('auth-not-available');
          const user = firebase.auth().currentUser;
          if (!user) throw new Error('not-authenticated');
          const token = await user.getIdTokenResult(true);
          const isClaimAdmin = hasAdminClaimFromTokenResult(token);
          if (user.emailVerified !== true || !isClaimAdmin) throw new Error('not-admin');
          return { isClaimAdmin, user };
        }

async function handleLogin(e){
  e.preventDefault();
  const email = document.getElementById('adminEmail').value.trim();
  const normalizedEmail = String(email || '').trim().toLowerCase();
  const pass = document.getElementById('adminPassword').value;
  const loginError = document.getElementById('loginError');

  // Rate limiting check (stable per email/device instead of random token)
  let adminLoginDeviceId = '';
  try {
    adminLoginDeviceId = String(localStorage.getItem('admin_login_device') || '');
    if (!adminLoginDeviceId) {
      adminLoginDeviceId = `device_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;
      localStorage.setItem('admin_login_device', adminLoginDeviceId);
    }
  } catch (_) {
    adminLoginDeviceId = `device_${Math.random().toString(36).slice(2, 9)}`;
  }
  const rateLimitKey = normalizedEmail ? `admin_login_${normalizedEmail}` : `admin_login_${adminLoginDeviceId}`;
  if (rateLimiter.isBlocked(rateLimitKey)) {
    const blockTime = Math.ceil(rateLimiter.getBlockTimeRemaining(rateLimitKey) / 60000);
    loginError.style.display = 'block';
    loginError.textContent = `تم حظر المحاولات. حاول مرة أخرى بعد ${blockTime} دقيقة`;
    return;
  }

  try{
    const userCred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCred.user;
    const token = await user.getIdTokenResult(true);
    const isClaimAdmin = hasAdminClaimFromTokenResult(token);

    if (!user.emailVerified) {
      await firebase.auth().signOut();
      loginError.style.display = 'block';
      loginError.textContent = 'يجب تفعيل البريد الإلكتروني أولًا للدخول كأدمن';
      return;
    }

    if (!isClaimAdmin) {
      await firebase.auth().signOut();
      rateLimiter.recordAttempt(rateLimitKey);
      const remaining = rateLimiter.getRemainingAttempts(rateLimitKey);
      loginError.style.display = 'block';
      loginError.textContent = `غير مصرح لك بالدخول. محاولات متبقية: ${remaining}`;
      return;
    }

    // Reset rate limiting on successful login
    rateLimiter.attempts.delete(rateLimitKey);
    
    // Create secure session
    const sessionId = sessionManager.createSession(userCred.user.uid, { 
      role: 'admin', 
      loginTime: new Date().toISOString() 
    });
    
    sessionStorage.setItem('adminLoggedIn', 'true');
    sessionStorage.setItem('adminSessionId', sessionId);
    
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('dashboard').classList.add('active');

     await loadAllData();
     await flushPendingProductOps();
     initDashboard();
     await loadOrdersPage({ reset: true, showToast: false }).catch(() => null);
     await loadCustomersPage({ reset: true, showToast: false }).catch(() => null);
     
     showNotification('success', 'تم تسجيل الدخول بنجاح');

  }catch(err){
    console.error('Login error:', err);
    rateLimiter.recordAttempt(rateLimitKey);
    const remaining = rateLimiter.getRemainingAttempts(rateLimitKey);
    loginError.style.display='block';
    loginError.textContent = `بيانات الدخول غير صحيحة. محاولات متبقية: ${remaining}`;
  }
}

async function sendVerificationLink() {
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value;
  const loginError = document.getElementById('loginError');

  if (!email || !pass) {
    loginError.style.display = 'block';
    loginError.textContent = 'أدخل البريد الإلكتروني وكلمة المرور لإرسال رابط التحقق';
    return;
  }

  try {
    const userCred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCred.user;
    if (user.emailVerified) {
      showNotification('info', 'الحساب موثّق', 'لا حاجة لإرسال رابط تحقق');
    } else {
      await user.sendEmailVerification();
      showNotification('success', 'تم الإرسال', 'تم إرسال رابط التحقق إلى بريدك');
    }
    await firebase.auth().signOut();
  } catch (err) {
    console.error(err);
    loginError.style.display = 'block';
    loginError.textContent = 'فشل إرسال رابط التحقق. تأكد من البيانات.';
  }
}

async function sendPasswordReset() {
  const email = document.getElementById('adminEmail').value.trim();
  const loginError = document.getElementById('loginError');

  if (!email) {
    loginError.style.display = 'block';
    loginError.textContent = 'أدخل البريد الإلكتروني أولاً';
    return;
  }

  try {
    await firebase.auth().sendPasswordResetEmail(email);
    showNotification('success', 'تم الإرسال', 'تم إرسال رابط استعادة كلمة المرور إلى بريدك');
  } catch (err) {
    console.error(err);
    loginError.style.display = 'block';
    loginError.textContent = 'فشل إرسال رابط الاستعادة. تأكد من البريد.';
  }
}

       function checkAdminSession() {
  if (typeof firebase !== 'undefined' && firebase.auth) {
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        stopCustomersRealtimeSync();
        stopStoreOperationsMonitoring();
        sessionStorage.removeItem('adminLoggedIn');
        sessionStorage.removeItem('adminSessionId');
        sessionStorage.removeItem('adminSession');
        stopSupportChatRealtime();
        document.getElementById('dashboard').classList.remove('active');
        document.getElementById('loginScreen').style.display = 'flex';
        return;
      }

       const token = await user.getIdTokenResult();
      const isClaimAdmin = hasAdminClaimFromTokenResult(token);
      if (!user.emailVerified) {
        await firebase.auth().signOut();
        return;
      }
      if (isClaimAdmin) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        if (!products.length) {
          loadAllData().then(async () => {
            await flushPendingProductOps();
             initDashboard();
             await loadOrdersPage({ reset: true, showToast: false }).catch(() => null);
             autoPurgeSamplesOnce();
             await loadCustomersPage({ reset: true, showToast: false }).catch(() => null);
           });
         }
      } else {
        await firebase.auth().signOut();
      }
    });
    return;
  }

  // Fallback: no Firebase
  stopStoreOperationsMonitoring();
  document.getElementById('dashboard').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'flex';
}

function adminLogout(){
  stopCustomersRealtimeSync();
  stopStoreOperationsMonitoring();
  stopSupportChatRealtime();
  const sessionId = sessionStorage.getItem('adminSessionId');
  if (sessionId) {
    sessionManager.destroySession(sessionId);
  }
  
  sessionStorage.removeItem('adminLoggedIn');
  sessionStorage.removeItem('adminSessionId');
  sessionStorage.removeItem('adminSession');
  
  // Clear Firebase auth if used
  if (typeof firebase !== 'undefined' && firebase.auth()) {
    firebase.auth().signOut();
  }
  
  showNotification('info', 'تم تسجيل الخروج بنجاح');
  location.reload();
}

        // ============================================
        // Dashboard
        // ============================================
        function initDashboard() {
            updateStats();
            updateBadges();
            renderAdminSupplierFilterOptions();
            renderProductsTable();
            renderSuppliersTable();
            renderSupplierOptions();
            renderOrdersTable();
            renderBannersTable();
            renderCouponsTable();
            renderUsersTable();
            renderRecentOrders();
            renderLoyaltySection();
            renderClientErrorLogsTable();
            renderStoreEventsTable();
            renderLiveSessionsTable();
            updateStoreOpsAccessUi();
            renderSupportThreads();
            renderSupportMessages();
            loadSettingsToForms();
            initCharts();
            startStoreOperationsMonitoring().catch((error) => {
                logWarnOnce(
                    'startStoreOperationsMonitoring.init.warning',
                    'store operations init warning:',
                    String(error && error.message ? error.message : error)
                );
            });
            startSupportChatRealtime();
        }

        function updateStats() {
            document.getElementById('statProducts').textContent = products.length;
            document.getElementById('statOrders').textContent = orders.length;
            document.getElementById('statUsers').textContent = users.length;
            document.getElementById('statRevenue').textContent = orders.reduce((s, o) => s + (o.total || 0), 0).toLocaleString();
            document.getElementById('statLoyalty').textContent = users.reduce((s, u) => s + (u.loyaltyPoints || 0), 0);
        }

        function updateBadges() {
            document.getElementById('productsCount').textContent = products.length;
            const suppliersBadge = document.getElementById('suppliersCount');
            if (suppliersBadge) suppliersBadge.textContent = (suppliers || []).filter((s) => s && s.active !== false).length;
            document.getElementById('ordersCount').textContent = orders.filter(o => o.status === 'pending').length;
            const supportBadge = document.getElementById('supportUnreadCount');
            if (supportBadge) {
                const unread = (supportThreads || []).reduce((sum, thread) => sum + Math.max(0, Number(thread && thread.unreadForAdmin || 0)), 0);
                supportBadge.textContent = String(unread);
            }
        }

        // ============================================
        // Products
        // ============================================
        function sanitizeImageUrl(url) {
            const placeholder = './assets/placeholder.svg';
            if (!url || typeof url !== 'string') return placeholder;

            const trimmed = url.trim();
            if (trimmed.startsWith('data:')) return trimmed;
            if (trimmed.startsWith('./') || trimmed.startsWith('assets/')) return trimmed;

            try {
                const parsed = new URL(trimmed, window.location.origin);
                if (parsed.origin === window.location.origin) {
                    return parsed.pathname + parsed.search + parsed.hash;
                }
            } catch (e) {
                return placeholder;
            }

            return placeholder;
        }

        function renderProductsTable() {
            const searchText = String(document.getElementById('adminProductSearch')?.value || '').trim().toLowerCase();
            const supplierFilter = String(document.getElementById('adminProductSupplierFilter')?.value || '').trim();
            const statusFilter = String(document.getElementById('adminProductStatusFilter')?.value || 'all');
            const tbody = document.getElementById('productsTable');
            const visibleRows = (products || []).filter((item) => {
                if (!item) return false;
                if (supplierFilter && String(item.supplierId || '') !== supplierFilter) return false;
                if (statusFilter === 'published' && item.isPublished === false) return false;
                if (statusFilter === 'hidden' && item.isPublished !== false) return false;
                if (!searchText) return true;
                const haystack = [
                    String(item.name || ''),
                    String(item.code || ''),
                    String(item.desc || ''),
                    String(item.supplierName || '')
                ].join(' ').toLowerCase();
                return haystack.includes(searchText);
            });

            if (visibleRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">📦</div><p>لا توجد منتجات</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = visibleRows.map((p) => {
                const safeProductId = escapeHtml(String(p && p.id || ''));
                const safeImageSrc = escapeHtml(sanitizeImageUrl(p && p.image));
                const safeFallbackImage = escapeHtml(sanitizeImageUrl(''));
                const safeName = escapeHtml(p && p.name || '-');
                const safeCategory = escapeHtml(getCategoryName(p && p.category) || '-');
                const safeSupplier = escapeHtml(p && p.supplierName || '-');
                const safeCost = escapeHtml(Number(p && p.costPrice || 0).toFixed(2));
                const safePrice = escapeHtml(Number(p && p.price || 0).toFixed(2));
                const safeProfit = escapeHtml(Number(p && p.profitValue || 0).toFixed(2));
                const safeProfitMargin = escapeHtml(Number(p && p.profitMarginActual || 0).toFixed(2));
                const isHidden = p && p.isPublished === false;
                const safeImportBatchId = escapeHtml(p && p.importBatchId || '');
                return `
                <tr>
                    <td><div class="product-cell"><img src="${safeImageSrc}" class="product-img" onerror="this.src='${safeFallbackImage}'"><div><strong>${safeName}</strong></div></div></td>
                    <td>${safeCategory}</td>
                    <td>${safeSupplier}</td>
                    <td><strong>${safeCost} ج.م</strong></td>
                    <td><strong>${safePrice} ج.م</strong>${p && p.manualPriceOverride === true ? '<div style="font-size:11px;color:#b8960c;">يدوي</div>' : ''}</td>
                    <td><strong>${safeProfit} ج.م</strong><div style="font-size:11px;color:#666;">${safeProfitMargin}%</div></td>
                    <td><span class="status-badge ${isHidden ? 'status-hidden' : 'status-published'}">${isHidden ? 'مخفي' : 'منشور'}</span></td>
                    <td>${safeImportBatchId ? `<span class="batch-chip" title="${safeImportBatchId}">${safeImportBatchId}</span>` : '-'}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn edit" data-product-id="${safeProductId}" onclick="editProduct(this.dataset.productId)">✏️</button>
                            ${isHidden
                                ? `<button class="action-btn publish" title="نشر" data-product-id="${safeProductId}" onclick="toggleProductPublish(this.dataset.productId, true)">👁️</button>`
                                : `<button class="action-btn hide" title="إخفاء" data-product-id="${safeProductId}" onclick="toggleProductPublish(this.dataset.productId, false)">🙈</button>`}
                            <button class="action-btn delete" data-product-id="${safeProductId}" onclick="deleteProduct(this.dataset.productId)">🗑️</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function renderAdminSupplierFilterOptions() {
            const select = document.getElementById('adminProductSupplierFilter');
            if (!select) return;
            const currentValue = String(select.value || '');
            const options = (suppliers || []).filter((item) => item && item.active !== false);
            select.innerHTML = '<option value="">كل الموردين</option>' + options.map((item) => (
                `<option value="${escapeHtml(String(item.id || ''))}">${escapeHtml(item.name || '')}</option>`
            )).join('');
            if (currentValue) select.value = currentValue;
        }

        function saveProductFilterView() {
            const viewName = prompt('اسم العرض المحفوظ');
            if (!viewName) return;
            const payload = {
                search: String(document.getElementById('adminProductSearch')?.value || ''),
                supplierId: String(document.getElementById('adminProductSupplierFilter')?.value || ''),
                status: String(document.getElementById('adminProductStatusFilter')?.value || 'all')
            };
            const allViews = getStorageData(PRODUCT_SAVED_FILTERS_KEY) || {};
            allViews[viewName] = payload;
            setStorageData(PRODUCT_SAVED_FILTERS_KEY, allViews);
            showNotification('success', `تم حفظ العرض: ${viewName}`);
        }

        function loadProductFilterView() {
            const allViews = getStorageData(PRODUCT_SAVED_FILTERS_KEY) || {};
            const names = Object.keys(allViews);
            if (!names.length) {
                showNotification('error', 'لا توجد عروض محفوظة');
                return;
            }
            const chosen = prompt(`اختر العرض:\n${names.join('\n')}`, names[0]);
            if (!chosen || !allViews[chosen]) return;
            const view = allViews[chosen];
            const searchInput = document.getElementById('adminProductSearch');
            const supplierInput = document.getElementById('adminProductSupplierFilter');
            const statusInput = document.getElementById('adminProductStatusFilter');
            if (searchInput) searchInput.value = String(view.search || '');
            if (supplierInput) supplierInput.value = String(view.supplierId || '');
            if (statusInput) statusInput.value = String(view.status || 'all');
            renderProductsTable();
            showNotification('success', `تم تحميل العرض: ${chosen}`);
        }

        // ============================================
        // Bulk sanitize external images (professional fix)
        // ============================================
        function isExternalImageUrl(url) {
            if (!url || typeof url !== 'string') return false;
            const trimmed = url.trim();
            if (trimmed.startsWith('data:')) return false;
            if (trimmed.startsWith('./') || trimmed.startsWith('assets/')) return false;
            try {
                const parsed = new URL(trimmed, window.location.origin);
                return parsed.origin !== window.location.origin;
            } catch (e) {
                return false;
            }
        }

        async function sanitizeAllImages() {
            if (!confirm('هل تريد استبدال كل الصور الخارجية ببدائل محلية؟')) return;

            const productPlaceholder = './assets/placeholder.svg';
            const bannerPlaceholder = './assets/banner-placeholder.svg';

            let productsUpdated = 0;
            let bannersUpdated = 0;

            // Update products
            products = products.map(p => {
                if (isExternalImageUrl(p.image)) {
                    productsUpdated += 1;
                    return { ...p, image: productPlaceholder };
                }
                return p;
            });

            // Update banners (if banners are used in admin data)
            if (Array.isArray(banners)) {
                banners = banners.map(b => {
                    if (isExternalImageUrl(b.image)) {
                        bannersUpdated += 1;
                        return { ...b, image: bannerPlaceholder };
                    }
                    return b;
                });
            }

            // Persist locally
            if (typeof saveProducts === 'function') saveProducts();
            if (typeof saveBanners === 'function') saveBanners();

            // Update Firebase if available
            try {
                if (typeof updateProduct === 'function') {
                    for (const p of products) {
                        if (p.id && p.image === productPlaceholder) {
                            await updateProduct(p.id, { image: p.image });
                        }
                    }
                }
                if (typeof updateBanner === 'function') {
                    for (const b of banners) {
                        if (b.id && b.image === bannerPlaceholder) {
                            await updateBanner(b.id, { image: b.image });
                        }
                    }
                }
            } catch (e) {
                console.warn('Firebase update skipped or failed:', e);
            }

            renderProductsTable();
            renderBannersTable();
            showNotification('success', 'تم تنظيف الصور', `تم تحديث ${productsUpdated} منتج و ${bannersUpdated} بانر`);
        }

        function getDefaultCategoryDefinitions() {
            return [
                { id: 'hair-care', name: 'شعر', icon: '💇‍♀️' },
                { id: 'skin-care', name: 'بشرة', icon: '🧴' },
                { id: 'baby-care', name: 'طفل', icon: '👶' },
                { id: 'supplements', name: 'مكملات', icon: '💊' },
                { id: 'medical', name: 'طبي', icon: '🏥' }
            ];
        }

        function sanitizeCategoryId(value) {
            const raw = String(value || '').trim().toLowerCase();
            if (!raw) return '';
            return raw.replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
        }

        function getAllCategoryDefinitions() {
            const map = new Map();
            getDefaultCategoryDefinitions().forEach((item) => map.set(item.id, item));
            const custom = Array.isArray(storeSettings?.customCategories) ? storeSettings.customCategories : [];
            custom.forEach((item) => {
                const id = sanitizeCategoryId(item && item.id);
                const name = String((item && item.name) || id || '').trim();
                if (!id || !name) return;
                map.set(id, { id, name, icon: String((item && item.icon) || '🏷️') });
            });
            return Array.from(map.values());
        }

        function renderProductCategoryOptions(selectedValue = '') {
            const select = document.getElementById('productCategory');
            if (!select) return;
            const categories = getAllCategoryDefinitions();
            const current = String(selectedValue || select.value || '');
            select.innerHTML = '<option value="">اختر</option>' + categories.map((item) => (
                `<option value="${escapeHtml(String(item.id || ''))}">${escapeHtml(item.icon || '')} ${escapeHtml(item.name || '')}</option>`
            )).join('');
            if (current && categories.some((item) => item.id === current)) {
                select.value = current;
            } else {
                select.value = '';
            }
        }

        function openAddCategoryPrompt() {
            const rawName = prompt('اسم القسم الجديد');
            if (!rawName) return;
            const name = String(rawName).trim();
            if (!name) return;

            const suggestedId = sanitizeCategoryId(name);
            const rawId = prompt('كود القسم (English/slug)', suggestedId || 'new-category');
            const id = sanitizeCategoryId(rawId);
            if (!id) {
                showNotification('error', 'كود القسم غير صالح');
                return;
            }

            const definitions = getAllCategoryDefinitions();
            if (definitions.some((item) => item.id === id)) {
                showNotification('error', 'القسم موجود بالفعل');
                return;
            }

            const rawIcon = prompt('أيقونة القسم (اختياري)', '🏷️');
            const icon = String(rawIcon || '🏷️').trim() || '🏷️';
            const nextCustom = Array.isArray(storeSettings.customCategories) ? [...storeSettings.customCategories] : [];
            nextCustom.push({ id, name, icon });
            storeSettings.customCategories = nextCustom;
            saveStoreSettings();
            renderProductCategoryOptions(id);
            renderProductsTable();
            showNotification('success', `تمت إضافة القسم: ${name}`);
        }

        function getCategoryName(cat) {
            const lookup = new Map(getAllCategoryDefinitions().map((item) => [item.id, item.name]));
            return lookup.get(String(cat || '')) || cat;
        }

        function getSupplierById(id) {
            const supplierId = String(id || '').trim();
            if (!supplierId) return null;
            return (suppliers || []).find((item) => String(item.id || '') === supplierId) || null;
        }

        function renderSupplierOptions() {
            const select = document.getElementById('productSupplierId');
            if (!select) return;
            const activeSuppliers = (suppliers || []).filter((item) => item && item.active !== false);
            const currentValue = String(select.value || '');
            select.innerHTML = '<option value="">بدون مورد</option>' + activeSuppliers.map((item) => (
                `<option value="${escapeHtml(String(item.id || ''))}">${escapeHtml(item.name || 'مورد بدون اسم')}</option>`
            )).join('');
            if (currentValue) select.value = currentValue;
        }

        function recalculateProductPricingFromForm() {
            const manualOverride = document.getElementById('productManualPriceOverride')?.checked === true;
            const cost = Number(parseMoney(document.getElementById('productCostPrice')?.value));
            const margin = Number(parseMoney(document.getElementById('productMarginPercent')?.value));

            if (!Number.isFinite(cost) || cost < 0) return;
            if (!Number.isFinite(margin) || margin < 0) return;

            const autoSellPrice = Number((cost * (1 + (Math.min(margin, 1000) / 100))).toFixed(2));
            const sellInput = document.getElementById('productPrice');
            if (!manualOverride && sellInput) {
                sellInput.value = String(autoSellPrice);
            }

            const finalSellPrice = Number(parseMoney(sellInput?.value));
            if (!Number.isFinite(finalSellPrice)) return;

            const profit = Number((finalSellPrice - cost).toFixed(2));
            const profitMargin = finalSellPrice > 0 ? Number(((profit / finalSellPrice) * 100).toFixed(2)) : 0;

            const profitInput = document.getElementById('productProfitValue');
            const marginActualInput = document.getElementById('productProfitMarginActual');
            if (profitInput) profitInput.value = String(profit);
            if (marginActualInput) marginActualInput.value = String(profitMargin);
        }

        function markManualSellPriceOverride() {
            const checkbox = document.getElementById('productManualPriceOverride');
            if (checkbox && checkbox.checked) {
                recalculateProductPricingFromForm();
            }
        }

        function handleProductSupplierChange() {
            const supplierId = document.getElementById('productSupplierId')?.value || '';
            const supplier = getSupplierById(supplierId);
            const marginInput = document.getElementById('productMarginPercent');
            const manualOverride = document.getElementById('productManualPriceOverride');
            if (supplier && marginInput && manualOverride && manualOverride.checked !== true) {
                marginInput.value = Number(supplier.defaultMarginPercent || 0).toString();
                recalculateProductPricingFromForm();
            }
        }

        function buildProductPayloadFromForm() {
            const imageFromUpload = document.getElementById('finalImg').value;
            const imageFromManual = document.getElementById('manualImg').value;
            const selectedCategory = document.getElementById('productCategory').value;
            const productIsPublished = document.getElementById('productIsPublished').checked;
            const supplierId = String(document.getElementById('productSupplierId')?.value || '').trim();
            const supplier = getSupplierById(supplierId);
            const rawCostPrice = parseMoney(document.getElementById('productCostPrice').value);
            const rawMarginPercent = parseMoney(document.getElementById('productMarginPercent').value);
            const rawPrice = parseMoney(document.getElementById('productPrice').value);
            const rawOldPrice = parseMoney(document.getElementById('productOldPrice').value);
            const manualPriceOverride = document.getElementById('productManualPriceOverride')?.checked === true;
            const manualPriceReason = String(document.getElementById('productManualPriceReason')?.value || '').trim();

            if (!Number.isFinite(rawCostPrice) || rawCostPrice < 0) {
                throw new Error('invalid-cost');
            }

            if (!Number.isFinite(rawMarginPercent) || rawMarginPercent < 0) {
                throw new Error('invalid-margin');
            }

            if (!Number.isFinite(rawPrice) || rawPrice < 0) {
                throw new Error('invalid-price');
            }

            const payload = normalizeProductForStorage({
                name: document.getElementById('productName').value.trim(),
                desc: document.getElementById('productDesc').value.trim(),
                category: selectedCategory,
                supplierId,
                supplierName: supplier ? String(supplier.name || '') : '',
                supplierCode: supplier ? String(supplier.code || '') : '',
                price: rawPrice,
                sellPrice: rawPrice,
                costPrice: rawCostPrice,
                marginPercent: rawMarginPercent,
                manualPriceOverride,
                manualPriceReason,
                oldPrice: Number.isFinite(rawOldPrice) && rawOldPrice > 0 ? rawOldPrice : null,
                image: imageFromUpload || imageFromManual || DEFAULT_PRODUCT_IMAGE,
                rating: 4.5,
                ratingCount: 0,
                code: String(document.getElementById('productCode')?.value || '').trim(),
                isPublished: productIsPublished
            }, {
                isPublished: productIsPublished,
                category: selectedCategory
            });

            if (!payload.name) {
                throw new Error('missing-name');
            }

            return payload;
        }

        function applyLocalProductUpdate(id, patch) {
            const idx = products.findIndex((p) => String(p.id) === String(id));
            if (idx === -1) return null;
            const current = products[idx];
            const merged = normalizeProductForStorage({ ...current, ...patch, id: current.id }, {
                isPublished: current.isPublished !== false,
                category: current.category
            });
            merged.createdAt = current.createdAt || merged.createdAt;
            products[idx] = merged;
            return merged;
        }

        function applyLocalProductVisibility(id, isPublished) {
            const idx = products.findIndex((p) => String(p.id) === String(id));
            if (idx === -1) return null;
            const current = products[idx];
            const next = normalizeProductForStorage({
                ...current,
                isPublished: isPublished !== false,
                visibilityState: isPublished !== false ? 'published' : 'hidden'
            }, {
                isPublished: isPublished !== false,
                category: current.category
            });
            next.createdAt = current.createdAt || next.createdAt;
            products[idx] = next;
            return next;
        }

        function removeQueuedOpsForProduct(id) {
            const strId = String(id || '');
            if (!strId) return;
            pendingProductOps = pendingProductOps.filter((op) => {
                const payload = op && op.payload ? op.payload : {};
                const payloadId = String(payload.id || payload.tmpId || '');
                return payloadId !== strId;
            });
            persistPendingProductOps();
        }

        async function toggleProductPublish(id, isPublished) {
            const productId = String(id || '').trim();
            if (!productId) return;
            const target = products.find((p) => String(p.id) === productId);
            if (!target) return;

            const publishValue = isPublished !== false;
            const online = navigator.onLine === true;

            if (online && !productId.startsWith('tmp_')) {
                try {
                    await requireAdminPermission();
                    if (typeof updateProductVisibility === 'function') {
                        await updateProductVisibility(productId, publishValue);
                    } else if (typeof updateProduct === 'function') {
                        await updateProduct(productId, {
                            isPublished: publishValue,
                            visibilityState: publishValue ? 'published' : 'hidden'
                        });
                    } else {
                        throw new Error('updateProductVisibility-unavailable');
                    }
                } catch (error) {
                    console.error('toggleProductPublish error:', error);
                    showNotification('error', 'فشل تحديث حالة النشر');
                    return;
                }
            } else if (productId.startsWith('tmp_')) {
                patchPendingAddByTempId(productId, (productDraft) => ({
                    ...productDraft,
                    isPublished: publishValue,
                    visibilityState: publishValue ? 'published' : 'hidden'
                }));
                if (online) await flushPendingProductOps();
            } else {
                enqueuePendingProductOp('visibility', { id: productId, isPublished: publishValue });
                showNotification('info', 'تم حفظ الحالة محليًا وسيتم الرفع عند عودة الاتصال');
            }

            applyLocalProductVisibility(productId, publishValue);
            saveProducts();
            renderProductsTable();
            updateStats();
            if (online) {
                showNotification('success', publishValue ? 'تم نشر المنتج' : 'تم إخفاء المنتج');
            }
        }

        async function updateBatchVisibility(batchId, isPublished) {
            const normalizedBatchId = String(batchId || '').trim();
            if (!normalizedBatchId) {
                showNotification('error', 'دفعة غير صالحة');
                return;
            }

            const targetProducts = products.filter((p) => String(p.importBatchId || '') === normalizedBatchId);
            if (!targetProducts.length) {
                showNotification('error', 'لا توجد منتجات لهذه الدفعة');
                return;
            }

            const publishValue = isPublished !== false;
            const online = navigator.onLine === true;

            if (online) {
                const realIds = targetProducts.map((p) => String(p.id)).filter((id) => id && !id.startsWith('tmp_'));
                try {
                    await requireAdminPermission();
                    if (realIds.length) {
                        if (typeof updateProductsVisibilityBatch === 'function') {
                            await updateProductsVisibilityBatch(realIds, publishValue);
                        } else if (typeof updateProductVisibility === 'function') {
                            for (const id of realIds) {
                                await updateProductVisibility(id, publishValue);
                            }
                        } else if (typeof updateProduct === 'function') {
                            for (const id of realIds) {
                                await updateProduct(id, {
                                    isPublished: publishValue,
                                    visibilityState: publishValue ? 'published' : 'hidden'
                                });
                            }
                        } else {
                            throw new Error('visibility-api-unavailable');
                        }
                    }
                } catch (error) {
                    console.error('updateBatchVisibility error:', error);
                    showNotification('error', 'فشل تحديث حالة الدفعة');
                    return;
                }
            }

            for (const product of targetProducts) {
                const productId = String(product.id);
                if (productId.startsWith('tmp_')) {
                    patchPendingAddByTempId(productId, (productDraft) => ({
                        ...productDraft,
                        isPublished: publishValue,
                        visibilityState: publishValue ? 'published' : 'hidden'
                    }));
                } else if (!online) {
                    enqueuePendingProductOp('visibility', { id: productId, isPublished: publishValue });
                }
                applyLocalProductVisibility(productId, publishValue);
            }

            saveProducts();
            renderProductsTable();
            updateStats();
            if (online) await flushPendingProductOps();
            showNotification('success', `تم ${publishValue ? 'نشر' : 'إخفاء'} ${targetProducts.length} منتج من الدفعة`);
        }

        async function publishBatchPrompt() {
            const batchIds = Array.from(new Set(products.map((p) => String(p.importBatchId || '').trim()).filter(Boolean)));
            if (!batchIds.length) {
                showNotification('error', 'لا توجد دفعات استيراد');
                return;
            }

            const defaultBatch = batchIds[batchIds.length - 1];
            const input = prompt(`اكتب رقم الدفعة (importBatchId)\nأحدث دفعة: ${defaultBatch}`, defaultBatch);
            if (!input) return;

            const isPublishAction = confirm('موافق = نشر الدفعة\nإلغاء = إخفاء الدفعة');
            await updateBatchVisibility(input, isPublishAction);
        }

        async function setAllProductsVisibility(isPublished) {
            const targetProducts = Array.isArray(products) ? products : [];
            if (!targetProducts.length) {
                showNotification('error', 'لا توجد منتجات');
                return;
            }

            const publishValue = isPublished !== false;
            const verb = publishValue ? 'نشر' : 'إخفاء';
            const input = prompt(`سيتم ${verb} ${targetProducts.length} منتج.\nاكتب "${verb}" للتأكيد`, '');
            if (String(input || '').trim() !== verb) return;

            const online = navigator.onLine === true;
            const realIds = targetProducts.map((p) => String(p.id || '')).filter((id) => id && !id.startsWith('tmp_'));

            if (online && realIds.length) {
                try {
                    await requireAdminPermission();
                    if (typeof updateProductsVisibilityBatch === 'function') {
                        await updateProductsVisibilityBatch(realIds, publishValue, { chunkSize: 300 });
                    } else {
                        for (const id of realIds) {
                            await updateProductVisibility(id, publishValue);
                        }
                    }
                } catch (error) {
                    console.error('setAllProductsVisibility error:', error);
                    showNotification('error', `فشل ${verb} جميع المنتجات`);
                    return;
                }
            }

            targetProducts.forEach((product) => {
                const productId = String(product.id || '');
                if (!productId) return;
                if (productId.startsWith('tmp_')) {
                    patchPendingAddByTempId(productId, (productDraft) => ({
                        ...productDraft,
                        isPublished: publishValue,
                        visibilityState: publishValue ? 'published' : 'hidden'
                    }));
                } else if (!online) {
                    enqueuePendingProductOp('visibility', { id: productId, isPublished: publishValue });
                }
                applyLocalProductVisibility(productId, publishValue);
            });

            saveProducts();
            renderProductsTable();
            updateStats();
            updateBadges();
            showNotification('success', `تم ${verb} ${targetProducts.length} منتج`);
        }

        async function deleteAllProducts() {
            const targetProducts = Array.isArray(products) ? products : [];
            if (!targetProducts.length) {
                showNotification('error', 'لا توجد منتجات للحذف');
                return;
            }

            const input = prompt(`تحذير: سيتم حذف ${targetProducts.length} منتج نهائياً.\nاكتب DELETE للتأكيد`, '');
            if (String(input || '').trim().toUpperCase() !== 'DELETE') return;

            const online = navigator.onLine === true;
            const realIds = targetProducts.map((p) => String(p.id || '')).filter((id) => id && !id.startsWith('tmp_'));

            if (online && realIds.length) {
                try {
                    await requireAdminPermission();
                    if (typeof deleteProductsBatch === 'function') {
                        await deleteProductsBatch(realIds, { chunkSize: 250 });
                    } else {
                        for (const id of realIds) {
                            await deleteProductFromFirebase(id);
                        }
                    }
                } catch (error) {
                    console.error('deleteAllProducts error:', error);
                    showNotification('error', 'فشل حذف جميع المنتجات من Firebase');
                    return;
                }
            } else if (!online) {
                targetProducts.forEach((item) => {
                    const productId = String(item.id || '');
                    if (!productId || productId.startsWith('tmp_')) return;
                    enqueuePendingProductOp('delete', { id: productId });
                });
                showNotification('info', 'تم الحذف محليًا وسيتم المزامنة عند عودة الاتصال');
            }

            products = [];
            saveProducts();
            renderProductsTable();
            updateStats();
            updateBadges();
            showNotification('success', 'تم مسح كل المنتجات');
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value.trim();
            let payload;
            try {
                payload = buildProductPayloadFromForm();
            } catch (error) {
                if (error && error.message === 'invalid-cost') {
                    showNotification('error', 'التكلفة غير صالحة');
                    return;
                }
                if (error && error.message === 'invalid-margin') {
                    showNotification('error', 'نسبة الهامش غير صالحة');
                    return;
                }
                if (error && error.message === 'invalid-price') {
                    showNotification('error', 'السعر غير صالح');
                    return;
                }
                if (error && error.message === 'missing-name') {
                    showNotification('error', 'اسم المنتج مطلوب');
                    return;
                }
                showNotification('error', 'تعذر قراءة بيانات المنتج');
                return;
            }

            const online = navigator.onLine === true;

            if (id) {
                const idx = products.findIndex((p) => String(p.id) === String(id));
                if (idx === -1) {
                    showNotification('error', 'المنتج غير موجود');
                    return;
                }

                const current = products[idx];
                const merged = normalizeProductForStorage({
                    ...current,
                    ...payload,
                    id: current.id
                }, {
                    isPublished: payload.isPublished !== false,
                    category: payload.category
                });
                merged.createdAt = current.createdAt || merged.createdAt;
                const updatePayload = { ...merged };
                delete updatePayload.id;

                if (online && !String(id).startsWith('tmp_')) {
                    try {
                        await requireAdminPermission();
                        if (typeof updateProduct !== 'function') {
                            throw new Error('updateProduct unavailable');
                        }
                        await updateProduct(id, updatePayload);
                    } catch (error) {
                        console.error('Firebase update error:', error);
                        showNotification('error', 'فشل تحديث المنتج على Firebase');
                        return;
                    }
                } else if (String(id).startsWith('tmp_')) {
                    patchPendingAddByTempId(String(id), (draft) => ({ ...draft, ...updatePayload }));
                    if (online) await flushPendingProductOps();
                    else showNotification('info', 'تم حفظ التعديل محليًا وسيتم الرفع عند عودة الاتصال');
                } else {
                    enqueuePendingProductOp('update', { id, data: updatePayload });
                    showNotification('info', 'تم حفظ التعديل محليًا وسيتم الرفع عند عودة الاتصال');
                }

                products[idx] = merged;
                showNotification('success', 'تم تحديث المنتج');
            } else {
                const nowIso = new Date().toISOString();
                const newProduct = normalizeProductForStorage({
                    ...payload,
                    createdAt: nowIso,
                    updatedAt: nowIso
                }, {
                    isPublished: payload.isPublished !== false,
                    category: payload.category
                });

                const createPayload = { ...newProduct };
                delete createPayload.id;

                if (online) {
                    try {
                        await requireAdminPermission();
                        if (typeof addProduct !== 'function') {
                            throw new Error('addProduct unavailable');
                        }
                        const firebaseId = await addProduct(createPayload);
                        newProduct.id = String(firebaseId);
                    } catch (error) {
                        console.error('Firebase create error:', error);
                        showNotification('error', 'فشل إضافة المنتج على Firebase');
                        return;
                    }
                } else {
                    const tempId = `tmp_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
                    newProduct.id = tempId;
                    enqueuePendingProductOp('add', { tmpId: tempId, product: createPayload });
                    showNotification('info', 'تمت إضافة المنتج محليًا وسيتم رفعه عند عودة الاتصال');
                }

                products.push(newProduct);
                showNotification('success', 'تمت إضافة المنتج');
            }

            saveProducts();
            renderProductsTable();
            updateStats();
            closeModal('productModal');
            resetProductForm();
        }

        function editProduct(id) {
            const p = products.find((x) => String(x.id) === String(id));
            if (!p) return;

            document.getElementById('productId').value = p.id || '';
            document.getElementById('productName').value = p.name || '';
            document.getElementById('productDesc').value = p.desc || '';
            renderProductCategoryOptions(p.category || '');
            renderSupplierOptions();
            document.getElementById('productSupplierId').value = p.supplierId || '';
            document.getElementById('productCode').value = p.code || '';
            document.getElementById('productCostPrice').value = p.costPrice ?? p.price ?? '';
            document.getElementById('productMarginPercent').value = p.marginPercent ?? 0;
            document.getElementById('productPrice').value = p.price ?? '';
            document.getElementById('productOldPrice').value = p.oldPrice ?? '';
            document.getElementById('productManualPriceOverride').checked = p.manualPriceOverride === true;
            document.getElementById('productManualPriceReason').value = p.manualPriceReason || '';
            document.getElementById('productIsPublished').checked = p.isPublished !== false;
            recalculateProductPricingFromForm();

            const img = p.image || '';
            document.getElementById('finalImg').value = img;
            document.getElementById('manualImg').value = img;

            const preview = document.getElementById('imgPreview');
            if (preview) {
                const safeImg = img ? sanitizeImageUrl(img) : '';
                preview.innerHTML = safeImg
                    ? `<img src="${safeImg}" style="max-width:150px;border-radius:8px;border:2px solid #D4AF37;margin-top:10px;" onerror="this.style.display='none'">`
                    : '';
            }

            const fileInput = document.getElementById('imgFile');
            if (fileInput) fileInput.value = '';

            document.getElementById('productModalTitle').textContent = '✏️ تعديل';
            openModal('productModal');
        }

        async function deleteProduct(id) {
            if (!confirm('حذف المنتج؟')) return;
            const productId = String(id || '');
            const idx = products.findIndex((p) => String(p.id) === productId);
            if (idx === -1) return;

            const online = navigator.onLine === true;
            const isTemp = productId.startsWith('tmp_');

            if (online && !isTemp) {
                try {
                    await requireAdminPermission();
                    if (typeof deleteProductFromFirebase !== 'function') {
                        throw new Error('deleteProductFromFirebase unavailable');
                    }
                    await deleteProductFromFirebase(productId);
                } catch (error) {
                    console.error('Firebase delete error:', error);
                    showNotification('error', 'فشل الحذف من Firebase');
                    return;
                }
            } else if (isTemp) {
                removeQueuedOpsForProduct(productId);
            } else {
                removeQueuedOpsForProduct(productId);
                enqueuePendingProductOp('delete', { id: productId });
                showNotification('info', 'تم الحذف محليًا وسيتم مزامنته عند عودة الاتصال');
            }

            products.splice(idx, 1);
            saveProducts();
            renderProductsTable();
            updateStats();
            showNotification('success', 'تم الحذف ✅');
        }


        function resetProductForm() {
            const idsToClear = [
                'productId',
                'productName',
                'productDesc',
                'productCategory',
                'productSupplierId',
                'productCode',
                'productCostPrice',
                'productMarginPercent',
                'productPrice',
                'productOldPrice',
                'productProfitValue',
                'productProfitMarginActual',
                'productManualPriceReason',
                'manualImg',
                'finalImg',
                'imgFile'
            ];

            idsToClear.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.type === 'file') el.value = '';
                else el.value = '';
            });

            const preview = document.getElementById('imgPreview');
            if (preview) preview.innerHTML = '';

            const legacy = ['productImage', 'productImageUrl', 'imagePreviewContainer', 'uploadStatus'];
            legacy.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.tagName === 'DIV') el.innerHTML = '';
                else el.value = '';
            });

            const productIsPublished = document.getElementById('productIsPublished');
            if (productIsPublished) productIsPublished.checked = true;
            const productManualPriceOverride = document.getElementById('productManualPriceOverride');
            if (productManualPriceOverride) productManualPriceOverride.checked = false;

            const defaultCostInput = document.getElementById('productCostPrice');
            if (defaultCostInput && !defaultCostInput.value) defaultCostInput.value = '0';
            const defaultMarginInput = document.getElementById('productMarginPercent');
            if (defaultMarginInput && !defaultMarginInput.value) defaultMarginInput.value = '0';

            const title = document.getElementById('productModalTitle');
            if (title) title.textContent = '➕ منتج جديد';
            renderProductCategoryOptions('');
            renderSupplierOptions();
            recalculateProductPricingFromForm();
        }

        function renderSuppliersTable() {
            const tbody = document.getElementById('suppliersTable');
            if (!tbody) return;
            if (!Array.isArray(suppliers) || suppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">🏭</div><p>لا يوجد موردون</p></div></td></tr>';
                return;
            }

            const rows = [...suppliers].sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''), 'ar'));
            tbody.innerHTML = rows.map((supplier) => {
                const safeSupplierId = escapeHtml(String(supplier && supplier.id || ''));
                const safeName = escapeHtml(supplier && supplier.name || '-');
                const safeCode = escapeHtml(supplier && supplier.code || '-');
                const safeMargin = escapeHtml(Number(supplier && supplier.defaultMarginPercent || 0).toFixed(2));
                const safeContact = escapeHtml(supplier && (supplier.contactName || supplier.phone) || '-');
                const isArchived = supplier && supplier.active === false;
                return `
                <tr>
                    <td><strong>${safeName}</strong></td>
                    <td>${safeCode}</td>
                    <td>${safeMargin}%</td>
                    <td>${safeContact}</td>
                    <td><span class="status-badge ${isArchived ? 'status-hidden' : 'status-published'}">${isArchived ? 'مؤرشف' : 'نشط'}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn edit" data-supplier-id="${safeSupplierId}" onclick="editSupplier(this.dataset.supplierId)">✏️</button>
                            <button class="action-btn ${isArchived ? 'publish' : 'hide'}" data-supplier-id="${safeSupplierId}" onclick="toggleSupplierArchive(this.dataset.supplierId, ${isArchived ? 'true' : 'false'})">${isArchived ? '♻️' : '🗂️'}</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function openSupplierModal() {
            resetSupplierForm();
            openModal('supplierModal');
        }

        function resetSupplierForm() {
            const ids = ['supplierId', 'supplierName', 'supplierCode', 'supplierContactName', 'supplierPhone', 'supplierDefaultMargin', 'supplierNotes'];
            ids.forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const activeInput = document.getElementById('supplierActive');
            if (activeInput) activeInput.checked = true;
            const title = document.getElementById('supplierModalTitle');
            if (title) title.textContent = '🏭 مورد جديد';
        }

        function editSupplier(id) {
            const supplier = (suppliers || []).find((item) => String(item.id) === String(id));
            if (!supplier) return;
            document.getElementById('supplierId').value = supplier.id || '';
            document.getElementById('supplierName').value = supplier.name || '';
            document.getElementById('supplierCode').value = supplier.code || '';
            document.getElementById('supplierContactName').value = supplier.contactName || '';
            document.getElementById('supplierPhone').value = supplier.phone || '';
            document.getElementById('supplierDefaultMargin').value = supplier.defaultMarginPercent ?? 0;
            document.getElementById('supplierNotes').value = supplier.notes || '';
            document.getElementById('supplierActive').checked = supplier.active !== false;
            const title = document.getElementById('supplierModalTitle');
            if (title) title.textContent = '✏️ تعديل المورد';
            openModal('supplierModal');
        }

        async function saveSupplier(event) {
            event.preventDefault();
            const id = String(document.getElementById('supplierId').value || '').trim();
            const payload = {
                name: String(document.getElementById('supplierName').value || '').trim(),
                code: String(document.getElementById('supplierCode').value || '').trim().toUpperCase(),
                contactName: String(document.getElementById('supplierContactName').value || '').trim(),
                phone: String(document.getElementById('supplierPhone').value || '').trim(),
                defaultMarginPercent: Number(parseMoney(document.getElementById('supplierDefaultMargin').value) || 0),
                notes: String(document.getElementById('supplierNotes').value || '').trim(),
                active: document.getElementById('supplierActive').checked
            };

            if (!payload.name || !payload.code) {
                showNotification('error', 'اسم المورد والكود مطلوبان');
                return;
            }

            const duplicate = (suppliers || []).find((item) =>
                String(item.code || '').toUpperCase() === payload.code
                && String(item.id || '') !== id
            );
            if (duplicate) {
                showNotification('error', 'كود المورد مستخدم بالفعل');
                return;
            }

            const online = navigator.onLine === true;
            try {
                if (online) {
                    await requireAdminPermission();
                    if (id) {
                        if (typeof updateSupplier !== 'function') throw new Error('updateSupplier unavailable');
                        await updateSupplier(id, payload);
                    } else {
                        if (typeof addSupplier !== 'function') throw new Error('addSupplier unavailable');
                        payload.id = await addSupplier(payload);
                    }
                } else if (!id) {
                    payload.id = `supplier_tmp_${Date.now()}`;
                    showNotification('info', 'المورد أُضيف محليًا، وسيتم رفعه عند عودة الاتصال');
                } else {
                    showNotification('info', 'تم تحديث المورد محليًا، ارفع التغييرات عند عودة الاتصال');
                }
            } catch (error) {
                console.error('saveSupplier error:', error);
                showNotification('error', 'فشل حفظ المورد');
                return;
            }

            if (id) {
                suppliers = (suppliers || []).map((item) => (
                    String(item.id) === id
                        ? { ...item, ...payload, id }
                        : item
                ));
            } else {
                suppliers = [...(suppliers || []), {
                    id: payload.id || `supplier_${Date.now()}`,
                    createdAt: new Date().toISOString(),
                    ...payload
                }];
            }

            suppliers = ensureSuppliersSchema(suppliers);
            saveSuppliers();
            renderSuppliersTable();
            renderSupplierOptions();
            renderAdminSupplierFilterOptions();
            updateBadges();
            closeModal('supplierModal');
            resetSupplierForm();
            showNotification('success', id ? 'تم تحديث المورد' : 'تم إضافة المورد');
        }

        async function toggleSupplierArchive(id, restore = false) {
            const supplierId = String(id || '').trim();
            if (!supplierId) return;
            const idx = (suppliers || []).findIndex((item) => String(item.id) === supplierId);
            if (idx === -1) return;

            const nextActiveState = restore === true;
            if (navigator.onLine === true) {
                try {
                    await requireAdminPermission();
                    if (nextActiveState && typeof updateSupplier === 'function') {
                        await updateSupplier(supplierId, { active: true });
                    } else if (!nextActiveState && typeof archiveSupplier === 'function') {
                        await archiveSupplier(supplierId);
                    } else if (typeof updateSupplier === 'function') {
                        await updateSupplier(supplierId, { active: nextActiveState });
                    }
                } catch (error) {
                    console.error('toggleSupplierArchive error:', error);
                    showNotification('error', 'فشل تحديث حالة المورد');
                    return;
                }
            }

            suppliers[idx] = { ...suppliers[idx], active: nextActiveState };
            saveSuppliers();
            renderSuppliersTable();
            renderSupplierOptions();
            renderAdminSupplierFilterOptions();
            updateBadges();
            showNotification('success', nextActiveState ? 'تم إعادة تفعيل المورد' : 'تم أرشفة المورد');
        }

        async function assignSupplierToSelectionPrompt() {
            const supplierOptions = (suppliers || []).filter((item) => item && item.active !== false);
            if (!supplierOptions.length) {
                showNotification('error', 'لا يوجد موردون نشطون');
                return;
            }

            const supplierCode = prompt(`أدخل كود المورد (${supplierOptions.map((item) => item.code).join(' / ')})`);
            if (!supplierCode) return;
            const supplier = supplierOptions.find((item) => String(item.code || '').toUpperCase() === String(supplierCode || '').trim().toUpperCase());
            if (!supplier) {
                showNotification('error', 'المورد غير موجود');
                return;
            }

            const idsInput = prompt('أدخل معرفات المنتجات مفصولة بفاصلة، أو اتركه فارغًا لتطبيق المورد على جميع المنتجات الحالية');
            const candidateIds = idsInput
                ? idsInput.split(',').map((item) => item.trim()).filter(Boolean)
                : (products || []).map((item) => String(item.id || '')).filter(Boolean);
            if (!candidateIds.length) {
                showNotification('error', 'لا يوجد منتجات للتحديث');
                return;
            }

            const marginInput = prompt('هامش اختياري % (اتركه فارغًا لاستخدام هامش المنتج الحالي)', String(supplier.defaultMarginPercent || ''));
            const marginValue = marginInput === '' ? null : Number(parseMoney(marginInput));

            try {
                if (navigator.onLine === true && typeof assignSupplierToProducts === 'function') {
                    await requireAdminPermission();
                    await assignSupplierToProducts(candidateIds, supplier.id, Number.isFinite(marginValue) ? marginValue : null);
                }

                const targetSet = new Set(candidateIds.map((id) => String(id)));
                products = (products || []).map((product) => {
                    if (!targetSet.has(String(product.id || ''))) return product;
                    const marginPercent = Number.isFinite(marginValue) ? marginValue : Number(product.marginPercent || supplier.defaultMarginPercent || 0);
                    return normalizeProductForStorage({
                        ...product,
                        supplierId: supplier.id,
                        supplierName: supplier.name,
                        supplierCode: supplier.code,
                        marginPercent
                    }, {
                        isPublished: product.isPublished !== false,
                        category: product.category
                    });
                });

                saveProducts();
                renderProductsTable();
                updateStats();
                showNotification('success', `تم تعيين المورد على ${candidateIds.length} منتج`);
            } catch (error) {
                console.error('assignSupplierToSelectionPrompt error:', error);
                showNotification('error', 'فشل تعيين المورد');
            }
        }

        async function recalculateSupplierPrompt() {
            const supplierOptions = (suppliers || []).filter((item) => item && item.active !== false);
            if (!supplierOptions.length) {
                showNotification('error', 'لا يوجد موردون نشطون');
                return;
            }
            const supplierCode = prompt(`أدخل كود المورد لإعادة التسعير (${supplierOptions.map((item) => item.code).join(' / ')})`);
            if (!supplierCode) return;
            const supplier = supplierOptions.find((item) => String(item.code || '').toUpperCase() === String(supplierCode || '').trim().toUpperCase());
            if (!supplier) {
                showNotification('error', 'المورد غير موجود');
                return;
            }

            const overwriteManual = confirm('موافق = إعادة التسعير حتى للمنتجات ذات السعر اليدوي\nإلغاء = الحفاظ على المنتجات ذات التثبيت اليدوي');
            const mode = overwriteManual ? 'overwrite_manual' : 'preserve_manual';

            try {
                if (navigator.onLine === true && typeof recalculateSupplierPrices === 'function') {
                    await requireAdminPermission();
                    await recalculateSupplierPrices(supplier.id, mode);
                }

                products = (products || []).map((product) => {
                    if (String(product.supplierId || '') !== String(supplier.id || '')) return product;
                    if (mode === 'preserve_manual' && product.manualPriceOverride === true) return product;
                    return normalizeProductForStorage({
                        ...product,
                        manualPriceOverride: mode === 'overwrite_manual' ? false : product.manualPriceOverride
                    }, {
                        isPublished: product.isPublished !== false,
                        category: product.category
                    });
                });

                saveProducts();
                renderProductsTable();
                updateStats();
                showNotification('success', 'تمت إعادة التسعير بنجاح');
            } catch (error) {
                console.error('recalculateSupplierPrompt error:', error);
                showNotification('error', 'فشل إعادة التسعير');
            }
        }

        // ============================================
        // Orders
        // ============================================
        function updateOrdersPaginationUi() {
            const metaEl = document.getElementById('ordersPaginationMeta');
            const loadMoreBtn = document.getElementById('ordersLoadMoreBtn');
            if (metaEl) {
                if (ordersLoading) {
                    metaEl.textContent = `جاري التحميل... (${ordersTotalLoaded})`;
                } else {
                    metaEl.textContent = `تم تحميل ${ordersTotalLoaded} طلب`;
                }
            }
            if (loadMoreBtn) {
                loadMoreBtn.disabled = ordersLoading || !ordersHasMore;
                loadMoreBtn.textContent = ordersLoading ? 'جاري التحميل...' : 'تحميل المزيد';
            }
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTable');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">🛍️</div><p>لا توجد طلبات</p></div></td></tr>';
                updateOrdersPaginationUi();
                return;
            }
            tbody.innerHTML = orders.map((o) => {
                const rawOrderId = String(o && o.id || '');
                const safeOrderNumber = escapeHtml(o && (o.orderNumber || o.id) || '-');
                const safeCustomerName = escapeHtml(o && o.customer && o.customer.name || '-');
                const safeCustomerPhone = escapeHtml(o && o.customer && o.customer.phone || '-');
                const safeTotal = escapeHtml(Number(o && o.total || 0).toFixed(2));
                const safeStatus = escapeHtml(getStatusName(o && o.status));
                const safeStatusClass = escapeHtml(String(o && o.status || 'pending').toLowerCase().replace(/[^a-z0-9_-]/g, ''));
                const safeCreatedAt = escapeHtml(formatDateTime(o && o.createdAt));
                const safeOrderIdAttr = escapeHtml(rawOrderId);
                return `
                <tr>
                    <td><strong>${safeOrderNumber}</strong></td>
                    <td>${safeCustomerName}</td>
                    <td>${safeCustomerPhone}</td>
                    <td><strong>${safeTotal} ج.م</strong></td>
                    <td><span class="status-badge status-${safeStatusClass}">${safeStatus}</span></td>
                    <td>${safeCreatedAt}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" data-order-id="${safeOrderIdAttr}" onclick="viewOrder(this.dataset.orderId)">👁️</button>
                            <button class="action-btn delete" data-order-id="${safeOrderIdAttr}" onclick="deleteOrder(this.dataset.orderId)">🚫</button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
            updateOrdersPaginationUi();
        }

        async function loadOrdersPage(options = {}) {
            const settings = options && typeof options === 'object' ? options : {};
            const reset = settings.reset === true;
            const showToastMessage = settings.showToast === true;
            if (ordersLoading) return;

            if (typeof listOrdersPage !== 'function') {
                const apiError = new Error('listOrdersPage unavailable');
                if (showToastMessage) showNotification('error', 'فشل تحميل الطلبات');
                throw apiError;
            }

            ordersLoading = true;
            updateOrdersPaginationUi();
            try {
                if (reset) {
                    orders = [];
                    ordersPageCursor = '';
                    ordersHasMore = false;
                    ordersTotalLoaded = 0;
                }

                const response = await listOrdersPage({
                    limit: ordersPageSize,
                    cursor: reset ? '' : ordersPageCursor
                });
                const pageRows = Array.isArray(response && response.items) ? response.items : [];
                const normalizedRows = pageRows.map((row) => ({ id: String(row && row.id || ''), ...row }));

                if (reset) {
                    orders = normalizedRows;
                } else if (normalizedRows.length) {
                    const map = new Map((orders || []).map((row) => [String(row && row.id || ''), row]));
                    normalizedRows.forEach((row) => map.set(String(row && row.id || ''), row));
                    orders = Array.from(map.values());
                }

                ordersHasMore = response && response.hasMore === true;
                ordersPageCursor = String(response && response.nextCursor || '').trim();
                ordersTotalLoaded = Array.isArray(orders) ? orders.length : 0;

                saveOrders();
                renderOrdersTable();
                renderRecentOrders();
                updateBadges();
                updateStats();
                if (showToastMessage) showNotification('success', 'تم تحديث الطلبات');
            } catch (error) {
                console.error('loadOrdersPage error:', error);
                if (showToastMessage) showNotification('error', 'فشل تحميل الطلبات');
                throw error;
            } finally {
                ordersLoading = false;
                updateOrdersPaginationUi();
            }
        }

        function renderRecentOrders() {
            const tbody = document.getElementById('recentOrdersTable');
            const recent = orders.slice(-5).reverse();
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">لا توجد طلبات</td></tr>';
                return;
            }
            tbody.innerHTML = recent.map((o) => {
                const safeOrderNumber = escapeHtml(o && (o.orderNumber || o.id) || '-');
                const safeCustomerName = escapeHtml(o && o.customer && o.customer.name || '-');
                const safeTotal = escapeHtml(Number(o && o.total || 0).toFixed(2));
                const safeStatus = escapeHtml(getStatusName(o && o.status));
                const safeStatusClass = escapeHtml(String(o && o.status || 'pending').toLowerCase().replace(/[^a-z0-9_-]/g, ''));
                const safeCreatedAt = escapeHtml(formatDateTime(o && o.createdAt));
                return `
                <tr>
                    <td><strong>${safeOrderNumber}</strong></td>
                    <td>${safeCustomerName}</td>
                    <td><strong>${safeTotal} ج.م</strong></td>
                    <td><span class="status-badge status-${safeStatusClass}">${safeStatus}</span></td>
                    <td>${safeCreatedAt}</td>
                </tr>
            `;
            }).join('');
        }

        function getStatusName(s) {
            const names = { pending: 'جديد', confirmed: 'مؤكد', processing: 'تجهيز', shipped: 'شحن', delivered: 'توصيل', completed: 'مكتمل', cancelled: 'ملغي' };
            return names[s] || s;
        }

        function formatDate(d) {
            if (!d) return '-';
            return new Date(d).toLocaleDateString('ar-EG');
        }

        function formatDateTime(d) {
            if (!d) return '-';
            const date = new Date(d);
            if (Number.isNaN(date.getTime())) return '-';
            return `${date.toLocaleDateString('ar-EG')} ${date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
        }

        function viewOrder(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;

            const safeOrderId = escapeHtml(String(o.id || ''));
            const safeOrderNumber = escapeHtml(o.orderNumber || o.id || '-');
            const safeCreatedAt = escapeHtml(formatDateTime(o.createdAt));
            const safeCustomerName = escapeHtml(o.customer && o.customer.name || '-');
            const safeCustomerPhone = escapeHtml(o.customer && o.customer.phone || '-');
            const safeCustomerAddress = escapeHtml(o.customer && o.customer.address || '-');
            const safeCustomerNotes = escapeHtml(o.customer && o.customer.notes || '');
            const safeSubtotal = escapeHtml(Number(o.subtotal || 0).toFixed(2));
            const safeCouponCode = escapeHtml(o.couponCode || '');
            const safeDiscount = escapeHtml(Number(o.discount || 0).toFixed(2));
            const safeUsedPoints = escapeHtml(Number(o.usedPoints || 0).toFixed(0));
            const safePointsDiscount = escapeHtml(Number(o.pointsDiscount || 0).toFixed(2));
            const safeEarnedPoints = escapeHtml(Number(o.earnedPoints || 0).toFixed(0));
            const safeTotal = escapeHtml(Number(o.total || 0).toFixed(2));
            const itemsHtml = (Array.isArray(o.items) ? o.items : []).map((i) => {
                const name = escapeHtml(i && i.name || '-');
                const quantity = Number(i && i.quantity || 0);
                const linePrice = Number(i && i.price || 0);
                const lineTotal = escapeHtml((linePrice * quantity).toFixed(2));
                return `
                <div class="order-item">
                    <span>${name} × ${escapeHtml(quantity)}</span>
                    <strong>${lineTotal} ج.م</strong>
                </div>
            `;
            }).join('');

            document.getElementById('orderModalBody').innerHTML = `
                <div class="order-detail-section">
                    <h4>📋 الطلب</h4>
                    <p><strong>رقم:</strong> ${safeOrderNumber}</p>
                    <p><strong>التاريخ:</strong> ${safeCreatedAt}</p>
                    <p><strong>الحالة:</strong> 
                        <select class="status-select" data-order-id="${safeOrderId}" onchange="updateOrderStatus(this.dataset.orderId, this.value)">
                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>جديد</option>
                            <option value="confirmed" ${o.status === 'confirmed' ? 'selected' : ''}>مؤكد</option>
                            <option value="processing" ${o.status === 'processing' ? 'selected' : ''}>تجهيز</option>
                            <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>شحن</option>
                            <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>توصيل</option>
                            <option value="completed" ${o.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                            <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>ملغي</option>
                        </select>
                    </p>
                </div>

                <div class="order-detail-section">
                    <h4>👤 العميل</h4>
                    <p><strong>الاسم:</strong> ${safeCustomerName}</p>
                    <p><strong>الهاتف:</strong> ${safeCustomerPhone}</p>
                    <p><strong>العنوان:</strong> ${safeCustomerAddress}</p>
                    ${safeCustomerNotes ? `<p><strong>ملاحظات:</strong> ${safeCustomerNotes}</p>` : ''}
                </div>

                <div class="order-detail-section">
                    <h4>📦 المنتجات</h4>
                    ${itemsHtml || '<p>لا توجد</p>'}
                    
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #ddd;">
                        <div class="order-item"><span>المجموع:</span><span>${safeSubtotal} ج.م</span></div>
                        ${o.couponCode ? `<div class="order-item" style="color: var(--success);"><span>🎫 ${safeCouponCode}</span><span>- ${safeDiscount} ج.م</span></div>` : ''}
                        ${o.usedPoints > 0 ? `<div class="order-item" style="color: var(--info);"><span>💎 نقاط (${safeUsedPoints})</span><span>- ${safePointsDiscount} ج.م</span></div>` : ''}
                        ${o.earnedPoints > 0 ? `<div class="order-item" style="color: var(--burgundy);"><span>⭐ نقاط مكتسبة</span><span>+${safeEarnedPoints}</span></div>` : ''}
                    </div>
                    <div class="order-total"><span>الإجمالي:</span><span>${safeTotal} ج.م</span></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-navy" data-order-id="${safeOrderId}" onclick="printOrder(this.dataset.orderId)" style="flex: 1;">🖨️ طباعة</button>
                    <button class="btn btn-success" data-order-id="${safeOrderId}" onclick="sendWhatsAppUpdate(this.dataset.orderId)" style="flex: 1;">💬 واتساب</button>
                </div>
            `;
            openModal('orderModal');
        }

        async function updateOrderStatus(id, status) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;

            const previousStatus = String(o.status || 'pending');
            const nextStatus = String(status || '').trim().toLowerCase();
            if (!nextStatus || nextStatus === previousStatus) return;

            try {
                if (typeof window.__firebaseApiUpdateOrderStatus === 'function') {
                    await window.__firebaseApiUpdateOrderStatus(String(id), nextStatus);
                }
            } catch (error) {
                console.error('updateOrderStatus sync error:', error);
                showNotification('error', 'فشل تحديث الحالة', 'تعذر مزامنة الحالة مع Firebase. حاول مرة أخرى.');
                renderOrdersTable();
                return;
            }

            o.status = nextStatus;
            if (!o.statusHistory) o.statusHistory = [];
            o.statusHistory.push({ status: nextStatus, date: new Date().toISOString() });
            saveOrders();
            renderOrdersTable();
            renderRecentOrders();
            updateBadges();
            showNotification('success', 'تم تحديث الحالة');
        }

        function sendWhatsAppUpdate(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            const phone = o.customer?.phone || '';
            const msg = `مرحباً ${o.customer?.name}!\n\n📦 طلبك رقم: ${o.orderNumber}\n📍 الحالة: ${getStatusName(o.status)}\n\nشكراً لتسوقك معنا! 🛍️`;
            window.open(`https://wa.me/2${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function printOrder(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            const w = window.open('', '_blank');
            if (!w) return;
            const safeOrderNumber = escapeHtml(o.orderNumber || o.id || '-');
            const safeCreatedAt = escapeHtml(formatDateTime(o.createdAt));
            const safeCustomerName = escapeHtml(o.customer && o.customer.name || '-');
            const safeCustomerPhone = escapeHtml(o.customer && o.customer.phone || '-');
            const safeCustomerAddress = escapeHtml(o.customer && o.customer.address || '-');
            const safeStorePhone = escapeHtml(storeSettings && storeSettings.contact && storeSettings.contact.phone || '');
            const itemsRows = (Array.isArray(o.items) ? o.items : []).map((i) => {
                const itemName = escapeHtml(i && i.name || '-');
                const quantity = Number(i && i.quantity || 0);
                const price = Number(i && i.price || 0);
                const total = (price * quantity).toFixed(2);
                return `<tr><td>${itemName}</td><td>${escapeHtml(quantity)}</td><td>${escapeHtml(price.toFixed(2))}</td><td>${escapeHtml(total)}</td></tr>`;
            }).join('');
            const safeTotal = escapeHtml(Number(o.total || 0).toFixed(2));
            w.document.write(`
                <!DOCTYPE html>
                <html dir="rtl"><head><title>فاتورة ${safeOrderNumber}</title>
                <style>body{font-family:Arial;padding:20px}h1{color:#D4AF37;text-align:center}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:10px;text-align:right}th{background:#f5f5f5;font-weight:700;color:#0A1128}.total{font-size:20px;font-weight:bold}</style></head>
                <body>
                <h1>Sale Zone Store</h1>
                <h2>فاتورة: ${safeOrderNumber}</h2>
                <p><strong>التاريخ:</strong> ${safeCreatedAt}</p>
                <p><strong>العميل:</strong> ${safeCustomerName}</p>
                <p><strong>الهاتف:</strong> ${safeCustomerPhone}</p>
                <p><strong>العنوان:</strong> ${safeCustomerAddress}</p>
                <table><tr><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr>
                ${itemsRows}
                </table>
                <p class="total">الإجمالي: ${safeTotal} ج.م</p>
                <p style="text-align:center">شكراً لتسوقك معنا! 📞 ${safeStorePhone}</p>
                </body></html>
            `);
            w.document.close();
            w.print();
        }

        async function deleteOrder(id) {
            const o = orders.find((entry) => String(entry && entry.id) === String(id));
            if (!o) return;
            if (String(o.status || '') === 'cancelled') {
                showNotification('info', 'الطلب ملغي بالفعل');
                return;
            }
            if (!confirm('إلغاء الطلب؟ لن يتم حذف السجل من قاعدة البيانات.')) return;
            await updateOrderStatus(id, 'cancelled');
        }

        // ============================================
        // Banners
        // ============================================
        function renderBannersTable() {
            const tbody = document.getElementById('bannersTable');
            if (banners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">🎠</div><p>لا توجد بانرات</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = banners.map((b) => {
                const safeBannerId = escapeHtml(String(b && b.id || ''));
                const safeIcon = escapeHtml(b && b.icon || '🎉');
                const safeTitle = escapeHtml(b && b.title || '-');
                const safeText = escapeHtml(b && b.text || '-');
                const safeCategory = escapeHtml(getCategoryName(b && b.category) || 'الكل');
                return `
                <tr>
                    <td style="font-size: 24px;">${safeIcon}</td>
                    <td><strong>${safeTitle}</strong></td>
                    <td>${safeText}</td>
                    <td>${safeCategory}</td>
                    <td><button class="action-btn delete" data-banner-id="${safeBannerId}" onclick="deleteBanner(this.dataset.bannerId)">🗑️</button></td>
                </tr>
            `;
            }).join('');
        }

        async function saveBanner(e) {
            e.preventDefault();
            if (navigator.onLine !== true) {
                showNotification('error', '\u0644\u0627 \u064a\u0645\u0643\u0646 \u0625\u0636\u0627\u0641\u0629 \u0627\u0644\u0628\u0627\u0646\u0631 \u0628\u062f\u0648\u0646 \u0627\u062a\u0635\u0627\u0644 \u0625\u0646\u062a\u0631\u0646\u062a');
                return;
            }

            const data = {
                icon: document.getElementById('bannerIcon').value || '\uD83C\uDF89',
                title: document.getElementById('bannerTitle').value.trim(),
                text: document.getElementById('bannerText').value.trim(),
                btn: document.getElementById('bannerBtn').value.trim() || '\u062a\u0633\u0648\u0642 \u0627\u0644\u0622\u0646',
                category: document.getElementById('bannerCategory').value
            };

            try {
                await requireAdminPermission();
                if (typeof addBanner !== 'function') throw new Error('addBanner unavailable');
                const firebaseId = await addBanner(data);
                banners.push({ ...data, id: String(firebaseId) });
            } catch (error) {
                logAdmin('error', 'ADMIN_BANNER_CREATE_FAILED', 'Failed to create banner in Firebase', {
                    error: error && error.message ? String(error.message) : String(error)
                });
                showNotification('error', '\u0641\u0634\u0644 \u0625\u0636\u0627\u0641\u0629 \u0627\u0644\u0628\u0627\u0646\u0631 \u0639\u0644\u0649 Firebase');
                return;
            }

            saveBanners();
            renderBannersTable();
            closeModal('bannerModal');
            showNotification('success', '\u062a\u0645\u062a \u0627\u0644\u0625\u0636\u0627\u0641\u0629 \u2705');
            document.getElementById('bannerIcon').value = '';
            document.getElementById('bannerTitle').value = '';
            document.getElementById('bannerText').value = '';
            document.getElementById('bannerBtn').value = '';
        }
        async function deleteBanner(id) {
            if (!confirm('\u062d\u0630\u0641 \u0627\u0644\u0628\u0627\u0646\u0631\u061f')) return;
            if (navigator.onLine !== true) {
                showNotification('error', '\u0644\u0627 \u064a\u0645\u0643\u0646 \u062d\u0630\u0641 \u0627\u0644\u0628\u0627\u0646\u0631 \u0628\u062f\u0648\u0646 \u0627\u062a\u0635\u0627\u0644 \u0625\u0646\u062a\u0631\u0646\u062a');
                return;
            }

            try {
                await requireAdminPermission();
                if (typeof deleteBannerFromFirebase !== 'function') throw new Error('deleteBannerFromFirebase unavailable');
                await deleteBannerFromFirebase(String(id));
            } catch (error) {
                logAdmin('error', 'ADMIN_BANNER_DELETE_FAILED', 'Failed to delete banner from Firebase', {
                    bannerId: String(id || ''),
                    error: error && error.message ? String(error.message) : String(error)
                });
                showNotification('error', '\u0641\u0634\u0644 \u062d\u0630\u0641 \u0627\u0644\u0628\u0627\u0646\u0631 \u0645\u0646 Firebase');
                return;
            }

            banners = banners.filter((b) => String(b.id) !== String(id));
            saveBanners();
            renderBannersTable();
            showNotification('success', '\u062a\u0645 \u0627\u0644\u062d\u0630\u0641 \u2705');
        }
        // ============================================
        // Coupons
        // ============================================
        function renderCouponsTable() {
            const tbody = document.getElementById('couponsTable');
            if (coupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">🎫</div><p>لا توجد كوبونات</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = coupons.map((c) => {
                const safeCouponId = escapeHtml(String(c && c.id || ''));
                const safeCode = escapeHtml(c && c.code || '-');
                const safeDesc = escapeHtml(c && c.desc || '-');
                const safeType = escapeHtml(c && c.type === 'percentage' ? 'نسبة' : 'ثابت');
                const safeValue = escapeHtml(Number(c && c.value || 0).toFixed(2));
                const safeUnit = c && c.type === 'percentage' ? '%' : ' ج.م';
                return `
                <tr>
                    <td><strong style="color: var(--burgundy);">${safeCode}</strong></td>
                    <td>${safeDesc}</td>
                    <td>${safeType}</td>
                    <td><strong>${safeValue}${safeUnit}</strong></td>
                    <td><button class="action-btn delete" data-coupon-id="${safeCouponId}" onclick="deleteCoupon(this.dataset.couponId)">🗑️</button></td>
                </tr>
            `;
            }).join('');
        }

        async function saveCoupon(e) {
            e.preventDefault();
            const code = document.getElementById('couponCode').value.trim().toUpperCase();
            if (!code) {
                showNotification('error', '\u0627\u0644\u0643\u0648\u062f \u0645\u0637\u0644\u0648\u0628');
                return;
            }
            if (coupons.find((c) => String(c.code || '').toUpperCase() === code)) {
                showNotification('error', '\u0627\u0644\u0643\u0648\u062f \u0645\u0648\u062c\u0648\u062f');
                return;
            }
            if (navigator.onLine !== true) {
                showNotification('error', '\u0644\u0627 \u064a\u0645\u0643\u0646 \u0625\u0636\u0627\u0641\u0629 \u0643\u0648\u0628\u0648\u0646 \u0628\u062f\u0648\u0646 \u0627\u062a\u0635\u0627\u0644 \u0625\u0646\u062a\u0631\u0646\u062a');
                return;
            }

            const value = parseFloat(document.getElementById('couponValue').value);
            if (!Number.isFinite(value) || value <= 0) {
                showNotification('error', '\u0642\u064a\u0645\u0629 \u0627\u0644\u062e\u0635\u0645 \u063a\u064a\u0631 \u0635\u0627\u0644\u062d\u0629');
                return;
            }

            const data = {
                code,
                desc: document.getElementById('couponDesc').value.trim(),
                type: document.getElementById('couponType').value,
                value
            };

            try {
                await requireAdminPermission();
                if (typeof addCoupon !== 'function') throw new Error('addCoupon unavailable');
                const firebaseId = await addCoupon(data);
                coupons.push({ ...data, id: String(firebaseId) });
            } catch (error) {
                logAdmin('error', 'ADMIN_COUPON_CREATE_FAILED', 'Failed to create coupon in Firebase', {
                    code,
                    error: error && error.message ? String(error.message) : String(error)
                });
                showNotification('error', '\u0641\u0634\u0644 \u0625\u0636\u0627\u0641\u0629 \u0627\u0644\u0643\u0648\u0628\u0648\u0646 \u0639\u0644\u0649 Firebase');
                return;
            }

            saveCoupons();
            renderCouponsTable();
            closeModal('couponModal');
            showNotification('success', '\u062a\u0645\u062a \u0627\u0644\u0625\u0636\u0627\u0641\u0629');
            document.getElementById('couponCode').value = '';
            document.getElementById('couponDesc').value = '';
            document.getElementById('couponValue').value = '';
        }
        async function deleteCoupon(id) {
            if (!confirm('\u062d\u0630\u0641 \u0627\u0644\u0643\u0648\u0628\u0648\u0646\u061f')) return;
            if (navigator.onLine !== true) {
                showNotification('error', '\u0644\u0627 \u064a\u0645\u0643\u0646 \u062d\u0630\u0641 \u0627\u0644\u0643\u0648\u0628\u0648\u0646 \u0628\u062f\u0648\u0646 \u0627\u062a\u0635\u0627\u0644 \u0625\u0646\u062a\u0631\u0646\u062a');
                return;
            }

            try {
                await requireAdminPermission();
                if (typeof deleteCouponFromFirebase !== 'function') throw new Error('deleteCouponFromFirebase unavailable');
                await deleteCouponFromFirebase(String(id));
            } catch (error) {
                logAdmin('error', 'ADMIN_COUPON_DELETE_FAILED', 'Failed to delete coupon from Firebase', {
                    couponId: String(id || ''),
                    error: error && error.message ? String(error.message) : String(error)
                });
                showNotification('error', '\u0641\u0634\u0644 \u062d\u0630\u0641 \u0627\u0644\u0643\u0648\u0628\u0648\u0646 \u0645\u0646 Firebase');
                return;
            }

            coupons = coupons.filter((c) => String(c.id) !== String(id));
            saveCoupons();
            renderCouponsTable();
            showNotification('success', '\u062a\u0645 \u0627\u0644\u062d\u0630\u0641 \u2705');
        }
        // ============================================
        // Users
        // ============================================
        function updateUsersPaginationUi() {
            const metaEl = document.getElementById('usersPaginationMeta');
            const loadMoreBtn = document.getElementById('usersLoadMoreBtn');
            if (metaEl) {
                if (customersLoading) {
                    metaEl.textContent = `جاري التحميل... (${customersTotalLoaded})`;
                } else {
                    metaEl.textContent = `تم تحميل ${customersTotalLoaded} عميل`;
                }
            }
            if (loadMoreBtn) {
                loadMoreBtn.disabled = customersLoading || !customersHasMore;
                loadMoreBtn.textContent = customersLoading ? 'جاري التحميل...' : 'تحميل المزيد';
            }
        }

        function getUserDisplayName(user) {
            const safe = user && typeof user === 'object' ? user : {};
            const name = String(safe.displayName || safe.name || '').trim();
            return name || 'عميل';
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">👥</div><p>لا يوجد عملاء</p></div></td></tr>';
                updateUsersPaginationUi();
                return;
            }
            tbody.innerHTML = users.map((u) => {
                const safeCustomerId = escapeHtml(String(u && u.id || ''));
                const safeName = escapeHtml(getUserDisplayName(u));
                const safePhone = escapeHtml(u && u.phone || '-');
                const safeEmail = escapeHtml(u && u.email || '-');
                const safeLoyalty = escapeHtml(Number(u && u.loyaltyPoints || 0).toFixed(0));
                const safeCreatedAt = escapeHtml(formatDate(u && u.createdAt));
                return `
                <tr>
                    <td><strong>${safeName}</strong></td>
                    <td>${safePhone}</td>
                    <td>${safeEmail}</td>
                    <td><strong style="color: var(--gold-dark);">${safeLoyalty}</strong></td>
                    <td>${safeCreatedAt}</td>
                    <td>
                        <button class="action-btn edit" data-customer-id="${safeCustomerId}" onclick="editCustomer(this.dataset.customerId)">✏️</button>
                        <button class="action-btn delete" data-customer-id="${safeCustomerId}" onclick="deleteCustomer(this.dataset.customerId)">🗑️</button>
                    </td>
                </tr>
            `;
            }).join('');
            updateUsersPaginationUi();
        }

        async function loadCustomersPage(options = {}) {
            const settings = options && typeof options === 'object' ? options : {};
            const reset = settings.reset === true;
            const showToastMessage = settings.showToast === true;
            if (customersLoading) return;

            if (typeof listCustomersPage !== 'function') {
                const apiError = new Error('listCustomersPage unavailable');
                if (showToastMessage) showNotification('error', 'فشل تحميل العملاء');
                throw apiError;
            }

            customersLoading = true;
            updateUsersPaginationUi();
            try {
                if (reset) {
                    users = [];
                    customersPageCursor = '';
                    customersHasMore = false;
                    customersTotalLoaded = 0;
                }

                const response = await listCustomersPage({
                    limit: customersPageSize,
                    cursor: reset ? '' : customersPageCursor
                });
                const pageRows = Array.isArray(response && response.items) ? response.items : [];
                const normalizedRows = pageRows.map((row) => ({ id: String(row && row.id || row && row.uid || ''), ...row }));

                if (reset) {
                    users = normalizedRows;
                } else if (normalizedRows.length) {
                    const map = new Map((users || []).map((row) => [String(row && row.id || ''), row]));
                    normalizedRows.forEach((row) => map.set(String(row && row.id || ''), row));
                    users = Array.from(map.values());
                }

                customersHasMore = response && response.hasMore === true;
                customersPageCursor = String(response && response.nextCursor || '').trim();
                customersTotalLoaded = Array.isArray(users) ? users.length : 0;

                saveUsers();
                renderUsersTable();
                renderLoyaltySection();
                updateStats();
                if (showToastMessage) showNotification('success', 'تم تحديث العملاء');
            } catch (error) {
                console.error('loadCustomersPage error:', error);
                if (showToastMessage) showNotification('error', 'فشل تحميل العملاء');
                throw error;
            } finally {
                customersLoading = false;
                updateUsersPaginationUi();
            }
        }

        async function syncCustomersFromFirebaseNow(showToastMessage = true) {
            try {
                await loadCustomersPage({ reset: true, showToast: showToastMessage });
            } catch (error) {
                console.error('syncCustomersFromFirebaseNow error:', error);
                if (showToastMessage) showNotification('error', 'فشل مزامنة العملاء');
            }
        }

        function startCustomersRealtimeSync() {
            return null;
        }

        function stopCustomersRealtimeSync() {
            return null;
        }

        async function editCustomer(userId) {
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;

            const name = prompt('اسم العميل:', user.displayName || user.name || '');
            if (name === null) return;
            const phone = prompt('هاتف العميل:', user.phone || '');
            if (phone === null) return;
            const email = prompt('بريد العميل:', user.email || '');
            if (email === null) return;

            const payload = {
                uid: String(user.uid || user.id || ''),
                displayName: String(name).trim(),
                phone: String(phone).trim(),
                email: String(email).trim().toLowerCase(),
                address: String(user.address || '').trim(),
                role: String(user.role || 'customer'),
                loyaltyPoints: Number(user.loyaltyPoints || 0),
                createdAt: String(user.createdAt || new Date().toISOString())
            };

            try {
                if (typeof updateCustomer === 'function') {
                    await updateCustomer(user.id, payload);
                }
                users = users.map(u => String(u.id) === String(user.id) ? { ...u, ...payload } : u);
                saveUsers();
                renderUsersTable();
                renderLoyaltySection();
                updateStats();
                showNotification('success', 'تم تعديل العميل');
            } catch (error) {
                console.error('editCustomer error:', error);
                showNotification('error', 'فشل تعديل العميل');
            }
        }

        async function deleteCustomer(userId) {
            const user = users.find(u => String(u.id) === String(userId));
            if (!user) return;
            if (!confirm(`حذف العميل ${user.name || ''}؟`)) return;

            try {
                if (typeof deleteCustomerFromFirebase === 'function') {
                    await deleteCustomerFromFirebase(user.id);
                }
                users = users.filter(u => String(u.id) !== String(user.id));
                saveUsers();
                renderUsersTable();
                renderLoyaltySection();
                updateStats();
                showNotification('success', 'تم حذف العميل');
            } catch (error) {
                console.error('deleteCustomer error:', error);
                showNotification('error', 'فشل حذف العميل');
            }
        }

        async function resetCustomerPassword() {
            showNotification('warning', 'غير متاح', 'تم تعطيل إدارة كلمات مرور العملاء. استخدم Firebase Auth reset email.');
        }

        // ============================================
        // Internal Support Chat
        // ============================================
        function getPermissionErrorCode(error) {
            const rawCode = String(error && (error.code || error.errorCode) || '').trim().toLowerCase();
            if (!rawCode) return '';
            return rawCode.startsWith('firebase/') ? rawCode.slice('firebase/'.length) : rawCode;
        }

        function isPermissionDenied(error) {
            if (!error) return false;
            if (error.permissionDenied === true) return true;
            const code = getPermissionErrorCode(error);
            if (code === 'permission-denied' || code === 'permission_denied') return true;
            const message = String(error && (error.message || error.reason) || error || '').toLowerCase();
            return message.includes('missing or insufficient permissions')
                || message.includes('insufficient permissions')
                || message.includes('permission-denied');
        }

        function logWarnOnce(key, message, meta) {
            const normalizedKey = String(key || '').trim();
            if (!normalizedKey) return;
            if (warningLogOnce.has(normalizedKey)) return;
            warningLogOnce.add(normalizedKey);
            if (typeof meta === 'undefined') {
                console.warn(message);
            } else {
                console.warn(message, meta);
            }
        }

        function warnPermissionDeniedOnce(source, error, prefix = 'permission denied') {
            const code = getPermissionErrorCode(error) || 'unknown';
            const key = `${String(source || 'permission')}|${code}`;
            const reason = String(error && (error.message || error.reason) || error || 'unknown permission error').trim();
            logWarnOnce(key, `${prefix} (${String(source || 'unknown')}): ${reason}`);
        }

        function getSupportAccessErrorCode(error) {
            return getPermissionErrorCode(error);
        }

        function isSupportPermissionDenied(error) {
            return isPermissionDenied(error);
        }

        function updateSupportAccessUi() {
            const noticeEl = document.getElementById('supportAccessNotice');
            const replyInput = document.getElementById('supportReplyInput');
            const replyBtn = document.getElementById('supportReplyBtn');
            const closeBtn = document.getElementById('closeSupportThreadBtn');

            if (noticeEl) {
                if (supportAccess.denied) {
                    const source = String(supportAccess.source || 'support');
                    noticeEl.textContent = `تعذر تشغيل الدردشة الداخلية بسبب الصلاحيات (source: ${source}). باقي لوحة الأدمن تعمل بشكل طبيعي.`;
                    noticeEl.style.display = 'block';
                } else {
                    noticeEl.style.display = 'none';
                    noticeEl.textContent = '';
                }
            }

            if (supportAccess.denied) {
                if (replyInput) replyInput.disabled = true;
                if (replyBtn) replyBtn.disabled = true;
                if (closeBtn) closeBtn.disabled = true;
            }
        }

        function clearSupportAccessState() {
            supportAccess.denied = false;
            supportAccess.reason = '';
            supportAccess.source = '';
            supportAccess.notifiedReason = '';
            updateSupportAccessUi();
        }

        function handleSupportAccessError(error, source = '') {
            const denied = isSupportPermissionDenied(error);
            if (!denied) return false;

            const reason = String(error && (error.message || error.reason) || error || 'unknown support access error').trim();
            const normalizedSource = String(source || 'support');
            supportAccess.denied = true;
            supportAccess.reason = reason;
            supportAccess.source = normalizedSource;

            if (supportAccess.notifiedReason !== reason) {
                supportAccess.notifiedReason = reason;
                showNotification('error', 'تعذر تشغيل الدردشة الداخلية بسبب الصلاحيات. باقي لوحة الأدمن تعمل بشكل طبيعي.');
            }

            warnPermissionDeniedOnce(normalizedSource, error, 'support access denied');
            stopSupportChatRealtime();
            supportThreads = [];
            supportMessages = [];
            activeSupportThreadId = '';
            renderSupportThreads();
            renderSupportMessages();
            updateSupportAccessUi();
            return true;
        }

        function canUseSupportChat(notify = true) {
            if (supportAccess.denied) {
                updateSupportAccessUi();
                if (notify) {
                    showNotification('error', 'الدردشة الداخلية متوقفة حاليًا بسبب الصلاحيات.');
                }
                return false;
            }
            return true;
        }

        function getSupportThreadById(threadId) {
            const id = String(threadId || '');
            return (supportThreads || []).find((item) => String(item && item.id || '') === id) || null;
        }

        function getSupportThreadStatusLabel(status) {
            return status === 'closed' ? 'مغلقة' : 'مفتوحة';
        }

        function getSupportThreadStatusClass(status) {
            return status === 'closed' ? 'status-cancelled' : 'status-confirmed';
        }

        function safeSupportTime(iso) {
            return formatDateTime(iso || '');
        }

        function renderSupportThreads() {
            const listEl = document.getElementById('supportThreadsList');
            const metaEl = document.getElementById('supportThreadsMeta');
            if (!listEl || !metaEl) return;
            updateSupportAccessUi();

            if (supportAccess.denied) {
                metaEl.textContent = 'صلاحيات غير متاحة';
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔒</div><p>الدردشة الداخلية متوقفة بسبب الصلاحيات.</p></div>';
                updateBadges();
                return;
            }

            const list = Array.isArray(supportThreads) ? [...supportThreads] : [];
            list.sort((a, b) => String(b && b.updatedAt || '').localeCompare(String(a && a.updatedAt || '')));
            supportThreads = list;
            metaEl.textContent = `${list.length} محادثة`;
            updateBadges();

            if (!list.length) {
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">💬</div><p>لا توجد محادثات دعم</p></div>';
                return;
            }

            listEl.innerHTML = list.map((thread) => {
                const id = String(thread && thread.id || '');
                const unread = Math.max(0, Number(thread && thread.unreadForAdmin || 0));
                const activeClass = id && id === String(activeSupportThreadId || '') ? 'active' : '';
                const name = escapeHtml(thread && thread.customerName || 'عميل');
                const phone = escapeHtml(thread && thread.customerPhone || '-');
                const lastMessage = escapeHtml(thread && thread.lastMessage || 'بدون رسائل');
                const status = getSupportThreadStatusLabel(String(thread && thread.status || 'open'));
                const statusClass = getSupportThreadStatusClass(String(thread && thread.status || 'open'));
                const safeId = escapeHtml(id);
                return `
                    <div class="support-thread-item ${activeClass}" data-thread-id="${safeId}" onclick="selectSupportThread(this.dataset.threadId)">
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <strong style="font-size:13px;">${name}</strong>
                            ${unread > 0 ? `<span class="support-unread-badge">${unread}</span>` : ''}
                        </div>
                        <div style="font-size:11px;color:#666;margin-top:4px;">${phone}</div>
                        <div style="font-size:12px;color:#333;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${lastMessage}</div>
                        <div class="support-thread-meta">
                            <span class="status-badge ${statusClass}">${status}</span>
                            <span>${safeSupportTime(thread && thread.updatedAt)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSupportMessages() {
            const listEl = document.getElementById('supportMessagesList');
            const titleEl = document.getElementById('supportActiveThreadTitle');
            const statusEl = document.getElementById('supportActiveThreadStatus');
            const replyInput = document.getElementById('supportReplyInput');
            const replyBtn = document.getElementById('supportReplyBtn');
            const closeBtn = document.getElementById('closeSupportThreadBtn');
            if (!listEl || !titleEl || !statusEl || !replyInput || !replyBtn || !closeBtn) return;
            updateSupportAccessUi();

            if (supportAccess.denied) {
                titleEl.textContent = 'الدردشة الداخلية غير متاحة';
                statusEl.className = 'status-badge status-pending';
                statusEl.textContent = 'صلاحيات';
                replyInput.value = '';
                replyInput.disabled = true;
                replyBtn.disabled = true;
                closeBtn.disabled = true;
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔒</div><p>لا يمكن تحميل الرسائل بسبب الصلاحيات.</p></div>';
                return;
            }

            const thread = getSupportThreadById(activeSupportThreadId);
            if (!thread) {
                titleEl.textContent = 'اختر محادثة';
                statusEl.className = 'status-badge status-pending';
                statusEl.textContent = '-';
                replyInput.value = '';
                replyInput.disabled = true;
                replyBtn.disabled = true;
                closeBtn.disabled = true;
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📨</div><p>اختر محادثة من القائمة</p></div>';
                return;
            }

            const threadStatus = String(thread.status || 'open');
            const isClosed = threadStatus === 'closed';
            titleEl.textContent = `${thread.customerName || 'عميل'} - ${thread.customerPhone || '-'}`;
            statusEl.className = `status-badge ${getSupportThreadStatusClass(threadStatus)}`;
            statusEl.textContent = getSupportThreadStatusLabel(threadStatus);
            replyInput.disabled = isClosed;
            replyBtn.disabled = isClosed;
            closeBtn.disabled = isClosed;

            const rows = Array.isArray(supportMessages) ? supportMessages : [];
            if (!rows.length) {
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">💬</div><p>لا توجد رسائل بعد</p></div>';
                return;
            }

            listEl.innerHTML = rows.map((msg) => {
                const role = String(msg && msg.senderRole || 'customer');
                const name = role === 'admin' ? 'الأدمن' : (thread.customerName || 'العميل');
                const cssClass = role === 'admin' ? 'admin' : 'customer';
                const text = escapeHtml(msg && msg.message || '');
                const createdAt = safeSupportTime(msg && msg.createdAt);
                return `
                    <div class="support-message ${cssClass}">
                        <div>${text}</div>
                        <div class="support-message-meta">${escapeHtml(name)} · ${createdAt}</div>
                    </div>
                `;
            }).join('');
            listEl.scrollTop = listEl.scrollHeight;
        }

        function clearSupportMessageSubscription() {
            if (typeof supportMessagesUnsubscribe === 'function') {
                supportMessagesUnsubscribe();
            }
            supportMessagesUnsubscribe = null;
        }

        function clearSupportThreadSubscription() {
            if (typeof supportThreadsUnsubscribe === 'function') {
                supportThreadsUnsubscribe();
            }
            supportThreadsUnsubscribe = null;
        }

        async function selectSupportThread(threadId) {
            if (!canUseSupportChat()) return;
            const id = String(threadId || '').trim();
            if (!id) return;
            activeSupportThreadId = id;
            supportMessages = [];
            renderSupportThreads();
            renderSupportMessages();

            try {
                await requireAdminPermission();
            } catch (error) {
                handleSupportAccessError(error, 'selectSupportThread.requireAdminPermission');
                return;
            }

            clearSupportMessageSubscription();
            if (typeof subscribeSupportMessages === 'function') {
                supportMessagesUnsubscribe = subscribeSupportMessages(
                    id,
                    async (rows) => {
                        supportMessages = Array.isArray(rows) ? rows : [];
                        renderSupportMessages();
                        if (typeof markSupportThreadReadByAdmin === 'function') {
                            await markSupportThreadReadByAdmin(id).catch(() => null);
                        }
                        supportThreads = (supportThreads || []).map((item) => (
                            String(item && item.id || '') === id
                                ? { ...item, unreadForAdmin: 0, updatedAt: new Date().toISOString() }
                                : item
                        ));
                        renderSupportThreads();
                    },
                    (error) => {
                        if (handleSupportAccessError(error, 'selectSupportThread.listener')) {
                            clearSupportMessageSubscription();
                            return;
                        }
                        logWarnOnce(
                            'selectSupportThread.listener.warning',
                            'support messages listener warning:',
                            String(error && error.message ? error.message : error)
                        );
                    },
                    300
                );
            } else if (typeof getSupportMessages === 'function') {
                try {
                    supportMessages = await getSupportMessages(id, 300, { strict: true });
                    renderSupportMessages();
                } catch (error) {
                    handleSupportAccessError(error, 'selectSupportThread.getSupportMessages');
                }
            }
        }

        async function refreshSupportThreads() {
            try {
                if (supportAccess.denied) {
                    showNotification('info', 'جاري إعادة التحقق من صلاحيات الدردشة...');
                }
                await requireAdminPermission();
                if (typeof getSupportThreads !== 'function') throw new Error('support API unavailable');
                supportThreads = await getSupportThreads(200, { strict: true });
                clearSupportAccessState();
                renderSupportThreads();
                renderSupportMessages();
                if (!activeSupportThreadId && supportThreads.length > 0) {
                    await selectSupportThread(String(supportThreads[0].id || ''));
                }
                showNotification('success', 'تم تحديث المحادثات');
            } catch (error) {
                if (handleSupportAccessError(error, 'refreshSupportThreads')) return;
                logWarnOnce(
                    'refreshSupportThreads.warning',
                    'refreshSupportThreads warning:',
                    String(error && error.message ? error.message : error)
                );
                showNotification('error', 'فشل تحديث المحادثات');
            }
        }

        async function startSupportChatRealtime() {
            if (supportThreadsUnsubscribe || typeof subscribeSupportThreads !== 'function') {
                renderSupportThreads();
                renderSupportMessages();
                return;
            }

            if (!canUseSupportChat(false)) {
                renderSupportThreads();
                renderSupportMessages();
                return;
            }

            try {
                await requireAdminPermission();
            } catch (error) {
                if (handleSupportAccessError(error, 'startSupportChatRealtime.requireAdminPermission')) return;
                logWarnOnce(
                    'startSupportChatRealtime.requireAdminPermission.warning',
                    'support realtime admin permission warning:',
                    String(error && error.message ? error.message : error)
                );
                return;
            }

            supportThreadsUnsubscribe = subscribeSupportThreads(
                (rows) => {
                    const previousActive = String(activeSupportThreadId || '');
                    supportThreads = Array.isArray(rows) ? rows : [];
                    if (previousActive && !getSupportThreadById(previousActive)) {
                        activeSupportThreadId = '';
                        supportMessages = [];
                        clearSupportMessageSubscription();
                    }
                    renderSupportThreads();
                    renderSupportMessages();
                    if (!activeSupportThreadId && supportThreads.length > 0) {
                        selectSupportThread(String(supportThreads[0].id || ''));
                    }
                },
                (error) => {
                    if (handleSupportAccessError(error, 'startSupportChatRealtime.listener')) {
                        stopSupportChatRealtime();
                        return;
                    }
                    logWarnOnce(
                        'startSupportChatRealtime.listener.warning',
                        'support threads listener warning:',
                        String(error && error.message ? error.message : error)
                    );
                },
                250
            );
        }

        function stopSupportChatRealtime() {
            clearSupportMessageSubscription();
            clearSupportThreadSubscription();
            supportMessages = [];
            activeSupportThreadId = '';
            updateSupportAccessUi();
        }

        async function sendSupportReply() {
            if (!canUseSupportChat()) return;
            const thread = getSupportThreadById(activeSupportThreadId);
            const input = document.getElementById('supportReplyInput');
            if (!thread || !input) return;
            if (String(thread.status || 'open') === 'closed') {
                showNotification('error', 'المحادثة مغلقة');
                return;
            }
            const message = String(input.value || '').trim();
            if (!message) return;

            try {
                await requireAdminPermission();
                const authUser = firebase && firebase.auth ? firebase.auth().currentUser : null;
                const senderUid = authUser && authUser.uid ? String(authUser.uid) : '';
                if (!senderUid) {
                    showNotification('error', 'جلسة الأدمن غير متاحة');
                    return;
                }
                const senderName = authUser && authUser.email ? String(authUser.email) : 'admin';
                await addSupportMessage({
                    threadId: String(thread.id || ''),
                    senderRole: 'admin',
                    senderUid,
                    senderName,
                    message,
                    createdAt: new Date().toISOString(),
                    createdAtMs: Date.now()
                });
                input.value = '';
            } catch (error) {
                if (handleSupportAccessError(error, 'sendSupportReply')) return;
                logWarnOnce(
                    'sendSupportReply.warning',
                    'sendSupportReply warning:',
                    String(error && error.message ? error.message : error)
                );
                showNotification('error', 'فشل إرسال الرد');
            }
        }

        async function closeActiveSupportThread() {
            if (!canUseSupportChat()) return;
            const thread = getSupportThreadById(activeSupportThreadId);
            if (!thread) {
                showNotification('error', 'اختر محادثة أولًا');
                return;
            }
            if (!confirm('إغلاق هذه المحادثة؟')) return;

            try {
                await requireAdminPermission();
                if (typeof closeSupportThread !== 'function') throw new Error('closeSupportThread unavailable');
                await closeSupportThread(thread.id);
                supportThreads = (supportThreads || []).map((item) => (
                    String(item && item.id || '') === String(thread.id || '')
                        ? { ...item, status: 'closed', updatedAt: new Date().toISOString() }
                        : item
                ));
                renderSupportThreads();
                renderSupportMessages();
                showNotification('success', 'تم إغلاق المحادثة');
            } catch (error) {
                if (handleSupportAccessError(error, 'closeActiveSupportThread')) return;
                logWarnOnce(
                    'closeActiveSupportThread.warning',
                    'closeActiveSupportThread warning:',
                    String(error && error.message ? error.message : error)
                );
                showNotification('error', 'فشل إغلاق المحادثة');
            }
        }

        // ============================================
        // Loyalty
        // ============================================
        function renderLoyaltySection() {
            const total = users.reduce((s, u) => s + (u.loyaltyPoints || 0), 0);
            document.getElementById('totalLoyalty').textContent = total;
            document.getElementById('loyaltyRate').textContent = storeSettings.loyalty?.rate || 5;
            document.getElementById('loyaltyRateInput').value = storeSettings.loyalty?.rate || 5;
            document.getElementById('pointValueInput').value = storeSettings.loyalty?.pointValue || 0.1;

            const list = document.getElementById('loyaltyUsersList');
            const select = document.getElementById('pointsUserId');

            if (users.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👥</div><p>لا يوجد عملاء</p></div>';
                select.innerHTML = '<option value="">لا يوجد</option>';
                return;
            }

            list.innerHTML = users.map((u) => {
                const safeUserId = escapeHtml(String(u && u.id || ''));
                const safeName = escapeHtml(getUserDisplayName(u));
                const safeAvatar = escapeHtml(getUserDisplayName(u).charAt(0));
                const safePhone = escapeHtml(u && u.phone || '-');
                const safePoints = escapeHtml(Number(u && u.loyaltyPoints || 0).toFixed(0));
                return `
                <div class="user-points-card">
                    <div class="user-points-info">
                        <div class="user-points-avatar">${safeAvatar}</div>
                        <div><strong>${safeName}</strong><div style="font-size:11px;color:#666;">${safePhone}</div></div>
                    </div>
                    <strong style="color: var(--gold-dark); font-size: 18px;">${safePoints}</strong>
                    <div class="user-points-actions">
                        <button class="points-btn add" data-user-id="${safeUserId}" onclick="quickAddPoints(this.dataset.userId)">➕</button>
                        <button class="points-btn sub" data-user-id="${safeUserId}" onclick="quickSubPoints(this.dataset.userId)">➖</button>
                    </div>
                </div>
            `;
            }).join('');

            select.innerHTML = '<option value="">اختر</option>' + users.map((u) => {
                const safeUserId = escapeHtml(String(u && u.id || ''));
                const safeName = escapeHtml(getUserDisplayName(u));
                const safePoints = escapeHtml(Number(u && u.loyaltyPoints || 0).toFixed(0));
                return `<option value="${safeUserId}">${safeName} (${safePoints})</option>`;
            }).join('');
        }

        function saveLoyaltySettings(e) {
            e.preventDefault();
            storeSettings.loyalty = {
                rate: parseFloat(document.getElementById('loyaltyRateInput').value),
                pointValue: parseFloat(document.getElementById('pointValueInput').value)
            };
            saveStoreSettings();
            renderLoyaltySection();
            showNotification('success', 'تم الحفظ');
        }

        async function quickAddPoints(userId) {
            const pts = prompt('عدد النقاط:');
            if (pts && !isNaN(pts)) {
                const u = users.find(x => x.id === userId);
                if (u) {
                    u.loyaltyPoints = (u.loyaltyPoints || 0) + parseInt(pts);
                    try {
                        if (typeof updateCustomer === 'function') {
                            await updateCustomer(u.id, { loyaltyPoints: u.loyaltyPoints });
                        }
                    } catch (error) {
                        console.error('quickAddPoints firebase update error:', error);
                    }
                    saveUsers();
                    renderLoyaltySection();
                    renderUsersTable();
                    updateStats();
                    showNotification('success', `تم إضافة ${pts} نقطة`);
                }
            }
        }

        async function quickSubPoints(userId) {
            const pts = prompt('عدد النقاط:');
            if (pts && !isNaN(pts)) {
                const u = users.find(x => x.id === userId);
                if (u) {
                    u.loyaltyPoints = Math.max(0, (u.loyaltyPoints || 0) - parseInt(pts));
                    try {
                        if (typeof updateCustomer === 'function') {
                            await updateCustomer(u.id, { loyaltyPoints: u.loyaltyPoints });
                        }
                    } catch (error) {
                        console.error('quickSubPoints firebase update error:', error);
                    }
                    saveUsers();
                    renderLoyaltySection();
                    renderUsersTable();
                    updateStats();
                    showNotification('success', `تم خصم ${pts} نقطة`);
                }
            }
        }

        async function handlePointsAction(e) {
            e.preventDefault();
            const userId = String(document.getElementById('pointsUserId').value || '');
            const action = document.getElementById('pointsAction').value;
            const amount = parseInt(document.getElementById('pointsAmount').value);
            const u = users.find(x => String(x.id) === userId);
            if (!u) { showNotification('error', 'اختر عميل'); return; }
            if (action === 'add') u.loyaltyPoints = (u.loyaltyPoints || 0) + amount;
            else u.loyaltyPoints = Math.max(0, (u.loyaltyPoints || 0) - amount);
            try {
                if (typeof updateCustomer === 'function') {
                    await updateCustomer(u.id, { loyaltyPoints: u.loyaltyPoints });
                }
            } catch (error) {
                console.error('handlePointsAction firebase update error:', error);
            }
            saveUsers();
            renderLoyaltySection();
            renderUsersTable();
            updateStats();
            closeModal('pointsModal');
            showNotification('success', 'تم');
        }

        // ============================================
        // Store Settings
        // ============================================
        function loadSettingsToForms() {
            document.getElementById('storeName').value = storeSettings.name || '';
            document.getElementById('storeTagline').value = storeSettings.tagline || '';
            document.getElementById('storeDescription').value = storeSettings.description || '';
            document.getElementById('storeFaqIntents').value = JSON.stringify(storeSettings.faqIntents || [], null, 2);
            document.getElementById('tawkPropertyId').value = storeSettings.chatSupport?.tawkPropertyId || '';
            document.getElementById('tawkWidgetId').value = storeSettings.chatSupport?.tawkWidgetId || '';
            document.getElementById('tawkEnabled').checked = storeSettings.chatSupport?.enableTawk === true;
            document.getElementById('topBarText').value = storeSettings.topBar?.text || '';
            document.getElementById('topBarBgColor').value = storeSettings.topBar?.bgColor || '#0A1128';
            document.getElementById('topBarTextColor').value = storeSettings.topBar?.textColor || '#F4E4BC';
            document.getElementById('topBarEnabled').checked = storeSettings.topBar?.enabled !== false;
            document.getElementById('contactPhone').value = storeSettings.contact?.phone || '';
            document.getElementById('contactWhatsapp').value = storeSettings.contact?.whatsapp || '';
            document.getElementById('contactEmail').value = storeSettings.contact?.email || '';
            document.getElementById('contactAddress').value = storeSettings.contact?.address || '';
            document.getElementById('footerAbout').value = storeSettings.footer?.about || '';
            document.getElementById('workingHoursWeekdays').value = storeSettings.footer?.workingHoursWeekdays || '';
            document.getElementById('workingHoursFriday').value = storeSettings.footer?.workingHoursFriday || '';
            document.getElementById('workingHoursNote').value = storeSettings.footer?.workingHoursNote || '';
            document.getElementById('copyrightText').value = storeSettings.footer?.copyright || '';
        }

        function saveGeneralSettings(e) {
            e.preventDefault();
            storeSettings.name = document.getElementById('storeName').value.trim();
            storeSettings.tagline = document.getElementById('storeTagline').value.trim();
            storeSettings.description = document.getElementById('storeDescription').value.trim();
            const faqRaw = document.getElementById('storeFaqIntents').value.trim();
            if (faqRaw) {
                try {
                    const parsed = JSON.parse(faqRaw);
                    storeSettings.faqIntents = Array.isArray(parsed) ? parsed : [];
                } catch (error) {
                    showNotification('error', 'JSON FAQ غير صالح');
                    return;
                }
            } else {
                storeSettings.faqIntents = [];
            }
            storeSettings.chatSupport = {
                enableTawk: document.getElementById('tawkEnabled').checked,
                tawkPropertyId: document.getElementById('tawkPropertyId').value.trim(),
                tawkWidgetId: document.getElementById('tawkWidgetId').value.trim()
            };
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function saveTopBarSettings(e) {
            e.preventDefault();
            storeSettings.topBar = {
                enabled: document.getElementById('topBarEnabled').checked,
                text: document.getElementById('topBarText').value.trim(),
                bgColor: document.getElementById('topBarBgColor').value,
                textColor: document.getElementById('topBarTextColor').value
            };
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function saveFooterSettings(e) {
            e.preventDefault();
            storeSettings.footer = {
                about: document.getElementById('footerAbout').value.trim(),
                workingHoursWeekdays: document.getElementById('workingHoursWeekdays').value.trim(),
                workingHoursFriday: document.getElementById('workingHoursFriday').value.trim(),
                workingHoursNote: document.getElementById('workingHoursNote').value.trim(),
                copyright: document.getElementById('copyrightText').value.trim()
            };
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function saveContactSettings(e) {
            e.preventDefault();
            storeSettings.contact = {
                phone: document.getElementById('contactPhone').value.trim(),
                whatsapp: document.getElementById('contactWhatsapp').value.trim(),
                email: document.getElementById('contactEmail').value.trim(),
                address: document.getElementById('contactAddress').value.trim()
            };
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function switchTab(name) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + 'Tab').classList.add('active');
        }

        // ============================================
        // Client Error Logs (Mobile / Tablet Monitoring)
        // ============================================
        function escapeHtml(value) {
            if (window.SecurityUtils && typeof window.SecurityUtils.escapeHtml === 'function') {
                return window.SecurityUtils.escapeHtml(value);
            }
            return String(value === null || value === undefined ? '' : value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getDeviceLabel(userAgent = '') {
            const ua = String(userAgent).toLowerCase();
            if (ua.includes('ipad') || ua.includes('tablet')) return 'Tablet';
            if (ua.includes('android') && !ua.includes('mobile')) return 'Tablet';
            if (ua.includes('mobile') || ua.includes('iphone') || ua.includes('android')) return 'Mobile';
            return 'Desktop';
        }

        function renderClientErrorLogsTable() {
            const tbody = document.getElementById('clientErrorLogsTable');
            const meta = document.getElementById('clientErrorsMeta');
            if (!tbody || !meta) return;

            if (!Array.isArray(clientErrorLogs) || clientErrorLogs.length === 0) {
                meta.textContent = 'لا توجد أخطاء مسجلة حاليًا.';
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">✅</div><p>لا توجد أخطاء عملاء</p></div></td></tr>';
                return;
            }

            meta.textContent = `عدد السجلات: ${clientErrorLogs.length}`;
            tbody.innerHTML = clientErrorLogs.map(log => {
                const context = log.context || {};
                const device = getDeviceLabel(context.userAgent || '');
                const online = context.online === false ? 'Offline' : 'Online';
                return `
                    <tr>
                        <td>${formatDateTime(log.timestamp)}</td>
                        <td><strong>${escapeHtml(log.type || '-')}</strong></td>
                        <td style="max-width: 260px; white-space: normal; word-break: break-word;">${escapeHtml(log.message || '-')}</td>
                        <td style="max-width: 220px; white-space: normal; word-break: break-word;">${escapeHtml(context.page || log.source || '-')}</td>
                        <td>${escapeHtml(device)}</td>
                        <td>${escapeHtml(online)}</td>
                    </tr>
                `;
            }).join('');
        }

        async function refreshClientErrorLogs() {
            try {
                if (typeof requireAdminPermission === 'function') {
                    await requireAdminPermission();
                }

                if (typeof getClientErrorLogs === 'function') {
                    clientErrorLogs = await getClientErrorLogs(50) || [];
                } else {
                    const localErrors = JSON.parse(localStorage.getItem('adminErrors') || '[]');
                    clientErrorLogs = localErrors.slice(-50).reverse();
                }

                renderClientErrorLogsTable();
                showNotification('success', 'تم تحديث سجل الأخطاء');
            } catch (error) {
                console.error('refreshClientErrorLogs error:', error);
                showNotification('error', 'فشل تحديث سجل الأخطاء');
            }
        }

        function exportClientErrorsExcel() {
            const rows = (clientErrorLogs || []).map(log => {
                const context = log.context || {};
                return {
                    'الوقت': formatDateTime(log.timestamp),
                    'النوع': log.type || '',
                    'الرسالة': log.message || '',
                    'المصدر': log.source || '',
                    'الصفحة': context.page || '',
                    'الحالة': context.online === false ? 'Offline' : 'Online',
                    'الجهاز': getDeviceLabel(context.userAgent || ''),
                    'المتصفح': context.userAgent || ''
                };
            });
            exportToExcel(rows, 'client-errors');
        }

        // ============================================
        // Store Operations Monitoring (Live by second)
        // ============================================
        function levelClass(level) {
            const normalized = String(level || 'info').toLowerCase();
            if (normalized === 'error') return 'status-cancelled';
            if (normalized === 'warning' || normalized === 'warn') return 'status-pending';
            return 'status-confirmed';
        }

        function safeJsonPreview(value) {
            try {
                const raw = JSON.stringify(value || {});
                if (raw.length <= 220) return raw;
                return `${raw.slice(0, 220)}...`;
            } catch (_) {
                return '{}';
            }
        }

        function updateStoreOpsAccessUi() {
            const noticeEl = document.getElementById('storeOpsAccessNotice');
            const liveBadge = document.getElementById('storeOpsLiveBadge');

            if (noticeEl) {
                if (storeOpsAccess.denied) {
                    const source = String(storeOpsAccess.source || 'store-ops');
                    noticeEl.textContent = `تعذر تشغيل المراقبة اللحظية بسبب الصلاحيات (source: ${source}). باقي لوحة الأدمن تعمل طبيعي.`;
                    noticeEl.style.display = 'block';
                } else {
                    noticeEl.style.display = 'none';
                    noticeEl.textContent = '';
                }
            }

            if (!liveBadge) return;
            if (storeOpsAccess.denied) {
                liveBadge.textContent = 'LOCKED';
                liveBadge.className = 'status-badge status-cancelled';
                return;
            }
            if (storeEventsUnsubscribe || liveSessionsUnsubscribe) {
                liveBadge.textContent = 'LIVE';
                liveBadge.className = 'status-badge status-confirmed';
                return;
            }
            liveBadge.textContent = 'IDLE';
            liveBadge.className = 'status-badge status-pending';
        }

        function clearStoreOpsAccessState() {
            storeOpsAccess.denied = false;
            storeOpsAccess.reason = '';
            storeOpsAccess.source = '';
            storeOpsAccess.notifiedReason = '';
            updateStoreOpsAccessUi();
        }

        function handleStoreOpsAccessError(error, source = '') {
            const denied = isPermissionDenied(error);
            if (!denied) return false;

            const reason = String(error && (error.message || error.reason) || error || 'unknown store ops access error').trim();
            const normalizedSource = String(source || 'store-ops');
            storeOpsAccess.denied = true;
            storeOpsAccess.reason = reason;
            storeOpsAccess.source = normalizedSource;

            if (storeOpsAccess.notifiedReason !== reason) {
                storeOpsAccess.notifiedReason = reason;
                showNotification('error', 'تعذر تشغيل المراقبة اللحظية بسبب الصلاحيات. باقي لوحة الأدمن تعمل طبيعي.');
            }

            warnPermissionDeniedOnce(normalizedSource, error, 'store operations access denied');
            stopStoreOperationsMonitoring();
            storeEvents = [];
            liveSessions = [];
            renderStoreEventsTable();
            renderLiveSessionsTable();
            updateStoreOpsAccessUi();
            return true;
        }

        function canUseStoreOps(notify = true) {
            if (storeOpsAccess.denied) {
                updateStoreOpsAccessUi();
                if (notify) {
                    showNotification('error', 'المراقبة اللحظية متوقفة حاليًا بسبب الصلاحيات.');
                }
                return false;
            }
            return true;
        }

        function renderStoreEventsTable() {
            const tbody = document.getElementById('storeEventsTable');
            const meta = document.getElementById('storeEventsMeta');
            const countEl = document.getElementById('storeEventsCount');
            const lastEl = document.getElementById('lastStoreEventAt');
            if (!tbody || !meta || !countEl || !lastEl) return;

            const rows = Array.isArray(storeEvents) ? storeEvents : [];
            countEl.textContent = String(rows.length);
            lastEl.textContent = rows.length ? formatDateTime(rows[0].timestamp) : '-';

            if (!rows.length) {
                meta.textContent = 'لا توجد أحداث تشغيلية حتى الآن.';
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">🛰️</div><p>لا توجد أحداث</p></div></td></tr>';
                return;
            }

            meta.textContent = `عدد الأحداث: ${rows.length}`;
            tbody.innerHTML = rows.map((ev) => `
                <tr>
                    <td>${formatDateTime(ev.timestamp)}</td>
                    <td><span class="status-badge ${levelClass(ev.level)}">${escapeHtml(ev.level || 'info')}</span></td>
                    <td><strong>${escapeHtml(ev.type || '-')}</strong></td>
                    <td style="max-width: 260px; white-space: normal; word-break: break-word;">${escapeHtml(ev.message || '-')}</td>
                    <td>${escapeHtml(ev.source || '-')}</td>
                    <td style="max-width: 240px; white-space: normal; word-break: break-word;">${escapeHtml(safeJsonPreview(ev.meta || {}))}</td>
                </tr>
            `).join('');
        }

        function renderLiveSessionsTable() {
            const tbody = document.getElementById('liveSessionsTable');
            const meta = document.getElementById('liveSessionsMeta');
            const countEl = document.getElementById('liveSessionsCount');
            if (!tbody || !meta || !countEl) return;

            const now = Date.now();
            const sessions = Array.isArray(liveSessions) ? liveSessions : [];
            // Session heartbeats can be ~45s on mobile; keep a generous window to avoid false "Idle".
            const ACTIVE_SESSION_WINDOW_MS = 90000;
            const active = sessions.filter((s) => {
                const ts = Date.parse(String(s.updatedAt || ''));
                return Number.isFinite(ts) && (now - ts) <= ACTIVE_SESSION_WINDOW_MS;
            });
            countEl.textContent = String(active.length);

            if (!sessions.length) {
                meta.textContent = 'لا توجد جلسات مباشرة حالياً.';
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">📴</div><p>لا توجد جلسات</p></div></td></tr>';
                return;
            }

            meta.textContent = `جلسات نشطة: ${active.length} / إجمالي مرصود: ${sessions.length}`;
            tbody.innerHTML = sessions.map((s) => {
                const ts = Date.parse(String(s.updatedAt || ''));
                const isActive = Number.isFinite(ts) && (now - ts) <= ACTIVE_SESSION_WINDOW_MS;
                const device = getDeviceLabel(s.userAgent || s.device || '');
                return `
                    <tr>
                        <td>${escapeHtml(s.sessionId || s.id || '-')}</td>
                        <td>${escapeHtml(device)}</td>
                        <td>${escapeHtml(s.customerPhone || s.customerId || '-')}</td>
                        <td style="max-width: 220px; white-space: normal; word-break: break-word;">${escapeHtml(s.page || '-')}</td>
                        <td>${formatDateTime(s.updatedAt)}</td>
                        <td><span class="status-badge ${isActive ? 'status-confirmed' : 'status-pending'}">${isActive ? 'Online' : 'Idle'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function stopStoreOperationsMonitoring() {
            if (typeof storeEventsUnsubscribe === 'function') storeEventsUnsubscribe();
            if (typeof liveSessionsUnsubscribe === 'function') liveSessionsUnsubscribe();
            storeEventsUnsubscribe = null;
            liveSessionsUnsubscribe = null;
            updateStoreOpsAccessUi();
        }

        async function startStoreOperationsMonitoring() {
            const liveBadge = document.getElementById('storeOpsLiveBadge');
            if (storeEventsUnsubscribe || liveSessionsUnsubscribe) return;
            if (!canUseStoreOps(false)) return;

            if (typeof subscribeStoreEvents !== 'function' || typeof subscribeLiveSessions !== 'function') {
                if (liveBadge) liveBadge.textContent = 'N/A';
                return;
            }

            try {
                await requireAdminPermission();
                clearStoreOpsAccessState();
            } catch (error) {
                handleStoreOpsAccessError(error, 'startStoreOperationsMonitoring.requireAdminPermission');
                return;
            }

            storeEventsUnsubscribe = subscribeStoreEvents((rows) => {
                storeEvents = rows || [];
                renderStoreEventsTable();
            }, (error) => {
                if (handleStoreOpsAccessError(error, 'startStoreOperationsMonitoring.storeEventsListener')) return;
                logWarnOnce(
                    'startStoreOperationsMonitoring.storeEventsListener.warning',
                    'store events listener warning:',
                    String(error && error.message ? error.message : error)
                );
            }, 100);

            liveSessionsUnsubscribe = subscribeLiveSessions((rows) => {
                liveSessions = rows || [];
                renderLiveSessionsTable();
            }, (error) => {
                if (handleStoreOpsAccessError(error, 'startStoreOperationsMonitoring.liveSessionsListener')) return;
                logWarnOnce(
                    'startStoreOperationsMonitoring.liveSessionsListener.warning',
                    'live sessions listener warning:',
                    String(error && error.message ? error.message : error)
                );
            }, 200);

            if (liveBadge) liveBadge.textContent = 'LIVE';
            updateStoreOpsAccessUi();
        }

        async function refreshStoreOperationsNow() {
            if (!canUseStoreOps()) return;
            try {
                await requireAdminPermission();
                clearStoreOpsAccessState();
                if (typeof getStoreEvents === 'function') {
                    storeEvents = await getStoreEvents(100) || [];
                }
                if (typeof db !== 'undefined' && db && db.collection) {
                    const snapshot = await db.collection('store_live_sessions').orderBy('updatedAt', 'desc').limit(200).get();
                    liveSessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                renderStoreEventsTable();
                renderLiveSessionsTable();
                showNotification('success', 'تم تحديث التشغيل اللحظي');
            } catch (error) {
                if (handleStoreOpsAccessError(error, 'refreshStoreOperationsNow')) return;
                logWarnOnce(
                    'refreshStoreOperationsNow.warning',
                    'refreshStoreOperationsNow warning:',
                    String(error && error.message ? error.message : error)
                );
                showNotification('error', 'فشل تحديث التشغيل اللحظي');
            }
        }

        function getAdminFunctionLevelLabel(level) {
            const normalized = String(level || '').toLowerCase();
            if (normalized === 'critical') return 'حرج';
            if (normalized === 'warning') return 'تحذيري';
            return 'معلوماتي';
        }

        function getAdminFunctionGroupLabel(group) {
            const map = {
                products: 'المنتجات',
                orders: 'الطلبات',
                banners: 'البانرات',
                coupons: 'الكوبونات',
                users: 'العملاء',
                support: 'الدعم',
                loyalty: 'الولاء',
                settings: 'الإعدادات',
                reports: 'التقارير',
                system: 'النظام',
                utility: 'مساعدة'
            };
            return map[String(group || '').toLowerCase()] || 'غير مصنف';
        }

        function getImpactLabel(value) {
            const normalized = String(value || '').toLowerCase();
            if (normalized === 'direct') return 'مباشر';
            if (normalized === 'indirect') return 'غير مباشر';
            return 'لا يوجد';
        }

        function getPersistenceLabel(value) {
            const normalized = String(value || '').toLowerCase();
            if (normalized === 'firebase_online') return 'أونلاين';
            if (normalized === 'hybrid') return 'هجين';
            if (normalized === 'local_temporary') return 'محلي مؤقت';
            return 'ذاكرة فقط';
        }

        function getAdminFunctionStatusClass(status) {
            const normalized = String(status || '').toLowerCase();
            if (normalized === 'fail') return 'status-cancelled';
            if (normalized === 'warn') return 'status-pending';
            return 'status-confirmed';
        }

        function sanitizeAdminFunctionEntry(entry) {
            const safe = entry && typeof entry === 'object' ? entry : {};
            const status = ['ok', 'warn', 'fail'].includes(String(safe.status || '').toLowerCase())
                ? String(safe.status || '').toLowerCase()
                : 'ok';
            const level = ['critical', 'warning', 'info'].includes(String(safe.monitorLevel || '').toLowerCase())
                ? String(safe.monitorLevel || '').toLowerCase()
                : 'info';
            const storeImpact = ['direct', 'indirect', 'none'].includes(String(safe.storeImpact || '').toLowerCase())
                ? String(safe.storeImpact || '').toLowerCase()
                : 'none';
            const mobileImpact = ['direct', 'indirect', 'none'].includes(String(safe.mobileImpact || '').toLowerCase())
                ? String(safe.mobileImpact || '').toLowerCase()
                : 'none';
            const persistenceMode = ['firebase_online', 'hybrid', 'local_temporary', 'memory_only'].includes(String(safe.persistenceMode || '').toLowerCase())
                ? String(safe.persistenceMode || '').toLowerCase()
                : 'memory_only';
            return {
                name: String(safe.name || ''),
                monitorLevel: level,
                status,
                reasonCode: String(safe.reasonCode || ''),
                reasonText: String(safe.reasonText || ''),
                group: String(safe.group || 'utility').toLowerCase(),
                storeImpact,
                mobileImpact,
                persistenceMode
            };
        }

        function renderAdminFunctionSummary() {
            const totalEl = document.getElementById('adminFunctionsTotal');
            const criticalEl = document.getElementById('adminFunctionsCritical');
            const storeDirectEl = document.getElementById('adminFunctionsStoreDirect');
            const mobileDirectEl = document.getElementById('adminFunctionsMobileDirect');
            const failuresEl = document.getElementById('adminFunctionsFailures');
            const metaEl = document.getElementById('adminFunctionsMeta');
            const impactSummaryEl = document.getElementById('adminFunctionsImpactSummary');
            const persistenceSummaryEl = document.getElementById('adminFunctionsPersistenceSummary');

            const total = Array.isArray(adminFunctionRegistry) ? adminFunctionRegistry.length : 0;
            const critical = adminFunctionRegistry.filter((item) => item.monitorLevel === 'critical').length;
            const storeDirect = adminFunctionRegistry.filter((item) => item.storeImpact === 'direct').length;
            const mobileDirect = adminFunctionRegistry.filter((item) => item.mobileImpact === 'direct').length;
            const failures = adminFunctionRegistry.filter((item) => item.status === 'fail').length;
            const filtered = Array.isArray(adminFunctionRegistryFiltered) ? adminFunctionRegistryFiltered.length : 0;
            const storeIndirect = adminFunctionRegistry.filter((item) => item.storeImpact === 'indirect').length;
            const storeNone = adminFunctionRegistry.filter((item) => item.storeImpact === 'none').length;
            const mobileIndirect = adminFunctionRegistry.filter((item) => item.mobileImpact === 'indirect').length;
            const mobileNone = adminFunctionRegistry.filter((item) => item.mobileImpact === 'none').length;
            const firebaseOnline = adminFunctionRegistry.filter((item) => item.persistenceMode === 'firebase_online').length;
            const hybrid = adminFunctionRegistry.filter((item) => item.persistenceMode === 'hybrid').length;
            const localTemporary = adminFunctionRegistry.filter((item) => item.persistenceMode === 'local_temporary').length;
            const memoryOnly = adminFunctionRegistry.filter((item) => item.persistenceMode === 'memory_only').length;

            if (totalEl) totalEl.textContent = String(total);
            if (criticalEl) criticalEl.textContent = String(critical);
            if (storeDirectEl) storeDirectEl.textContent = String(storeDirect);
            if (mobileDirectEl) mobileDirectEl.textContent = String(mobileDirect);
            if (failuresEl) failuresEl.textContent = String(failures);

            if (metaEl) {
                const generatedAt = adminFunctionRegistryMeta && adminFunctionRegistryMeta.generatedAt
                    ? formatDateTime(adminFunctionRegistryMeta.generatedAt)
                    : '-';
                const generatorVersion = adminFunctionRegistryMeta && adminFunctionRegistryMeta.generatorVersion
                    ? String(adminFunctionRegistryMeta.generatorVersion)
                    : '-';
                metaEl.textContent = `الدوال: ${total} | المعروضة: ${filtered} | نسخة المولد: ${generatorVersion} | التوليد: ${generatedAt}`;
            }

            if (impactSummaryEl) {
                impactSummaryEl.textContent = `تأثير المتجر (مباشر: ${storeDirect} | غير مباشر: ${storeIndirect} | لا يوجد: ${storeNone}) • تأثير الموبايل (مباشر: ${mobileDirect} | غير مباشر: ${mobileIndirect} | لا يوجد: ${mobileNone})`;
            }

            if (persistenceSummaryEl) {
                persistenceSummaryEl.textContent = `نمط الحفظ: Firebase أونلاين ${firebaseOnline} | هجين ${hybrid} | محلي مؤقت ${localTemporary} | ذاكرة فقط ${memoryOnly}`;
            }
        }

        function renderAdminFunctionTable() {
            const tbody = document.getElementById('adminFunctionsTable');
            if (!tbody) return;

            const rows = Array.isArray(adminFunctionRegistryFiltered) ? adminFunctionRegistryFiltered : [];
            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="empty-state-icon">🧭</div><p>لا توجد نتائج مطابقة للفلاتر.</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = rows.map((item) => {
                const name = escapeHtml(item.name || '-');
                const levelLabel = escapeHtml(getAdminFunctionLevelLabel(item.monitorLevel));
                const statusLabel = item.status === 'fail' ? 'فشل' : (item.status === 'warn' ? 'تحذير' : 'سليم');
                const reason = escapeHtml(item.reasonText || item.reasonCode || 'لا توجد ملاحظات');
                const groupLabel = escapeHtml(getAdminFunctionGroupLabel(item.group));
                const storeImpact = escapeHtml(getImpactLabel(item.storeImpact));
                const mobileImpact = escapeHtml(getImpactLabel(item.mobileImpact));
                const persistence = escapeHtml(getPersistenceLabel(item.persistenceMode));
                const levelClassName = item.monitorLevel === 'critical' ? 'status-cancelled' : (item.monitorLevel === 'warning' ? 'status-pending' : 'status-confirmed');
                const statusClassName = getAdminFunctionStatusClass(item.status);

                return `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td><span class="status-badge ${levelClassName}">${levelLabel}</span></td>
                        <td><span class="status-badge ${statusClassName}">${escapeHtml(statusLabel)}</span></td>
                        <td style="max-width: 280px; white-space: normal; word-break: break-word;">${reason}</td>
                        <td>${groupLabel}</td>
                        <td>${storeImpact}</td>
                        <td>${mobileImpact}</td>
                        <td>${persistence}</td>
                    </tr>
                `;
            }).join('');
        }

        function applyAdminFunctionFilters() {
            const searchValue = String(document.getElementById('adminFunctionsSearch')?.value || '').trim().toLowerCase();
            const levelFilter = String(document.getElementById('adminFunctionsLevelFilter')?.value || '').trim().toLowerCase();
            const groupFilter = String(document.getElementById('adminFunctionsGroupFilter')?.value || '').trim().toLowerCase();
            const storeImpactFilter = String(document.getElementById('adminFunctionsStoreImpactFilter')?.value || '').trim().toLowerCase();
            const mobileImpactFilter = String(document.getElementById('adminFunctionsMobileImpactFilter')?.value || '').trim().toLowerCase();
            const persistenceFilter = String(document.getElementById('adminFunctionsPersistenceFilter')?.value || '').trim().toLowerCase();

            adminFunctionRegistryFiltered = adminFunctionRegistry.filter((item) => {
                if (searchValue && !String(item.name || '').toLowerCase().includes(searchValue)) return false;
                if (levelFilter && String(item.monitorLevel || '').toLowerCase() !== levelFilter) return false;
                if (groupFilter && String(item.group || '').toLowerCase() !== groupFilter) return false;
                if (storeImpactFilter && String(item.storeImpact || '').toLowerCase() !== storeImpactFilter) return false;
                if (mobileImpactFilter && String(item.mobileImpact || '').toLowerCase() !== mobileImpactFilter) return false;
                if (persistenceFilter && String(item.persistenceMode || '').toLowerCase() !== persistenceFilter) return false;
                return true;
            });

            renderAdminFunctionSummary();
            renderAdminFunctionTable();
        }

        async function refreshAdminFunctionMonitorView() {
            try {
                const response = await fetch(`./monitoring/admin-function-registry.json?t=${Date.now()}`, { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error(`registry-fetch-${response.status}`);
                }
                const payload = await response.json();
                const rows = Array.isArray(payload && payload.functions) ? payload.functions : [];

                adminFunctionRegistry = rows.map((item) => sanitizeAdminFunctionEntry(item));
                adminFunctionRegistryFiltered = [...adminFunctionRegistry];
                adminFunctionRegistryMeta = {
                    generatedAt: String(payload && payload.generatedAt || ''),
                    generatorVersion: String(payload && payload.generatorVersion || ''),
                    registryHash: String(payload && payload.registryHash || '')
                };

                applyAdminFunctionFilters();
                logAdmin('info', 'ADMIN_FUNCTION_MONITOR_LOADED', 'Admin function registry loaded for dashboard', {
                    total: adminFunctionRegistry.length
                });
            } catch (error) {
                adminFunctionRegistry = [];
                adminFunctionRegistryFiltered = [];
                adminFunctionRegistryMeta = {
                    generatedAt: '',
                    generatorVersion: '',
                    registryHash: ''
                };
                renderAdminFunctionSummary();
                renderAdminFunctionTable();
                logAdmin('warn', 'ADMIN_FUNCTION_MONITOR_LOAD_FAILED', 'Failed to load admin function registry', {
                    error: error && error.message ? String(error.message) : String(error)
                });
                showNotification('error', 'فشل تحميل تقرير وظائف الأدمن');
            }
        }

        // ============================================
        // Excel Export/Import
        // ============================================
        function exportProductsExcel() {
            const data = products.map((p) => ({
                'الاسم': p.name,
                'الوصف': p.desc,
                'القسم': getCategoryName(p.category),
                'المورد': p.supplierName || '',
                'السعر': p.price,
                'التكلفة': p.costPrice || 0,
                'هامش التسعير %': p.marginPercent || 0,
                'الربح': p.profitValue || 0,
                'هامش الربح الفعلي %': p.profitMarginActual || 0,
                'السعر القديم': p.oldPrice || '',
                'التقييم': p.rating,
                'الصورة': p.image,
                'الحالة': p.isPublished === false ? 'مخفي' : 'منشور',
                'دفعة الاستيراد': p.importBatchId || '',
                'مصدر الاستيراد': p.importSource || '',
                'الكود': p.code || '',
                'المخزون': Number.isFinite(Number(p.stock)) ? Number(p.stock) : ''
            }));
            exportToExcel(data, 'products');
        }

        function exportOrdersExcel() {
            const data = orders.map(o => ({ 'رقم': o.orderNumber, 'العميل': o.customer?.name, 'الهاتف': o.customer?.phone, 'العنوان': o.customer?.address, 'المبلغ': o.total, 'الكوبون': o.couponCode || '', 'الخصم': o.discount || 0, 'الحالة': getStatusName(o.status), 'التاريخ': formatDateTime(o.createdAt) }));
            exportToExcel(data, 'orders');
        }

        function exportUsersExcel() {
            const data = users.map(u => ({ 'الاسم': getUserDisplayName(u), 'الهاتف': u.phone || '', 'البريد': u.email || '', 'العنوان': u.address || '', 'النقاط': u.loyaltyPoints || 0, 'التسجيل': formatDateTime(u.createdAt) }));
            exportToExcel(data, 'users');
        }

        function exportCouponsExcel() {
            const data = coupons.map(c => ({ 'الكود': c.code, 'الوصف': c.desc, 'النوع': c.type === 'percentage' ? 'نسبة' : 'ثابت', 'القيمة': c.value }));
            exportToExcel(data, 'coupons');
        }

        function exportFullReport() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(products.map((p) => ({
                'الاسم': p.name,
                'القسم': getCategoryName(p.category),
                'المورد': p.supplierName || '',
                'السعر': p.price,
                'التكلفة': p.costPrice || 0,
                'الربح': p.profitValue || 0,
                'الحالة': p.isPublished === false ? 'مخفي' : 'منشور',
                'دفعة الاستيراد': p.importBatchId || ''
            }))), 'المنتجات');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(orders.map(o => ({ 'رقم': o.orderNumber, 'العميل': o.customer?.name, 'المبلغ': o.total, 'الحالة': getStatusName(o.status) }))), 'الطلبات');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(users.map(u => ({ 'الاسم': getUserDisplayName(u), 'الهاتف': u.phone || '', 'النقاط': u.loyaltyPoints || 0 }))), 'العملاء');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{ 'المنتجات': products.length, 'الطلبات': orders.length, 'العملاء': users.length, 'الإيرادات': orders.reduce((s, o) => s + (o.total || 0), 0) }]), 'ملخص');
            XLSX.writeFile(wb, `تقرير-${Date.now()}.xlsx`);
            showNotification('success', 'تم التصدير');
        }

        function exportToExcel(data, name) {
            if (data.length === 0) { showNotification('error', 'لا توجد بيانات'); return; }
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, name);
            XLSX.writeFile(wb, `${name}-${Date.now()}.xlsx`);
            showNotification('success', 'تم التصدير');
        }

        function createEmptyImportWizardState() {
            return {
                step: 1,
                fileName: '',
                workbook: null,
                sheetName: '',
                sheetRows: [],
                sheetAnalyses: [],
                headerRowIndex: 0,
                detectedHeaderRowIndex: 0,
                columns: [],
                mapping: {
                    name: '',
                    price: '',
                    desc: '',
                    category: '',
                    image: '',
                    oldPrice: '',
                    code: '',
                    stock: ''
                },
                validatedProducts: [],
                invalidRows: [],
                isCommitting: false,
                importBatchId: ''
            };
        }

        function setWizardProgress(percent, message) {
            const fill = document.getElementById('wizardProgressFill');
            const text = document.getElementById('wizardProgressText');
            const safePercent = Math.max(0, Math.min(100, Number(percent) || 0));
            if (fill) fill.style.width = `${safePercent}%`;
            if (text) text.textContent = message || '';
        }

        function resetImportWizardState() {
            importWizardState = createEmptyImportWizardState();

            const sheetSelect = document.getElementById('wizardSheetSelect');
            const fileInput = document.getElementById('wizardFileInput');
            const headerRowInput = document.getElementById('wizardHeaderRowInput');
            const headerHint = document.getElementById('wizardHeaderHint');
            const importSource = document.getElementById('wizardImportSource');
            const validationReport = document.getElementById('wizardValidationReport');
            const fileValidation = document.getElementById('wizardFileValidation');

            if (sheetSelect) sheetSelect.innerHTML = '<option value="">اختر الشيت</option>';
            if (fileInput) fileInput.value = '';
            if (headerRowInput) headerRowInput.value = '1';
            if (headerHint) headerHint.value = '';
            if (importSource) importSource.value = '';
            if (validationReport) validationReport.textContent = 'لا يوجد تقرير بعد.';
            if (fileValidation) fileValidation.textContent = 'سيتم اختبار الملف تلقائيًا بعد اختياره.';

            ['wizardSheetPreview', 'wizardHeaderPreview'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'لا توجد بيانات للعرض.';
            });

            ['mapNameCol', 'mapPriceCol', 'mapDescCol', 'mapCategoryCol', 'mapImageCol', 'mapOldPriceCol', 'mapCodeCol', 'mapStockCol']
                .forEach((id) => {
                    const select = document.getElementById(id);
                    if (!select) return;
                    select.innerHTML = '<option value="">-- غير محدد --</option>';
                });

            setWizardProgress(0, 'جاهز للتنفيذ.');
            showImportWizardStep(1);
        }

        function openImportWizard() {
            resetImportWizardState();
            openModal('importWizardModal');
        }

        function showImportWizardStep(step) {
            const safeStep = Math.max(1, Math.min(5, Number(step) || 1));
            importWizardState = importWizardState || createEmptyImportWizardState();
            importWizardState.step = safeStep;

            document.querySelectorAll('#importWizardSteps .wizard-step').forEach((el) => {
                el.classList.toggle('active', Number(el.dataset.step) === safeStep);
            });
            document.querySelectorAll('#importWizardModal .wizard-panel').forEach((el, index) => {
                el.classList.toggle('active', index + 1 === safeStep);
            });

            const prevBtn = document.getElementById('wizardPrevBtn');
            const nextBtn = document.getElementById('wizardNextBtn');
            const commitBtn = document.getElementById('wizardCommitBtn');

            if (prevBtn) prevBtn.disabled = safeStep <= 1 || importWizardState.isCommitting;
            if (nextBtn) {
                nextBtn.style.display = safeStep >= 5 ? 'none' : '';
                nextBtn.disabled = importWizardState.isCommitting;
            }
            if (commitBtn) {
                commitBtn.style.display = safeStep === 5 ? '' : 'none';
                commitBtn.disabled = importWizardState.isCommitting;
            }
        }

        function renderWizardTable(containerId, rows, options = {}) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const list = Array.isArray(rows) ? rows : [];
            if (!list.length) {
                container.textContent = 'لا توجد بيانات للعرض.';
                return;
            }

            const startIndex = Math.max(0, Number(options.startIndex) || 0);
            const headerRowIndex = Number.isFinite(Number(options.headerRowIndex)) ? Number(options.headerRowIndex) : -1;
            const maxCols = Math.max(1, ...list.map((row) => Array.isArray(row) ? row.length : 0));
            const limit = Math.max(1, Math.min(40, Number(options.limit) || 20));
            const renderedRows = list.slice(0, limit);

            let html = '<div style="overflow:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<thead><tr><th style="border:1px solid #ddd;padding:6px;background:#f4f4f4;">#</th>';
            for (let i = 0; i < maxCols; i += 1) {
                html += `<th style="border:1px solid #ddd;padding:6px;background:#f4f4f4;">C${i + 1}</th>`;
            }
            html += '</tr></thead><tbody>';

            renderedRows.forEach((row, i) => {
                const absoluteRow = startIndex + i;
                const isHeader = absoluteRow === headerRowIndex;
                const rowStyle = isHeader ? 'background:#e8f8ed;font-weight:700;' : '';
                html += `<tr style="${rowStyle}"><td style="border:1px solid #ddd;padding:6px;">${absoluteRow + 1}</td>`;
                for (let col = 0; col < maxCols; col += 1) {
                    const rawCell = Array.isArray(row) ? row[col] : '';
                    const text = String(rawCell == null ? '' : rawCell);
                    html += `<td style="border:1px solid #ddd;padding:6px;white-space:nowrap;max-width:220px;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(text)}">${escapeHtml(text) || '&nbsp;'}</td>`;
                }
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function scoreHeaderCell(normalizedCell, fieldKey) {
            if (!normalizedCell) return 0;
            const synonyms = IMPORT_HEADER_SYNONYMS[fieldKey] || [];
            let best = 0;
            for (const rawSynonym of synonyms) {
                const synonym = normalizeArabicHeader(rawSynonym);
                if (!synonym) continue;
                if (normalizedCell === synonym) best = Math.max(best, 12);
                else if (normalizedCell.includes(synonym) || synonym.includes(normalizedCell)) best = Math.max(best, 8);
                else {
                    const wordsCell = normalizedCell.split(' ');
                    const wordsSynonym = synonym.split(' ');
                    const shared = wordsCell.filter((w) => wordsSynonym.includes(w)).length;
                    if (shared >= 2) best = Math.max(best, 6);
                    else if (shared === 1) best = Math.max(best, 3);
                }
            }
            return best;
        }

        function detectHeaderRow(rows) {
            const list = Array.isArray(rows) ? rows : [];
            if (!list.length) return 0;

            let bestIndex = 0;
            let bestScore = -1;
            const maxScan = Math.min(list.length, 25);

            for (let i = 0; i < maxScan; i += 1) {
                const row = Array.isArray(list[i]) ? list[i] : [];
                const nonEmptyCells = row
                    .map((cell) => String(cell == null ? '' : cell).trim())
                    .filter(Boolean);
                if (!nonEmptyCells.length) continue;

                let score = nonEmptyCells.length * 0.4;
                for (const cell of nonEmptyCells) {
                    const normalizedCell = normalizeArabicHeader(cell);
                    for (const field of IMPORT_WIZARD_FIELDS) {
                        score += scoreHeaderCell(normalizedCell, field.key);
                    }
                }

                if (score > bestScore) {
                    bestScore = score;
                    bestIndex = i;
                }
            }

            return bestIndex;
        }

        function detectNumericCandidateColumns(rows, dataStartIndex = 0) {
            const list = Array.isArray(rows) ? rows : [];
            if (!list.length) return [];

            const start = Math.max(0, Number(dataStartIndex) || 0);
            const maxScanRows = Math.min(list.length, start + 40);
            const maxCols = Math.max(1, ...list.slice(start, maxScanRows).map((row) => Array.isArray(row) ? row.length : 0));
            const candidates = [];

            for (let col = 0; col < maxCols; col += 1) {
                let samples = 0;
                let numericHits = 0;

                for (let rowIdx = start; rowIdx < maxScanRows; rowIdx += 1) {
                    const row = Array.isArray(list[rowIdx]) ? list[rowIdx] : [];
                    const raw = String(row[col] == null ? '' : row[col]).trim();
                    if (!raw) continue;
                    samples += 1;
                    if (Number.isFinite(parseMoney(raw))) numericHits += 1;
                }

                if (samples >= 3 && numericHits >= 3 && (numericHits / samples) >= 0.5) {
                    candidates.push(col);
                }
            }

            return candidates;
        }

        function analyzeSheetForImportCompatibility(rows, sheetName = '') {
            const list = Array.isArray(rows) ? rows : [];
            if (!list.length) {
                return {
                    sheetName,
                    detectedHeaderRowIndex: 0,
                    nameColumns: [],
                    priceColumns: [],
                    numericPriceCandidates: [],
                    isCompatible: false
                };
            }

            const detectedHeaderRowIndex = detectHeaderRow(list);
            const headerRow = Array.isArray(list[detectedHeaderRowIndex]) ? list[detectedHeaderRowIndex] : [];
            const maxCols = Math.max(
                headerRow.length,
                ...list.slice(detectedHeaderRowIndex, detectedHeaderRowIndex + 30).map((row) => Array.isArray(row) ? row.length : 0),
                1
            );

            const columns = [];
            for (let col = 0; col < maxCols; col += 1) {
                const raw = String(headerRow[col] == null ? '' : headerRow[col]).trim();
                columns.push({
                    index: col,
                    label: raw || `عمود ${col + 1}`,
                    normalized: normalizeArabicHeader(raw || `عمود ${col + 1}`)
                });
            }

            const nameColumns = columns.filter((col) => scoreHeaderCell(col.normalized, 'name') > 0).map((col) => col.index);
            const priceColumns = columns.filter((col) => scoreHeaderCell(col.normalized, 'price') > 0).map((col) => col.index);
            const numericPriceCandidates = detectNumericCandidateColumns(list, detectedHeaderRowIndex + 1);

            const isCompatible = nameColumns.length > 0 && (priceColumns.length > 0 || numericPriceCandidates.length > 0);

            return {
                sheetName,
                detectedHeaderRowIndex,
                nameColumns,
                priceColumns,
                numericPriceCandidates,
                isCompatible
            };
        }

        function getCurrentSheetAnalysis() {
            const analyses = importWizardState && Array.isArray(importWizardState.sheetAnalyses)
                ? importWizardState.sheetAnalyses
                : [];
            const selectedSheet = String(importWizardState && importWizardState.sheetName || '');
            return analyses.find((entry) => String(entry.sheetName) === selectedSheet) || null;
        }

        function renderWizardFileValidationReport() {
            const container = document.getElementById('wizardFileValidation');
            if (!container) return;

            const analyses = importWizardState && Array.isArray(importWizardState.sheetAnalyses)
                ? importWizardState.sheetAnalyses
                : [];
            const selectedSheet = String(importWizardState && importWizardState.sheetName || '');

            if (!analyses.length) {
                container.textContent = 'سيتم اختبار الملف تلقائيًا بعد اختياره.';
                return;
            }

            const usableCount = analyses.filter((entry) => entry.isCompatible).length;
            const rows = analyses.map((entry) => {
                const passLabel = entry.isCompatible ? '✅ صالح' : '⚠️ يحتاج ضبط يدوي';
                const headerLabel = `Header: ${Number(entry.detectedHeaderRowIndex) + 1}`;
                const nameLabel = `Name: ${entry.nameColumns.length > 0 ? 'OK' : 'N/A'}`;
                const priceLabel = entry.priceColumns.length > 0
                    ? 'Price: OK'
                    : (entry.numericPriceCandidates.length > 0
                        ? `Price: يدوي (C${entry.numericPriceCandidates.map((x) => x + 1).slice(0, 4).join(', C')})`
                        : 'Price: N/A');
                const isSelected = String(entry.sheetName || '') === selectedSheet;
                const selectedBadge = isSelected ? ' <span style="color:#0f7c33;font-weight:700;">(المحدد)</span>' : '';
                return `<li><strong>${escapeHtml(entry.sheetName || 'Sheet')}</strong>${selectedBadge} — ${passLabel} — ${headerLabel} — ${nameLabel} — ${priceLabel}</li>`;
            }).join('');

            container.innerHTML = `
                <div><strong>نتيجة الاختبار التلقائي قبل الرفع:</strong> ${usableCount}/${analyses.length} شيت صالح</div>
                <ul style="margin-top:8px;padding-inline-start:18px;">${rows}</ul>
            `;
        }

        function getBestSheetForImport(analyses, fallbackSheet = '') {
            const list = Array.isArray(analyses) ? analyses : [];
            if (!list.length) return fallbackSheet || '';

            let best = null;
            let bestScore = -1;

            list.forEach((entry, index) => {
                const score = (entry.isCompatible ? 100 : 0)
                    + ((entry.nameColumns || []).length * 12)
                    + ((entry.priceColumns || []).length * 10)
                    + ((entry.numericPriceCandidates || []).length * 6)
                    - (Number(entry.detectedHeaderRowIndex) || 0)
                    - (index * 0.01);
                if (score > bestScore) {
                    best = entry;
                    bestScore = score;
                }
            });

            return String((best && best.sheetName) || fallbackSheet || '');
        }

        function selectImportSheet(sheetName) {
            importWizardState = importWizardState || createEmptyImportWizardState();
            if (!importWizardState.workbook) return;

            const targetSheet = sheetName || importWizardState.workbook.SheetNames[0];
            if (!targetSheet || !importWizardState.workbook.Sheets[targetSheet]) return;

            const rows = XLSX.utils.sheet_to_json(importWizardState.workbook.Sheets[targetSheet], {
                header: 1,
                defval: '',
                raw: false
            });

            importWizardState.sheetName = targetSheet;
            importWizardState.sheetRows = Array.isArray(rows) ? rows : [];
            importWizardState.validatedProducts = [];
            importWizardState.invalidRows = [];
            const selectedAnalysis = getCurrentSheetAnalysis() || analyzeSheetForImportCompatibility(importWizardState.sheetRows, targetSheet);

            const detectedHeader = Number(selectedAnalysis.detectedHeaderRowIndex) || 0;
            importWizardState.detectedHeaderRowIndex = detectedHeader;
            importWizardState.headerRowIndex = detectedHeader;

            const headerInput = document.getElementById('wizardHeaderRowInput');
            if (headerInput) headerInput.value = String(detectedHeader + 1);
            const headerHint = document.getElementById('wizardHeaderHint');
            if (headerHint) {
                const hint = selectedAnalysis.priceColumns && selectedAnalysis.priceColumns.length > 0
                    ? `تم اكتشاف السطر ${detectedHeader + 1} كعناوين.`
                    : `تم اكتشاف السطر ${detectedHeader + 1}. اختر عمود السعر يدويًا قبل التنفيذ.`;
                headerHint.value = hint;
            }

            renderWizardFileValidationReport();

            renderWizardTable('wizardSheetPreview', importWizardState.sheetRows, {
                limit: 20,
                startIndex: 0,
                headerRowIndex: importWizardState.headerRowIndex
            });
            setHeaderRowManual();
        }

        function resolveAutoMapping(fieldKey, columns) {
            const list = Array.isArray(columns) ? columns : [];
            let bestKey = '';
            let bestScore = -1;

            list.forEach((column) => {
                const score = scoreHeaderCell(normalizeArabicHeader(column.label), fieldKey);
                if (score > bestScore) {
                    bestScore = score;
                    bestKey = column.key;
                }
            });

            return bestScore > 0 ? bestKey : '';
        }

        function buildColumnMapping() {
            importWizardState = importWizardState || createEmptyImportWizardState();
            const columns = importWizardState.columns || [];
            const mappingTargets = {
                name: 'mapNameCol',
                price: 'mapPriceCol',
                desc: 'mapDescCol',
                category: 'mapCategoryCol',
                image: 'mapImageCol',
                oldPrice: 'mapOldPriceCol',
                code: 'mapCodeCol',
                stock: 'mapStockCol'
            };

            const optionsHtml = columns.map((col) => `<option value="${col.key}">${escapeHtml(col.label)} (C${col.index + 1})</option>`).join('');

            Object.entries(mappingTargets).forEach(([fieldKey, selectId]) => {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = `<option value="">-- غير محدد --</option>${optionsHtml}`;

                const currentValue = importWizardState.mapping[fieldKey];
                const hasCurrent = columns.some((col) => col.key === currentValue);
                const suggested = hasCurrent ? currentValue : resolveAutoMapping(fieldKey, columns);
                importWizardState.mapping[fieldKey] = suggested || '';
                select.value = importWizardState.mapping[fieldKey] || '';
            });
        }

        function setHeaderRowManual() {
            importWizardState = importWizardState || createEmptyImportWizardState();
            const rows = importWizardState.sheetRows || [];
            if (!rows.length) return;

            const headerInput = document.getElementById('wizardHeaderRowInput');
            let rowNumber = Number(headerInput ? headerInput.value : 1);
            if (!Number.isFinite(rowNumber)) rowNumber = 1;

            rowNumber = Math.max(1, Math.min(rows.length, Math.floor(rowNumber)));
            importWizardState.headerRowIndex = rowNumber - 1;
            if (headerInput) headerInput.value = String(rowNumber);

            const previewStart = Math.max(0, importWizardState.headerRowIndex - 2);
            const previewRows = rows.slice(previewStart, previewStart + 12);
            renderWizardTable('wizardHeaderPreview', previewRows, {
                limit: 12,
                startIndex: previewStart,
                headerRowIndex: importWizardState.headerRowIndex
            });

            const headerRow = Array.isArray(rows[importWizardState.headerRowIndex]) ? rows[importWizardState.headerRowIndex] : [];
            const maxCols = Math.max(
                headerRow.length,
                ...rows.slice(importWizardState.headerRowIndex, importWizardState.headerRowIndex + 30).map((row) => Array.isArray(row) ? row.length : 0),
                1
            );

            importWizardState.columns = [];
            for (let idx = 0; idx < maxCols; idx += 1) {
                const raw = String(headerRow[idx] == null ? '' : headerRow[idx]).trim();
                importWizardState.columns.push({
                    key: `c${idx}`,
                    index: idx,
                    label: raw || `عمود ${idx + 1}`
                });
            }

            buildColumnMapping();
        }

        async function parseWorkbook(event) {
            const file = event && event.target && event.target.files ? event.target.files[0] : null;
            if (!file) return;

            importWizardState = createEmptyImportWizardState();
            importWizardState.fileName = file.name || '';

            try {
                const buffer = await file.arrayBuffer();
                importWizardState.workbook = XLSX.read(buffer, {
                    type: 'array',
                    cellDates: true
                });
            } catch (error) {
                console.error('parseWorkbook error:', error);
                showNotification('error', 'فشل قراءة ملف Excel');
                return;
            }

            const sheetNames = Array.isArray(importWizardState.workbook.SheetNames) ? importWizardState.workbook.SheetNames : [];
            const sheetSelect = document.getElementById('wizardSheetSelect');

            if (!sheetNames.length) {
                showNotification('error', 'الملف لا يحتوي على شيتات صالحة');
                return;
            }

            const analyses = [];
            for (const sheetName of sheetNames) {
                const rows = XLSX.utils.sheet_to_json(importWizardState.workbook.Sheets[sheetName], {
                    header: 1,
                    defval: '',
                    raw: false
                });
                analyses.push(analyzeSheetForImportCompatibility(rows, sheetName));
            }
            importWizardState.sheetAnalyses = analyses;

            const preferredSheet = getBestSheetForImport(analyses, sheetNames[0]);

            if (sheetSelect) {
                sheetSelect.innerHTML = sheetNames.map((name) => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');
                sheetSelect.value = preferredSheet || sheetNames[0];
            }

            selectImportSheet(preferredSheet || sheetNames[0]);

            const usableCount = analyses.filter((entry) => entry.isCompatible).length;
            if (usableCount > 0) {
                showNotification('success', `تم اختبار الملف: ${usableCount}/${analyses.length} شيت جاهز للاستيراد`);
            } else {
                showNotification('warning', 'تم اختبار الملف لكن يحتاج ضبط يدوي للأعمدة قبل التنفيذ');
            }
        }

        function readWizardMappingFromUI() {
            const state = importWizardState || createEmptyImportWizardState();
            const mapping = {
                name: document.getElementById('mapNameCol')?.value || '',
                price: document.getElementById('mapPriceCol')?.value || '',
                desc: document.getElementById('mapDescCol')?.value || '',
                category: document.getElementById('mapCategoryCol')?.value || '',
                image: document.getElementById('mapImageCol')?.value || '',
                oldPrice: document.getElementById('mapOldPriceCol')?.value || '',
                code: document.getElementById('mapCodeCol')?.value || '',
                stock: document.getElementById('mapStockCol')?.value || ''
            };
            state.mapping = mapping;
            importWizardState = state;
            return mapping;
        }

        function getMappedValue(row, mappingKey) {
            if (!mappingKey) return '';
            const colIndex = Number(String(mappingKey).replace('c', ''));
            if (!Number.isFinite(colIndex) || colIndex < 0) return '';
            if (!Array.isArray(row)) return '';
            return String(row[colIndex] == null ? '' : row[colIndex]).trim();
        }

        function parseStockValue(value) {
            const parsed = parseMoney(value);
            if (!Number.isFinite(parsed)) return -1;
            return Math.max(0, Math.floor(parsed));
        }

        function renderWizardValidationReport(validRows, invalidRows, skippedRows) {
            const report = document.getElementById('wizardValidationReport');
            if (!report) return;

            const invalidPreview = invalidRows.slice(0, 20).map((row) => `<li>السطر ${row.row}: ${escapeHtml(row.reason)}</li>`).join('');
            const remaining = invalidRows.length > 20 ? `<li>... وهناك ${invalidRows.length - 20} سطر إضافي</li>` : '';

            report.innerHTML = `
                <div><strong>الصفوف الصالحة:</strong> ${validRows.length}</div>
                <div><strong>الصفوف المرفوضة:</strong> ${invalidRows.length}</div>
                <div><strong>الصفوف الفارغة (تم تجاوزها):</strong> ${skippedRows}</div>
                ${invalidRows.length ? `<hr><div><strong>أسباب الرفض:</strong></div><ul style="margin-top:8px;padding-inline-start:18px;">${invalidPreview}${remaining}</ul>` : '<hr><div style="color:#0f7c33;">كل الصفوف صالحة ✅</div>'}
            `;
        }

        function validateImportRows() {
            importWizardState = importWizardState || createEmptyImportWizardState();
            const rows = importWizardState.sheetRows || [];
            const mapping = readWizardMappingFromUI();

            if (!rows.length) {
                showNotification('error', 'لا توجد بيانات للتحقق');
                return { validRows: [], invalidRows: [], skippedRows: 0 };
            }

            if (!mapping.name || !mapping.price) {
                showNotification('error', 'اختيار عمود الاسم والسعر إلزامي');
                renderWizardValidationReport([], [{ row: '-', reason: 'لم يتم تحديد عمود الاسم أو السعر.' }], 0);
                return { validRows: [], invalidRows: [{ row: '-', reason: 'Missing required mapping' }], skippedRows: 0 };
            }

            const validRows = [];
            const invalidRows = [];
            let skippedRows = 0;
            const startIndex = importWizardState.headerRowIndex + 1;

            for (let rowIndex = startIndex; rowIndex < rows.length; rowIndex += 1) {
                const row = Array.isArray(rows[rowIndex]) ? rows[rowIndex] : [];
                const allEmpty = row.every((cell) => String(cell == null ? '' : cell).trim() === '');
                if (allEmpty) {
                    skippedRows += 1;
                    continue;
                }

                const name = getMappedValue(row, mapping.name);
                const priceRaw = getMappedValue(row, mapping.price);
                const price = parseMoney(priceRaw);

                if (!name) {
                    invalidRows.push({ row: rowIndex + 1, reason: 'اسم المنتج فارغ.' });
                    continue;
                }
                if (!Number.isFinite(price) || price < 0) {
                    invalidRows.push({ row: rowIndex + 1, reason: `سعر غير صالح: "${priceRaw}"` });
                    continue;
                }

                const oldPriceRaw = getMappedValue(row, mapping.oldPrice);
                const oldPrice = parseMoney(oldPriceRaw);
                const categoryRaw = getMappedValue(row, mapping.category);
                const desc = getMappedValue(row, mapping.desc);
                const code = getMappedValue(row, mapping.code);
                const stock = parseStockValue(getMappedValue(row, mapping.stock));
                const image = getMappedValue(row, mapping.image);

                const product = normalizeProductForStorage({
                    name,
                    desc,
                    category: categoryRaw || inferCategory(name),
                    price,
                    oldPrice: Number.isFinite(oldPrice) ? oldPrice : null,
                    image: image || DEFAULT_PRODUCT_IMAGE,
                    code,
                    stock,
                    rating: 4.5,
                    ratingCount: 0,
                    isPublished: false
                }, {
                    isPublished: false,
                    category: categoryRaw || inferCategory(name)
                });

                validRows.push({
                    row: rowIndex + 1,
                    product
                });
            }

            importWizardState.validatedProducts = validRows;
            importWizardState.invalidRows = invalidRows;
            renderWizardValidationReport(validRows, invalidRows, skippedRows);

            return { validRows, invalidRows, skippedRows };
        }

        function nextImportWizardStep() {
            importWizardState = importWizardState || createEmptyImportWizardState();
            const step = importWizardState.step || 1;

            if (step === 1) {
                if (!importWizardState.workbook || !importWizardState.sheetRows.length) {
                    showNotification('error', 'اختر ملفًا وشيت صالحًا أولًا');
                    return;
                }

                const selectedAnalysis = getCurrentSheetAnalysis();
                if (selectedAnalysis && !selectedAnalysis.isCompatible) {
                    const canContinue = confirm(
                        'نتيجة الاختبار: الشيت المحدد يحتاج ضبط يدوي (اسم/سعر).\n' +
                        'يمكنك المتابعة وتحديد الأعمدة يدويًا في الخطوات القادمة.\n' +
                        'هل تريد المتابعة؟'
                    );
                    if (!canContinue) return;
                }

                showImportWizardStep(2);
                return;
            }

            if (step === 2) {
                setHeaderRowManual();
                showImportWizardStep(3);
                return;
            }

            if (step === 3) {
                validateImportRows();
                showImportWizardStep(4);
                return;
            }

            if (step === 4) {
                const sourceLabel = `${importWizardState.fileName || 'unknown-file'} :: ${importWizardState.sheetName || 'Sheet1'}`;
                const sourceInput = document.getElementById('wizardImportSource');
                if (sourceInput) sourceInput.value = sourceLabel;
                setWizardProgress(0, `جاهز للاستيراد (${importWizardState.validatedProducts.length} صف صالح)`);
                showImportWizardStep(5);
            }
        }

        function prevImportWizardStep() {
            importWizardState = importWizardState || createEmptyImportWizardState();
            if (importWizardState.isCommitting) return;
            showImportWizardStep((importWizardState.step || 1) - 1);
        }

        async function commitImportBatch() {
            importWizardState = importWizardState || createEmptyImportWizardState();
            if (importWizardState.isCommitting) return;

            let validRows = Array.isArray(importWizardState.validatedProducts) ? importWizardState.validatedProducts : [];
            if (!validRows.length) {
                const validation = validateImportRows();
                validRows = validation.validRows;
            }

            if (!validRows.length) {
                showNotification('error', 'لا توجد صفوف صالحة للاستيراد');
                return;
            }

            importWizardState.isCommitting = true;
            showImportWizardStep(5);

            const prevBtn = document.getElementById('wizardPrevBtn');
            const nextBtn = document.getElementById('wizardNextBtn');
            const commitBtn = document.getElementById('wizardCommitBtn');
            if (prevBtn) prevBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = true;
            if (commitBtn) commitBtn.disabled = true;

            const importBatchId = makeImportBatchId();
            importWizardState.importBatchId = importBatchId;
            const importSource = `${importWizardState.fileName || 'unknown-file'} :: ${importWizardState.sheetName || 'Sheet1'}`;
            const sourceInput = document.getElementById('wizardImportSource');
            if (sourceInput) sourceInput.value = `${importSource} | ${importBatchId}`;

            const normalizedProducts = validRows.map((row) => normalizeProductForStorage({
                ...row.product,
                isPublished: false,
                visibilityState: 'hidden',
                importBatchId,
                importSource
            }, {
                isPublished: false,
                category: row.product.category
            }));

            const online = navigator.onLine === true;
            let writeOnline = online;
            let syncedCount = 0;
            let queuedCount = 0;
            const localImported = [];
            const chunkSize = 100;

            if (online) {
                try {
                    await requireAdminPermission();
                } catch (error) {
                    console.error('Import permission check failed:', error);
                    setWizardProgress(0, 'فشل التحقق من صلاحيات الأدمن.');
                    showNotification('error', 'تعذر التحقق من صلاحيات الأدمن');
                    importWizardState.isCommitting = false;
                    showImportWizardStep(5);
                    return;
                }
            }

            try {
                for (let offset = 0; offset < normalizedProducts.length; offset += chunkSize) {
                    const chunk = normalizedProducts.slice(offset, offset + chunkSize);
                    const payloadChunk = chunk.map((item) => {
                        const copy = { ...item };
                        delete copy.id;
                        return copy;
                    });

                    let createdIds = [];
                    if (writeOnline) {
                        try {
                            if (typeof addProductsBatch === 'function') {
                                createdIds = await addProductsBatch(payloadChunk, {
                                    isPublished: false,
                                    importBatchId,
                                    importSource,
                                    chunkSize: chunk.length
                                });
                            } else if (typeof addProduct === 'function') {
                                for (const payload of payloadChunk) {
                                    createdIds.push(await addProduct(payload));
                                }
                            } else {
                                throw new Error('addProduct API unavailable');
                            }
                        } catch (error) {
                            writeOnline = false;
                            console.warn('Import chunk upload failed, switching to queue mode:', error);
                        }
                    }

                    chunk.forEach((item, index) => {
                        const cloned = { ...item };
                        const createdId = createdIds[index];
                        if (writeOnline && createdId) {
                            cloned.id = String(createdId);
                            syncedCount += 1;
                        } else {
                            const tempId = `tmp_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
                            cloned.id = tempId;
                            const queuePayload = { ...item };
                            delete queuePayload.id;
                            enqueuePendingProductOp('add', {
                                tmpId: tempId,
                                product: queuePayload
                            });
                            queuedCount += 1;
                        }
                        localImported.push(cloned);
                    });

                    const done = Math.min(normalizedProducts.length, offset + chunk.length);
                    setWizardProgress(Math.round((done / normalizedProducts.length) * 100), `تمت معالجة ${done} من ${normalizedProducts.length}`);
                    await new Promise((resolve) => setTimeout(resolve, 0));
                }

                products = ensureProductsSchema([...products, ...localImported]);
                saveProducts();
                renderProductsTable();
                updateStats();

                if (queuedCount > 0 && navigator.onLine) {
                    await flushPendingProductOps();
                }

                setWizardProgress(100, `اكتمل الاستيراد: ${localImported.length} منتج | مباشر: ${syncedCount} | انتظار: ${queuedCount}`);
                showNotification('success', `تم استيراد ${localImported.length} منتج (دفعة: ${importBatchId})`);
            } catch (error) {
                console.error('commitImportBatch error:', error);
                setWizardProgress(0, 'فشل تنفيذ الاستيراد.');
                showNotification('error', 'فشل تنفيذ الاستيراد');
            } finally {
                importWizardState.isCommitting = false;
                showImportWizardStep(5);
            }
        }

        function importProductsExcel(e) {
            openImportWizard();
            parseWorkbook(e);
        }

        // ============================================
        // JSON Backup
        // ============================================
        function exportAllDataJSON() {
            const data = { products, orders, coupons, banners, users, storeSettings };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup-${Date.now()}.json`;
            a.click();
            showNotification('success', 'تم التصدير');
        }

        function importAllDataJSON(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.products) { products = ensureProductsSchema(data.products); saveProducts(); }
                    if (data.orders) { orders = data.orders; saveOrders(); }
                    if (data.coupons) { coupons = data.coupons; saveCoupons(); }
                    if (data.banners) { banners = data.banners; saveBanners(); }
                    if (data.users) { users = data.users; saveUsers(); }
                    if (data.storeSettings) { storeSettings = data.storeSettings; saveStoreSettings(); }
                    initDashboard();
                    showNotification('success', 'تم الاستيراد');
                } catch (err) { showNotification('error', 'ملف غير صالح'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function clearAllData() {
            if (!confirm('⚠️ حذف كل البيانات؟')) return;
            if (!confirm('⚠️ متأكد؟ لا يمكن التراجع!')) return;
            localStorage.clear();
            products = []; orders = []; coupons = []; banners = []; users = [];
            initDashboard();
            showNotification('success', 'تم الحذف');
        }

        async function changeAdminPassword(e) {
            e.preventDefault();
            const current = document.getElementById('currentAdminPass').value;
            const newPass = document.getElementById('newAdminPass').value;
            const confirm = document.getElementById('confirmAdminPass').value;
            if (newPass !== confirm) { showNotification('error', 'غير متطابقة'); return; }
            const user = firebase.auth().currentUser;
            if (!user) { showNotification('error', 'سجل دخول مرة أخرى'); return; }
            try {
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, current);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPass);
                showNotification('success', 'تم التغيير');
                document.getElementById('currentAdminPass').value = '';
                document.getElementById('newAdminPass').value = '';
                document.getElementById('confirmAdminPass').value = '';
            } catch (err) {
                showNotification('error', 'فشل تغيير كلمة المرور');
            }
        }

        // ============================================
        // Charts
        // ============================================
        function initCharts() {
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
            if (salesCtx) {
                if (salesChart) salesChart.destroy();
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        datasets: [{ label: 'المبيعات', data: [1200, 1900, 3000, 5000, 4000, 6000], borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            const catCtx = document.getElementById('categoriesChart')?.getContext('2d');
            if (catCtx) {
                if (categoriesChart) categoriesChart.destroy();
                categoriesChart = new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['شعر', 'بشرة', 'طفل', 'مكملات', 'طبي'],
                        datasets: [{ data: [products.filter(p => p.category === 'hair-care').length, products.filter(p => p.category === 'skin-care').length, products.filter(p => p.category === 'baby-care').length, products.filter(p => p.category === 'supplements').length, products.filter(p => p.category === 'medical').length], backgroundColor: ['#B76E79', '#E8A0BF', '#7EC8E3', '#4CAF50', '#2196F3'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        // ============================================
        // UI
        // ============================================
        function showSection(name) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(name + 'Section').classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event?.target?.classList.add('active');
            const titles = { overview: '📊 نظرة عامة', products: '📦 المنتجات', suppliers: '🏭 الموردين', orders: '🛍️ الطلبات', banners: '🎠 البانرات', coupons: '🎫 الكوبونات', users: '👥 العملاء', support: '💬 الدردشة الداخلية', loyalty: '💎 نقاط الولاء', reports: '📈 التقارير', storeSettings: '🏪 المتجر', settings: '⚙️ النظام' };
            document.getElementById('pageTitle').textContent = titles[name] || name;
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            if (name === 'reports') {
                renderClientErrorLogsTable();
                refreshClientErrorLogs();
                renderStoreEventsTable();
                renderLiveSessionsTable();
                refreshStoreOperationsNow();
                refreshAdminFunctionMonitorView();
            } else if (name === 'support') {
                renderSupportThreads();
                renderSupportMessages();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function applyAutoTooltips(root = document) {
            const scope = root && typeof root.querySelectorAll === 'function' ? root : document;
            const elements = scope.querySelectorAll('button, .btn, .action-btn, .menu-item, [role="button"], a[onclick]');
            elements.forEach((el) => {
                if (!el || el.dataset.tooltipBound === '1') return;
                if (el.getAttribute('title')) {
                    el.dataset.tooltipBound = '1';
                    return;
                }
                const label = String(el.getAttribute('aria-label') || el.textContent || '')
                    .replace(/\s+/g, ' ')
                    .trim();
                if (!label) return;
                el.setAttribute('title', label.slice(0, 120));
                el.dataset.tooltipBound = '1';
            });
        }

        function setupAutoTooltips() {
            applyAutoTooltips(document);
            if (window.__ADMIN_TOOLTIP_OBSERVER__) return;
            const observer = new MutationObserver(() => applyAutoTooltips(document));
            observer.observe(document.body, { childList: true, subtree: true });
            window.__ADMIN_TOOLTIP_OBSERVER__ = observer;
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function openProductModal() {
            resetProductForm();
            renderSupplierOptions();
            openModal('productModal');
        }
        function closeModal(modalId) {
  document.getElementById(modalId)?.classList.remove('active');
  if (modalId === 'productModal') resetProductForm();
  if (modalId === 'supplierModal') resetSupplierForm();
  if (modalId === 'importWizardModal') resetImportWizardState();
}

        document.querySelectorAll('.modal-overlay').forEach(o => {
            o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        });

        function showNotification(type, message) {
            const container = document.getElementById('notificationsContainer');
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.innerHTML = '<div class="notification-icon"></div><div class="notification-content"><div class="notification-title"></div><div class="notification-message"></div></div><button class="notification-close" type="button">✕</button>';
            const iconNode = n.querySelector('.notification-icon');
            const titleNode = n.querySelector('.notification-title');
            const messageNode = n.querySelector('.notification-message');
            const closeBtn = n.querySelector('.notification-close');
            if (iconNode) iconNode.textContent = type === 'success' ? '✓' : '✕';
            if (titleNode) titleNode.textContent = type === 'success' ? 'نجاح' : 'خطأ';
            if (messageNode) messageNode.textContent = String(message || '');
            if (closeBtn) closeBtn.addEventListener('click', () => n.remove());
            container.appendChild(n);
            setTimeout(() => n.remove(), 4000);
        }

        // ============================================
        // Purge Sample Data (Auto + Manual)
        // ============================================
        const SAMPLE_PURGE_FLAG = 'salezone_sample_purge_done';

        function getSamplePurgeTargets() {
            const placeholderProductNames = new Set([
                'شامبو كيراتين فاخر',
                'سيروم فيتامين C',
                'حليب الأطفال المخصص',
                'فيتامينات متعددة',
                'كريم مرطب للوجه',
                'بلسم الشعر المعالج',
                'زيت الأطفال اللطيف'
            ]);
            const placeholderBannerTitles = new Set(['خصم 30%', 'جديدنا']);
            const placeholderCouponCodes = new Set(['WELCOME20', 'SALE50']);

            const isProductPlaceholder = (p) => {
                const name = String(p?.name || '').trim();
                const img = String(p?.image || '').trim();
                return placeholderProductNames.has(name) && /placeholder\.svg$/i.test(img);
            };
            const isBannerPlaceholder = (b) => {
                const title = String(b?.title || '').trim();
                const img = String(b?.image || '').trim();
                return placeholderBannerTitles.has(title) && /banner-placeholder\.svg$/i.test(img);
            };
            const isCouponPlaceholder = (c) => {
                const code = String(c?.code || '').trim().toUpperCase();
                return placeholderCouponCodes.has(code);
            };

            const productsToDelete = (products || []).filter(isProductPlaceholder);
            const bannersToDelete = (banners || []).filter(isBannerPlaceholder);
            const couponsToDelete = (coupons || []).filter(isCouponPlaceholder);
            return { productsToDelete, bannersToDelete, couponsToDelete };
        }

        async function purgeSampleData(auto = false) {
            try {
                if (typeof requireAdminPermission === 'function') {
                    await requireAdminPermission();
                }
            } catch (error) {
                if (!auto) showNotification('error', 'لا يمكن حذف التجريبية بدون صلاحيات');
                return false;
            }

            const { productsToDelete, bannersToDelete, couponsToDelete } = getSamplePurgeTargets();
            const total = productsToDelete.length + bannersToDelete.length + couponsToDelete.length;

            if (!total) {
                if (!auto) showNotification('success', 'لا توجد بيانات تجريبية');
                return true;
            }

            if (!auto) {
                const msg = `سيتم حذف ${productsToDelete.length} منتج، ${bannersToDelete.length} بانر، ${couponsToDelete.length} كوبون تجريبي. هل أنت متأكد؟`;
                if (!confirm(msg)) return false;
            }

            const deletedIds = {
                products: new Set(productsToDelete.map(p => String(p.id))),
                banners: new Set(bannersToDelete.map(b => String(b.id))),
                coupons: new Set(couponsToDelete.map(c => String(c.id)))
            };

            for (const p of productsToDelete) {
                try {
                    if (typeof deleteProductFromFirebase === 'function') {
                        await deleteProductFromFirebase(p.id);
                    }
                } catch (e) { console.error('Delete product failed:', e); }
            }
            for (const b of bannersToDelete) {
                try {
                    if (typeof deleteBannerFromFirebase === 'function') {
                        await deleteBannerFromFirebase(b.id);
                    }
                } catch (e) { console.error('Delete banner failed:', e); }
            }
            for (const c of couponsToDelete) {
                try {
                    if (typeof deleteCouponFromFirebase === 'function') {
                        await deleteCouponFromFirebase(c.id);
                    }
                } catch (e) { console.error('Delete coupon failed:', e); }
            }

            products = (products || []).filter(p => !deletedIds.products.has(String(p.id)));
            banners = (banners || []).filter(b => !deletedIds.banners.has(String(b.id)));
            coupons = (coupons || []).filter(c => !deletedIds.coupons.has(String(c.id)));

            saveProducts();
            saveBanners();
            saveCoupons();
            renderProductsTable();
            renderBannersTable();
            renderCouponsTable();
            updateStats();

            showNotification('success', `تم حذف ${total} عنصر تجريبي`);
            return true;
        }

        async function autoPurgeSamplesOnce() {
            if (localStorage.getItem(SAMPLE_PURGE_FLAG) === '1') return;
            const ok = await purgeSampleData(true);
            if (ok) localStorage.setItem(SAMPLE_PURGE_FLAG, '1');
        }

        async function runProductsSchemaMigration() {
            if (!Array.isArray(products) || !products.length) {
                showNotification('error', 'لا توجد منتجات للترحيل');
                return;
            }

            if (!confirm(`سيتم ترحيل ${products.length} منتج إلى schema الربحية/الموردين. متابعة؟`)) return;

            const report = {
                total: products.length,
                localUpdated: 0,
                firebaseUpdated: 0,
                failed: 0,
                failedIds: []
            };

            const migrated = [];
            for (const item of products) {
                try {
                    const normalized = normalizeProductForStorage({
                        ...item,
                        costPrice: Number.isFinite(Number(item.costPrice)) ? Number(item.costPrice) : Number(item.price || 0),
                        marginPercent: Number.isFinite(Number(item.marginPercent)) ? Number(item.marginPercent) : 0,
                        sellPrice: Number.isFinite(Number(item.sellPrice)) ? Number(item.sellPrice) : Number(item.price || 0),
                        manualPriceOverride: item.manualPriceOverride === true ? true : false
                    }, {
                        isPublished: item.isPublished !== false,
                        category: item.category
                    });
                    migrated.push(normalized);
                    report.localUpdated += 1;
                } catch (_) {
                    report.failed += 1;
                    report.failedIds.push(String(item && item.id || 'unknown'));
                    migrated.push(item);
                }
            }

            products = migrated;
            saveProducts();
            renderProductsTable();
            updateStats();

            if (navigator.onLine === true && typeof updateProduct === 'function') {
                try {
                    await requireAdminPermission();
                    for (const product of products) {
                        try {
                            if (!product || !product.id || String(product.id).startsWith('tmp_')) continue;
                            const payload = { ...product };
                            delete payload.id;
                            await updateProduct(product.id, payload);
                            report.firebaseUpdated += 1;
                        } catch (_) {
                            report.failed += 1;
                            report.failedIds.push(String(product && product.id || 'unknown'));
                        }
                    }
                } catch (error) {
                    console.warn('runProductsSchemaMigration online sync warning:', error);
                }
            }

            const output = [
                '✅ Migration report',
                `- Total: ${report.total}`,
                `- Local updated: ${report.localUpdated}`,
                `- Firebase updated: ${report.firebaseUpdated}`,
                `- Failed: ${report.failed}`,
                report.failedIds.length ? `- Failed IDs: ${report.failedIds.join(', ')}` : ''
            ].filter(Boolean).join('\n');

            const preflightOutput = document.getElementById('preflightOutput');
            if (preflightOutput) preflightOutput.textContent = output;
            openModal('preflightModal');
            showNotification(report.failed ? 'warning' : 'success', report.failed ? 'تم الترحيل مع بعض الإخفاقات' : 'تم ترحيل المنتجات بنجاح');
        }

        async function runPreflightCheck() {
            try {
                const files = ['index.html', 'offline.html', 'متجر_2.HTML', 'ادمن_2.HTML'];
                const issues = [];

                for (const file of files) {
                    const res = await fetch(file, { cache: 'no-store' });
                    if (!res.ok) {
                        issues.push(`${file}: تعذر التحميل (${res.status})`);
                        continue;
                    }
                    const buf = new Uint8Array(await res.arrayBuffer());
                    const hasBom = buf.length >= 3 && buf[0] === 0xEF && buf[1] === 0xBB && buf[2] === 0xBF;
                    const text = new TextDecoder('utf-8').decode(buf);

                    if (!hasBom) issues.push(`${file}: لا يوجد BOM UTF-8`);

                    const parsed = new DOMParser().parseFromString(text, 'text/html');
                    const metaCharset = parsed.querySelector('meta[charset]');
                    if (!metaCharset) {
                        issues.push(`${file}: لا يوجد <meta charset="UTF-8">`);
                    }

                    if (text.includes('\uFFFD')) issues.push(`${file}: يحتوي على أحرف تالفة (U+FFFD)`);
                    if (text.includes('\u00A7')) issues.push(`${file}: يحتوي على الحرف غير المسموح (U+00A7)`);

                    // Check for unquoted Arabic keys inside <script> blocks
                    const scripts = [];
                    const scriptRegex = new RegExp('<script[^>]*>([\\s\\S]*?)<\\\\/script>', 'gi');
                    let match;
                    while ((match = scriptRegex.exec(text)) !== null) {
                        scripts.push(match[1]);
                    }
                    const arabicKeyRegex = /[,{]\\s*([\\u0600-\\u06FF]+)\\s*:/g;
                    if (scripts.some(s => arabicKeyRegex.test(s))) {
                        issues.push(`${file}: مفاتيح عربية بدون علامات اقتباس داخل JS`);
                    }
                }

                const output = issues.length
                    ? `❌ تم العثور على مشاكل:\\n- ${issues.join('\\n- ')}`
                    : '✅ الفحص ناجح: لا توجد مشاكل ترميز أو أخطاء عربية.';

                document.getElementById('preflightOutput').textContent = output;
                openModal('preflightModal');
                showNotification(issues.length ? 'error' : 'success', issues.length ? 'تم اكتشاف مشاكل' : 'الفحص ناجح');
            } catch (err) {
                console.error('Preflight error:', err);
                showNotification('error', 'فشل الفحص');
            }
        }

        function copyPreflightReport() {
            const text = document.getElementById('preflightOutput').textContent || '';
            navigator.clipboard.writeText(text).then(() => {
                showNotification('success', 'تم نسخ التقرير');
            }).catch(() => {
                showNotification('error', 'فشل النسخ');
            });
        }
    </script>
    <script>
async function uploadAndPreview(input) {
    if(!input.files[0]) return;
    // معاينة
    const reader = new FileReader();
    reader.onload = (e) => document.getElementById('imgPreview').innerHTML = `<img src="${e.target.result}" style="max-width:150px;border-radius:5px;margin:5px 0;">`;
    reader.readAsDataURL(input.files[0]);
    
    // رفع
    try {
        const res = await uploadToCloudinary(input.files[0]);
        if(res) {
            document.getElementById('finalImg').value = res.url;
            document.getElementById('manualImg').value = res.url;
            alert('✅ تم رفع الصورة');
        }
    } catch(err) {
        alert('❌ فشل الرفع: ' + err.message);
    }
}
</script>
</body>
</html>

