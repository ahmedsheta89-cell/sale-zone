<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A1128">
    <meta name="description" content="Sale Zone Store Admin - لوحة التحكم">
    <link rel="icon" href="./icon-192.png">
    <link rel="shortcut icon" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <title>لوحة التحكم | Sale Zone Store</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Error Detection System -->
    <script src="ERROR_DETECTION_SYSTEM.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-api.js"></script>
    <script src="firebase-data.js"></script>
    <script src="auth-utils.js"></script>
    <script src="enhancement-utils.js"></script>
    <script src="storage-keys.js"></script>
    <script src="cloudinary-service.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F4E4BC;
            --gold-dark: #B8960C;
            --navy: #0A1128;
            --navy-light: #1A2744;
            --burgundy: #800020;
            --cream: #FAF8F3;
            --white: #FFFFFF;
            --success: #50C878;
            --error: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
            --font-display: 'Playfair Display', serif;
            --font-arabic: 'Almarai', sans-serif;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
            --transition: all 0.3s ease;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; }
        body { font-family: var(--font-arabic); background: #f5f6fa; min-height: 100vh; text-rendering: optimizeLegibility; overscroll-behavior: none; touch-action: manipulation; }
        button { min-height: 44px; }
        input, textarea, select { font-size: 16px; }

        /* Login */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--navy), var(--navy-light));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: var(--white);
            border-radius: 20px;
            padding: 40px 35px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        .login-logo { font-size: 50px; margin-bottom: 15px; }
        .login-title { font-family: var(--font-display); font-size: 24px; color: var(--navy); margin-bottom: 8px; }
        .login-subtitle { color: #666; margin-bottom: 25px; font-size: 14px; }
        .login-form .form-group { margin-bottom: 18px; text-align: right; }
        .login-form label { display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px; font-size: 13px; }
        .login-form input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: var(--transition);
        }
        .login-form input:focus { border-color: var(--gold); outline: none; }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212,175,55,0.4); }
        .login-error { background: #fee; color: var(--error); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; font-size: 13px; }
        .back-link { margin-top: 20px; color: var(--gold-dark); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; font-size: 13px; }

        /* Dashboard */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.active { display: flex; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--navy), var(--navy-light));
            min-height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logo { font-family: var(--font-display); font-size: 20px; color: var(--gold); }
        .sidebar-subtitle { font-size: 11px; color: var(--gold-light); margin-top: 3px; }
        .sidebar-menu { padding: 15px 0; }
        .menu-section { padding: 0 12px; margin-bottom: 8px; }
        .menu-section-title {
            font-size: 10px;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 12px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 3px;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            font-size: 13px;
            font-family: var(--font-arabic);
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: var(--white); }
        .menu-item.active { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); }
        .menu-item .badge {
            margin-right: auto;
            background: var(--burgundy);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        /* Main */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--white);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            gap: 12px;
        }
        .page-title {
            font-family: var(--font-display);
            font-size: 20px;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .top-bar-actions { display: flex; align-items: center; gap: 10px; }
        .admin-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--cream);
            border-radius: 20px;
            font-size: 13px;
        }
        .admin-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 12px;
        }
        .logout-btn {
            background: var(--error);
            color: var(--white);
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }
        .logout-btn:hover { background: #c0392b; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 3px;
        }
        .stat-card.products::before { background: var(--gold); }
        .stat-card.orders::before { background: var(--success); }
        .stat-card.users::before { background: var(--info); }
        .stat-card.revenue::before { background: var(--burgundy); }
        .stat-card.loyalty::before { background: var(--warning); }
        .stat-icon { font-size: 28px; margin-bottom: 8px; }
        .stat-value { font-size: 26px; font-weight: 800; color: var(--navy); }
        .stat-label { font-size: 12px; color: #666; }

        /* Section Card */
        .section-card {
            background: var(--white);
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 18px;
            overflow: hidden;
        }
        .section-header {
            padding: 15px 18px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); }
        .btn-gold:hover { box-shadow: 0 4px 15px rgba(212,175,55,0.4); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-info { background: var(--info); color: var(--white); }
        .btn-danger { background: var(--error); color: var(--white); }
        .btn-navy { background: var(--navy); color: var(--white); }
        .section-body { padding: 18px; }

        /* Tables */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .data-table th, .data-table td {
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .data-table th { background: var(--cream); font-weight: 700; color: var(--navy); }
        .data-table tbody tr:hover { background: var(--cream); }
        .product-cell { display: flex; align-items: center; gap: 10px; }
        .product-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: var(--white);
        }
        .status-pending { background: var(--warning); color: #333; }
        .status-confirmed { background: var(--info); }
        .status-processing { background: #9b59b6; }
        .status-shipped { background: #3498db; }
        .status-delivered { background: var(--success); }
        .status-completed { background: var(--success); }
        .status-cancelled { background: var(--error); }
        .action-btns { display: flex; gap: 5px; }
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition);
        }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.view { background: rgba(23,162,184,0.15); color: var(--info); }
        .action-btn.edit { background: rgba(212,175,55,0.15); color: var(--gold-dark); }
        .action-btn.delete { background: rgba(220,53,69,0.15); color: var(--error); }

        /* Content Section */
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
        }
        .chart-title { font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 12px; }
        .chart-container { height: 250px; position: relative; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: var(--transition);
        }
        .modal.large { max-width: 700px; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header {
            padding: 18px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        .modal-header h2 { font-size: 18px; color: var(--navy); display: flex; align-items: center; gap: 8px; }
        .close-modal {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }
        .close-modal:hover { background: #ddd; transform: rotate(90deg); }
        .modal-body{
          padding: 18px;
          max-height: 80vh;      /* أقصى ارتفاع 80% من الشاشة */
          overflow-y: auto;      /* فعل التمرير داخل المودال */
          padding-bottom: 30px;  /* مساحة تحت للزر */
}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-family: var(--font-arabic);
            transition: var(--transition);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--gold);
            outline: none;
        }
        .form-group textarea { resize: vertical; min-height: 70px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        .submit-btn:hover { box-shadow: 0 4px 15px rgba(212,175,55,0.4); }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 18px;
        }
        .settings-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
        }
        .settings-card h3 {
            font-size: 15px;
            color: var(--navy);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--cream);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .danger-zone { border: 2px solid var(--error); }
        .danger-zone h3 { color: var(--error); }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px 18px;
            background: var(--cream);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--navy);
            font-size: 12px;
            transition: var(--transition);
        }
        .tab-btn.active { background: var(--gold); color: var(--white); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Order Details */
        .order-detail-section {
            background: var(--cream);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .order-detail-section h4 {
            font-size: 14px;
            color: var(--navy);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 13px;
        }
        .order-item:last-child { border-bottom: none; }
        .order-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 800;
            color: var(--navy);
            padding-top: 12px;
            border-top: 2px solid var(--gold);
            margin-top: 10px;
        }

        /* Notifications */
        .notifications-container {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 320px;
        }
        .notification {
            background: var(--white);
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.4s ease;
            border-right: 4px solid;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        .notification.success { border-right-color: var(--success); }
        .notification.error { border-right-color: var(--error); }
        .notification-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--white);
        }
        .notification.success .notification-icon { background: var(--success); }
        .notification.error .notification-icon { background: var(--error); }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 700; font-size: 12px; color: var(--navy); }
        .notification-message { font-size: 11px; color: #666; }
        .notification-close { background: transparent; border: none; color: #999; font-size: 14px; cursor: pointer; }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state-icon { font-size: 50px; margin-bottom: 12px; opacity: 0.5; }

        /* Mobile */
        .mobile-menu-btn {
            display: none;
            background: var(--gold);
            color: var(--white);
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .overlay.active { display: block; }

        @media (max-width: 1024px) {
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; }
        }
        @media (max-width: 768px) {
            .main-content { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-value { font-size: 20px; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .modal-overlay { align-items: flex-end; padding: 10px; }
            .modal { max-width: 100%; max-height: 92dvh; border-radius: 16px; }
            .modal-body { padding: 16px; }
            .close-modal { top: 10px; left: 10px; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .settings-grid { grid-template-columns: 1fr; }
            .modal-header h2 { font-size: 16px; }
            .modal-body { padding: 14px; }
        }

        /* Status Select */
        .status-select {
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: var(--white);
        }
        .status-select:focus { border-color: var(--gold); outline: none; }

        /* Color Input */
        input[type="color"] {
            width: 50px;
            height: 35px;
            padding: 2px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Loyalty Cards */
        .loyalty-card {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 14px;
            padding: 20px;
            color: var(--white);
            text-align: center;
            margin-bottom: 15px;
        }
        .loyalty-value { font-size: 36px; font-weight: 800; }
        .loyalty-label { font-size: 13px; opacity: 0.9; }

        .user-points-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--cream);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .user-points-info { display: flex; align-items: center; gap: 10px; }
        .user-points-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--navy);
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .user-points-actions { display: flex; gap: 6px; }
        .points-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }
        .points-btn.add { background: var(--success); color: white; }
        .points-btn.sub { background: var(--error); color: white; }
    </style>
</head>
<body>
    <div class="notifications-container" id="notificationsContainer"></div>

    <!-- Login -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">🔐</div>
            <h1 class="login-title">لوحة التحكم</h1>
            <p class="login-subtitle">Sale Zone Store</p>
            <div class="login-error" id="loginError">بيانات الدخول غير صحيحة</div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>📧 البريد الإلكتروني</label>
                    <input type="email" id="adminEmail" required placeholder="أدخل البريد الإلكتروني">
                </div>
                <div class="form-group">
                    <label>🔑 كلمة المرور</label>
                    <input type="password" id="adminPassword" required placeholder="أدخل كلمة المرور">
                </div>
                <button type="submit" class="login-btn">دخول</button>
                <button type="button" class="login-btn" style="margin-top: 10px; background: #1A2744;" onclick="sendVerificationLink()">
                    إرسال رابط التحقق
                </button>
                <button type="button" class="login-btn" style="margin-top: 10px; background: #800020;" onclick="sendPasswordReset()">
                    نسيت كلمة المرور
                </button>
            </form>
            <a href="index.html" class="back-link">← العودة للمتجر</a>
            <a href="متجر_2.HTML" class="back-link" style="margin-right: 20px;">🛍️ عرض المتجر</a>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Sale Zone</div>
                <div class="sidebar-subtitle">لوحة التحكم</div>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">الرئيسية</div>
                    <button class="menu-item active" onclick="showSection('overview')">📊 نظرة عامة</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">الإدارة</div>
                    <button class="menu-item" onclick="showSection('products')">📦 المنتجات <span class="badge" id="productsCount">0</span></button>
                    <button class="menu-item" onclick="showSection('orders')">🛍️ الطلبات <span class="badge" id="ordersCount">0</span></button>
                    <button class="menu-item" onclick="showSection('banners')">🎠 البانرات</button>
                    <button class="menu-item" onclick="showSection('coupons')">🎫 الكوبونات</button>
                    <button class="menu-item" onclick="showSection('users')">👥 العملاء</button>
                    <button class="menu-item" onclick="showSection('loyalty')">💎 نقاط الولاء</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">التقارير</div>
                    <button class="menu-item" onclick="showSection('reports')">📈 التقارير</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">الإعدادات</div>
                    <button class="menu-item" onclick="showSection('storeSettings')">🏪 المتجر</button>
                    <button class="menu-item" onclick="showSection('settings')">⚙️ النظام</button>
                    <a href="متجر_2.HTML" class="menu-item">🛍️ عرض المتجر</a>
                    <a href="index.html" class="menu-item">🏠 الصفحة الرئيسية</a>
                </div>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                    <h1 class="page-title" id="pageTitle">📊 نظرة عامة</h1>
                </div>
                <div class="top-bar-actions">
                    <div class="admin-info">
                        <div class="admin-avatar">م</div>
                        <span>المدير</span>
                    </div>
                    <button class="logout-btn" onclick="adminLogout()">🚪 خروج</button>
                </div>
            </div>
            <!-- Overview -->
            <section class="content-section active" id="overviewSection">
                <div class="stats-grid">
                    <div class="stat-card products">
                        <div class="stat-icon">📦</div>
                        <div class="stat-value" id="statProducts">0</div>
                        <div class="stat-label">منتج</div>
                    </div>
                    <div class="stat-card orders">
                        <div class="stat-icon">🛍️</div>
                        <div class="stat-value" id="statOrders">0</div>
                        <div class="stat-label">طلب</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-icon">👥</div>
                        <div class="stat-value" id="statUsers">0</div>
                        <div class="stat-label">عميل</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon">💰</div>
                        <div class="stat-value" id="statRevenue">0</div>
                        <div class="stat-label">إيرادات (ج.م)</div>
                    </div>
                    <div class="stat-card loyalty">
                        <div class="stat-icon">💎</div>
                        <div class="stat-value" id="statLoyalty">0</div>
                        <div class="stat-label">نقاط ولاء</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">📈 المبيعات</div>
                        <div class="chart-container"><canvas id="salesChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">📊 الأقسام</div>
                        <div class="chart-container"><canvas id="categoriesChart"></canvas></div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🕐 آخر الطلبات</h3>
                        <button class="btn btn-gold" onclick="showSection('orders')">عرض الكل</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>رقم</th><th>العميل</th><th>المبلغ</th><th>الحالة</th><th>التاريخ</th></tr></thead>
                                <tbody id="recentOrdersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products -->
            <section class="content-section" id="productsSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">📦 المنتجات</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="openModal('productModal')">➕ إضافة</button>
                            <button class="btn btn-success" onclick="exportProductsExcel()">📤 Excel</button>
                            <input type="file" id="importProductsFile" accept=".xlsx,.xls" onchange="importProductsExcel(event)" style="display:none">
                            <button class="btn btn-info" onclick="document.getElementById('importProductsFile').click()">📥 استيراد</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>المنتج</th><th>القسم</th><th>السعر</th><th>التقييم</th><th>إجراءات</th></tr></thead>
                                <tbody id="productsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders -->
            <section class="content-section" id="ordersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🛍️ الطلبات</h3>
                        <div class="header-actions">
                            <button class="btn btn-success" onclick="exportOrdersExcel()">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>رقم</th><th>العميل</th><th>الهاتف</th><th>المبلغ</th><th>الحالة</th><th>التاريخ</th><th>إجراءات</th></tr></thead>
                                <tbody id="ordersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Banners -->
            <section class="content-section" id="bannersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🎠 البانرات</h3>
                        <button class="btn btn-gold" onclick="openModal('bannerModal')">➕ إضافة</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>أيقونة</th><th>العنوان</th><th>النص</th><th>القسم</th><th>إجراءات</th></tr></thead>
                                <tbody id="bannersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Coupons -->
            <section class="content-section" id="couponsSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">🎫 الكوبونات</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="openModal('couponModal')">➕ إضافة</button>
                            <button class="btn btn-success" onclick="exportCouponsExcel()">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>الكود</th><th>الوصف</th><th>النوع</th><th>القيمة</th><th>إجراءات</th></tr></thead>
                                <tbody id="couponsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users -->
            <section class="content-section" id="usersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">👥 العملاء</h3>
                        <button class="btn btn-success" onclick="exportUsersExcel()">📤 Excel</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>الاسم</th><th>الهاتف</th><th>البريد</th><th>النقاط</th><th>التسجيل</th></tr></thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Loyalty -->
            <section class="content-section" id="loyaltySection">
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="loyalty-card">
                        <div class="loyalty-value" id="totalLoyalty">0</div>
                        <div class="loyalty-label">💎 إجمالي النقاط</div>
                    </div>
                    <div class="loyalty-card" style="background: linear-gradient(135deg, var(--burgundy), #a00030);">
                        <div class="loyalty-value" id="loyaltyRate">5</div>
                        <div class="loyalty-label">% نسبة الاكتساب</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">⚙️ إعدادات الولاء</h3>
                    </div>
                    <div class="section-body">
                        <form onsubmit="saveLoyaltySettings(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>نسبة الاكتساب (%)</label>
                                    <input type="number" id="loyaltyRateInput" min="1" max="50" value="5">
                                </div>
                                <div class="form-group">
                                    <label>قيمة النقطة (ج.م)</label>
                                    <input type="number" id="pointValueInput" min="0.01" step="0.01" value="0.1">
                                </div>
                            </div>
                            <button type="submit" class="submit-btn" style="max-width: 200px;">💾 حفظ</button>
                        </form>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">👥 نقاط العملاء</h3>
                        <button class="btn btn-gold" onclick="openModal('pointsModal')">➕ إضافة نقاط</button>
                    </div>
                    <div class="section-body" id="loyaltyUsersList"></div>
                </div>
            </section>

            <!-- Reports -->
            <section class="content-section" id="reportsSection">
                <div class="settings-grid">
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">📦 المنتجات</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">تصدير جميع المنتجات</p>
                            <button class="btn btn-success" onclick="exportProductsExcel()" style="width: 100%;">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">🛍️ الطلبات</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">تصدير جميع الطلبات</p>
                            <button class="btn btn-success" onclick="exportOrdersExcel()" style="width: 100%;">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">👥 العملاء</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">تصدير بيانات العملاء</p>
                            <button class="btn btn-success" onclick="exportUsersExcel()" style="width: 100%;">📤 Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">📊 تقرير شامل</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">جميع البيانات</p>
                            <button class="btn btn-success" onclick="exportFullReport()" style="width: 100%;">📤 تقرير شامل</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Store Settings -->
            <section class="content-section" id="storeSettingsSection">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('general')">⚙️ عام</button>
                    <button class="tab-btn" onclick="switchTab('topbar')">📢 الشريط</button>
                    <button class="tab-btn" onclick="switchTab('footer')">🦶 الفوتر</button>
                    <button class="tab-btn" onclick="switchTab('contact')">📞 التواصل</button>
                </div>

                <div class="tab-content active" id="generalTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveGeneralSettings(event)">
                                <div class="form-group">
                                    <label>🏪 اسم المتجر</label>
                                    <input type="text" id="storeName" placeholder="Sale Zone Store">
                                </div>
                                <div class="form-group">
                                    <label>💬 الشعار</label>
                                    <input type="text" id="storeTagline" placeholder="التسوق الفاخر الذكي">
                                </div>
                                <div class="form-group">
                                    <label>📝 الوصف</label>
                                    <textarea id="storeDescription"></textarea>
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="topbarTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveTopBarSettings(event)">
                                <div class="form-group">
                                    <label>📝 النص المتحرك</label>
                                    <textarea id="topBarText" rows="2"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>🎨 لون الخلفية</label>
                                        <input type="color" id="topBarBgColor" value="#0A1128">
                                    </div>
                                    <div class="form-group">
                                        <label>🎨 لون النص</label>
                                        <input type="color" id="topBarTextColor" value="#F4E4BC">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="topBarEnabled" checked> تفعيل الشريط</label>
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="footerTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveFooterSettings(event)">
                                <div class="form-group">
                                    <label>📖 عن المتجر</label>
                                    <textarea id="footerAbout" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>⏰ أيام الأسبوع</label>
                                    <input type="text" id="workingHoursWeekdays" placeholder="السبت - الخميس: 9 ص - 10 م">
                                </div>
                                <div class="form-group">
                                    <label>⏰ الجمعة</label>
                                    <input type="text" id="workingHoursFriday" placeholder="الجمعة: 2 م - 10 م">
                                </div>
                                <div class="form-group">
                                    <label>📝 ملاحظة</label>
                                    <input type="text" id="workingHoursNote" placeholder="🔔 خدمة 24/7">
                                </div>
                                <div class="form-group">
                                    <label>©️ حقوق النشر</label>
                                    <input type="text" id="copyrightText">
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="contactTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveContactSettings(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>📞 الهاتف</label>
                                        <input type="tel" id="contactPhone" placeholder="01018108979">
                                    </div>
                                    <div class="form-group">
                                        <label>💬 واتساب</label>
                                        <input type="tel" id="contactWhatsapp" placeholder="01018108979">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>📧 الإيميل</label>
                                        <input type="email" id="contactEmail">
                                    </div>
                                    <div class="form-group">
                                        <label>📍 العنوان</label>
                                        <input type="text" id="contactAddress">
                                    </div>
                                </div>
                                <button type="submit" class="submit-btn">💾 حفظ</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Settings -->
            <section class="content-section" id="settingsSection">
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>🔐 كلمة المرور</h3>
                        <form onsubmit="changeAdminPassword(event)">
                            <div class="form-group">
                                <label>الحالية</label>
                                <input type="password" id="currentAdminPass" required>
                            </div>
                            <div class="form-group">
                                <label>الجديدة</label>
                                <input type="password" id="newAdminPass" required>
                            </div>
                            <div class="form-group">
                                <label>تأكيد</label>
                                <input type="password" id="confirmAdminPass" required>
                            </div>
                            <button type="submit" class="submit-btn">🔑 تغيير</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3>💾 النسخ الاحتياطي</h3>
                        <button class="btn btn-gold" onclick="exportAllDataJSON()" style="width: 100%; margin-bottom: 10px;">📤 تصدير JSON</button>
                        <input type="file" id="importJSONFile" accept=".json" onchange="importAllDataJSON(event)" style="display:none">
                        <button class="btn btn-info" onclick="document.getElementById('importJSONFile').click()" style="width: 100%;">📥 استيراد JSON</button>
                    </div>

                    <div class="settings-card">
                        <h3>🧹 تنظيف الصور الخارجية</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">
                            استبدال جميع الروابط الخارجية للصور بـ Placeholders محلية لتجنب مشاكل ORB/CORS.
                        </p>
                        <button class="btn btn-gold" onclick="sanitizeAllImages()" style="width: 100%;">✅ تنظيف صور المنتجات والبانرات</button>
                    </div>

                    <div class="settings-card">
                        <h3>🧪 فحص قبل النشر</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">
                            فحص سريع يمنع تكرار أخطاء العربية والترميز قبل أي رفع.
                        </p>
                        <button class="btn btn-info" onclick="runPreflightCheck()" style="width: 100%;">🔍 تشغيل الفحص</button>
                    </div>

                    <div class="settings-card danger-zone">
                        <h3>⚠️ منطقة الخطر</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">لا يمكن التراجع عن هذه الإجراءات!</p>
                        <button class="btn btn-danger" onclick="clearAllData()" style="width: 100%;">🗑️ حذف الكل</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

<!-- Modals -->
<!-- Preflight Modal -->
<div class="modal-overlay" id="preflightModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2>🧪 تقرير فحص قبل النشر</h2>
      <button class="close-modal" onclick="closeModal('preflightModal')">✕</button>
    </div>
    <div class="modal-body">
      <pre id="preflightOutput" style="white-space: pre-wrap; font-size: 13px; color: #333; background: #f7f7f7; padding: 12px; border-radius: 8px; border: 1px solid #eee;"></pre>
      <button class="btn btn-gold" onclick="copyPreflightReport()" style="width: 100%; margin-top: 10px;">📋 نسخ التقرير</button>
    </div>
  </div>
</div>

<!-- Product Modal -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="productModalTitle">➕ منتج جديد</h2>
      <button class="close-modal" onclick="closeModal('productModal')">✕</button>
    </div>

    <div class="modal-body">
      <form onsubmit="saveProduct(event)">
        <input type="hidden" id="productId">

        <div class="form-group">
          <label>اسم المنتج *</label>
          <input type="text" id="productName" required>
        </div>

        <div class="form-group">
          <label>الوصف *</label>
          <textarea id="productDesc" required></textarea>
        </div>

        <div class="form-group">
          <label>القسم *</label>
          <select id="productCategory" required>
            <option value="">اختر</option>
            <option value="hair-care">💇‍♀️ شعر</option>
            <option value="skin-care">🧴 بشرة</option>
            <option value="baby-care">👶 طفل</option>
            <option value="supplements">💊 مكملات</option>
            <option value="medical">🏥 طبي</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>السعر *</label>
            <input type="number" id="productPrice" required min="0">
          </div>
          <div class="form-group">
            <label>السعر القديم</label>
            <input type="number" id="productOldPrice" min="0">
          </div>
        </div>

        <!-- ============ صورة المنتج (رفع أو رابط) ============ -->
        <div class="form-group">
          <label>🖼️ صورة المنتج</label>

          <!-- رفع من الجهاز -->
          <input type="file" id="imgFile" accept="image/*" style="display:none" onchange="uploadAndPreview(this)">
          <button type="button"
                  onclick="document.getElementById('imgFile').click()"
                  style="background:#D4AF37;color:white;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;">
            📁 رفع من الجهاز
          </button>

          <div id="imgPreview" style="margin-top:10px;"></div>

          <!-- أو رابط -->
          <div style="margin:10px 0;color:#999;text-align:center;">— أو أدخل رابط —</div>
          <input type="url" id="manualImg" placeholder="https://..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;direction:ltr;">

          <!-- رابط نهائي (يتم تعبئته تلقائياً بعد الرفع) -->
          <input type="hidden" id="finalImg" required>
        </div>
        <!-- =================================================== -->

        <!-- زر حفظ المنتج (اللي كان ناقص) -->
        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee; text-align: center;">
          <button type="submit" class="submit-btn" style="min-width: 220px; font-size: 16px; font-weight: bold;">
            💾 حفظ المنتج
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

    <!-- Banner Modal -->
    <div class="modal-overlay" id="bannerModal">
        <div class="modal">
            <div class="modal-header">
                <h2>➕ بانر جديد</h2>
                <button class="close-modal" onclick="closeModal('bannerModal')">✕</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveBanner(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>الأيقونة</label>
                            <input type="text" id="bannerIcon" placeholder="🎉">
                        </div>
                        <div class="form-group">
                            <label>القسم</label>
                            <select id="bannerCategory">
                                <option value="all">الكل</option>
                                <option value="hair-care">شعر</option>
                                <option value="skin-care">بشرة</option>
                                <option value="baby-care">طفل</option>
                                <option value="supplements">مكملات</option>
                                <option value="medical">طبي</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>العنوان *</label>
                        <input type="text" id="bannerTitle" required>
                    </div>
                    <div class="form-group">
                        <label>النص</label>
                        <input type="text" id="bannerText">
                    </div>
                    <div class="form-group">
                        <label>نص الزر</label>
                        <input type="text" id="bannerBtn" placeholder="تسوق الآن">
                    </div>
                    <button type="submit" class="submit-btn">💾 حفظ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div class="modal-overlay" id="couponModal">
        <div class="modal">
            <div class="modal-header">
                <h2>➕ كوبون جديد</h2>
                <button class="close-modal" onclick="closeModal('couponModal')">✕</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveCoupon(event)">
                    <div class="form-group">
                        <label>الكود *</label>
                        <input type="text" id="couponCode" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>الوصف *</label>
                        <input type="text" id="couponDesc" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>النوع *</label>
                            <select id="couponType" required>
                                <option value="percentage">نسبة %</option>
                                <option value="fixed">مبلغ ثابت</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>القيمة *</label>
                            <input type="number" id="couponValue" required min="1">
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">💾 حفظ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal large">
            <div class="modal-header">
                <h2>📦 تفاصيل الطلب</h2>
                <button class="close-modal" onclick="closeModal('orderModal')">✕</button>
            </div>
            <div class="modal-body" id="orderModalBody"></div>
        </div>
    </div>

    <!-- Points Modal -->
    <div class="modal-overlay" id="pointsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>💎 إضافة/خصم نقاط</h2>
                <button class="close-modal" onclick="closeModal('pointsModal')">✕</button>
            </div>
            <div class="modal-body">
                <form onsubmit="handlePointsAction(event)">
                    <div class="form-group">
                        <label>العميل *</label>
                        <select id="pointsUserId" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>العملية *</label>
                            <select id="pointsAction" required>
                                <option value="add">➕ إضافة</option>
                                <option value="subtract">➖ خصم</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>النقاط *</label>
                            <input type="number" id="pointsAmount" required min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>السبب</label>
                        <input type="text" id="pointsReason">
                    </div>
                    <button type="submit" class="submit-btn">✅ تنفيذ</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // Data Store
        // ============================================
        let products = [];
        let orders = [];
        let coupons = [];
        let banners = [];
        let users = [];
        // 🔐 تحسين الأمان: كلمة مرور قوية افتراضياً
        // ⚠️ يُنصح بتغييرها فوراً بعد أول تسجيل دخول
        let adminPassword = null;
        let storeSettings = {
            name: 'Sale Zone Store',
            tagline: 'التسوق الفاخر الذكي',
            description: '',
            topBar: { enabled: true, text: '🎉 خصومات حصرية!', bgColor: '#0A1128', textColor: '#F4E4BC' },
            contact: { phone: '01018108979', whatsapp: '01018108979', email: 'info@salezone.com', address: 'مصر' },
            footer: { about: '', workingHoursWeekdays: 'السبت - الخميس: 9 ص - 10 م', workingHoursFriday: 'الجمعة: 2 م - 10 م', workingHoursNote: '🔔 خدمة 24/7', copyright: '© 2026 Sale Zone Store ❤️' },
            loyalty: { rate: 5, pointValue: 0.1 }
        };
        let salesChart, categoriesChart;

        // ============================================
        // ServiceWorker Auto Update (Admin)
        // ============================================
        function setupServiceWorkerAutoUpdate() {
            if (!('serviceWorker' in navigator)) {
                return;
            }

            let swRefreshing = false;
            const requestRefresh = () => {
                if (swRefreshing) return;
                swRefreshing = true;
                window.location.reload();
            };

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                requestRefresh();
            });

            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_UPDATED' && navigator.serviceWorker.controller) {
                    requestRefresh();
                }
            });

            navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                .then(registration => {
                    const updateNow = () => registration.update().catch(() => undefined);
                    updateNow();
                    setInterval(updateNow, 60 * 60 * 1000);
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') updateNow();
                    });

                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }

                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (!newWorker) return;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (registration.waiting) {
                                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                                }
                                if (navigator.serviceWorker.controller) {
                                    requestRefresh();
                                }
                            }
                        });
                    });
                })
                .catch(() => undefined);
        }

        // ============================================
        // Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            setupServiceWorkerAutoUpdate();
            await checkAdminSession();
        });

        // ============================================
        // Data Management
        // ============================================
        // 🔥 Firebase + LocalStorage Hybrid Data Loading
        async function loadAllData() {
            try {
                // محاولة تحميل من Firebase أولاً
                if (typeof getAllProducts === 'function') {
                    console.log('🔥 Admin: Loading from Firebase...');
                    
                    products = await getAllProducts() || [];
                    orders = await getAllOrders() || [];
                    users = await getAllUsers() || [];
                    coupons = await getAllCoupons() || [];
                    banners = await getAllBanners() || [];
                    
                    const settings = await getSettings();
                    if (settings) storeSettings = { ...storeSettings, ...settings };
                    
                    console.log('✅ Admin data loaded from Firebase');
                    console.log('📦 Products:', products.length);
                    console.log('📦 Product IDs:', products.map(p => p.id));
                    console.log('🛍️ Orders:', orders.length);
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (error) {
                console.warn('⚠️ Firebase error, using localStorage:', error);
                // Fallback to localStorage
                products = getStorageData('PRODUCTS') || [];
                orders = getStorageData('ORDERS') || [];
                coupons = getStorageData('COUPONS') || [];
                banners = getStorageData('BANNERS') || [];
                users = getStorageData('CUSTOMERS') || [];
            }
            
            // كلمة المرور دائماً من localStorage
            const saved = getStorageData('SETTINGS');
            if (saved) storeSettings = { ...storeSettings, ...saved };
            
            // Data loaded, rendering will be done by initDashboard()
        }

        function saveProducts() { setStorageData('PRODUCTS', products); }
        function saveOrders() { setStorageData('ORDERS', orders); }
        function saveCoupons() { setStorageData('COUPONS', coupons); }
        function saveBanners() { setStorageData('BANNERS', banners); }
        function saveUsers() { setStorageData('CUSTOMERS', users); }
        function saveAdminPassword() {}
        function saveStoreSettings() { setStorageData('SETTINGS', storeSettings); }

        // ============================================
        // Auth
        // ============================================
        const ADMIN_EMAILS = ["ahmed.sheta89@gmail.com"];
        const ALLOW_BOOTSTRAP_ADMIN = true; // Temporary until custom claims are set

        function isEmailAllowed(email) {
          return ADMIN_EMAILS.includes(String(email || '').toLowerCase());
        }

        async function requireAdminPermission() {
          if (!firebase || !firebase.auth) throw new Error('auth-not-available');
          const user = firebase.auth().currentUser;
          if (!user) throw new Error('not-authenticated');
          const token = await user.getIdTokenResult(true);
          const isClaimAdmin = token?.claims?.admin === true;
          const isBootstrapAdmin = ALLOW_BOOTSTRAP_ADMIN && user.emailVerified === true && isEmailAllowed(user.email);
          if (!isClaimAdmin && !isBootstrapAdmin) throw new Error('not-admin');
          return { isClaimAdmin, isBootstrapAdmin, user };
        }

        async function handleLogin(e){
  e.preventDefault();
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value;
  const loginError = document.getElementById('loginError');

  // Rate limiting check
  const clientIP = 'client_' + Math.random().toString(36).substr(2, 9);
  if (rateLimiter.isBlocked(clientIP)) {
    const blockTime = Math.ceil(rateLimiter.getBlockTimeRemaining(clientIP) / 60000);
    loginError.style.display = 'block';
    loginError.textContent = `تم حظر المحاولات. حاول مرة أخرى بعد ${blockTime} دقيقة`;
    return;
  }

  try{
    const userCred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCred.user;
    const token = await user.getIdTokenResult(true);
    const isAdmin = token?.claims?.admin === true;
    const isBootstrapAdmin = ALLOW_BOOTSTRAP_ADMIN && user.emailVerified === true && isEmailAllowed(user.email);

    if (!user.emailVerified) {
      await firebase.auth().signOut();
      loginError.style.display = 'block';
      loginError.textContent = 'يجب تفعيل البريد الإلكتروني أولًا للدخول كأدمن';
      return;
    }

    if (!isAdmin && !isBootstrapAdmin) {
      await firebase.auth().signOut();
      rateLimiter.recordAttempt(clientIP);
      const remaining = rateLimiter.getRemainingAttempts(clientIP);
      loginError.style.display = 'block';
      loginError.textContent = `غير مصرح لك بالدخول. محاولات متبقية: ${remaining}`;
      return;
    }

    // Reset rate limiting on successful login
    rateLimiter.attempts.delete(clientIP);
    
    // Create secure session
    const sessionId = sessionManager.createSession(userCred.user.uid, { 
      role: 'admin', 
      loginTime: new Date().toISOString() 
    });
    
    sessionStorage.setItem('adminLoggedIn', 'true');
    sessionStorage.setItem('adminSessionId', sessionId);
    
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('dashboard').classList.add('active');

    await loadAllData();
    initDashboard();
    
    if (!isAdmin && isBootstrapAdmin) {
      showNotification('info', 'تنبيه أمني', 'الدخول تم بوضع مؤقت. فعّل Custom Claims ثم عطّل ALLOW_BOOTSTRAP_ADMIN.');
    } else {
      showNotification('success', 'تم تسجيل الدخول بنجاح');
    }

  }catch(err){
    console.error('Login error:', err);
    rateLimiter.recordAttempt(clientIP);
    const remaining = rateLimiter.getRemainingAttempts(clientIP);
    loginError.style.display='block';
    loginError.textContent = `بيانات الدخول غير صحيحة. محاولات متبقية: ${remaining}`;
  }
}

async function sendVerificationLink() {
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value;
  const loginError = document.getElementById('loginError');

  if (!email || !pass) {
    loginError.style.display = 'block';
    loginError.textContent = 'أدخل البريد الإلكتروني وكلمة المرور لإرسال رابط التحقق';
    return;
  }

  try {
    const userCred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCred.user;
    if (user.emailVerified) {
      showNotification('info', 'الحساب موثّق', 'لا حاجة لإرسال رابط تحقق');
    } else {
      await user.sendEmailVerification();
      showNotification('success', 'تم الإرسال', 'تم إرسال رابط التحقق إلى بريدك');
    }
    await firebase.auth().signOut();
  } catch (err) {
    console.error(err);
    loginError.style.display = 'block';
    loginError.textContent = 'فشل إرسال رابط التحقق. تأكد من البيانات.';
  }
}

async function sendPasswordReset() {
  const email = document.getElementById('adminEmail').value.trim();
  const loginError = document.getElementById('loginError');

  if (!email) {
    loginError.style.display = 'block';
    loginError.textContent = 'أدخل البريد الإلكتروني أولاً';
    return;
  }

  try {
    await firebase.auth().sendPasswordResetEmail(email);
    showNotification('success', 'تم الإرسال', 'تم إرسال رابط استعادة كلمة المرور إلى بريدك');
  } catch (err) {
    console.error(err);
    loginError.style.display = 'block';
    loginError.textContent = 'فشل إرسال رابط الاستعادة. تأكد من البريد.';
  }
}

       function checkAdminSession() {
  if (typeof firebase !== 'undefined' && firebase.auth) {
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        sessionStorage.removeItem('adminLoggedIn');
        sessionStorage.removeItem('adminSessionId');
        sessionStorage.removeItem('adminSession');
        document.getElementById('dashboard').classList.remove('active');
        document.getElementById('loginScreen').style.display = 'flex';
        return;
      }

      const token = await user.getIdTokenResult();
      const isAdmin = token?.claims?.admin === true;
      const isBootstrapAdmin = ALLOW_BOOTSTRAP_ADMIN && user.emailVerified === true && isEmailAllowed(user.email);
      if (!user.emailVerified) {
        await firebase.auth().signOut();
        return;
      }
      if (isAdmin || isBootstrapAdmin) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        if (!products.length) {
          loadAllData().then(initDashboard);
        }
      } else {
        await firebase.auth().signOut();
      }
    });
    return;
  }

  // Fallback: no Firebase
  document.getElementById('dashboard').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'flex';
}

function adminLogout(){
  const sessionId = sessionStorage.getItem('adminSessionId');
  if (sessionId) {
    sessionManager.destroySession(sessionId);
  }
  
  sessionStorage.removeItem('adminLoggedIn');
  sessionStorage.removeItem('adminSessionId');
  sessionStorage.removeItem('adminSession');
  
  // Clear Firebase auth if used
  if (typeof firebase !== 'undefined' && firebase.auth()) {
    firebase.auth().signOut();
  }
  
  showNotification('info', 'تم تسجيل الخروج بنجاح');
  location.reload();
}

        // ============================================
        // Dashboard
        // ============================================
        function initDashboard() {
            updateStats();
            updateBadges();
            renderProductsTable();
            renderOrdersTable();
            renderBannersTable();
            renderCouponsTable();
            renderUsersTable();
            renderRecentOrders();
            renderLoyaltySection();
            loadSettingsToForms();
            initCharts();
        }

        function updateStats() {
            document.getElementById('statProducts').textContent = products.length;
            document.getElementById('statOrders').textContent = orders.length;
            document.getElementById('statUsers').textContent = users.length;
            document.getElementById('statRevenue').textContent = orders.reduce((s, o) => s + (o.total || 0), 0).toLocaleString();
            document.getElementById('statLoyalty').textContent = users.reduce((s, u) => s + (u.loyaltyPoints || 0), 0);
        }

        function updateBadges() {
            document.getElementById('productsCount').textContent = products.length;
            document.getElementById('ordersCount').textContent = orders.filter(o => o.status === 'pending').length;
        }

        // ============================================
        // Products
        // ============================================
        function sanitizeImageUrl(url) {
            const placeholder = './assets/placeholder.svg';
            if (!url || typeof url !== 'string') return placeholder;

            const trimmed = url.trim();
            if (trimmed.startsWith('data:')) return trimmed;
            if (trimmed.startsWith('./') || trimmed.startsWith('assets/')) return trimmed;

            try {
                const parsed = new URL(trimmed, window.location.origin);
                if (parsed.origin === window.location.origin) {
                    return parsed.pathname + parsed.search + parsed.hash;
                }
            } catch (e) {
                return placeholder;
            }

            return placeholder;
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTable');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">📦</div><p>لا توجد منتجات</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td><div class="product-cell"><img src="${sanitizeImageUrl(p.image)}" class="product-img" onerror="this.src='${sanitizeImageUrl('')}'"><div><strong>${p.name}</strong></div></div></td>
                    <td>${getCategoryName(p.category)}</td>
                    <td><strong>${p.price} ج.م</strong></td>
                    <td>⭐ ${(p.rating || 0).toFixed(1)}</td>
                    <td><div class="action-btns"><button class="action-btn edit" onclick="editProduct('${p.id}')">✏️</button><button class="action-btn delete" onclick="deleteProduct('${p.id}')">🗑️</button></div></td>
                </tr>
            `).join('');
        }

        // ============================================
        // Bulk sanitize external images (professional fix)
        // ============================================
        function isExternalImageUrl(url) {
            if (!url || typeof url !== 'string') return false;
            const trimmed = url.trim();
            if (trimmed.startsWith('data:')) return false;
            if (trimmed.startsWith('./') || trimmed.startsWith('assets/')) return false;
            try {
                const parsed = new URL(trimmed, window.location.origin);
                return parsed.origin !== window.location.origin;
            } catch (e) {
                return false;
            }
        }

        async function sanitizeAllImages() {
            if (!confirm('هل تريد استبدال كل الصور الخارجية ببدائل محلية؟')) return;

            const productPlaceholder = './assets/placeholder.svg';
            const bannerPlaceholder = './assets/banner-placeholder.svg';

            let productsUpdated = 0;
            let bannersUpdated = 0;

            // Update products
            products = products.map(p => {
                if (isExternalImageUrl(p.image)) {
                    productsUpdated += 1;
                    return { ...p, image: productPlaceholder };
                }
                return p;
            });

            // Update banners (if banners are used in admin data)
            if (Array.isArray(banners)) {
                banners = banners.map(b => {
                    if (isExternalImageUrl(b.image)) {
                        bannersUpdated += 1;
                        return { ...b, image: bannerPlaceholder };
                    }
                    return b;
                });
            }

            // Persist locally
            if (typeof saveProducts === 'function') saveProducts();
            if (typeof saveBanners === 'function') saveBanners();

            // Update Firebase if available
            try {
                if (typeof updateProduct === 'function') {
                    for (const p of products) {
                        if (p.id && p.image === productPlaceholder) {
                            await updateProduct(p.id, { image: p.image });
                        }
                    }
                }
                if (typeof updateBanner === 'function') {
                    for (const b of banners) {
                        if (b.id && b.image === bannerPlaceholder) {
                            await updateBanner(b.id, { image: b.image });
                        }
                    }
                }
            } catch (e) {
                console.warn('Firebase update skipped or failed:', e);
            }

            renderProductsTable();
            renderBannersTable();
            showNotification('success', 'تم تنظيف الصور', `تم تحديث ${productsUpdated} منتج و ${bannersUpdated} بانر`);
        }

        function getCategoryName(cat) {
            const names = { 'hair-care': 'شعر', 'skin-care': 'بشرة', 'baby-care': 'طفل', 'supplements': 'مكملات', 'medical': 'طبي' };
            return names[cat] || cat;
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value.trim();
            const imageUrl = document.getElementById('finalImg').value || document.getElementById('manualImg').value;
            if (!imageUrl) {
        showNotification('error', '❌ الصورة مطلوبة', 'يرجى رفع صورة أو إدخال رابط');
        return;
    }
    
    const data = {
        name: document.getElementById('productName').value.trim(),
        desc: document.getElementById('productDesc').value.trim(),
        category: document.getElementById('productCategory').value,
        price: parseFloat(document.getElementById('productPrice').value),
        oldPrice: parseFloat(document.getElementById('productOldPrice').value) || null,
        image: imageUrl, // ← هنا استخدمنا المتغير الجديد
        rating: 4.5,
        ratingCount: 0
    };
            try {
                await requireAdminPermission();
                if (id) {
                    // تحديث منتج موجود
                    const idx = products.findIndex(p => String(p.id) === String(id));
                    if (idx !== -1) {
                        products[idx] = { ...products[idx], ...data };
                        if (typeof updateProduct === 'function') {
                            await updateProduct(id, { ...products[idx] });
                        }
                    }
                    showNotification('success', 'تم التحديث بنجاح');
                } else {
                    // إضافة منتج جديد
                    if (typeof addProduct === 'function') {
                        const firebaseId = await addProduct(data);
                        data.id = firebaseId;
                    } else {
                        data.id = Date.now().toString();
                    }
                    products.push(data);
                    showNotification('success', 'تمت الإضافة بنجاح');
                }
            } catch (error) {
                console.error('Firebase save error:', error);
                showNotification('error', 'فشل الحفظ', 'لا تملك صلاحيات أو يوجد خطأ بالاتصال');
                return;
            }

            saveProducts();
            renderProductsTable();
            updateStats();
            closeModal('productModal');
            resetProductForm();
        }

        function editProduct(id) {
  const p = products.find(x => String(x.id) === String(id));
  if (!p) return;

  document.getElementById('productId').value = p.id || '';
  document.getElementById('productName').value = p.name || '';
  document.getElementById('productDesc').value = p.desc || '';
  document.getElementById('productCategory').value = p.category || '';
  document.getElementById('productPrice').value = p.price ?? '';
  document.getElementById('productOldPrice').value = p.oldPrice ?? '';

  // ✅ الصورة
  const img = p.image || '';
  document.getElementById('finalImg').value = img;
  document.getElementById('manualImg').value = img;

  // ✅ معاينة الصورة (اختياري)
  const preview = document.getElementById('imgPreview');
  if (preview) {
    const safeImg = img ? sanitizeImageUrl(img) : '';
    preview.innerHTML = safeImg
      ? `<img src="${safeImg}" style="max-width:150px;border-radius:8px;border:2px solid #D4AF37;margin-top:10px;" onerror="this.style.display='none'">`
      : '';
  }

  // (اختياري) تصفير اختيار الملف عشان لو هيرفع صورة جديدة
  const fileInput = document.getElementById('imgFile');
  if (fileInput) fileInput.value = '';

  document.getElementById('productModalTitle').textContent = '✏️ تعديل';
  openModal('productModal');
}

        async function deleteProduct(id) {
            if (!confirm('حذف المنتج؟')) return;
            try {
                await requireAdminPermission();
                if (typeof deleteProductFromFirebase === 'function') {
                    await deleteProductFromFirebase(id);
                }
                products = products.filter(p => p.id != id && String(p.id) != String(id));
                saveProducts();
                renderProductsTable();
                updateStats();
                showNotification('success', 'تم الحذف ✅');
            } catch (error) {
                console.error('Firebase delete error:', error);
                showNotification('error', 'فشل الحذف', 'لا تملك صلاحيات أو يوجد خطأ بالاتصال');
            }
        }


        function resetProductForm() {
  // IDs الجديدة + الأساسية
  const idsToClear = [
    'productId',
    'productName',
    'productDesc',
    'productCategory',
    'productPrice',
    'productOldPrice',

    // نظام الصورة الجديد
    'manualImg',
    'finalImg',
    'imgFile'
  ];

  idsToClear.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return; // ✅ لو العنصر مش موجود ما نعملش خطأ

    if (el.type === 'file') el.value = '';
    else el.value = '';
  });

  // مسح المعاينة
  const preview = document.getElementById('imgPreview');
  if (preview) preview.innerHTML = '';

  // (توافق مع IDs قديمة لو موجودة عندك في أي جزء)
  const legacy = ['productImage', 'productImageUrl', 'imagePreviewContainer', 'uploadStatus'];
  legacy.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'DIV') el.innerHTML = '';
    else el.value = '';
  });

  // عنوان المودال يرجع افتراضي
  const title = document.getElementById('productModalTitle');
  if (title) title.textContent = '➕ منتج جديد';
}

        // ============================================
        // Orders
        // ============================================
        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTable');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">🛍️</div><p>لا توجد طلبات</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = orders.map(o => `
                <tr>
                    <td><strong>${o.orderNumber || o.id}</strong></td>
                    <td>${o.customer?.name || '-'}</td>
                    <td>${o.customer?.phone || '-'}</td>
                    <td><strong>${o.total || 0} ج.م</strong></td>
                    <td><span class="status-badge status-${o.status}">${getStatusName(o.status)}</span></td>
                    <td>${formatDate(o.createdAt)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" onclick="viewOrder('${o.id}')">👁️</button>
                            <button class="action-btn delete" onclick="deleteOrder('${o.id}')">🗑️</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecentOrders() {
            const tbody = document.getElementById('recentOrdersTable');
            const recent = orders.slice(-5).reverse();
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">لا توجد طلبات</td></tr>';
                return;
            }
            tbody.innerHTML = recent.map(o => `
                <tr>
                    <td><strong>${o.orderNumber || o.id}</strong></td>
                    <td>${o.customer?.name || '-'}</td>
                    <td><strong>${o.total || 0} ج.م</strong></td>
                    <td><span class="status-badge status-${o.status}">${getStatusName(o.status)}</span></td>
                    <td>${formatDate(o.createdAt)}</td>
                </tr>
            `).join('');
        }

        function getStatusName(s) {
            const names = { pending: 'جديد', confirmed: 'مؤكد', processing: 'تجهيز', shipped: 'شحن', delivered: 'توصيل', completed: 'مكتمل', cancelled: 'ملغي' };
            return names[s] || s;
        }

        function formatDate(d) {
            if (!d) return '-';
            return new Date(d).toLocaleDateString('ar-EG');
        }

        function viewOrder(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;

            let itemsHtml = o.items?.map(i => `
                <div class="order-item">
                    <span>${i.name} × ${i.quantity}</span>
                    <strong>${i.price * i.quantity} ج.م</strong>
                </div>
            `).join('') || '';

            document.getElementById('orderModalBody').innerHTML = `
                <div class="order-detail-section">
                    <h4>📋 الطلب</h4>
                    <p><strong>رقم:</strong> ${o.orderNumber || o.id}</p>
                    <p><strong>التاريخ:</strong> ${formatDate(o.createdAt)}</p>
                    <p><strong>الحالة:</strong> 
                        <select class="status-select" onchange="updateOrderStatus('${o.id}', this.value)">
                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>جديد</option>
                            <option value="confirmed" ${o.status === 'confirmed' ? 'selected' : ''}>مؤكد</option>
                            <option value="processing" ${o.status === 'processing' ? 'selected' : ''}>تجهيز</option>
                            <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>شحن</option>
                            <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>توصيل</option>
                            <option value="completed" ${o.status === 'completed' ? 'selected' : ''}>مكتمل</option>
                            <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>ملغي</option>
                        </select>
                    </p>
                </div>

                <div class="order-detail-section">
                    <h4>👤 العميل</h4>
                    <p><strong>الاسم:</strong> ${o.customer?.name}</p>
                    <p><strong>الهاتف:</strong> ${o.customer?.phone}</p>
                    <p><strong>العنوان:</strong> ${o.customer?.address}</p>
                    ${o.customer?.notes ? `<p><strong>ملاحظات:</strong> ${o.customer.notes}</p>` : ''}
                </div>

                <div class="order-detail-section">
                    <h4>📦 المنتجات</h4>
                    ${itemsHtml || '<p>لا توجد</p>'}
                    
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #ddd;">
                        <div class="order-item"><span>المجموع:</span><span>${o.subtotal || 0} ج.م</span></div>
                        ${o.couponCode ? `<div class="order-item" style="color: var(--success);"><span>🎫 ${o.couponCode}</span><span>- ${o.discount || 0} ج.م</span></div>` : ''}
                        ${o.usedPoints > 0 ? `<div class="order-item" style="color: var(--info);"><span>💎 نقاط (${o.usedPoints})</span><span>- ${o.pointsDiscount || 0} ج.م</span></div>` : ''}
                        ${o.earnedPoints > 0 ? `<div class="order-item" style="color: var(--burgundy);"><span>⭐ نقاط مكتسبة</span><span>+${o.earnedPoints}</span></div>` : ''}
                    </div>
                    <div class="order-total"><span>الإجمالي:</span><span>${o.total || 0} ج.م</span></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-navy" onclick="printOrder('${o.id}')" style="flex: 1;">🖨️ طباعة</button>
                    <button class="btn btn-success" onclick="sendWhatsAppUpdate('${o.id}')" style="flex: 1;">💬 واتساب</button>
                </div>
            `;
            openModal('orderModal');
        }

        function updateOrderStatus(id, status) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            o.status = status;
            if (!o.statusHistory) o.statusHistory = [];
            o.statusHistory.push({ status, date: new Date().toISOString() });
            saveOrders();
            renderOrdersTable();
            renderRecentOrders();
            updateBadges();
            showNotification('success', 'تم تحديث الحالة');
        }

        function sendWhatsAppUpdate(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            const phone = o.customer?.phone || '';
            const msg = `مرحباً ${o.customer?.name}!\n\n📦 طلبك رقم: ${o.orderNumber}\n📍 الحالة: ${getStatusName(o.status)}\n\nشكراً لتسوقك معنا! 🛍️`;
            window.open(`https://wa.me/2${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function printOrder(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            const w = window.open('', '_blank');
            w.document.write(`
                <!DOCTYPE html>
                <html dir="rtl"><head><title>فاتورة ${o.orderNumber}</title>
                <style>body{font-family:Arial;padding:20px}h1{color:#D4AF37;text-align:center}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:10px;text-align:right}th{background:#f5f5f5;font-weight:700;color:#0A1128}.total{font-size:20px;font-weight:bold}</style></head>
                <body>
                <h1>Sale Zone Store</h1>
                <h2>فاتورة: ${o.orderNumber}</h2>
                <p><strong>التاريخ:</strong> ${formatDate(o.createdAt)}</p>
                <p><strong>العميل:</strong> ${o.customer?.name}</p>
                <p><strong>الهاتف:</strong> ${o.customer?.phone}</p>
                <p><strong>العنوان:</strong> ${o.customer?.address}</p>
                <table><tr><th>المنتج</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th></tr>
                ${o.items?.map(i => `<tr><td>${i.name}</td><td>${i.quantity}</td><td>${i.price}</td><td>${i.price * i.quantity}</td></tr>`).join('')}
                </table>
                <p class="total">الإجمالي: ${o.total} ج.م</p>
                <p style="text-align:center">شكراً لتسوقك معنا! 📞 ${storeSettings.contact?.phone}</p>
                </body></html>
            `);
            w.document.close();
            w.print();
        }

        function deleteOrder(id) {
            if (!confirm('حذف الطلب؟')) return;
            orders = orders.filter(o => String(o.id) !== String(id));
            saveOrders();
            renderOrdersTable();
            renderRecentOrders();
            updateStats();
            showNotification('success', 'تم الحذف');
        }

        // ============================================
        // Banners
        // ============================================
        function renderBannersTable() {
            const tbody = document.getElementById('bannersTable');
            if (banners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">🎠</div><p>لا توجد بانرات</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = banners.map(b => `
                <tr>
                    <td style="font-size: 24px;">${b.icon || '🎉'}</td>
                    <td><strong>${b.title}</strong></td>
                    <td>${b.text || '-'}</td>
                    <td>${getCategoryName(b.category) || 'الكل'}</td>
                    <td><button class="action-btn delete" onclick="deleteBanner('${b.id}')">🗑️</button></td>
                </tr>
            `).join('');
        }

        async function saveBanner(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                icon: document.getElementById('bannerIcon').value || '🎉',
                title: document.getElementById('bannerTitle').value.trim(),
                text: document.getElementById('bannerText').value.trim(),
                btn: document.getElementById('bannerBtn').value.trim() || 'تسوق الآن',
                category: document.getElementById('bannerCategory').value
            };
            try {
                if (typeof addBanner === 'function') {
                    const firebaseId = await addBanner(data);
                    data.id = firebaseId;
                }
            } catch (error) { console.error('Firebase error:', error); if (!data.id) data.id = Date.now(); }
            banners.push(data);
            saveBanners();
            renderBannersTable();
            closeModal('bannerModal');
            showNotification('success', 'تمت الإضافة ✅');
            document.getElementById('bannerIcon').value = '';
            document.getElementById('bannerTitle').value = '';
            document.getElementById('bannerText').value = '';
            document.getElementById('bannerBtn').value = '';
        }

        async function deleteBanner(id) {
            if (!confirm('حذف البانر؟')) return;
            try {
                if (typeof deleteBannerFromFirebase === 'function') {
                    await deleteBannerFromFirebase(id);
                }
            } catch (error) { console.error('Firebase delete error:', error); }
            banners = banners.filter(b => String(b.id) !== String(id));
            saveBanners();
            renderBannersTable();
            showNotification('success', 'تم الحذف ✅');
        }

        // ============================================
        // Coupons
        // ============================================
        function renderCouponsTable() {
            const tbody = document.getElementById('couponsTable');
            if (coupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">🎫</div><p>لا توجد كوبونات</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = coupons.map(c => `
                <tr>
                    <td><strong style="color: var(--burgundy);">${c.code}</strong></td>
                    <td>${c.desc}</td>
                    <td>${c.type === 'percentage' ? 'نسبة' : 'ثابت'}</td>
                    <td><strong>${c.value}${c.type === 'percentage' ? '%' : ' ج.م'}</strong></td>
                    <td><button class="action-btn delete" onclick="deleteCoupon('${c.id}')">🗑️</button></td>
                </tr>
            `).join('');
        }

        async function saveCoupon(e) {
            e.preventDefault();
            const code = document.getElementById('couponCode').value.trim().toUpperCase();
            if (coupons.find(c => c.code === code)) {
                showNotification('error', 'الكود موجود');
                return;
            }
            coupons.push({
                id: Date.now(),
                code,
                desc: document.getElementById('couponDesc').value.trim(),
                type: document.getElementById('couponType').value,
                value: parseFloat(document.getElementById('couponValue').value)
            });
            saveCoupons();
            renderCouponsTable();
            closeModal('couponModal');
            showNotification('success', 'تمت الإضافة');
            document.getElementById('couponCode').value = '';
            document.getElementById('couponDesc').value = '';
            document.getElementById('couponValue').value = '';
        }

        async function deleteCoupon(id) {
            if (!confirm('حذف الكوبون؟')) return;
            try {
                if (typeof deleteCouponFromFirebase === 'function') {
                    await deleteCouponFromFirebase(id);
                }
            } catch (error) { console.error('Firebase delete error:', error); }
            coupons = coupons.filter(c => String(c.id) !== String(id));
            saveCoupons();
            renderCouponsTable();
            showNotification('success', 'تم الحذف ✅');
        }

        // ============================================
        // Users
        // ============================================
        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">👥</div><p>لا يوجد عملاء</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.phone}</td>
                    <td>${u.email || '-'}</td>
                    <td><strong style="color: var(--gold-dark);">${u.loyaltyPoints || 0}</strong></td>
                    <td>${formatDate(u.createdAt)}</td>
                </tr>
            `).join('');
        }

        // ============================================
        // Loyalty
        // ============================================
        function renderLoyaltySection() {
            const total = users.reduce((s, u) => s + (u.loyaltyPoints || 0), 0);
            document.getElementById('totalLoyalty').textContent = total;
            document.getElementById('loyaltyRate').textContent = storeSettings.loyalty?.rate || 5;
            document.getElementById('loyaltyRateInput').value = storeSettings.loyalty?.rate || 5;
            document.getElementById('pointValueInput').value = storeSettings.loyalty?.pointValue || 0.1;

            const list = document.getElementById('loyaltyUsersList');
            const select = document.getElementById('pointsUserId');

            if (users.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">👥</div><p>لا يوجد عملاء</p></div>';
                select.innerHTML = '<option value="">لا يوجد</option>';
                return;
            }

            list.innerHTML = users.map(u => `
                <div class="user-points-card">
                    <div class="user-points-info">
                        <div class="user-points-avatar">${u.name.charAt(0)}</div>
                        <div><strong>${u.name}</strong><div style="font-size:11px;color:#666;">${u.phone}</div></div>
                    </div>
                    <strong style="color: var(--gold-dark); font-size: 18px;">${u.loyaltyPoints || 0}</strong>
                    <div class="user-points-actions">
                        <button class="points-btn add" onclick="quickAddPoints('${u.id}')">➕</button>
                        <button class="points-btn sub" onclick="quickSubPoints('${u.id}')">➖</button>
                    </div>
                </div>
            `).join('');

            select.innerHTML = '<option value="">اختر</option>' + users.map(u => `<option value="${u.id}">${u.name} (${u.loyaltyPoints || 0})</option>`).join('');
        }

        function saveLoyaltySettings(e) {
            e.preventDefault();
            storeSettings.loyalty = {
                rate: parseFloat(document.getElementById('loyaltyRateInput').value),
                pointValue: parseFloat(document.getElementById('pointValueInput').value)
            };
            saveStoreSettings();
            renderLoyaltySection();
            showNotification('success', 'تم الحفظ');
        }

        function quickAddPoints(userId) {
            const pts = prompt('عدد النقاط:');
            if (pts && !isNaN(pts)) {
                const u = users.find(x => x.id === userId);
                if (u) {
                    u.loyaltyPoints = (u.loyaltyPoints || 0) + parseInt(pts);
                    saveUsers();
                    renderLoyaltySection();
                    renderUsersTable();
                    updateStats();
                    showNotification('success', `تم إضافة ${pts} نقطة`);
                }
            }
        }

        function quickSubPoints(userId) {
            const pts = prompt('عدد النقاط:');
            if (pts && !isNaN(pts)) {
                const u = users.find(x => x.id === userId);
                if (u) {
                    u.loyaltyPoints = Math.max(0, (u.loyaltyPoints || 0) - parseInt(pts));
                    saveUsers();
                    renderLoyaltySection();
                    renderUsersTable();
                    updateStats();
                    showNotification('success', `تم خصم ${pts} نقطة`);
                }
            }
        }

        function handlePointsAction(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('pointsUserId').value);
            const action = document.getElementById('pointsAction').value;
            const amount = parseInt(document.getElementById('pointsAmount').value);
            const u = users.find(x => x.id === userId);
            if (!u) { showNotification('error', 'اختر عميل'); return; }
            if (action === 'add') u.loyaltyPoints = (u.loyaltyPoints || 0) + amount;
            else u.loyaltyPoints = Math.max(0, (u.loyaltyPoints || 0) - amount);
            saveUsers();
            renderLoyaltySection();
            renderUsersTable();
            updateStats();
            closeModal('pointsModal');
            showNotification('success', 'تم');
        }

        // ============================================
        // Store Settings
        // ============================================
        function loadSettingsToForms() {
            document.getElementById('storeName').value = storeSettings.name || '';
            document.getElementById('storeTagline').value = storeSettings.tagline || '';
            document.getElementById('storeDescription').value = storeSettings.description || '';
            document.getElementById('topBarText').value = storeSettings.topBar?.text || '';
            document.getElementById('topBarBgColor').value = storeSettings.topBar?.bgColor || '#0A1128';
            document.getElementById('topBarTextColor').value = storeSettings.topBar?.textColor || '#F4E4BC';
            document.getElementById('topBarEnabled').checked = storeSettings.topBar?.enabled !== false;
            document.getElementById('contactPhone').value = storeSettings.contact?.phone || '';
            document.getElementById('contactWhatsapp').value = storeSettings.contact?.whatsapp || '';
            document.getElementById('contactEmail').value = storeSettings.contact?.email || '';
            document.getElementById('contactAddress').value = storeSettings.contact?.address || '';
            document.getElementById('footerAbout').value = storeSettings.footer?.about || '';
            document.getElementById('workingHoursWeekdays').value = storeSettings.footer?.workingHoursWeekdays || '';
            document.getElementById('workingHoursFriday').value = storeSettings.footer?.workingHoursFriday || '';
            document.getElementById('workingHoursNote').value = storeSettings.footer?.workingHoursNote || '';
            document.getElementById('copyrightText').value = storeSettings.footer?.copyright || '';
        }

        function saveGeneralSettings(e) {
            e.preventDefault();
            storeSettings.name = document.getElementById('storeName').value.trim();
            storeSettings.tagline = document.getElementById('storeTagline').value.trim();
            storeSettings.description = document.getElementById('storeDescription').value.trim();
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function saveTopBarSettings(e) {
            e.preventDefault();
            storeSettings.topBar = {
                enabled: document.getElementById('topBarEnabled').checked,
                text: document.getElementById('topBarText').value.trim(),
                bgColor: document.getElementById('topBarBgColor').value,
                textColor: document.getElementById('topBarTextColor').value
            };
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function saveFooterSettings(e) {
            e.preventDefault();
            storeSettings.footer = {
                about: document.getElementById('footerAbout').value.trim(),
                workingHoursWeekdays: document.getElementById('workingHoursWeekdays').value.trim(),
                workingHoursFriday: document.getElementById('workingHoursFriday').value.trim(),
                workingHoursNote: document.getElementById('workingHoursNote').value.trim(),
                copyright: document.getElementById('copyrightText').value.trim()
            };
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function saveContactSettings(e) {
            e.preventDefault();
            storeSettings.contact = {
                phone: document.getElementById('contactPhone').value.trim(),
                whatsapp: document.getElementById('contactWhatsapp').value.trim(),
                email: document.getElementById('contactEmail').value.trim(),
                address: document.getElementById('contactAddress').value.trim()
            };
            saveStoreSettings();
            showNotification('success', 'تم الحفظ');
        }

        function switchTab(name) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + 'Tab').classList.add('active');
        }

        // ============================================
        // Excel Export/Import
        // ============================================
        function exportProductsExcel() {
            const data = products.map(p => ({ 'الاسم': p.name, 'الوصف': p.desc, 'القسم': getCategoryName(p.category), 'السعر': p.price, 'السعر القديم': p.oldPrice || '', 'التقييم': p.rating, 'الصورة': p.image }));
            exportToExcel(data, 'products');
        }

        function exportOrdersExcel() {
            const data = orders.map(o => ({ 'رقم': o.orderNumber, 'العميل': o.customer?.name, 'الهاتف': o.customer?.phone, 'العنوان': o.customer?.address, 'المبلغ': o.total, 'الكوبون': o.couponCode || '', 'الخصم': o.discount || 0, 'الحالة': getStatusName(o.status), 'التاريخ': formatDate(o.createdAt) }));
            exportToExcel(data, 'orders');
        }

        function exportUsersExcel() {
            const data = users.map(u => ({ 'الاسم': u.name, 'الهاتف': u.phone, 'البريد': u.email || '', 'العنوان': u.address, 'النقاط': u.loyaltyPoints || 0, 'التسجيل': formatDate(u.createdAt) }));
            exportToExcel(data, 'users');
        }

        function exportCouponsExcel() {
            const data = coupons.map(c => ({ 'الكود': c.code, 'الوصف': c.desc, 'النوع': c.type === 'percentage' ? 'نسبة' : 'ثابت', 'القيمة': c.value }));
            exportToExcel(data, 'coupons');
        }

        function exportFullReport() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(products.map(p => ({ 'الاسم': p.name, 'القسم': getCategoryName(p.category), 'السعر': p.price }))), 'المنتجات');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(orders.map(o => ({ 'رقم': o.orderNumber, 'العميل': o.customer?.name, 'المبلغ': o.total, 'الحالة': getStatusName(o.status) }))), 'الطلبات');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(users.map(u => ({ 'الاسم': u.name, 'الهاتف': u.phone, 'النقاط': u.loyaltyPoints || 0 }))), 'العملاء');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{ 'المنتجات': products.length, 'الطلبات': orders.length, 'العملاء': users.length, 'الإيرادات': orders.reduce((s, o) => s + (o.total || 0), 0) }]), 'ملخص');
            XLSX.writeFile(wb, `تقرير-${Date.now()}.xlsx`);
            showNotification('success', 'تم التصدير');
        }

        function exportToExcel(data, name) {
            if (data.length === 0) { showNotification('error', 'لا توجد بيانات'); return; }
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, name);
            XLSX.writeFile(wb, `${name}-${Date.now()}.xlsx`);
            showNotification('success', 'تم التصدير');
        }

        function importProductsExcel(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const wb = XLSX.read(ev.target.result, { type: 'binary' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    let count = 0;
                    data.forEach(row => {
                        if (row['الاسم'] && row['السعر']) {
                            products.push({ id: Date.now() + Math.random(), name: row['الاسم'], desc: row['الوصف'] || '', category: 'supplements', price: parseFloat(row['السعر']), oldPrice: parseFloat(row['السعر القديم']) || null, image: row['الصورة'] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0xNTAgMTkwQzEzNS4wNDYgMTkwIDEyMy4yOTkgMTc4LjI1MyAxMjMuMjk5IDE2M0MxMjMuMjk5IDE0Ny43NDcgMTM1LjA0NiAxMzYgMTUwIDEzNkMxNjQuOTU0IDEzNiAxNzYuNzAxIDE0Ny43NDcgMTc2LjcwMSAxNjNDMTc2LjcwMSAxNzguMjUzIDE2NC45NTQgMTkwIDE1MCAxOTBaIiBmaWxsPSIjOUNDOUNDOSIvPgo8L3N2Zz4K', rating: 4.5, ratingCount: 0 });
                            count++;
                        }
                    });
                    saveProducts();
                    renderProductsTable();
                    updateStats();
                    showNotification('success', `تم استيراد ${count} منتج`);
                } catch (err) { showNotification('error', 'خطأ في الملف'); }
            };
            reader.readAsBinaryString(file);
            e.target.value = '';
        }

        // ============================================
        // JSON Backup
        // ============================================
        function exportAllDataJSON() {
            const data = { products, orders, coupons, banners, users, storeSettings };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup-${Date.now()}.json`;
            a.click();
            showNotification('success', 'تم التصدير');
        }

        function importAllDataJSON(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.products) { products = data.products; saveProducts(); }
                    if (data.orders) { orders = data.orders; saveOrders(); }
                    if (data.coupons) { coupons = data.coupons; saveCoupons(); }
                    if (data.banners) { banners = data.banners; saveBanners(); }
                    if (data.users) { users = data.users; saveUsers(); }
                    if (data.storeSettings) { storeSettings = data.storeSettings; saveStoreSettings(); }
                    initDashboard();
                    showNotification('success', 'تم الاستيراد');
                } catch (err) { showNotification('error', 'ملف غير صالح'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function clearAllData() {
            if (!confirm('⚠️ حذف كل البيانات؟')) return;
            if (!confirm('⚠️ متأكد؟ لا يمكن التراجع!')) return;
            localStorage.clear();
            products = []; orders = []; coupons = []; banners = []; users = [];
            initDashboard();
            showNotification('success', 'تم الحذف');
        }

        async function changeAdminPassword(e) {
            e.preventDefault();
            const current = document.getElementById('currentAdminPass').value;
            const newPass = document.getElementById('newAdminPass').value;
            const confirm = document.getElementById('confirmAdminPass').value;
            if (newPass !== confirm) { showNotification('error', 'غير متطابقة'); return; }
            const user = firebase.auth().currentUser;
            if (!user) { showNotification('error', 'سجل دخول مرة أخرى'); return; }
            try {
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, current);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPass);
                showNotification('success', 'تم التغيير');
                document.getElementById('currentAdminPass').value = '';
                document.getElementById('newAdminPass').value = '';
                document.getElementById('confirmAdminPass').value = '';
            } catch (err) {
                showNotification('error', 'فشل تغيير كلمة المرور');
            }
        }

        // ============================================
        // Charts
        // ============================================
        function initCharts() {
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
            if (salesCtx) {
                if (salesChart) salesChart.destroy();
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        datasets: [{ label: 'المبيعات', data: [1200, 1900, 3000, 5000, 4000, 6000], borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            const catCtx = document.getElementById('categoriesChart')?.getContext('2d');
            if (catCtx) {
                if (categoriesChart) categoriesChart.destroy();
                categoriesChart = new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['شعر', 'بشرة', 'طفل', 'مكملات', 'طبي'],
                        datasets: [{ data: [products.filter(p => p.category === 'hair-care').length, products.filter(p => p.category === 'skin-care').length, products.filter(p => p.category === 'baby-care').length, products.filter(p => p.category === 'supplements').length, products.filter(p => p.category === 'medical').length], backgroundColor: ['#B76E79', '#E8A0BF', '#7EC8E3', '#4CAF50', '#2196F3'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        // ============================================
        // UI
        // ============================================
        function showSection(name) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(name + 'Section').classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event?.target?.classList.add('active');
            const titles = { overview: '📊 نظرة عامة', products: '📦 المنتجات', orders: '🛍️ الطلبات', banners: '🎠 البانرات', coupons: '🎫 الكوبونات', users: '👥 العملاء', loyalty: '💎 نقاط الولاء', reports: '📈 التقارير', storeSettings: '🏪 المتجر', settings: '⚙️ النظام' };
            document.getElementById('pageTitle').textContent = titles[name] || name;
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(modalId) {
  document.getElementById(modalId)?.classList.remove('active');
  if (modalId === 'productModal') resetProductForm();
}

        document.querySelectorAll('.modal-overlay').forEach(o => {
            o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        });

        function showNotification(type, message) {
            const container = document.getElementById('notificationsContainer');
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.innerHTML = `<div class="notification-icon">${type === 'success' ? '✓' : '✕'}</div><div class="notification-content"><div class="notification-title">${type === 'success' ? 'نجاح' : 'خطأ'}</div><div class="notification-message">${message}</div></div><button class="notification-close" onclick="this.parentElement.remove()">✕</button>`;
            container.appendChild(n);
            setTimeout(() => n.remove(), 4000);
        }

        async function runPreflightCheck() {
            try {
                const files = ['index.html', 'offline.html', 'متجر_2.HTML', 'ادمن_2.HTML'];
                const issues = [];

                for (const file of files) {
                    const res = await fetch(file, { cache: 'no-store' });
                    if (!res.ok) {
                        issues.push(`${file}: تعذر التحميل (${res.status})`);
                        continue;
                    }
                    const buf = new Uint8Array(await res.arrayBuffer());
                    const hasBom = buf.length >= 3 && buf[0] === 0xEF && buf[1] === 0xBB && buf[2] === 0xBF;
                    const text = new TextDecoder('utf-8').decode(buf);

                    if (!hasBom) issues.push(`${file}: لا يوجد BOM UTF-8`);

                    const parsed = new DOMParser().parseFromString(text, 'text/html');
                    const metaCharset = parsed.querySelector('meta[charset]');
                    if (!metaCharset) {
                        issues.push(`${file}: لا يوجد <meta charset="UTF-8">`);
                    }

                    if (text.includes('\uFFFD')) issues.push(`${file}: يحتوي على أحرف تالفة (U+FFFD)`);
                    if (text.includes('\u00A7')) issues.push(`${file}: يحتوي على الحرف غير المسموح (U+00A7)`);

                    // Check for unquoted Arabic keys inside <script> blocks
                    const scripts = [];
                    const scriptRegex = new RegExp('<script[^>]*>([\\s\\S]*?)<\\\\/script>', 'gi');
                    let match;
                    while ((match = scriptRegex.exec(text)) !== null) {
                        scripts.push(match[1]);
                    }
                    const arabicKeyRegex = /[,{]\\s*([\\u0600-\\u06FF]+)\\s*:/g;
                    if (scripts.some(s => arabicKeyRegex.test(s))) {
                        issues.push(`${file}: مفاتيح عربية بدون علامات اقتباس داخل JS`);
                    }
                }

                const output = issues.length
                    ? `❌ تم العثور على مشاكل:\\n- ${issues.join('\\n- ')}`
                    : '✅ الفحص ناجح: لا توجد مشاكل ترميز أو أخطاء عربية.';

                document.getElementById('preflightOutput').textContent = output;
                openModal('preflightModal');
                showNotification(issues.length ? 'error' : 'success', issues.length ? 'تم اكتشاف مشاكل' : 'الفحص ناجح');
            } catch (err) {
                console.error('Preflight error:', err);
                showNotification('error', 'فشل الفحص');
            }
        }

        function copyPreflightReport() {
            const text = document.getElementById('preflightOutput').textContent || '';
            navigator.clipboard.writeText(text).then(() => {
                showNotification('success', 'تم نسخ التقرير');
            }).catch(() => {
                showNotification('error', 'فشل النسخ');
            });
        }
    </script>
    <script>
async function uploadAndPreview(input) {
    if(!input.files[0]) return;
    // معاينة
    const reader = new FileReader();
    reader.onload = (e) => document.getElementById('imgPreview').innerHTML = `<img src="${e.target.result}" style="max-width:150px;border-radius:5px;margin:5px 0;">`;
    reader.readAsDataURL(input.files[0]);
    
    // رفع
    try {
        const res = await uploadToCloudinary(input.files[0]);
        if(res) {
            document.getElementById('finalImg').value = res.url;
            document.getElementById('manualImg').value = res.url;
            alert('✅ تم رفع الصورة');
        }
    } catch(err) {
        alert('❌ فشل الرفع: ' + err.message);
    }
}
</script>
</body>
</html>

