<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A1128">
    <meta name="description" content="Sale Zone Store Admin - ظ„ظˆط­ط© ط§ظ„طھط­ظƒظ…">
    <link rel="icon" href="./icon-192.png">
    <link rel="shortcut icon" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <title>ظ„ظˆط­ط© ط§ظ„طھط­ظƒظ… | Sale Zone Store</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Error Detection System -->
    <script src="ERROR_DETECTION_SYSTEM.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-api.js"></script>
    <script src="firebase-data.js"></script>
    <script src="auth-utils.js"></script>
    <script src="enhancement-utils.js"></script>
    <script src="storage-keys.js"></script>
    <script src="cloudinary-service.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F4E4BC;
            --gold-dark: #B8960C;
            --navy: #0A1128;
            --navy-light: #1A2744;
            --burgundy: #800020;
            --cream: #FAF8F3;
            --white: #FFFFFF;
            --success: #50C878;
            --error: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
            --font-display: 'Playfair Display', serif;
            --font-arabic: 'Almarai', sans-serif;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
            --transition: all 0.3s ease;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; }
        body { font-family: var(--font-arabic); background: #f5f6fa; min-height: 100vh; text-rendering: optimizeLegibility; overscroll-behavior: none; touch-action: manipulation; }
        button { min-height: 44px; }
        input, textarea, select { font-size: 16px; }

        /* Login */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--navy), var(--navy-light));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: var(--white);
            border-radius: 20px;
            padding: 40px 35px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }
        .login-logo { font-size: 50px; margin-bottom: 15px; }
        .login-title { font-family: var(--font-display); font-size: 24px; color: var(--navy); margin-bottom: 8px; }
        .login-subtitle { color: #666; margin-bottom: 25px; font-size: 14px; }
        .login-form .form-group { margin-bottom: 18px; text-align: right; }
        .login-form label { display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px; font-size: 13px; }
        .login-form input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: var(--transition);
        }
        .login-form input:focus { border-color: var(--gold); outline: none; }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(212,175,55,0.4); }
        .login-error { background: #fee; color: var(--error); padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none; font-size: 13px; }
        .back-link { margin-top: 20px; color: var(--gold-dark); text-decoration: none; display: inline-flex; align-items: center; gap: 5px; font-size: 13px; }

        /* Dashboard */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.active { display: flex; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--navy), var(--navy-light));
            min-height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 20px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-logo { font-family: var(--font-display); font-size: 20px; color: var(--gold); }
        .sidebar-subtitle { font-size: 11px; color: var(--gold-light); margin-top: 3px; }
        .sidebar-menu { padding: 15px 0; }
        .menu-section { padding: 0 12px; margin-bottom: 8px; }
        .menu-section-title {
            font-size: 10px;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 12px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 3px;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            background: transparent;
            width: 100%;
            font-size: 13px;
            font-family: var(--font-arabic);
        }
        .menu-item:hover { background: rgba(255,255,255,0.1); color: var(--white); }
        .menu-item.active { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); }
        .menu-item .badge {
            margin-right: auto;
            background: var(--burgundy);
            color: var(--white);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        /* Main */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--white);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            flex-wrap: wrap;
            gap: 12px;
        }
        .page-title {
            font-family: var(--font-display);
            font-size: 20px;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .top-bar-actions { display: flex; align-items: center; gap: 10px; }
        .admin-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--cream);
            border-radius: 20px;
            font-size: 13px;
        }
        .admin-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 12px;
        }
        .logout-btn {
            background: var(--error);
            color: var(--white);
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: var(--transition);
        }
        .logout-btn:hover { background: #c0392b; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 3px;
        }
        .stat-card.products::before { background: var(--gold); }
        .stat-card.orders::before { background: var(--success); }
        .stat-card.users::before { background: var(--info); }
        .stat-card.revenue::before { background: var(--burgundy); }
        .stat-card.loyalty::before { background: var(--warning); }
        .stat-icon { font-size: 28px; margin-bottom: 8px; }
        .stat-value { font-size: 26px; font-weight: 800; color: var(--navy); }
        .stat-label { font-size: 12px; color: #666; }

        /* Section Card */
        .section-card {
            background: var(--white);
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 18px;
            overflow: hidden;
        }
        .section-header {
            padding: 15px 18px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--navy);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); }
        .btn-gold:hover { box-shadow: 0 4px 15px rgba(212,175,55,0.4); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-info { background: var(--info); color: var(--white); }
        .btn-danger { background: var(--error); color: var(--white); }
        .btn-navy { background: var(--navy); color: var(--white); }
        .section-body { padding: 18px; }

        /* Tables */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .data-table th, .data-table td {
            padding: 12px 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .data-table th { background: var(--cream); font-weight: 700; color: var(--navy); }
        .data-table tbody tr:hover { background: var(--cream); }
        .product-cell { display: flex; align-items: center; gap: 10px; }
        .product-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: var(--white);
        }
        .status-pending { background: var(--warning); color: #333; }
        .status-confirmed { background: var(--info); }
        .status-processing { background: #9b59b6; }
        .status-shipped { background: #3498db; }
        .status-delivered { background: var(--success); }
        .status-completed { background: var(--success); }
        .status-cancelled { background: var(--error); }
        .action-btns { display: flex; gap: 5px; }
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition);
        }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.view { background: rgba(23,162,184,0.15); color: var(--info); }
        .action-btn.edit { background: rgba(212,175,55,0.15); color: var(--gold-dark); }
        .action-btn.delete { background: rgba(220,53,69,0.15); color: var(--error); }

        /* Content Section */
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
        }
        .chart-title { font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 12px; }
        .chart-container { height: 250px; position: relative; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: var(--transition);
        }
        .modal.large { max-width: 700px; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header {
            padding: 18px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
        }
        .modal-header h2 { font-size: 18px; color: var(--navy); display: flex; align-items: center; gap: 8px; }
        .close-modal {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--cream);
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }
        .close-modal:hover { background: #ddd; transform: rotate(90deg); }
        .modal-body{
          padding: 18px;
          max-height: 80vh;      /* ط£ظ‚طµظ‰ ط§ط±طھظپط§ط¹ 80% ظ…ظ† ط§ظ„ط´ط§ط´ط© */
          overflow-y: auto;      /* ظپط¹ظ„ ط§ظ„طھظ…ط±ظٹط± ط¯ط§ط®ظ„ ط§ظ„ظ…ظˆط¯ط§ظ„ */
          padding-bottom: 30px;  /* ظ…ط³ط§ط­ط© طھط­طھ ظ„ظ„ط²ط± */
}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-family: var(--font-arabic);
            transition: var(--transition);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--gold);
            outline: none;
        }
        .form-group textarea { resize: vertical; min-height: 70px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        .submit-btn:hover { box-shadow: 0 4px 15px rgba(212,175,55,0.4); }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 18px;
        }
        .settings-card {
            background: var(--white);
            border-radius: 14px;
            padding: 18px;
            box-shadow: var(--shadow-sm);
        }
        .settings-card h3 {
            font-size: 15px;
            color: var(--navy);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--cream);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .danger-zone { border: 2px solid var(--error); }
        .danger-zone h3 { color: var(--error); }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 18px; flex-wrap: wrap; }
        .tab-btn {
            padding: 10px 18px;
            background: var(--cream);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--navy);
            font-size: 12px;
            transition: var(--transition);
        }
        .tab-btn.active { background: var(--gold); color: var(--white); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Order Details */
        .order-detail-section {
            background: var(--cream);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .order-detail-section h4 {
            font-size: 14px;
            color: var(--navy);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 13px;
        }
        .order-item:last-child { border-bottom: none; }
        .order-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 800;
            color: var(--navy);
            padding-top: 12px;
            border-top: 2px solid var(--gold);
            margin-top: 10px;
        }

        /* Notifications */
        .notifications-container {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 320px;
        }
        .notification {
            background: var(--white);
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.4s ease;
            border-right: 4px solid;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        .notification.success { border-right-color: var(--success); }
        .notification.error { border-right-color: var(--error); }
        .notification-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--white);
        }
        .notification.success .notification-icon { background: var(--success); }
        .notification.error .notification-icon { background: var(--error); }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 700; font-size: 12px; color: var(--navy); }
        .notification-message { font-size: 11px; color: #666; }
        .notification-close { background: transparent; border: none; color: #999; font-size: 14px; cursor: pointer; }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state-icon { font-size: 50px; margin-bottom: 12px; opacity: 0.5; }

        /* Mobile */
        .mobile-menu-btn {
            display: none;
            background: var(--gold);
            color: var(--white);
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .overlay.active { display: block; }

        @media (max-width: 1024px) {
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; }
        }
        @media (max-width: 768px) {
            .main-content { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-value { font-size: 20px; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .modal-overlay { align-items: flex-end; padding: 10px; }
            .modal { max-width: 100%; max-height: 92dvh; border-radius: 16px; }
            .modal-body { padding: 16px; }
            .close-modal { top: 10px; left: 10px; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .settings-grid { grid-template-columns: 1fr; }
            .modal-header h2 { font-size: 16px; }
            .modal-body { padding: 14px; }
        }

        /* Status Select */
        .status-select {
            padding: 6px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: var(--white);
        }
        .status-select:focus { border-color: var(--gold); outline: none; }

        /* Color Input */
        input[type="color"] {
            width: 50px;
            height: 35px;
            padding: 2px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Loyalty Cards */
        .loyalty-card {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            border-radius: 14px;
            padding: 20px;
            color: var(--white);
            text-align: center;
            margin-bottom: 15px;
        }
        .loyalty-value { font-size: 36px; font-weight: 800; }
        .loyalty-label { font-size: 13px; opacity: 0.9; }

        .user-points-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--cream);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .user-points-info { display: flex; align-items: center; gap: 10px; }
        .user-points-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--navy);
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .user-points-actions { display: flex; gap: 6px; }
        .points-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }
        .points-btn.add { background: var(--success); color: white; }
        .points-btn.sub { background: var(--error); color: white; }
    </style>
</head>
<body>
    <div class="notifications-container" id="notificationsContainer"></div>

    <!-- Login -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">ًں”گ</div>
            <h1 class="login-title">ظ„ظˆط­ط© ط§ظ„طھط­ظƒظ…</h1>
            <p class="login-subtitle">Sale Zone Store</p>
            <div class="login-error" id="loginError">ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¯ط®ظˆظ„ ط؛ظٹط± طµط­ظٹط­ط©</div>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>ًں“§ ط§ظ„ط¨ط±ظٹط¯ ط§ظ„ط¥ظ„ظƒطھط±ظˆظ†ظٹ</label>
                    <input type="email" id="adminEmail" required placeholder="ط£ط¯ط®ظ„ ط§ظ„ط¨ط±ظٹط¯ ط§ظ„ط¥ظ„ظƒطھط±ظˆظ†ظٹ">
                </div>
                <div class="form-group">
                    <label>ًں”‘ ظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط±</label>
                    <input type="password" id="adminPassword" required placeholder="ط£ط¯ط®ظ„ ظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط±">
                </div>
                <button type="submit" class="login-btn">ط¯ط®ظˆظ„</button>
                <button type="button" class="login-btn" style="margin-top: 10px; background: #1A2744;" onclick="sendVerificationLink()">
                    ط¥ط±ط³ط§ظ„ ط±ط§ط¨ط· ط§ظ„طھط­ظ‚ظ‚
                </button>
                <button type="button" class="login-btn" style="margin-top: 10px; background: #800020;" onclick="sendPasswordReset()">
                    ظ†ط³ظٹطھ ظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط±
                </button>
            </form>
            <a href="index.html" class="back-link">â†گ ط§ظ„ط¹ظˆط¯ط© ظ„ظ„ظ…طھط¬ط±</a>
            <a href="ظ…طھط¬ط±_2.HTML" class="back-link" style="margin-right: 20px;">ًں›چï¸ڈ ط¹ط±ط¶ ط§ظ„ظ…طھط¬ط±</a>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Sale Zone</div>
                <div class="sidebar-subtitle">ظ„ظˆط­ط© ط§ظ„طھط­ظƒظ…</div>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">ط§ظ„ط±ط¦ظٹط³ظٹط©</div>
                    <button class="menu-item active" onclick="showSection('overview')">ًں“ٹ ظ†ط¸ط±ط© ط¹ط§ظ…ط©</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">ط§ظ„ط¥ط¯ط§ط±ط©</div>
                    <button class="menu-item" onclick="showSection('products')">ًں“¦ ط§ظ„ظ…ظ†طھط¬ط§طھ <span class="badge" id="productsCount">0</span></button>
                    <button class="menu-item" onclick="showSection('orders')">ًں›چï¸ڈ ط§ظ„ط·ظ„ط¨ط§طھ <span class="badge" id="ordersCount">0</span></button>
                    <button class="menu-item" onclick="showSection('banners')">ًںژ  ط§ظ„ط¨ط§ظ†ط±ط§طھ</button>
                    <button class="menu-item" onclick="showSection('coupons')">ًںژ« ط§ظ„ظƒظˆط¨ظˆظ†ط§طھ</button>
                    <button class="menu-item" onclick="showSection('users')">ًں‘¥ ط§ظ„ط¹ظ…ظ„ط§ط،</button>
                    <button class="menu-item" onclick="showSection('loyalty')">ًں’ژ ظ†ظ‚ط§ط· ط§ظ„ظˆظ„ط§ط،</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">ط§ظ„طھظ‚ط§ط±ظٹط±</div>
                    <button class="menu-item" onclick="showSection('reports')">ًں“ˆ ط§ظ„طھظ‚ط§ط±ظٹط±</button>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">ط§ظ„ط¥ط¹ط¯ط§ط¯ط§طھ</div>
                    <button class="menu-item" onclick="showSection('storeSettings')">ًںڈھ ط§ظ„ظ…طھط¬ط±</button>
                    <button class="menu-item" onclick="showSection('settings')">âڑ™ï¸ڈ ط§ظ„ظ†ط¸ط§ظ…</button>
                    <a href="ظ…طھط¬ط±_2.HTML" class="menu-item">ًں›چï¸ڈ ط¹ط±ط¶ ط§ظ„ظ…طھط¬ط±</a>
                    <a href="index.html" class="menu-item">ًںڈ  ط§ظ„طµظپط­ط© ط§ظ„ط±ط¦ظٹط³ظٹط©</a>
                </div>
            </nav>
        </aside>

        <!-- Main -->
        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">âک°</button>
                    <h1 class="page-title" id="pageTitle">ًں“ٹ ظ†ط¸ط±ط© ط¹ط§ظ…ط©</h1>
                </div>
                <div class="top-bar-actions">
                    <div class="admin-info">
                        <div class="admin-avatar">ظ…</div>
                        <span>ط§ظ„ظ…ط¯ظٹط±</span>
                    </div>
                    <button class="logout-btn" onclick="adminLogout()">ًںڑھ ط®ط±ظˆط¬</button>
                </div>
            </div>
            <!-- Overview -->
            <section class="content-section active" id="overviewSection">
                <div class="stats-grid">
                    <div class="stat-card products">
                        <div class="stat-icon">ًں“¦</div>
                        <div class="stat-value" id="statProducts">0</div>
                        <div class="stat-label">ظ…ظ†طھط¬</div>
                    </div>
                    <div class="stat-card orders">
                        <div class="stat-icon">ًں›چï¸ڈ</div>
                        <div class="stat-value" id="statOrders">0</div>
                        <div class="stat-label">ط·ظ„ط¨</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-icon">ًں‘¥</div>
                        <div class="stat-value" id="statUsers">0</div>
                        <div class="stat-label">ط¹ظ…ظٹظ„</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon">ًں’°</div>
                        <div class="stat-value" id="statRevenue">0</div>
                        <div class="stat-label">ط¥ظٹط±ط§ط¯ط§طھ (ط¬.ظ…)</div>
                    </div>
                    <div class="stat-card loyalty">
                        <div class="stat-icon">ًں’ژ</div>
                        <div class="stat-value" id="statLoyalty">0</div>
                        <div class="stat-label">ظ†ظ‚ط§ط· ظˆظ„ط§ط،</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">ًں“ˆ ط§ظ„ظ…ط¨ظٹط¹ط§طھ</div>
                        <div class="chart-container"><canvas id="salesChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">ًں“ٹ ط§ظ„ط£ظ‚ط³ط§ظ…</div>
                        <div class="chart-container"><canvas id="categoriesChart"></canvas></div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">ًں•گ ط¢ط®ط± ط§ظ„ط·ظ„ط¨ط§طھ</h3>
                        <button class="btn btn-gold" onclick="showSection('orders')">ط¹ط±ط¶ ط§ظ„ظƒظ„</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>ط±ظ‚ظ…</th><th>ط§ظ„ط¹ظ…ظٹظ„</th><th>ط§ظ„ظ…ط¨ظ„ط؛</th><th>ط§ظ„ط­ط§ظ„ط©</th><th>ط§ظ„طھط§ط±ظٹط®</th></tr></thead>
                                <tbody id="recentOrdersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products -->
            <section class="content-section" id="productsSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">ًں“¦ ط§ظ„ظ…ظ†طھط¬ط§طھ</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="openModal('productModal')">â‍• ط¥ط¶ط§ظپط©</button>
                            <button class="btn btn-success" onclick="exportProductsExcel()">ًں“¤ Excel</button>
                            <input type="file" id="importProductsFile" accept=".xlsx,.xls" onchange="importProductsExcel(event)" style="display:none">
                            <button class="btn btn-info" onclick="document.getElementById('importProductsFile').click()">ًں“¥ ط§ط³طھظٹط±ط§ط¯</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>ط§ظ„ظ…ظ†طھط¬</th><th>ط§ظ„ظ‚ط³ظ…</th><th>ط§ظ„ط³ط¹ط±</th><th>ط§ظ„طھظ‚ظٹظٹظ…</th><th>ط¥ط¬ط±ط§ط،ط§طھ</th></tr></thead>
                                <tbody id="productsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders -->
            <section class="content-section" id="ordersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">ًں›چï¸ڈ ط§ظ„ط·ظ„ط¨ط§طھ</h3>
                        <div class="header-actions">
                            <button class="btn btn-success" onclick="exportOrdersExcel()">ًں“¤ Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>ط±ظ‚ظ…</th><th>ط§ظ„ط¹ظ…ظٹظ„</th><th>ط§ظ„ظ‡ط§طھظپ</th><th>ط§ظ„ظ…ط¨ظ„ط؛</th><th>ط§ظ„ط­ط§ظ„ط©</th><th>ط§ظ„طھط§ط±ظٹط®</th><th>ط¥ط¬ط±ط§ط،ط§طھ</th></tr></thead>
                                <tbody id="ordersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Banners -->
            <section class="content-section" id="bannersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">ًںژ  ط§ظ„ط¨ط§ظ†ط±ط§طھ</h3>
                        <button class="btn btn-gold" onclick="openModal('bannerModal')">â‍• ط¥ط¶ط§ظپط©</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>ط£ظٹظ‚ظˆظ†ط©</th><th>ط§ظ„ط¹ظ†ظˆط§ظ†</th><th>ط§ظ„ظ†طµ</th><th>ط§ظ„ظ‚ط³ظ…</th><th>ط¥ط¬ط±ط§ط،ط§طھ</th></tr></thead>
                                <tbody id="bannersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Coupons -->
            <section class="content-section" id="couponsSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">ًںژ« ط§ظ„ظƒظˆط¨ظˆظ†ط§طھ</h3>
                        <div class="header-actions">
                            <button class="btn btn-gold" onclick="openModal('couponModal')">â‍• ط¥ط¶ط§ظپط©</button>
                            <button class="btn btn-success" onclick="exportCouponsExcel()">ًں“¤ Excel</button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>ط§ظ„ظƒظˆط¯</th><th>ط§ظ„ظˆطµظپ</th><th>ط§ظ„ظ†ظˆط¹</th><th>ط§ظ„ظ‚ظٹظ…ط©</th><th>ط¥ط¬ط±ط§ط،ط§طھ</th></tr></thead>
                                <tbody id="couponsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users -->
            <section class="content-section" id="usersSection">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">ًں‘¥ ط§ظ„ط¹ظ…ظ„ط§ط،</h3>
                        <button class="btn btn-success" onclick="exportUsersExcel()">ًں“¤ Excel</button>
                    </div>
                    <div class="section-body">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>ط§ظ„ط§ط³ظ…</th><th>ط§ظ„ظ‡ط§طھظپ</th><th>ط§ظ„ط¨ط±ظٹط¯</th><th>ط§ظ„ظ†ظ‚ط§ط·</th><th>ط§ظ„طھط³ط¬ظٹظ„</th></tr></thead>
                                <tbody id="usersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Loyalty -->
            <section class="content-section" id="loyaltySection">
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="loyalty-card">
                        <div class="loyalty-value" id="totalLoyalty">0</div>
                        <div class="loyalty-label">ًں’ژ ط¥ط¬ظ…ط§ظ„ظٹ ط§ظ„ظ†ظ‚ط§ط·</div>
                    </div>
                    <div class="loyalty-card" style="background: linear-gradient(135deg, var(--burgundy), #a00030);">
                        <div class="loyalty-value" id="loyaltyRate">5</div>
                        <div class="loyalty-label">% ظ†ط³ط¨ط© ط§ظ„ط§ظƒطھط³ط§ط¨</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">âڑ™ï¸ڈ ط¥ط¹ط¯ط§ط¯ط§طھ ط§ظ„ظˆظ„ط§ط،</h3>
                    </div>
                    <div class="section-body">
                        <form onsubmit="saveLoyaltySettings(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>ظ†ط³ط¨ط© ط§ظ„ط§ظƒطھط³ط§ط¨ (%)</label>
                                    <input type="number" id="loyaltyRateInput" min="1" max="50" value="5">
                                </div>
                                <div class="form-group">
                                    <label>ظ‚ظٹظ…ط© ط§ظ„ظ†ظ‚ط·ط© (ط¬.ظ…)</label>
                                    <input type="number" id="pointValueInput" min="0.01" step="0.01" value="0.1">
                                </div>
                            </div>
                            <button type="submit" class="submit-btn" style="max-width: 200px;">ًں’¾ ط­ظپط¸</button>
                        </form>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">ًں‘¥ ظ†ظ‚ط§ط· ط§ظ„ط¹ظ…ظ„ط§ط،</h3>
                        <button class="btn btn-gold" onclick="openModal('pointsModal')">â‍• ط¥ط¶ط§ظپط© ظ†ظ‚ط§ط·</button>
                    </div>
                    <div class="section-body" id="loyaltyUsersList"></div>
                </div>
            </section>

            <!-- Reports -->
            <section class="content-section" id="reportsSection">
                <div class="settings-grid">
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">ًں“¦ ط§ظ„ظ…ظ†طھط¬ط§طھ</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">طھطµط¯ظٹط± ط¬ظ…ظٹط¹ ط§ظ„ظ…ظ†طھط¬ط§طھ</p>
                            <button class="btn btn-success" onclick="exportProductsExcel()" style="width: 100%;">ًں“¤ Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">ًں›چï¸ڈ ط§ظ„ط·ظ„ط¨ط§طھ</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">طھطµط¯ظٹط± ط¬ظ…ظٹط¹ ط§ظ„ط·ظ„ط¨ط§طھ</p>
                            <button class="btn btn-success" onclick="exportOrdersExcel()" style="width: 100%;">ًں“¤ Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">ًں‘¥ ط§ظ„ط¹ظ…ظ„ط§ط،</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">طھطµط¯ظٹط± ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¹ظ…ظ„ط§ط،</p>
                            <button class="btn btn-success" onclick="exportUsersExcel()" style="width: 100%;">ًں“¤ Excel</button>
                        </div>
                    </div>
                    <div class="section-card">
                        <div class="section-header"><h3 class="section-title">ًں“ٹ طھظ‚ط±ظٹط± ط´ط§ظ…ظ„</h3></div>
                        <div class="section-body">
                            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">ط¬ظ…ظٹط¹ ط§ظ„ط¨ظٹط§ظ†ط§طھ</p>
                            <button class="btn btn-success" onclick="exportFullReport()" style="width: 100%;">ًں“¤ طھظ‚ط±ظٹط± ط´ط§ظ…ظ„</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Store Settings -->
            <section class="content-section" id="storeSettingsSection">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('general')">âڑ™ï¸ڈ ط¹ط§ظ…</button>
                    <button class="tab-btn" onclick="switchTab('topbar')">ًں“¢ ط§ظ„ط´ط±ظٹط·</button>
                    <button class="tab-btn" onclick="switchTab('footer')">ًں¦¶ ط§ظ„ظپظˆطھط±</button>
                    <button class="tab-btn" onclick="switchTab('contact')">ًں“‍ ط§ظ„طھظˆط§طµظ„</button>
                </div>

                <div class="tab-content active" id="generalTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveGeneralSettings(event)">
                                <div class="form-group">
                                    <label>ًںڈھ ط§ط³ظ… ط§ظ„ظ…طھط¬ط±</label>
                                    <input type="text" id="storeName" placeholder="Sale Zone Store">
                                </div>
                                <div class="form-group">
                                    <label>ًں’¬ ط§ظ„ط´ط¹ط§ط±</label>
                                    <input type="text" id="storeTagline" placeholder="ط§ظ„طھط³ظˆظ‚ ط§ظ„ظپط§ط®ط± ط§ظ„ط°ظƒظٹ">
                                </div>
                                <div class="form-group">
                                    <label>ًں“‌ ط§ظ„ظˆطµظپ</label>
                                    <textarea id="storeDescription"></textarea>
                                </div>
                                <button type="submit" class="submit-btn">ًں’¾ ط­ظپط¸</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="topbarTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveTopBarSettings(event)">
                                <div class="form-group">
                                    <label>ًں“‌ ط§ظ„ظ†طµ ط§ظ„ظ…طھط­ط±ظƒ</label>
                                    <textarea id="topBarText" rows="2"></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ًںژ¨ ظ„ظˆظ† ط§ظ„ط®ظ„ظپظٹط©</label>
                                        <input type="color" id="topBarBgColor" value="#0A1128">
                                    </div>
                                    <div class="form-group">
                                        <label>ًںژ¨ ظ„ظˆظ† ط§ظ„ظ†طµ</label>
                                        <input type="color" id="topBarTextColor" value="#F4E4BC">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="topBarEnabled" checked> طھظپط¹ظٹظ„ ط§ظ„ط´ط±ظٹط·</label>
                                </div>
                                <button type="submit" class="submit-btn">ًں’¾ ط­ظپط¸</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="footerTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveFooterSettings(event)">
                                <div class="form-group">
                                    <label>ًں“– ط¹ظ† ط§ظ„ظ…طھط¬ط±</label>
                                    <textarea id="footerAbout" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>âڈ° ط£ظٹط§ظ… ط§ظ„ط£ط³ط¨ظˆط¹</label>
                                    <input type="text" id="workingHoursWeekdays" placeholder="ط§ظ„ط³ط¨طھ - ط§ظ„ط®ظ…ظٹط³: 9 طµ - 10 ظ…">
                                </div>
                                <div class="form-group">
                                    <label>âڈ° ط§ظ„ط¬ظ…ط¹ط©</label>
                                    <input type="text" id="workingHoursFriday" placeholder="ط§ظ„ط¬ظ…ط¹ط©: 2 ظ… - 10 ظ…">
                                </div>
                                <div class="form-group">
                                    <label>ًں“‌ ظ…ظ„ط§ط­ط¸ط©</label>
                                    <input type="text" id="workingHoursNote" placeholder="ًں”” ط®ط¯ظ…ط© 24/7">
                                </div>
                                <div class="form-group">
                                    <label>آ©ï¸ڈ ط­ظ‚ظˆظ‚ ط§ظ„ظ†ط´ط±</label>
                                    <input type="text" id="copyrightText">
                                </div>
                                <button type="submit" class="submit-btn">ًں’¾ ط­ظپط¸</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="contactTab">
                    <div class="section-card">
                        <div class="section-body">
                            <form onsubmit="saveContactSettings(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ًں“‍ ط§ظ„ظ‡ط§طھظپ</label>
                                        <input type="tel" id="contactPhone" placeholder="01018108979">
                                    </div>
                                    <div class="form-group">
                                        <label>ًں’¬ ظˆط§طھط³ط§ط¨</label>
                                        <input type="tel" id="contactWhatsapp" placeholder="01018108979">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ًں“§ ط§ظ„ط¥ظٹظ…ظٹظ„</label>
                                        <input type="email" id="contactEmail">
                                    </div>
                                    <div class="form-group">
                                        <label>ًں“چ ط§ظ„ط¹ظ†ظˆط§ظ†</label>
                                        <input type="text" id="contactAddress">
                                    </div>
                                </div>
                                <button type="submit" class="submit-btn">ًں’¾ ط­ظپط¸</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Settings -->
            <section class="content-section" id="settingsSection">
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>ًں”گ ظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط±</h3>
                        <form onsubmit="changeAdminPassword(event)">
                            <div class="form-group">
                                <label>ط§ظ„ط­ط§ظ„ظٹط©</label>
                                <input type="password" id="currentAdminPass" required>
                            </div>
                            <div class="form-group">
                                <label>ط§ظ„ط¬ط¯ظٹط¯ط©</label>
                                <input type="password" id="newAdminPass" required>
                            </div>
                            <div class="form-group">
                                <label>طھط£ظƒظٹط¯</label>
                                <input type="password" id="confirmAdminPass" required>
                            </div>
                            <button type="submit" class="submit-btn">ًں”‘ طھط؛ظٹظٹط±</button>
                        </form>
                    </div>

                    <div class="settings-card">
                        <h3>ًں’¾ ط§ظ„ظ†ط³ط® ط§ظ„ط§ط­طھظٹط§ط·ظٹ</h3>
                        <button class="btn btn-gold" onclick="exportAllDataJSON()" style="width: 100%; margin-bottom: 10px;">ًں“¤ طھطµط¯ظٹط± JSON</button>
                        <input type="file" id="importJSONFile" accept=".json" onchange="importAllDataJSON(event)" style="display:none">
                        <button class="btn btn-info" onclick="document.getElementById('importJSONFile').click()" style="width: 100%;">ًں“¥ ط§ط³طھظٹط±ط§ط¯ JSON</button>
                    </div>

                    <div class="settings-card">
                        <h3>ًں§¹ طھظ†ط¸ظٹظپ ط§ظ„طµظˆط± ط§ظ„ط®ط§ط±ط¬ظٹط©</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">
                            ط§ط³طھط¨ط¯ط§ظ„ ط¬ظ…ظٹط¹ ط§ظ„ط±ظˆط§ط¨ط· ط§ظ„ط®ط§ط±ط¬ظٹط© ظ„ظ„طµظˆط± ط¨ظ€ Placeholders ظ…ط­ظ„ظٹط© ظ„طھط¬ظ†ط¨ ظ…ط´ط§ظƒظ„ ORB/CORS.
                        </p>
                        <button class="btn btn-gold" onclick="sanitizeAllImages()" style="width: 100%;">âœ… طھظ†ط¸ظٹظپ طµظˆط± ط§ظ„ظ…ظ†طھط¬ط§طھ ظˆط§ظ„ط¨ط§ظ†ط±ط§طھ</button>
                    </div>

                    <div class="settings-card danger-zone">
                        <h3>âڑ ï¸ڈ ظ…ظ†ط·ظ‚ط© ط§ظ„ط®ط·ط±</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 12px;">ظ„ط§ ظٹظ…ظƒظ† ط§ظ„طھط±ط§ط¬ط¹ ط¹ظ† ظ‡ط°ظ‡ ط§ظ„ط¥ط¬ط±ط§ط،ط§طھ!</p>
                        <button class="btn btn-danger" onclick="clearAllData()" style="width: 100%;">ًں—‘ï¸ڈ ط­ط°ظپ ط§ظ„ظƒظ„</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Product Modal -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="productModalTitle">â‍• ظ…ظ†طھط¬ ط¬ط¯ظٹط¯</h2>
      <button class="close-modal" onclick="closeModal('productModal')">âœ•</button>
    </div>

    <div class="modal-body">
      <form onsubmit="saveProduct(event)">
        <input type="hidden" id="productId">

        <div class="form-group">
          <label>ط§ط³ظ… ط§ظ„ظ…ظ†طھط¬ *</label>
          <input type="text" id="productName" required>
        </div>

        <div class="form-group">
          <label>ط§ظ„ظˆطµظپ *</label>
          <textarea id="productDesc" required></textarea>
        </div>

        <div class="form-group">
          <label>ط§ظ„ظ‚ط³ظ… *</label>
          <select id="productCategory" required>
            <option value="">ط§ط®طھط±</option>
            <option value="hair-care">ًں’‡â€چâ™€ï¸ڈ ط´ط¹ط±</option>
            <option value="skin-care">ًں§´ ط¨ط´ط±ط©</option>
            <option value="baby-care">ًں‘¶ ط·ظپظ„</option>
            <option value="supplements">ًں’ٹ ظ…ظƒظ…ظ„ط§طھ</option>
            <option value="medical">ًںڈ¥ ط·ط¨ظٹ</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ط§ظ„ط³ط¹ط± *</label>
            <input type="number" id="productPrice" required min="0">
          </div>
          <div class="form-group">
            <label>ط§ظ„ط³ط¹ط± ط§ظ„ظ‚ط¯ظٹظ…</label>
            <input type="number" id="productOldPrice" min="0">
          </div>
        </div>

        <!-- ============ طµظˆط±ط© ط§ظ„ظ…ظ†طھط¬ (ط±ظپط¹ ط£ظˆ ط±ط§ط¨ط·) ============ -->
        <div class="form-group">
          <label>ًں–¼ï¸ڈ طµظˆط±ط© ط§ظ„ظ…ظ†طھط¬</label>

          <!-- ط±ظپط¹ ظ…ظ† ط§ظ„ط¬ظ‡ط§ط² -->
          <input type="file" id="imgFile" accept="image/*" style="display:none" onchange="uploadAndPreview(this)">
          <button type="button"
                  onclick="document.getElementById('imgFile').click()"
                  style="background:#D4AF37;color:white;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;">
            ًں“پ ط±ظپط¹ ظ…ظ† ط§ظ„ط¬ظ‡ط§ط²
          </button>

          <div id="imgPreview" style="margin-top:10px;"></div>

          <!-- ط£ظˆ ط±ط§ط¨ط· -->
          <div style="margin:10px 0;color:#999;text-align:center;">â€” ط£ظˆ ط£ط¯ط®ظ„ ط±ط§ط¨ط· â€”</div>
          <input type="url" id="manualImg" placeholder="https://..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;direction:ltr;">

          <!-- ط±ط§ط¨ط· ظ†ظ‡ط§ط¦ظٹ (ظٹطھظ… طھط¹ط¨ط¦طھظ‡ طھظ„ظ‚ط§ط¦ظٹط§ظ‹ ط¨ط¹ط¯ ط§ظ„ط±ظپط¹) -->
          <input type="hidden" id="finalImg" required>
        </div>
        <!-- =================================================== -->

        <!-- ط²ط± ط­ظپط¸ ط§ظ„ظ…ظ†طھط¬ (ط§ظ„ظ„ظٹ ظƒط§ظ† ظ†ط§ظ‚طµ) -->
        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee; text-align: center;">
          <button type="submit" class="submit-btn" style="min-width: 220px; font-size: 16px; font-weight: bold;">
            ًں’¾ ط­ظپط¸ ط§ظ„ظ…ظ†طھط¬
          </button>
        </div>

      </form>
    </div>
  </div>
</div>

    <!-- Banner Modal -->
    <div class="modal-overlay" id="bannerModal">
        <div class="modal">
            <div class="modal-header">
                <h2>â‍• ط¨ط§ظ†ط± ط¬ط¯ظٹط¯</h2>
                <button class="close-modal" onclick="closeModal('bannerModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveBanner(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ط§ظ„ط£ظٹظ‚ظˆظ†ط©</label>
                            <input type="text" id="bannerIcon" placeholder="ًںژ‰">
                        </div>
                        <div class="form-group">
                            <label>ط§ظ„ظ‚ط³ظ…</label>
                            <select id="bannerCategory">
                                <option value="all">ط§ظ„ظƒظ„</option>
                                <option value="hair-care">ط´ط¹ط±</option>
                                <option value="skin-care">ط¨ط´ط±ط©</option>
                                <option value="baby-care">ط·ظپظ„</option>
                                <option value="supplements">ظ…ظƒظ…ظ„ط§طھ</option>
                                <option value="medical">ط·ط¨ظٹ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ط§ظ„ط¹ظ†ظˆط§ظ† *</label>
                        <input type="text" id="bannerTitle" required>
                    </div>
                    <div class="form-group">
                        <label>ط§ظ„ظ†طµ</label>
                        <input type="text" id="bannerText">
                    </div>
                    <div class="form-group">
                        <label>ظ†طµ ط§ظ„ط²ط±</label>
                        <input type="text" id="bannerBtn" placeholder="طھط³ظˆظ‚ ط§ظ„ط¢ظ†">
                    </div>
                    <button type="submit" class="submit-btn">ًں’¾ ط­ظپط¸</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div class="modal-overlay" id="couponModal">
        <div class="modal">
            <div class="modal-header">
                <h2>â‍• ظƒظˆط¨ظˆظ† ط¬ط¯ظٹط¯</h2>
                <button class="close-modal" onclick="closeModal('couponModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveCoupon(event)">
                    <div class="form-group">
                        <label>ط§ظ„ظƒظˆط¯ *</label>
                        <input type="text" id="couponCode" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>ط§ظ„ظˆطµظپ *</label>
                        <input type="text" id="couponDesc" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ط§ظ„ظ†ظˆط¹ *</label>
                            <select id="couponType" required>
                                <option value="percentage">ظ†ط³ط¨ط© %</option>
                                <option value="fixed">ظ…ط¨ظ„ط؛ ط«ط§ط¨طھ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ط§ظ„ظ‚ظٹظ…ط© *</label>
                            <input type="number" id="couponValue" required min="1">
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">ًں’¾ ط­ظپط¸</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal large">
            <div class="modal-header">
                <h2>ًں“¦ طھظپط§طµظٹظ„ ط§ظ„ط·ظ„ط¨</h2>
                <button class="close-modal" onclick="closeModal('orderModal')">âœ•</button>
            </div>
            <div class="modal-body" id="orderModalBody"></div>
        </div>
    </div>

    <!-- Points Modal -->
    <div class="modal-overlay" id="pointsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ًں’ژ ط¥ط¶ط§ظپط©/ط®طµظ… ظ†ظ‚ط§ط·</h2>
                <button class="close-modal" onclick="closeModal('pointsModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <form onsubmit="handlePointsAction(event)">
                    <div class="form-group">
                        <label>ط§ظ„ط¹ظ…ظٹظ„ *</label>
                        <select id="pointsUserId" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ط§ظ„ط¹ظ…ظ„ظٹط© *</label>
                            <select id="pointsAction" required>
                                <option value="add">â‍• ط¥ط¶ط§ظپط©</option>
                                <option value="subtract">â‍– ط®طµظ…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ط§ظ„ظ†ظ‚ط§ط· *</label>
                            <input type="number" id="pointsAmount" required min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ط§ظ„ط³ط¨ط¨</label>
                        <input type="text" id="pointsReason">
                    </div>
                    <button type="submit" class="submit-btn">âœ… طھظ†ظپظٹط°</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // Data Store
        // ============================================
        let products = [];
        let orders = [];
        let coupons = [];
        let banners = [];
        let users = [];
        // ًں”گ طھط­ط³ظٹظ† ط§ظ„ط£ظ…ط§ظ†: ظƒظ„ظ…ط© ظ…ط±ظˆط± ظ‚ظˆظٹط© ط§ظپطھط±ط§ط¶ظٹط§ظ‹
        // âڑ ï¸ڈ ظٹظڈظ†طµط­ ط¨طھط؛ظٹظٹط±ظ‡ط§ ظپظˆط±ط§ظ‹ ط¨ط¹ط¯ ط£ظˆظ„ طھط³ط¬ظٹظ„ ط¯ط®ظˆظ„
        let adminPassword = null;
        let storeSettings = {
            name: 'Sale Zone Store',
            tagline: 'ط§ظ„طھط³ظˆظ‚ ط§ظ„ظپط§ط®ط± ط§ظ„ط°ظƒظٹ',
            description: '',
            topBar: { enabled: true, text: 'ًںژ‰ ط®طµظˆظ…ط§طھ ط­طµط±ظٹط©!', bgColor: '#0A1128', textColor: '#F4E4BC' },
            contact: { phone: '01018108979', whatsapp: '01018108979', email: 'info@salezone.com', address: 'ظ…طµط±' },
            footer: { about: '', workingHoursWeekdays: 'ط§ظ„ط³ط¨طھ - ط§ظ„ط®ظ…ظٹط³: 9 طµ - 10 ظ…', workingHoursFriday: 'ط§ظ„ط¬ظ…ط¹ط©: 2 ظ… - 10 ظ…', workingHoursNote: 'ًں”” ط®ط¯ظ…ط© 24/7', copyright: 'آ© 2026 Sale Zone Store â‌¤ï¸ڈ' },
            loyalty: { rate: 5, pointValue: 0.1 }
        };
        let salesChart, categoriesChart;

        // ============================================
        // Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAdminSession();
        });

        // ============================================
        // Data Management
        // ============================================
        // ًں”¥ Firebase + LocalStorage Hybrid Data Loading
        async function loadAllData() {
            try {
                // ظ…ط­ط§ظˆظ„ط© طھط­ظ…ظٹظ„ ظ…ظ† Firebase ط£ظˆظ„ط§ظ‹
                if (typeof getAllProducts === 'function') {
                    console.log('ًں”¥ Admin: Loading from Firebase...');
                    
                    products = await getAllProducts() || [];
                    orders = await getAllOrders() || [];
                    users = await getAllUsers() || [];
                    coupons = await getAllCoupons() || [];
                    banners = await getAllBanners() || [];
                    
                    const settings = await getSettings();
                    if (settings) storeSettings = { ...storeSettings, ...settings };
                    
                    console.log('âœ… Admin data loaded from Firebase');
                    console.log('ًں“¦ Products:', products.length);
                    console.log('ًں“¦ Product IDs:', products.map(p => p.id));
                    console.log('ًں›چï¸ڈ Orders:', orders.length);
                } else {
                    throw new Error('Firebase not available');
                }
            } catch (error) {
                console.warn('âڑ ï¸ڈ Firebase error, using localStorage:', error);
                // Fallback to localStorage
                products = getStorageData('PRODUCTS') || [];
                orders = getStorageData('ORDERS') || [];
                coupons = getStorageData('COUPONS') || [];
                banners = getStorageData('BANNERS') || [];
                users = getStorageData('CUSTOMERS') || [];
            }
            
            // ظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط± ط¯ط§ط¦ظ…ط§ظ‹ ظ…ظ† localStorage
            const saved = getStorageData('SETTINGS');
            if (saved) storeSettings = { ...storeSettings, ...saved };
            
            // Data loaded, rendering will be done by initDashboard()
        }

        function saveProducts() { setStorageData('PRODUCTS', products); }
        function saveOrders() { setStorageData('ORDERS', orders); }
        function saveCoupons() { setStorageData('COUPONS', coupons); }
        function saveBanners() { setStorageData('BANNERS', banners); }
        function saveUsers() { setStorageData('CUSTOMERS', users); }
        function saveAdminPassword() {}
        function saveStoreSettings() { setStorageData('SETTINGS', storeSettings); }

        // ============================================
        // Auth
        // ============================================
        const ADMIN_EMAILS = ["ahmed.sheta89@gmail.com"];
        const ALLOW_BOOTSTRAP_ADMIN = true; // Temporary until custom claims are set

        function isEmailAllowed(email) {
          return ADMIN_EMAILS.includes(String(email || '').toLowerCase());
        }

        async function requireAdminPermission() {
          if (!firebase || !firebase.auth) throw new Error('auth-not-available');
          const user = firebase.auth().currentUser;
          if (!user) throw new Error('not-authenticated');
          const token = await user.getIdTokenResult(true);
          const isClaimAdmin = token?.claims?.admin === true;
          const isBootstrapAdmin = ALLOW_BOOTSTRAP_ADMIN && user.emailVerified === true && isEmailAllowed(user.email);
          if (!isClaimAdmin && !isBootstrapAdmin) throw new Error('not-admin');
          return { isClaimAdmin, isBootstrapAdmin, user };
        }

        async function handleLogin(e){
  e.preventDefault();
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value;
  const loginError = document.getElementById('loginError');

  // Rate limiting check
  const clientIP = 'client_' + Math.random().toString(36).substr(2, 9);
  if (rateLimiter.isBlocked(clientIP)) {
    const blockTime = Math.ceil(rateLimiter.getBlockTimeRemaining(clientIP) / 60000);
    loginError.style.display = 'block';
    loginError.textContent = `طھظ… ط­ط¸ط± ط§ظ„ظ…ط­ط§ظˆظ„ط§طھ. ط­ط§ظˆظ„ ظ…ط±ط© ط£ط®ط±ظ‰ ط¨ط¹ط¯ ${blockTime} ط¯ظ‚ظٹظ‚ط©`;
    return;
  }

  try{
    const userCred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCred.user;
    const token = await user.getIdTokenResult(true);
    const isAdmin = token?.claims?.admin === true;
    const isBootstrapAdmin = ALLOW_BOOTSTRAP_ADMIN && user.emailVerified === true && isEmailAllowed(user.email);

    if (!user.emailVerified) {
      await firebase.auth().signOut();
      loginError.style.display = 'block';
      loginError.textContent = 'يجب تفعيل البريد الإلكتروني أولًا للدخول كأدمن';
      return;
    }

    if (!isAdmin && !isBootstrapAdmin) {
      await firebase.auth().signOut();
      rateLimiter.recordAttempt(clientIP);
      const remaining = rateLimiter.getRemainingAttempts(clientIP);
      loginError.style.display = 'block';
      loginError.textContent = `ط؛ظٹط± ظ…طµط±ط­ ظ„ظƒ ط¨ط§ظ„ط¯ط®ظˆظ„. ظ…ط­ط§ظˆظ„ط§طھ ظ…طھط¨ظ‚ظٹط©: ${remaining}`;
      return;
    }

    // Reset rate limiting on successful login
    rateLimiter.attempts.delete(clientIP);
    
    // Create secure session
    const sessionId = sessionManager.createSession(userCred.user.uid, { 
      role: 'admin', 
      loginTime: new Date().toISOString() 
    });
    
    sessionStorage.setItem('adminLoggedIn', 'true');
    sessionStorage.setItem('adminSessionId', sessionId);
    
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('dashboard').classList.add('active');

    await loadAllData();
    initDashboard();
    
    if (!isAdmin && isBootstrapAdmin) {
      showNotification('info', 'طھظ†ط¨ظٹظ‡ ط£ظ…ظ†ظٹ', 'ط§ظ„ط¯ط®ظˆظ„ طھظ… ط¨ظˆط¶ط¹ ظ…ط¤ظ‚طھ. ظپط¹ظ‘ظ„ Custom Claims ط«ظ… ط¹ط·ظ‘ظ„ ALLOW_BOOTSTRAP_ADMIN.');
    } else {
      showNotification('success', 'طھظ… طھط³ط¬ظٹظ„ ط§ظ„ط¯ط®ظˆظ„ ط¨ظ†ط¬ط§ط­');
    }

  }catch(err){
    console.error('Login error:', err);
    rateLimiter.recordAttempt(clientIP);
    const remaining = rateLimiter.getRemainingAttempts(clientIP);
    loginError.style.display='block';
    loginError.textContent = `ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¯ط®ظˆظ„ ط؛ظٹط± طµط­ظٹط­ط©. ظ…ط­ط§ظˆظ„ط§طھ ظ…طھط¨ظ‚ظٹط©: ${remaining}`;
  }
}

async function sendVerificationLink() {
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value;
  const loginError = document.getElementById('loginError');

  if (!email || !pass) {
    loginError.style.display = 'block';
    loginError.textContent = 'ط£ط¯ط®ظ„ ط§ظ„ط¨ط±ظٹط¯ ط§ظ„ط¥ظ„ظƒطھط±ظˆظ†ظٹ ظˆظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط± ظ„ط¥ط±ط³ط§ظ„ ط±ط§ط¨ط· ط§ظ„طھط­ظ‚ظ‚';
    return;
  }

  try {
    const userCred = await firebase.auth().signInWithEmailAndPassword(email, pass);
    const user = userCred.user;
    if (user.emailVerified) {
      showNotification('info', 'ط§ظ„ط­ط³ط§ط¨ ظ…ظˆط«ظ‘ظ‚', 'ظ„ط§ ط­ط§ط¬ط© ظ„ط¥ط±ط³ط§ظ„ ط±ط§ط¨ط· طھط­ظ‚ظ‚');
    } else {
      await user.sendEmailVerification();
      showNotification('success', 'طھظ… ط§ظ„ط¥ط±ط³ط§ظ„', 'طھظ… ط¥ط±ط³ط§ظ„ ط±ط§ط¨ط· ط§ظ„طھط­ظ‚ظ‚ ط¥ظ„ظ‰ ط¨ط±ظٹط¯ظƒ');
    }
    await firebase.auth().signOut();
  } catch (err) {
    console.error(err);
    loginError.style.display = 'block';
    loginError.textContent = 'ظپط´ظ„ ط¥ط±ط³ط§ظ„ ط±ط§ط¨ط· ط§ظ„طھط­ظ‚ظ‚. طھط£ظƒط¯ ظ…ظ† ط§ظ„ط¨ظٹط§ظ†ط§طھ.';
  }
}

async function sendPasswordReset() {
  const email = document.getElementById('adminEmail').value.trim();
  const loginError = document.getElementById('loginError');

  if (!email) {
    loginError.style.display = 'block';
    loginError.textContent = 'ط£ط¯ط®ظ„ ط§ظ„ط¨ط±ظٹط¯ ط§ظ„ط¥ظ„ظƒطھط±ظˆظ†ظٹ ط£ظˆظ„ط§ظ‹';
    return;
  }

  try {
    await firebase.auth().sendPasswordResetEmail(email);
    showNotification('success', 'طھظ… ط§ظ„ط¥ط±ط³ط§ظ„', 'طھظ… ط¥ط±ط³ط§ظ„ ط±ط§ط¨ط· ط§ط³طھط¹ط§ط¯ط© ظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط± ط¥ظ„ظ‰ ط¨ط±ظٹط¯ظƒ');
  } catch (err) {
    console.error(err);
    loginError.style.display = 'block';
    loginError.textContent = 'ظپط´ظ„ ط¥ط±ط³ط§ظ„ ط±ط§ط¨ط· ط§ظ„ط§ط³طھط¹ط§ط¯ط©. طھط£ظƒط¯ ظ…ظ† ط§ظ„ط¨ط±ظٹط¯.';
  }
}

       function checkAdminSession() {
  if (typeof firebase !== 'undefined' && firebase.auth) {
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        sessionStorage.removeItem('adminLoggedIn');
        sessionStorage.removeItem('adminSessionId');
        sessionStorage.removeItem('adminSession');
        document.getElementById('dashboard').classList.remove('active');
        document.getElementById('loginScreen').style.display = 'flex';
        return;
      }

      const token = await user.getIdTokenResult();
      const isAdmin = token?.claims?.admin === true;
      const isBootstrapAdmin = ALLOW_BOOTSTRAP_ADMIN && user.emailVerified === true && isEmailAllowed(user.email);
      if (!user.emailVerified) {
        await firebase.auth().signOut();
        return;
      }
      if (isAdmin || isBootstrapAdmin) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        if (!products.length) {
          loadAllData().then(initDashboard);
        }
      } else {
        await firebase.auth().signOut();
      }
    });
    return;
  }

  // Fallback: no Firebase
  document.getElementById('dashboard').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'flex';
}

function adminLogout(){
  const sessionId = sessionStorage.getItem('adminSessionId');
  if (sessionId) {
    sessionManager.destroySession(sessionId);
  }
  
  sessionStorage.removeItem('adminLoggedIn');
  sessionStorage.removeItem('adminSessionId');
  sessionStorage.removeItem('adminSession');
  
  // Clear Firebase auth if used
  if (typeof firebase !== 'undefined' && firebase.auth()) {
    firebase.auth().signOut();
  }
  
  showNotification('info', 'طھظ… طھط³ط¬ظٹظ„ ط§ظ„ط®ط±ظˆط¬ ط¨ظ†ط¬ط§ط­');
  location.reload();
}

        // ============================================
        // Dashboard
        // ============================================
        function initDashboard() {
            updateStats();
            updateBadges();
            renderProductsTable();
            renderOrdersTable();
            renderBannersTable();
            renderCouponsTable();
            renderUsersTable();
            renderRecentOrders();
            renderLoyaltySection();
            loadSettingsToForms();
            initCharts();
        }

        function updateStats() {
            document.getElementById('statProducts').textContent = products.length;
            document.getElementById('statOrders').textContent = orders.length;
            document.getElementById('statUsers').textContent = users.length;
            document.getElementById('statRevenue').textContent = orders.reduce((s, o) => s + (o.total || 0), 0).toLocaleString();
            document.getElementById('statLoyalty').textContent = users.reduce((s, u) => s + (u.loyaltyPoints || 0), 0);
        }

        function updateBadges() {
            document.getElementById('productsCount').textContent = products.length;
            document.getElementById('ordersCount').textContent = orders.filter(o => o.status === 'pending').length;
        }

        // ============================================
        // Products
        // ============================================
        function sanitizeImageUrl(url) {
            const placeholder = './assets/placeholder.svg';
            if (!url || typeof url !== 'string') return placeholder;

            const trimmed = url.trim();
            if (trimmed.startsWith('data:')) return trimmed;
            if (trimmed.startsWith('./') || trimmed.startsWith('assets/')) return trimmed;

            try {
                const parsed = new URL(trimmed, window.location.origin);
                if (parsed.origin === window.location.origin) {
                    return parsed.pathname + parsed.search + parsed.hash;
                }
            } catch (e) {
                return placeholder;
            }

            return placeholder;
        }

        function renderProductsTable() {
            const tbody = document.getElementById('productsTable');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">ًں“¦</div><p>ظ„ط§ طھظˆط¬ط¯ ظ…ظ†طھط¬ط§طھ</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td><div class="product-cell"><img src="${sanitizeImageUrl(p.image)}" class="product-img" onerror="this.src='${sanitizeImageUrl('')}'"><div><strong>${p.name}</strong></div></div></td>
                    <td>${getCategoryName(p.category)}</td>
                    <td><strong>${p.price} ط¬.ظ…</strong></td>
                    <td>â­گ ${(p.rating || 0).toFixed(1)}</td>
                    <td><div class="action-btns"><button class="action-btn edit" onclick="editProduct('${p.id}')">âœڈï¸ڈ</button><button class="action-btn delete" onclick="deleteProduct('${p.id}')">ًں—‘ï¸ڈ</button></div></td>
                </tr>
            `).join('');
        }

        // ============================================
        // Bulk sanitize external images (professional fix)
        // ============================================
        function isExternalImageUrl(url) {
            if (!url || typeof url !== 'string') return false;
            const trimmed = url.trim();
            if (trimmed.startsWith('data:')) return false;
            if (trimmed.startsWith('./') || trimmed.startsWith('assets/')) return false;
            try {
                const parsed = new URL(trimmed, window.location.origin);
                return parsed.origin !== window.location.origin;
            } catch (e) {
                return false;
            }
        }

        async function sanitizeAllImages() {
            if (!confirm('ظ‡ظ„ طھط±ظٹط¯ ط§ط³طھط¨ط¯ط§ظ„ ظƒظ„ ط§ظ„طµظˆط± ط§ظ„ط®ط§ط±ط¬ظٹط© ط¨ط¨ط¯ط§ط¦ظ„ ظ…ط­ظ„ظٹط©طں')) return;

            const productPlaceholder = './assets/placeholder.svg';
            const bannerPlaceholder = './assets/banner-placeholder.svg';

            let productsUpdated = 0;
            let bannersUpdated = 0;

            // Update products
            products = products.map(p => {
                if (isExternalImageUrl(p.image)) {
                    productsUpdated += 1;
                    return { ...p, image: productPlaceholder };
                }
                return p;
            });

            // Update banners (if banners are used in admin data)
            if (Array.isArray(banners)) {
                banners = banners.map(b => {
                    if (isExternalImageUrl(b.image)) {
                        bannersUpdated += 1;
                        return { ...b, image: bannerPlaceholder };
                    }
                    return b;
                });
            }

            // Persist locally
            if (typeof saveProducts === 'function') saveProducts();
            if (typeof saveBanners === 'function') saveBanners();

            // Update Firebase if available
            try {
                if (typeof updateProduct === 'function') {
                    for (const p of products) {
                        if (p.id && p.image === productPlaceholder) {
                            await updateProduct(p.id, { image: p.image });
                        }
                    }
                }
                if (typeof updateBanner === 'function') {
                    for (const b of banners) {
                        if (b.id && b.image === bannerPlaceholder) {
                            await updateBanner(b.id, { image: b.image });
                        }
                    }
                }
            } catch (e) {
                console.warn('Firebase update skipped or failed:', e);
            }

            renderProductsTable();
            renderBannersTable();
            showNotification('success', 'طھظ… طھظ†ط¸ظٹظپ ط§ظ„طµظˆط±', `طھظ… طھط­ط¯ظٹط« ${productsUpdated} ظ…ظ†طھط¬ ظˆ ${bannersUpdated} ط¨ط§ظ†ط±`);
        }

        function getCategoryName(cat) {
            const names = { 'hair-care': 'ط´ط¹ط±', 'skin-care': 'ط¨ط´ط±ط©', 'baby-care': 'ط·ظپظ„', 'supplements': 'ظ…ظƒظ…ظ„ط§طھ', 'medical': 'ط·ط¨ظٹ' };
            return names[cat] || cat;
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value.trim();
            const imageUrl = document.getElementById('finalImg').value || document.getElementById('manualImg').value;
            if (!imageUrl) {
        showNotification('error', 'â‌Œ ط§ظ„طµظˆط±ط© ظ…ط·ظ„ظˆط¨ط©', 'ظٹط±ط¬ظ‰ ط±ظپط¹ طµظˆط±ط© ط£ظˆ ط¥ط¯ط®ط§ظ„ ط±ط§ط¨ط·');
        return;
    }
    
    const data = {
        name: document.getElementById('productName').value.trim(),
        desc: document.getElementById('productDesc').value.trim(),
        category: document.getElementById('productCategory').value,
        price: parseFloat(document.getElementById('productPrice').value),
        oldPrice: parseFloat(document.getElementById('productOldPrice').value) || null,
        image: imageUrl, // â†گ ظ‡ظ†ط§ ط§ط³طھط®ط¯ظ…ظ†ط§ ط§ظ„ظ…طھط؛ظٹط± ط§ظ„ط¬ط¯ظٹط¯
        rating: 4.5,
        ratingCount: 0
    };
            try {
                await requireAdminPermission();
                if (id) {
                    // تحديث منتج موجود
                    const idx = products.findIndex(p => String(p.id) === String(id));
                    if (idx !== -1) {
                        products[idx] = { ...products[idx], ...data };
                        if (typeof updateProduct === 'function') {
                            await updateProduct(id, { ...products[idx] });
                        }
                    }
                    showNotification('success', 'تم التحديث بنجاح');
                } else {
                    // إضافة منتج جديد
                    if (typeof addProduct === 'function') {
                        const firebaseId = await addProduct(data);
                        data.id = firebaseId;
                    } else {
                        data.id = Date.now().toString();
                    }
                    products.push(data);
                    showNotification('success', 'تمت الإضافة بنجاح');
                }
            } catch (error) {
                console.error('Firebase save error:', error);
                showNotification('error', 'فشل الحفظ', 'لا تملك صلاحيات أو يوجد خطأ بالاتصال');
                return;
            }

            saveProducts();
            renderProductsTable();
            updateStats();
            closeModal('productModal');
            resetProductForm();
        }

        function editProduct(id) {
  const p = products.find(x => String(x.id) === String(id));
  if (!p) return;

  document.getElementById('productId').value = p.id || '';
  document.getElementById('productName').value = p.name || '';
  document.getElementById('productDesc').value = p.desc || '';
  document.getElementById('productCategory').value = p.category || '';
  document.getElementById('productPrice').value = p.price ?? '';
  document.getElementById('productOldPrice').value = p.oldPrice ?? '';

  // âœ… ط§ظ„طµظˆط±ط©
  const img = p.image || '';
  document.getElementById('finalImg').value = img;
  document.getElementById('manualImg').value = img;

  // âœ… ظ…ط¹ط§ظٹظ†ط© ط§ظ„طµظˆط±ط© (ط§ط®طھظٹط§ط±ظٹ)
  const preview = document.getElementById('imgPreview');
  if (preview) {
    const safeImg = img ? sanitizeImageUrl(img) : '';
    preview.innerHTML = safeImg
      ? `<img src="${safeImg}" style="max-width:150px;border-radius:8px;border:2px solid #D4AF37;margin-top:10px;" onerror="this.style.display='none'">`
      : '';
  }

  // (ط§ط®طھظٹط§ط±ظٹ) طھطµظپظٹط± ط§ط®طھظٹط§ط± ط§ظ„ظ…ظ„ظپ ط¹ط´ط§ظ† ظ„ظˆ ظ‡ظٹط±ظپط¹ طµظˆط±ط© ط¬ط¯ظٹط¯ط©
  const fileInput = document.getElementById('imgFile');
  if (fileInput) fileInput.value = '';

  document.getElementById('productModalTitle').textContent = 'âœڈï¸ڈ طھط¹ط¯ظٹظ„';
  openModal('productModal');
}

        async function deleteProduct(id) {
            if (!confirm('حذف المنتج؟')) return;
            try {
                await requireAdminPermission();
                if (typeof deleteProductFromFirebase === 'function') {
                    await deleteProductFromFirebase(id);
                }
                products = products.filter(p => p.id != id && String(p.id) != String(id));
                saveProducts();
                renderProductsTable();
                updateStats();
                showNotification('success', 'تم الحذف ?');
            } catch (error) {
                console.error('Firebase delete error:', error);
                showNotification('error', 'فشل الحذف', 'لا تملك صلاحيات أو يوجد خطأ بالاتصال');
            }
        }


        function resetProductForm() {
  // IDs ط§ظ„ط¬ط¯ظٹط¯ط© + ط§ظ„ط£ط³ط§ط³ظٹط©
  const idsToClear = [
    'productId',
    'productName',
    'productDesc',
    'productCategory',
    'productPrice',
    'productOldPrice',

    // ظ†ط¸ط§ظ… ط§ظ„طµظˆط±ط© ط§ظ„ط¬ط¯ظٹط¯
    'manualImg',
    'finalImg',
    'imgFile'
  ];

  idsToClear.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return; // âœ… ظ„ظˆ ط§ظ„ط¹ظ†طµط± ظ…ط´ ظ…ظˆط¬ظˆط¯ ظ…ط§ ظ†ط¹ظ…ظ„ط´ ط®ط·ط£

    if (el.type === 'file') el.value = '';
    else el.value = '';
  });

  // ظ…ط³ط­ ط§ظ„ظ…ط¹ط§ظٹظ†ط©
  const preview = document.getElementById('imgPreview');
  if (preview) preview.innerHTML = '';

  // (طھظˆط§ظپظ‚ ظ…ط¹ IDs ظ‚ط¯ظٹظ…ط© ظ„ظˆ ظ…ظˆط¬ظˆط¯ط© ط¹ظ†ط¯ظƒ ظپظٹ ط£ظٹ ط¬ط²ط،)
  const legacy = ['productImage', 'productImageUrl', 'imagePreviewContainer', 'uploadStatus'];
  legacy.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'DIV') el.innerHTML = '';
    else el.value = '';
  });

  // ط¹ظ†ظˆط§ظ† ط§ظ„ظ…ظˆط¯ط§ظ„ ظٹط±ط¬ط¹ ط§ظپطھط±ط§ط¶ظٹ
  const title = document.getElementById('productModalTitle');
  if (title) title.textContent = 'â‍• ظ…ظ†طھط¬ ط¬ط¯ظٹط¯';
}

        // ============================================
        // Orders
        // ============================================
        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTable');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ًں›چï¸ڈ</div><p>ظ„ط§ طھظˆط¬ط¯ ط·ظ„ط¨ط§طھ</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = orders.map(o => `
                <tr>
                    <td><strong>${o.orderNumber || o.id}</strong></td>
                    <td>${o.customer?.name || '-'}</td>
                    <td>${o.customer?.phone || '-'}</td>
                    <td><strong>${o.total || 0} ط¬.ظ…</strong></td>
                    <td><span class="status-badge status-${o.status}">${getStatusName(o.status)}</span></td>
                    <td>${formatDate(o.createdAt)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" onclick="viewOrder(${o.id})">ًں‘پï¸ڈ</button>
                            <button class="action-btn delete" onclick="deleteOrder('${o.id}')">ًں—‘ï¸ڈ</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecentOrders() {
            const tbody = document.getElementById('recentOrdersTable');
            const recent = orders.slice(-5).reverse();
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">ظ„ط§ طھظˆط¬ط¯ ط·ظ„ط¨ط§طھ</td></tr>';
                return;
            }
            tbody.innerHTML = recent.map(o => `
                <tr>
                    <td><strong>${o.orderNumber || o.id}</strong></td>
                    <td>${o.customer?.name || '-'}</td>
                    <td><strong>${o.total || 0} ط¬.ظ…</strong></td>
                    <td><span class="status-badge status-${o.status}">${getStatusName(o.status)}</span></td>
                    <td>${formatDate(o.createdAt)}</td>
                </tr>
            `).join('');
        }

        function getStatusName(s) {
            const names = { pending: 'ط¬ط¯ظٹط¯', confirmed: 'ظ…ط¤ظƒط¯', processing: 'طھط¬ظ‡ظٹط²', shipped: 'ط´ط­ظ†', delivered: 'طھظˆطµظٹظ„', completed: 'ظ…ظƒطھظ…ظ„', cancelled: 'ظ…ظ„ط؛ظٹ' };
            return names[s] || s;
        }

        function formatDate(d) {
            if (!d) return '-';
            return new Date(d).toLocaleDateString('ar-EG');
        }

        function viewOrder(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;

            let itemsHtml = o.items?.map(i => `
                <div class="order-item">
                    <span>${i.name} أ— ${i.quantity}</span>
                    <strong>${i.price * i.quantity} ط¬.ظ…</strong>
                </div>
            `).join('') || '';

            document.getElementById('orderModalBody').innerHTML = `
                <div class="order-detail-section">
                    <h4>ًں“‹ ط§ظ„ط·ظ„ط¨</h4>
                    <p><strong>ط±ظ‚ظ…:</strong> ${o.orderNumber || o.id}</p>
                    <p><strong>ط§ظ„طھط§ط±ظٹط®:</strong> ${formatDate(o.createdAt)}</p>
                    <p><strong>ط§ظ„ط­ط§ظ„ط©:</strong> 
                        <select class="status-select" onchange="updateOrderStatus(${o.id}, this.value)">
                            <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>ط¬ط¯ظٹط¯</option>
                            <option value="confirmed" ${o.status === 'confirmed' ? 'selected' : ''}>ظ…ط¤ظƒط¯</option>
                            <option value="processing" ${o.status === 'processing' ? 'selected' : ''}>طھط¬ظ‡ظٹط²</option>
                            <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>ط´ط­ظ†</option>
                            <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>طھظˆطµظٹظ„</option>
                            <option value="completed" ${o.status === 'completed' ? 'selected' : ''}>ظ…ظƒطھظ…ظ„</option>
                            <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>ظ…ظ„ط؛ظٹ</option>
                        </select>
                    </p>
                </div>

                <div class="order-detail-section">
                    <h4>ًں‘¤ ط§ظ„ط¹ظ…ظٹظ„</h4>
                    <p><strong>ط§ظ„ط§ط³ظ…:</strong> ${o.customer?.name}</p>
                    <p><strong>ط§ظ„ظ‡ط§طھظپ:</strong> ${o.customer?.phone}</p>
                    <p><strong>ط§ظ„ط¹ظ†ظˆط§ظ†:</strong> ${o.customer?.address}</p>
                    ${o.customer?.notes ? `<p><strong>ظ…ظ„ط§ط­ط¸ط§طھ:</strong> ${o.customer.notes}</p>` : ''}
                </div>

                <div class="order-detail-section">
                    <h4>ًں“¦ ط§ظ„ظ…ظ†طھط¬ط§طھ</h4>
                    ${itemsHtml || '<p>ظ„ط§ طھظˆط¬ط¯</p>'}
                    
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #ddd;">
                        <div class="order-item"><span>ط§ظ„ظ…ط¬ظ…ظˆط¹:</span><span>${o.subtotal || 0} ط¬.ظ…</span></div>
                        ${o.couponCode ? `<div class="order-item" style="color: var(--success);"><span>ًںژ« ${o.couponCode}</span><span>- ${o.discount || 0} ط¬.ظ…</span></div>` : ''}
                        ${o.usedPoints > 0 ? `<div class="order-item" style="color: var(--info);"><span>ًں’ژ ظ†ظ‚ط§ط· (${o.usedPoints})</span><span>- ${o.pointsDiscount || 0} ط¬.ظ…</span></div>` : ''}
                        ${o.earnedPoints > 0 ? `<div class="order-item" style="color: var(--burgundy);"><span>â­گ ظ†ظ‚ط§ط· ظ…ظƒطھط³ط¨ط©</span><span>+${o.earnedPoints}</span></div>` : ''}
                    </div>
                    <div class="order-total"><span>ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ:</span><span>${o.total || 0} ط¬.ظ…</span></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-navy" onclick="printOrder(${o.id})" style="flex: 1;">ًں–¨ï¸ڈ ط·ط¨ط§ط¹ط©</button>
                    <button class="btn btn-success" onclick="sendWhatsAppUpdate(${o.id})" style="flex: 1;">ًں’¬ ظˆط§طھط³ط§ط¨</button>
                </div>
            `;
            openModal('orderModal');
        }

        function updateOrderStatus(id, status) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            o.status = status;
            if (!o.statusHistory) o.statusHistory = [];
            o.statusHistory.push({ status, date: new Date().toISOString() });
            saveOrders();
            renderOrdersTable();
            renderRecentOrders();
            updateBadges();
            showNotification('success', 'طھظ… طھط­ط¯ظٹط« ط§ظ„ط­ط§ظ„ط©');
        }

        function sendWhatsAppUpdate(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            const phone = o.customer?.phone || '';
            const msg = `ظ…ط±ط­ط¨ط§ظ‹ ${o.customer?.name}!\n\nًں“¦ ط·ظ„ط¨ظƒ ط±ظ‚ظ…: ${o.orderNumber}\nًں“چ ط§ظ„ط­ط§ظ„ط©: ${getStatusName(o.status)}\n\nط´ظƒط±ط§ظ‹ ظ„طھط³ظˆظ‚ظƒ ظ…ط¹ظ†ط§! ًں›چï¸ڈ`;
            window.open(`https://wa.me/2${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function printOrder(id) {
            const o = orders.find(x => String(x.id) === String(id));
            if (!o) return;
            const w = window.open('', '_blank');
            w.document.write(`
                <!DOCTYPE html>
                <html dir="rtl"><head><title>ظپط§طھظˆط±ط© ${o.orderNumber}</title>
                <style>body{font-family:Arial;padding:20px}h1{color:#D4AF37;text-align:center}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:10px;text-align:right}th{background:#f5f5f5;font-weight:700;color:#0A1128}.total{font-size:20px;font-weight:bold}</style></head>
                <body>
                <h1>Sale Zone Store</h1>
                <h2>ظپط§طھظˆط±ط©: ${o.orderNumber}</h2>
                <p><strong>ط§ظ„طھط§ط±ظٹط®:</strong> ${formatDate(o.createdAt)}</p>
                <p><strong>ط§ظ„ط¹ظ…ظٹظ„:</strong> ${o.customer?.name}</p>
                <p><strong>ط§ظ„ظ‡ط§طھظپ:</strong> ${o.customer?.phone}</p>
                <p><strong>ط§ظ„ط¹ظ†ظˆط§ظ†:</strong> ${o.customer?.address}</p>
                <table><tr><th>ط§ظ„ظ…ظ†طھط¬</th><th>ط§ظ„ظƒظ…ظٹط©</th><th>ط§ظ„ط³ط¹ط±</th><th>ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ</th></tr>
                ${o.items?.map(i => `<tr><td>${i.name}</td><td>${i.quantity}</td><td>${i.price}</td><td>${i.price * i.quantity}</td></tr>`).join('')}
                </table>
                <p class="total">ط§ظ„ط¥ط¬ظ…ط§ظ„ظٹ: ${o.total} ط¬.ظ…</p>
                <p style="text-align:center">ط´ظƒط±ط§ظ‹ ظ„طھط³ظˆظ‚ظƒ ظ…ط¹ظ†ط§! ًں“‍ ${storeSettings.contact?.phone}</p>
                </body></html>
            `);
            w.document.close();
            w.print();
        }

        function deleteOrder(id) {
            if (!confirm('ط­ط°ظپ ط§ظ„ط·ظ„ط¨طں')) return;
            orders = orders.filter(o => String(o.id) !== String(id));
            saveOrders();
            renderOrdersTable();
            renderRecentOrders();
            updateStats();
            showNotification('success', 'طھظ… ط§ظ„ط­ط°ظپ');
        }

        // ============================================
        // Banners
        // ============================================
        function renderBannersTable() {
            const tbody = document.getElementById('bannersTable');
            if (banners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">ًںژ </div><p>ظ„ط§ طھظˆط¬ط¯ ط¨ط§ظ†ط±ط§طھ</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = banners.map(b => `
                <tr>
                    <td style="font-size: 24px;">${b.icon || 'ًںژ‰'}</td>
                    <td><strong>${b.title}</strong></td>
                    <td>${b.text || '-'}</td>
                    <td>${getCategoryName(b.category) || 'ط§ظ„ظƒظ„'}</td>
                    <td><button class="action-btn delete" onclick="deleteBanner('${b.id}')">ًں—‘ï¸ڈ</button></td>
                </tr>
            `).join('');
        }

        async function saveBanner(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                icon: document.getElementById('bannerIcon').value || 'ًںژ‰',
                title: document.getElementById('bannerTitle').value.trim(),
                text: document.getElementById('bannerText').value.trim(),
                btn: document.getElementById('bannerBtn').value.trim() || 'طھط³ظˆظ‚ ط§ظ„ط¢ظ†',
                category: document.getElementById('bannerCategory').value
            };
            try {
                if (typeof addBanner === 'function') {
                    const firebaseId = await addBanner(data);
                    data.id = firebaseId;
                }
            } catch (error) { console.error('Firebase error:', error); if (!data.id) data.id = Date.now(); }
            banners.push(data);
            saveBanners();
            renderBannersTable();
            closeModal('bannerModal');
            showNotification('success', 'طھظ…طھ ط§ظ„ط¥ط¶ط§ظپط© âœ…');
            document.getElementById('bannerIcon').value = '';
            document.getElementById('bannerTitle').value = '';
            document.getElementById('bannerText').value = '';
            document.getElementById('bannerBtn').value = '';
        }

        async function deleteBanner(id) {
            if (!confirm('ط­ط°ظپ ط§ظ„ط¨ط§ظ†ط±طں')) return;
            try {
                if (typeof deleteBannerFromFirebase === 'function') {
                    await deleteBannerFromFirebase(id);
                }
            } catch (error) { console.error('Firebase delete error:', error); }
            banners = banners.filter(b => String(b.id) !== String(id));
            saveBanners();
            renderBannersTable();
            showNotification('success', 'طھظ… ط§ظ„ط­ط°ظپ âœ…');
        }

        // ============================================
        // Coupons
        // ============================================
        function renderCouponsTable() {
            const tbody = document.getElementById('couponsTable');
            if (coupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">ًںژ«</div><p>ظ„ط§ طھظˆط¬ط¯ ظƒظˆط¨ظˆظ†ط§طھ</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = coupons.map(c => `
                <tr>
                    <td><strong style="color: var(--burgundy);">${c.code}</strong></td>
                    <td>${c.desc}</td>
                    <td>${c.type === 'percentage' ? 'ظ†ط³ط¨ط©' : 'ط«ط§ط¨طھ'}</td>
                    <td><strong>${c.value}${c.type === 'percentage' ? '%' : ' ط¬.ظ…'}</strong></td>
                    <td><button class="action-btn delete" onclick="deleteCoupon('${c.id}')">ًں—‘ï¸ڈ</button></td>
                </tr>
            `).join('');
        }

        async function saveCoupon(e) {
            e.preventDefault();
            const code = document.getElementById('couponCode').value.trim().toUpperCase();
            if (coupons.find(c => c.code === code)) {
                showNotification('error', 'ط§ظ„ظƒظˆط¯ ظ…ظˆط¬ظˆط¯');
                return;
            }
            coupons.push({
                id: Date.now(),
                code,
                desc: document.getElementById('couponDesc').value.trim(),
                type: document.getElementById('couponType').value,
                value: parseFloat(document.getElementById('couponValue').value)
            });
            saveCoupons();
            renderCouponsTable();
            closeModal('couponModal');
            showNotification('success', 'طھظ…طھ ط§ظ„ط¥ط¶ط§ظپط©');
            document.getElementById('couponCode').value = '';
            document.getElementById('couponDesc').value = '';
            document.getElementById('couponValue').value = '';
        }

        async function deleteCoupon(id) {
            if (!confirm('ط­ط°ظپ ط§ظ„ظƒظˆط¨ظˆظ†طں')) return;
            try {
                if (typeof deleteCouponFromFirebase === 'function') {
                    await deleteCouponFromFirebase(id);
                }
            } catch (error) { console.error('Firebase delete error:', error); }
            coupons = coupons.filter(c => String(c.id) !== String(id));
            saveCoupons();
            renderCouponsTable();
            showNotification('success', 'طھظ… ط§ظ„ط­ط°ظپ âœ…');
        }

        // ============================================
        // Users
        // ============================================
        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">ًں‘¥</div><p>ظ„ط§ ظٹظˆط¬ط¯ ط¹ظ…ظ„ط§ط،</p></div></td></tr>';
                return;
            }
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><strong>${u.name}</strong></td>
                    <td>${u.phone}</td>
                    <td>${u.email || '-'}</td>
                    <td><strong style="color: var(--gold-dark);">${u.loyaltyPoints || 0}</strong></td>
                    <td>${formatDate(u.createdAt)}</td>
                </tr>
            `).join('');
        }

        // ============================================
        // Loyalty
        // ============================================
        function renderLoyaltySection() {
            const total = users.reduce((s, u) => s + (u.loyaltyPoints || 0), 0);
            document.getElementById('totalLoyalty').textContent = total;
            document.getElementById('loyaltyRate').textContent = storeSettings.loyalty?.rate || 5;
            document.getElementById('loyaltyRateInput').value = storeSettings.loyalty?.rate || 5;
            document.getElementById('pointValueInput').value = storeSettings.loyalty?.pointValue || 0.1;

            const list = document.getElementById('loyaltyUsersList');
            const select = document.getElementById('pointsUserId');

            if (users.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ًں‘¥</div><p>ظ„ط§ ظٹظˆط¬ط¯ ط¹ظ…ظ„ط§ط،</p></div>';
                select.innerHTML = '<option value="">ظ„ط§ ظٹظˆط¬ط¯</option>';
                return;
            }

            list.innerHTML = users.map(u => `
                <div class="user-points-card">
                    <div class="user-points-info">
                        <div class="user-points-avatar">${u.name.charAt(0)}</div>
                        <div><strong>${u.name}</strong><div style="font-size:11px;color:#666;">${u.phone}</div></div>
                    </div>
                    <strong style="color: var(--gold-dark); font-size: 18px;">${u.loyaltyPoints || 0}</strong>
                    <div class="user-points-actions">
                        <button class="points-btn add" onclick="quickAddPoints(${u.id})">â‍•</button>
                        <button class="points-btn sub" onclick="quickSubPoints(${u.id})">â‍–</button>
                    </div>
                </div>
            `).join('');

            select.innerHTML = '<option value="">ط§ط®طھط±</option>' + users.map(u => `<option value="${u.id}">${u.name} (${u.loyaltyPoints || 0})</option>`).join('');
        }

        function saveLoyaltySettings(e) {
            e.preventDefault();
            storeSettings.loyalty = {
                rate: parseFloat(document.getElementById('loyaltyRateInput').value),
                pointValue: parseFloat(document.getElementById('pointValueInput').value)
            };
            saveStoreSettings();
            renderLoyaltySection();
            showNotification('success', 'طھظ… ط§ظ„ط­ظپط¸');
        }

        function quickAddPoints(userId) {
            const pts = prompt('ط¹ط¯ط¯ ط§ظ„ظ†ظ‚ط§ط·:');
            if (pts && !isNaN(pts)) {
                const u = users.find(x => x.id === userId);
                if (u) {
                    u.loyaltyPoints = (u.loyaltyPoints || 0) + parseInt(pts);
                    saveUsers();
                    renderLoyaltySection();
                    renderUsersTable();
                    updateStats();
                    showNotification('success', `طھظ… ط¥ط¶ط§ظپط© ${pts} ظ†ظ‚ط·ط©`);
                }
            }
        }

        function quickSubPoints(userId) {
            const pts = prompt('ط¹ط¯ط¯ ط§ظ„ظ†ظ‚ط§ط·:');
            if (pts && !isNaN(pts)) {
                const u = users.find(x => x.id === userId);
                if (u) {
                    u.loyaltyPoints = Math.max(0, (u.loyaltyPoints || 0) - parseInt(pts));
                    saveUsers();
                    renderLoyaltySection();
                    renderUsersTable();
                    updateStats();
                    showNotification('success', `طھظ… ط®طµظ… ${pts} ظ†ظ‚ط·ط©`);
                }
            }
        }

        function handlePointsAction(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('pointsUserId').value);
            const action = document.getElementById('pointsAction').value;
            const amount = parseInt(document.getElementById('pointsAmount').value);
            const u = users.find(x => x.id === userId);
            if (!u) { showNotification('error', 'ط§ط®طھط± ط¹ظ…ظٹظ„'); return; }
            if (action === 'add') u.loyaltyPoints = (u.loyaltyPoints || 0) + amount;
            else u.loyaltyPoints = Math.max(0, (u.loyaltyPoints || 0) - amount);
            saveUsers();
            renderLoyaltySection();
            renderUsersTable();
            updateStats();
            closeModal('pointsModal');
            showNotification('success', 'طھظ…');
        }

        // ============================================
        // Store Settings
        // ============================================
        function loadSettingsToForms() {
            document.getElementById('storeName').value = storeSettings.name || '';
            document.getElementById('storeTagline').value = storeSettings.tagline || '';
            document.getElementById('storeDescription').value = storeSettings.description || '';
            document.getElementById('topBarText').value = storeSettings.topBar?.text || '';
            document.getElementById('topBarBgColor').value = storeSettings.topBar?.bgColor || '#0A1128';
            document.getElementById('topBarTextColor').value = storeSettings.topBar?.textColor || '#F4E4BC';
            document.getElementById('topBarEnabled').checked = storeSettings.topBar?.enabled !== false;
            document.getElementById('contactPhone').value = storeSettings.contact?.phone || '';
            document.getElementById('contactWhatsapp').value = storeSettings.contact?.whatsapp || '';
            document.getElementById('contactEmail').value = storeSettings.contact?.email || '';
            document.getElementById('contactAddress').value = storeSettings.contact?.address || '';
            document.getElementById('footerAbout').value = storeSettings.footer?.about || '';
            document.getElementById('workingHoursWeekdays').value = storeSettings.footer?.workingHoursWeekdays || '';
            document.getElementById('workingHoursFriday').value = storeSettings.footer?.workingHoursFriday || '';
            document.getElementById('workingHoursNote').value = storeSettings.footer?.workingHoursNote || '';
            document.getElementById('copyrightText').value = storeSettings.footer?.copyright || '';
        }

        function saveGeneralSettings(e) {
            e.preventDefault();
            storeSettings.name = document.getElementById('storeName').value.trim();
            storeSettings.tagline = document.getElementById('storeTagline').value.trim();
            storeSettings.description = document.getElementById('storeDescription').value.trim();
            saveStoreSettings();
            showNotification('success', 'طھظ… ط§ظ„ط­ظپط¸');
        }

        function saveTopBarSettings(e) {
            e.preventDefault();
            storeSettings.topBar = {
                enabled: document.getElementById('topBarEnabled').checked,
                text: document.getElementById('topBarText').value.trim(),
                bgColor: document.getElementById('topBarBgColor').value,
                textColor: document.getElementById('topBarTextColor').value
            };
            saveStoreSettings();
            showNotification('success', 'طھظ… ط§ظ„ط­ظپط¸');
        }

        function saveFooterSettings(e) {
            e.preventDefault();
            storeSettings.footer = {
                about: document.getElementById('footerAbout').value.trim(),
                workingHoursWeekdays: document.getElementById('workingHoursWeekdays').value.trim(),
                workingHoursFriday: document.getElementById('workingHoursFriday').value.trim(),
                workingHoursNote: document.getElementById('workingHoursNote').value.trim(),
                copyright: document.getElementById('copyrightText').value.trim()
            };
            saveStoreSettings();
            showNotification('success', 'طھظ… ط§ظ„ط­ظپط¸');
        }

        function saveContactSettings(e) {
            e.preventDefault();
            storeSettings.contact = {
                phone: document.getElementById('contactPhone').value.trim(),
                whatsapp: document.getElementById('contactWhatsapp').value.trim(),
                email: document.getElementById('contactEmail').value.trim(),
                address: document.getElementById('contactAddress').value.trim()
            };
            saveStoreSettings();
            showNotification('success', 'طھظ… ط§ظ„ط­ظپط¸');
        }

        function switchTab(name) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(name + 'Tab').classList.add('active');
        }

        // ============================================
        // Excel Export/Import
        // ============================================
        function exportProductsExcel() {
            const data = products.map(p => ({ 'ط§ظ„ط§ط³ظ…': p.name, 'ط§ظ„ظˆطµظپ': p.desc, 'ط§ظ„ظ‚ط³ظ…': getCategoryName(p.category), 'ط§ظ„ط³ط¹ط±': p.price, 'ط§ظ„ط³ط¹ط± ط§ظ„ظ‚ط¯ظٹظ…': p.oldPrice || '', 'ط§ظ„طھظ‚ظٹظٹظ…': p.rating, 'ط§ظ„طµظˆط±ط©': p.image }));
            exportToExcel(data, 'products');
        }

        function exportOrdersExcel() {
            const data = orders.map(o => ({ 'ط±ظ‚ظ…': o.orderNumber, 'ط§ظ„ط¹ظ…ظٹظ„': o.customer?.name, 'ط§ظ„ظ‡ط§طھظپ': o.customer?.phone, 'ط§ظ„ط¹ظ†ظˆط§ظ†': o.customer?.address, 'ط§ظ„ظ…ط¨ظ„ط؛': o.total, 'ط§ظ„ظƒظˆط¨ظˆظ†': o.couponCode || '', 'ط§ظ„ط®طµظ…': o.discount || 0, 'ط§ظ„ط­ط§ظ„ط©': getStatusName(o.status), 'ط§ظ„طھط§ط±ظٹط®': formatDate(o.createdAt) }));
            exportToExcel(data, 'orders');
        }

        function exportUsersExcel() {
            const data = users.map(u => ({ 'ط§ظ„ط§ط³ظ…': u.name, 'ط§ظ„ظ‡ط§طھظپ': u.phone, 'ط§ظ„ط¨ط±ظٹط¯': u.email || '', 'ط§ظ„ط¹ظ†ظˆط§ظ†': u.address, 'ط§ظ„ظ†ظ‚ط§ط·': u.loyaltyPoints || 0, 'ط§ظ„طھط³ط¬ظٹظ„': formatDate(u.createdAt) }));
            exportToExcel(data, 'users');
        }

        function exportCouponsExcel() {
            const data = coupons.map(c => ({ 'ط§ظ„ظƒظˆط¯': c.code, 'ط§ظ„ظˆطµظپ': c.desc, 'ط§ظ„ظ†ظˆط¹': c.type === 'percentage' ? 'ظ†ط³ط¨ط©' : 'ط«ط§ط¨طھ', 'ط§ظ„ظ‚ظٹظ…ط©': c.value }));
            exportToExcel(data, 'coupons');
        }

        function exportFullReport() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(products.map(p => ({ ط§ظ„ط§ط³ظ…: p.name, ط§ظ„ظ‚ط³ظ…: getCategoryName(p.category), ط§ظ„ط³ط¹ط±: p.price }))), 'ط§ظ„ظ…ظ†طھط¬ط§طھ');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(orders.map(o => ({ ط±ظ‚ظ…: o.orderNumber, ط§ظ„ط¹ظ…ظٹظ„: o.customer?.name, ط§ظ„ظ…ط¨ظ„ط؛: o.total, ط§ظ„ط­ط§ظ„ط©: getStatusName(o.status) }))), 'ط§ظ„ط·ظ„ط¨ط§طھ');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(users.map(u => ({ ط§ظ„ط§ط³ظ…: u.name, ط§ظ„ظ‡ط§طھظپ: u.phone, ط§ظ„ظ†ظ‚ط§ط·: u.loyaltyPoints || 0 }))), 'ط§ظ„ط¹ظ…ظ„ط§ط،');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{ ط§ظ„ظ…ظ†طھط¬ط§طھ: products.length, ط§ظ„ط·ظ„ط¨ط§طھ: orders.length, ط§ظ„ط¹ظ…ظ„ط§ط،: users.length, ط§ظ„ط¥ظٹط±ط§ط¯ط§طھ: orders.reduce((s, o) => s + (o.total || 0), 0) }]), 'ظ…ظ„ط®طµ');
            XLSX.writeFile(wb, `طھظ‚ط±ظٹط±-${Date.now()}.xlsx`);
            showNotification('success', 'طھظ… ط§ظ„طھطµط¯ظٹط±');
        }

        function exportToExcel(data, name) {
            if (data.length === 0) { showNotification('error', 'ظ„ط§ طھظˆط¬ط¯ ط¨ظٹط§ظ†ط§طھ'); return; }
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, name);
            XLSX.writeFile(wb, `${name}-${Date.now()}.xlsx`);
            showNotification('success', 'طھظ… ط§ظ„طھطµط¯ظٹط±');
        }

        function importProductsExcel(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const wb = XLSX.read(ev.target.result, { type: 'binary' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    let count = 0;
                    data.forEach(row => {
                        if (row['ط§ظ„ط§ط³ظ…'] && row['ط§ظ„ط³ط¹ط±']) {
                            products.push({ id: Date.now() + Math.random(), name: row['ط§ظ„ط§ط³ظ…'], desc: row['ط§ظ„ظˆطµظپ'] || '', category: 'supplements', price: parseFloat(row['ط§ظ„ط³ط¹ط±']), oldPrice: parseFloat(row['ط§ظ„ط³ط¹ط± ط§ظ„ظ‚ط¯ظٹظ…']) || null, image: row['ط§ظ„طµظˆط±ط©'] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0xNTAgMTkwQzEzNS4wNDYgMTkwIDEyMy4yOTkgMTc4LjI1MyAxMjMuMjk5IDE2M0MxMjMuMjk5IDE0Ny43NDcgMTM1LjA0NiAxMzYgMTUwIDEzNkMxNjQuOTU0IDEzNiAxNzYuNzAxIDE0Ny43NDcgMTc2LjcwMSAxNjNDMTc2LjcwMSAxNzguMjUzIDE2NC45NTQgMTkwIDE1MCAxOTBaIiBmaWxsPSIjOUNDOUNDOSIvPgo8L3N2Zz4K', rating: 4.5, ratingCount: 0 });
                            count++;
                        }
                    });
                    saveProducts();
                    renderProductsTable();
                    updateStats();
                    showNotification('success', `طھظ… ط§ط³طھظٹط±ط§ط¯ ${count} ظ…ظ†طھط¬`);
                } catch (err) { showNotification('error', 'ط®ط·ط£ ظپظٹ ط§ظ„ظ…ظ„ظپ'); }
            };
            reader.readAsBinaryString(file);
            e.target.value = '';
        }

        // ============================================
        // JSON Backup
        // ============================================
        function exportAllDataJSON() {
            const data = { products, orders, coupons, banners, users, storeSettings };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup-${Date.now()}.json`;
            a.click();
            showNotification('success', 'طھظ… ط§ظ„طھطµط¯ظٹط±');
        }

        function importAllDataJSON(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.products) { products = data.products; saveProducts(); }
                    if (data.orders) { orders = data.orders; saveOrders(); }
                    if (data.coupons) { coupons = data.coupons; saveCoupons(); }
                    if (data.banners) { banners = data.banners; saveBanners(); }
                    if (data.users) { users = data.users; saveUsers(); }
                    if (data.storeSettings) { storeSettings = data.storeSettings; saveStoreSettings(); }
                    initDashboard();
                    showNotification('success', 'طھظ… ط§ظ„ط§ط³طھظٹط±ط§ط¯');
                } catch (err) { showNotification('error', 'ظ…ظ„ظپ ط؛ظٹط± طµط§ظ„ط­'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function clearAllData() {
            if (!confirm('âڑ ï¸ڈ ط­ط°ظپ ظƒظ„ ط§ظ„ط¨ظٹط§ظ†ط§طھطں')) return;
            if (!confirm('âڑ ï¸ڈ ظ…طھط£ظƒط¯طں ظ„ط§ ظٹظ…ظƒظ† ط§ظ„طھط±ط§ط¬ط¹!')) return;
            localStorage.clear();
            products = []; orders = []; coupons = []; banners = []; users = [];
            initDashboard();
            showNotification('success', 'طھظ… ط§ظ„ط­ط°ظپ');
        }

        async function changeAdminPassword(e) {
            e.preventDefault();
            const current = document.getElementById('currentAdminPass').value;
            const newPass = document.getElementById('newAdminPass').value;
            const confirm = document.getElementById('confirmAdminPass').value;
            if (newPass !== confirm) { showNotification('error', 'ط؛ظٹط± ظ…طھط·ط§ط¨ظ‚ط©'); return; }
            const user = firebase.auth().currentUser;
            if (!user) { showNotification('error', 'ط³ط¬ظ„ ط¯ط®ظˆظ„ ظ…ط±ط© ط£ط®ط±ظ‰'); return; }
            try {
                const cred = firebase.auth.EmailAuthProvider.credential(user.email, current);
                await user.reauthenticateWithCredential(cred);
                await user.updatePassword(newPass);
                showNotification('success', 'طھظ… ط§ظ„طھط؛ظٹظٹط±');
                document.getElementById('currentAdminPass').value = '';
                document.getElementById('newAdminPass').value = '';
                document.getElementById('confirmAdminPass').value = '';
            } catch (err) {
                showNotification('error', 'ظپط´ظ„ طھط؛ظٹظٹط± ظƒظ„ظ…ط© ط§ظ„ظ…ط±ظˆط±');
            }
        }

        // ============================================
        // Charts
        // ============================================
        function initCharts() {
            const salesCtx = document.getElementById('salesChart')?.getContext('2d');
            if (salesCtx) {
                if (salesChart) salesChart.destroy();
                salesChart = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['ظٹظ†ط§ظٹط±', 'ظپط¨ط±ط§ظٹط±', 'ظ…ط§ط±ط³', 'ط£ط¨ط±ظٹظ„', 'ظ…ط§ظٹظˆ', 'ظٹظˆظ†ظٹظˆ'],
                        datasets: [{ label: 'ط§ظ„ظ…ط¨ظٹط¹ط§طھ', data: [1200, 1900, 3000, 5000, 4000, 6000], borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.1)', fill: true, tension: 0.4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            const catCtx = document.getElementById('categoriesChart')?.getContext('2d');
            if (catCtx) {
                if (categoriesChart) categoriesChart.destroy();
                categoriesChart = new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ط´ط¹ط±', 'ط¨ط´ط±ط©', 'ط·ظپظ„', 'ظ…ظƒظ…ظ„ط§طھ', 'ط·ط¨ظٹ'],
                        datasets: [{ data: [products.filter(p => p.category === 'hair-care').length, products.filter(p => p.category === 'skin-care').length, products.filter(p => p.category === 'baby-care').length, products.filter(p => p.category === 'supplements').length, products.filter(p => p.category === 'medical').length], backgroundColor: ['#B76E79', '#E8A0BF', '#7EC8E3', '#4CAF50', '#2196F3'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        // ============================================
        // UI
        // ============================================
        function showSection(name) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(name + 'Section').classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event?.target?.classList.add('active');
            const titles = { overview: 'ًں“ٹ ظ†ط¸ط±ط© ط¹ط§ظ…ط©', products: 'ًں“¦ ط§ظ„ظ…ظ†طھط¬ط§طھ', orders: 'ًں›چï¸ڈ ط§ظ„ط·ظ„ط¨ط§طھ', banners: 'ًںژ  ط§ظ„ط¨ط§ظ†ط±ط§طھ', coupons: 'ًںژ« ط§ظ„ظƒظˆط¨ظˆظ†ط§طھ', users: 'ًں‘¥ ط§ظ„ط¹ظ…ظ„ط§ط،', loyalty: 'ًں’ژ ظ†ظ‚ط§ط· ط§ظ„ظˆظ„ط§ط،', reports: 'ًں“ˆ ط§ظ„طھظ‚ط§ط±ظٹط±', storeSettings: 'ًںڈھ ط§ظ„ظ…طھط¬ط±', settings: 'âڑ™ï¸ڈ ط§ظ„ظ†ط¸ط§ظ…' };
            document.getElementById('pageTitle').textContent = titles[name] || name;
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(modalId) {
  document.getElementById(modalId)?.classList.remove('active');
  if (modalId === 'productModal') resetProductForm();
}

        document.querySelectorAll('.modal-overlay').forEach(o => {
            o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        });

        function showNotification(type, message) {
            const container = document.getElementById('notificationsContainer');
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.innerHTML = `<div class="notification-icon">${type === 'success' ? 'âœ“' : 'âœ•'}</div><div class="notification-content"><div class="notification-title">${type === 'success' ? 'ظ†ط¬ط§ط­' : 'ط®ط·ط£'}</div><div class="notification-message">${message}</div></div><button class="notification-close" onclick="this.parentElement.remove()">âœ•</button>`;
            container.appendChild(n);
            setTimeout(() => n.remove(), 4000);
        }
    </script>
    <script>
async function uploadAndPreview(input) {
    if(!input.files[0]) return;
    // ظ…ط¹ط§ظٹظ†ط©
    const reader = new FileReader();
    reader.onload = (e) => document.getElementById('imgPreview').innerHTML = `<img src="${e.target.result}" style="max-width:150px;border-radius:5px;margin:5px 0;">`;
    reader.readAsDataURL(input.files[0]);
    
    // ط±ظپط¹
    try {
        const res = await uploadToCloudinary(input.files[0]);
        if(res) {
            document.getElementById('finalImg').value = res.url;
            document.getElementById('manualImg').value = res.url;
            alert('âœ… طھظ… ط±ظپط¹ ط§ظ„طµظˆط±ط©');
        }
    } catch(err) {
        alert('â‌Œ ظپط´ظ„ ط§ظ„ط±ظپط¹: ' + err.message);
    }
}
</script>
</body>
</html>

