rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function isAdminEmail() {
      return request.auth != null
        && request.auth.token.email_verified == true
        && request.auth.token.email in ["ahmed.sheta89@gmail.com"];
    }

    function isValidOrderCreate() {
      return request.resource.data.keys().hasAll([
        "orderNumber",
        "customer",
        "items",
        "total",
        "createdAt"
      ])
      && request.resource.data.customer is map
      && request.resource.data.items is list
      && request.resource.data.items.size() > 0
      && request.resource.data.total is number;
    }

    function isValidCustomerCreate() {
      return request.resource.data.keys().hasAll([
        "name",
        "phone",
        "createdAt"
      ])
      && request.resource.data.name is string
      && request.resource.data.phone is string
      && !request.resource.data.keys().hasAny(["password"]);
    }

    function isValidClientErrorCreate() {
      return request.resource.data.keys().hasOnly([
        "type",
        "message",
        "stack",
        "source",
        "timestamp",
        "context"
      ])
      && request.resource.data.keys().hasAll([
        "type",
        "message",
        "timestamp",
        "context"
      ])
      && request.resource.data.type is string
      && request.resource.data.type.size() > 0
      && request.resource.data.type.size() <= 100
      && request.resource.data.message is string
      && request.resource.data.message.size() > 0
      && request.resource.data.message.size() <= 500
      && (!("stack" in request.resource.data) || (request.resource.data.stack is string && request.resource.data.stack.size() <= 6000))
      && (!("source" in request.resource.data) || (request.resource.data.source is string && request.resource.data.source.size() <= 300))
      && request.resource.data.timestamp is string
      && request.resource.data.context is map
      && request.resource.data.context.keys().hasAll([
        "page",
        "href",
        "userAgent",
        "language",
        "platform",
        "online",
        "viewport"
      ])
      && request.resource.data.context.page is string
      && request.resource.data.context.href is string
      && request.resource.data.context.userAgent is string
      && request.resource.data.context.language is string
      && request.resource.data.context.platform is string
      && request.resource.data.context.online is bool
      && request.resource.data.context.viewport is map;
    }

    // Public readable content
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /coupons/{couponId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /settings/{settingId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    // Admin-only data
    match /orders/{orderId} {
      allow read, update, delete: if isAdmin() || isAdminEmail();
      allow create: if isAdmin() || isAdminEmail() || isValidOrderCreate();
    }

    match /customers/{customerId} {
      allow read, update, delete: if isAdmin() || isAdminEmail();
      allow create: if isAdmin() || isAdminEmail() || isValidCustomerCreate();
    }

    match /admins/{adminId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /analytics/{analyticsId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /logs/{logId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /errors/{errorId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /client_error_logs/{logId} {
      allow read, update, delete: if isAdmin() || isAdminEmail();
      allow create: if isValidClientErrorCreate();
    }

    match /sessions/{sessionId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /sync/{syncId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }
  }
}
