rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isVerifiedUser() {
      return isSignedIn() && request.auth.token.email_verified == true;
    }

    function hasAdminClaim() {
      return isSignedIn()
        && (
          request.auth.token.admin == true
          || request.auth.token.role == "admin"
        );
    }

    function isBootstrapAdminEmail() {
      return isVerifiedUser()
        && request.auth.token.email in ["ahmed.sheta89@gmail.com"];
    }

    function isAdmin() {
      return isVerifiedUser() && (hasAdminClaim() || isBootstrapAdminEmail());
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isValidOrderCreate() {
      return request.resource.data.keys().hasAll([
        "orderNumber",
        "customer",
        "items",
        "total",
        "createdAt"
      ])
      && request.resource.data.customer is map
      && request.resource.data.items is list
      && request.resource.data.items.size() > 0
      && request.resource.data.total is number;
    }

    function isValidCustomerDocument() {
      return request.resource.data.keys().hasAll([
        "uid",
        "email",
        "phone",
        "address",
        "displayName",
        "role",
        "createdAt",
        "updatedAt"
      ])
      && request.resource.data.keys().hasOnly([
        "uid",
        "email",
        "phone",
        "address",
        "displayName",
        "role",
        "createdAt",
        "updatedAt",
        "loyaltyPoints",
        "status"
      ])
      && request.resource.data.uid is string
      && request.resource.data.uid.size() > 0
      && request.resource.data.email is string
      && request.resource.data.email.size() > 3
      && request.resource.data.phone is string
      && request.resource.data.phone.size() > 0
      && request.resource.data.address is string
      && request.resource.data.address.size() > 0
      && request.resource.data.displayName is string
      && request.resource.data.role in ["customer", "admin"]
      && (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp)
      && (request.resource.data.updatedAt is string || request.resource.data.updatedAt is timestamp)
      && (!("loyaltyPoints" in request.resource.data) || (request.resource.data.loyaltyPoints is number && request.resource.data.loyaltyPoints >= 0))
      && (!("status" in request.resource.data) || request.resource.data.status is string);
    }

    function isCustomerOwnerCreate(uid) {
      return isOwner(uid)
        && isValidCustomerDocument()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.role == "customer"
        && request.resource.data.email == request.auth.token.email
        && !("password" in request.resource.data);
    }

    function isCustomerOwnerUpdate(uid) {
      return isOwner(uid)
        && isValidCustomerDocument()
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.role == resource.data.role
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.email == resource.data.email
        && (!("loyaltyPoints" in resource.data) || request.resource.data.loyaltyPoints == resource.data.loyaltyPoints)
        && !("password" in request.resource.data);
    }

    function isCustomerAdminWrite(uid) {
      return isAdmin()
        && isValidCustomerDocument()
        && request.resource.data.uid == uid
        && !("password" in request.resource.data);
    }

    function isValidClientErrorCreate() {
      return request.resource.data.keys().hasOnly([
        "type",
        "message",
        "stack",
        "source",
        "timestamp",
        "context"
      ])
      && request.resource.data.keys().hasAll([
        "type",
        "message",
        "timestamp",
        "context"
      ])
      && request.resource.data.type is string
      && request.resource.data.message is string
      && request.resource.data.timestamp is string
      && request.resource.data.context is map;
    }

    function isValidStoreEventCreate() {
      return request.resource.data.keys().hasOnly([
        "type",
        "level",
        "message",
        "source",
        "timestamp",
        "sessionId",
        "customerId",
        "meta",
        "context"
      ])
      && request.resource.data.keys().hasAll([
        "type",
        "level",
        "source",
        "timestamp"
      ])
      && request.resource.data.type is string
      && request.resource.data.level is string
      && request.resource.data.source is string
      && request.resource.data.timestamp is string;
    }

    function isValidLiveSessionWrite() {
      return request.resource.data.keys().hasOnly([
        "sessionId",
        "page",
        "href",
        "online",
        "customerId",
        "customerPhone",
        "device",
        "userAgent",
        "updatedAt",
        "createdAt"
      ])
      && request.resource.data.keys().hasAll([
        "sessionId",
        "updatedAt"
      ])
      && request.resource.data.sessionId is string
      && request.resource.data.updatedAt is string;
    }

    function isValidSupportThreadWrite(threadId) {
      return request.resource.data.keys().hasOnly([
        "uid",
        "status",
        "lastMessage",
        "updatedAt",
        "createdAt",
        "lastMessageAt",
        "lastSenderRole",
        "unreadForAdmin",
        "unreadForCustomer",
        "customerName",
        "customerPhone",
        "customerEmail"
      ])
      && request.resource.data.keys().hasAll([
        "uid",
        "status",
        "updatedAt"
      ])
      && request.resource.data.uid is string
      && request.resource.data.uid == threadId
      && request.resource.data.status in ["open", "closed"]
      && (request.resource.data.updatedAt is string || request.resource.data.updatedAt is timestamp)
      && (!("createdAt" in request.resource.data) || (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp))
      && (!("lastMessage" in request.resource.data) || request.resource.data.lastMessage is string)
      && (!("lastMessageAt" in request.resource.data) || (request.resource.data.lastMessageAt is string || request.resource.data.lastMessageAt is timestamp))
      && (!("lastSenderRole" in request.resource.data) || request.resource.data.lastSenderRole in ["customer", "admin"])
      && (!("unreadForAdmin" in request.resource.data) || (request.resource.data.unreadForAdmin is number && request.resource.data.unreadForAdmin >= 0))
      && (!("unreadForCustomer" in request.resource.data) || (request.resource.data.unreadForCustomer is number && request.resource.data.unreadForCustomer >= 0))
      && (!("customerName" in request.resource.data) || request.resource.data.customerName is string)
      && (!("customerPhone" in request.resource.data) || request.resource.data.customerPhone is string)
      && (!("customerEmail" in request.resource.data) || request.resource.data.customerEmail is string);
    }

    function isValidSupportMessageCreate(threadId) {
      return request.resource.data.keys().hasOnly([
        "threadId",
        "senderRole",
        "senderUid",
        "senderName",
        "message",
        "text",
        "createdAt",
        "createdAtMs"
      ])
      && request.resource.data.keys().hasAll([
        "threadId",
        "senderRole",
        "senderUid",
        "createdAt"
      ])
      && request.resource.data.threadId is string
      && request.resource.data.threadId == threadId
      && request.resource.data.senderRole in ["customer", "admin"]
      && request.resource.data.senderUid is string
      && (
        (("message" in request.resource.data) && request.resource.data.message is string && request.resource.data.message.size() > 0)
        || (("text" in request.resource.data) && request.resource.data.text is string && request.resource.data.text.size() > 0)
      )
      && (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp)
      && (!("createdAtMs" in request.resource.data) || request.resource.data.createdAtMs is number)
      && (!("senderName" in request.resource.data) || request.resource.data.senderName is string);
    }

    function isValidProductWrite() {
      return request.resource.data.name is string
      && request.resource.data.name.size() > 0
      && request.resource.data.price is number
      && request.resource.data.price >= 0;
    }

    match /products/{productId} {
      allow read: if (resource.data.isPublished != false) || isAdmin();
      allow create, update: if isAdmin() && isValidProductWrite();
      allow delete: if isAdmin();
    }

    match /coupons/{couponId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /settings/{settingId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /suppliers/{supplierId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /orders/{orderId} {
      allow read, update, delete: if isAdmin();
      allow create: if isAdmin() || (isVerifiedUser() && isValidOrderCreate());
    }

    match /customers/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isCustomerOwnerCreate(uid) || isCustomerAdminWrite(uid);
      allow update: if isCustomerOwnerUpdate(uid) || isCustomerAdminWrite(uid);
      allow delete: if isAdmin();
    }

    match /admins/{adminId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /analytics/{analyticsId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /logs/{logId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /errors/{errorId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /client_error_logs/{logId} {
      allow read, update, delete: if isAdmin();
      allow create: if isValidClientErrorCreate();
    }

    match /store_events/{eventId} {
      allow read, update, delete: if isAdmin();
      allow create: if isAdmin() || isValidStoreEventCreate();
    }

    match /store_live_sessions/{sessionId} {
      allow read, delete: if isAdmin();
      allow create, update: if isAdmin() || isValidLiveSessionWrite();
    }

    match /support_threads/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isValidSupportThreadWrite(uid)
        && (
          (isOwner(uid) && isVerifiedUser())
          || isAdmin()
        );
      allow update: if isValidSupportThreadWrite(uid)
        && (
          (isOwner(uid) && isVerifiedUser())
          || isAdmin()
        );
      allow delete: if isAdmin();

      match /messages/{messageId} {
        allow read: if isOwner(uid) || isAdmin();
        allow create: if isValidSupportMessageCreate(uid)
          && (
            (
              isOwner(uid)
              && isVerifiedUser()
              && request.resource.data.senderRole == "customer"
              && request.resource.data.senderUid == request.auth.uid
            )
            || (
              isAdmin()
              && request.resource.data.senderRole == "admin"
              && request.resource.data.senderUid == request.auth.uid
            )
          );
        allow update, delete: if isAdmin();
      }
    }

    match /sessions/{sessionId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /sync/{syncId} {
      allow read, create, update, delete: if isAdmin();
    }
  }
}
