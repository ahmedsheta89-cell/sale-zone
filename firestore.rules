rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isVerifiedUser() {
      return isSignedIn() && request.auth.token.email_verified == true;
    }

    function hasAdminClaim() {
      return isSignedIn()
        && (
          request.auth.token.admin == true
          || request.auth.token.role == "admin"
        );
    }

    function isAdmin() {
      return isVerifiedUser() && hasAdminClaim();
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isValidOrderCreate() {
      return request.resource.data.keys().hasAll([
        "uid",
        "orderNumber",
        "customer",
        "items",
        "total",
        "status",
        "createdAt",
        "idempotencyKey"
      ])
      && request.resource.data.keys().hasOnly([
        "id",
        "uid",
        "email",
        "requestId",
        "deviceId",
        "orderNumber",
        "customer",
        "items",
        "subtotal",
        "discount",
        "couponCode",
        "usedPoints",
        "pointsDiscount",
        "total",
        "earnedPoints",
        "status",
        "statusHistory",
        "createdAt",
        "updatedAt",
        "version",
        "source",
        "syncState",
        "idempotencyKey"
      ])
      && request.resource.data.uid is string
      && request.resource.data.uid.size() > 0
      && request.resource.data.orderNumber is string
      && request.resource.data.orderNumber.size() > 0
      && request.resource.data.idempotencyKey is string
      && request.resource.data.idempotencyKey.size() >= 12
      && request.resource.data.customer is map
      && request.resource.data.items is list
      && request.resource.data.items.size() > 0
      && request.resource.data.total is number
      && request.resource.data.total >= 0
      && request.resource.data.status in ["pending", "confirmed", "processing", "shipped", "delivered", "completed", "cancelled"]
      && (!("subtotal" in request.resource.data) || (request.resource.data.subtotal is number && request.resource.data.subtotal >= 0))
      && (!("discount" in request.resource.data) || (request.resource.data.discount is number && request.resource.data.discount >= 0))
      && (!("pointsDiscount" in request.resource.data) || (request.resource.data.pointsDiscount is number && request.resource.data.pointsDiscount >= 0))
      && (!("usedPoints" in request.resource.data) || (request.resource.data.usedPoints is number && request.resource.data.usedPoints >= 0))
      && (!("earnedPoints" in request.resource.data) || (request.resource.data.earnedPoints is number && request.resource.data.earnedPoints >= 0))
      && (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp)
      && (!("updatedAt" in request.resource.data) || (request.resource.data.updatedAt is string || request.resource.data.updatedAt is timestamp))
      && (!("version" in request.resource.data) || (request.resource.data.version is number && request.resource.data.version >= 1));
    }

    function isValidOrderOwnerCreate() {
      return isVerifiedUser()
        && isValidOrderCreate()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.status == "pending";
    }

    function isValidOrderAdminUpdate() {
      return isAdmin()
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.orderNumber == resource.data.orderNumber
        && request.resource.data.idempotencyKey == resource.data.idempotencyKey
        && request.resource.data.items == resource.data.items
        && request.resource.data.customer == resource.data.customer
        && request.resource.data.total == resource.data.total
        && (!("subtotal" in resource.data) || request.resource.data.subtotal == resource.data.subtotal)
        && (!("discount" in resource.data) || request.resource.data.discount == resource.data.discount)
        && (!("pointsDiscount" in resource.data) || request.resource.data.pointsDiscount == resource.data.pointsDiscount)
        && (!("usedPoints" in resource.data) || request.resource.data.usedPoints == resource.data.usedPoints)
        && (!("earnedPoints" in resource.data) || request.resource.data.earnedPoints == resource.data.earnedPoints)
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.status in ["pending", "confirmed", "processing", "shipped", "delivered", "completed", "cancelled"]
        && (!("version" in resource.data) || request.resource.data.version == resource.data.version + 1);
    }

    function isValidOrderQueueWrite() {
      return request.resource.data.keys().hasAll([
        "queueId",
        "uid",
        "idempotencyKey",
        "status",
        "queuedAt",
        "updatedAt"
      ])
      && request.resource.data.uid is string
      && request.resource.data.uid.size() > 0
      && request.resource.data.queueId is string
      && request.resource.data.queueId.size() > 0
      && request.resource.data.idempotencyKey is string
      && request.resource.data.idempotencyKey.size() >= 12
      && request.resource.data.status in ["queued", "pending", "processing", "processed", "failed"]
      && (request.resource.data.queuedAt is string || request.resource.data.queuedAt is timestamp)
      && (request.resource.data.updatedAt is string || request.resource.data.updatedAt is timestamp)
      && (!("retryCount" in request.resource.data) || (request.resource.data.retryCount is number && request.resource.data.retryCount >= 0))
      && (!("lastError" in request.resource.data) || request.resource.data.lastError is string);
    }

    function isValidOrderEventWrite() {
      return request.resource.data.keys().hasAll([
        "type",
        "orderId",
        "uid",
        "createdAt"
      ])
      && request.resource.data.type is string
      && request.resource.data.type.size() > 0
      && request.resource.data.orderId is string
      && request.resource.data.orderId.size() > 0
      && request.resource.data.uid is string
      && request.resource.data.uid.size() > 0
      && (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp)
      && (!("idempotencyKey" in request.resource.data) || request.resource.data.idempotencyKey is string)
      && (!("payload" in request.resource.data) || request.resource.data.payload is map);
    }

    function isValidAuditLogWrite() {
      return request.resource.data.keys().hasAll([
        "action",
        "uid",
        "createdAt"
      ])
      && request.resource.data.action is string
      && request.resource.data.action.size() > 0
      && request.resource.data.uid is string
      && request.resource.data.uid.size() > 0
      && (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp)
      && (!("scope" in request.resource.data) || request.resource.data.scope is string)
      && (!("targetId" in request.resource.data) || request.resource.data.targetId is string)
      && (!("details" in request.resource.data) || request.resource.data.details is map);
    }

    function isValidCustomerDocument() {
      return request.resource.data.keys().hasAll([
        "uid",
        "email",
        "phone",
        "address",
        "displayName",
        "role",
        "createdAt",
        "updatedAt"
      ])
      && request.resource.data.keys().hasOnly([
        "uid",
        "email",
        "phone",
        "address",
        "displayName",
        "role",
        "createdAt",
        "updatedAt",
        "loyaltyPoints",
        "status"
      ])
      && request.resource.data.uid is string
      && request.resource.data.uid.size() > 0
      && request.resource.data.email is string
      && request.resource.data.email.size() > 3
      && request.resource.data.phone is string
      && request.resource.data.phone.size() > 0
      && request.resource.data.address is string
      && request.resource.data.address.size() > 0
      && request.resource.data.displayName is string
      && request.resource.data.role in ["customer", "admin"]
      && (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp)
      && (request.resource.data.updatedAt is string || request.resource.data.updatedAt is timestamp)
      && (!("loyaltyPoints" in request.resource.data) || (request.resource.data.loyaltyPoints is number && request.resource.data.loyaltyPoints >= 0))
      && (!("status" in request.resource.data) || request.resource.data.status is string);
    }

    function isCustomerOwnerCreate(uid) {
      return isOwner(uid)
        && isValidCustomerDocument()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.role == "customer"
        && request.resource.data.email == request.auth.token.email
        && !("password" in request.resource.data);
    }

    function isCustomerOwnerUpdate(uid) {
      return isOwner(uid)
        && isValidCustomerDocument()
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.role == resource.data.role
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.email == resource.data.email
        && (!("loyaltyPoints" in resource.data) || request.resource.data.loyaltyPoints == resource.data.loyaltyPoints)
        && !("password" in request.resource.data);
    }

    function isCustomerAdminWrite(uid) {
      return isAdmin()
        && isValidCustomerDocument()
        && request.resource.data.uid == uid
        && !("password" in request.resource.data);
    }

    function isValidClientErrorCreate() {
      return request.resource.data.keys().hasOnly([
        "type",
        "message",
        "stack",
        "source",
        "timestamp",
        "context"
      ])
      && request.resource.data.keys().hasAll([
        "type",
        "message",
        "timestamp",
        "context"
      ])
      && request.resource.data.type is string
      && request.resource.data.message is string
      && request.resource.data.type.size() > 0
      && request.resource.data.type.size() <= 64
      && request.resource.data.message.size() > 0
      && request.resource.data.message.size() <= 1000
      && request.resource.data.timestamp is string
      && request.resource.data.timestamp.size() > 0
      && request.resource.data.timestamp.size() <= 64
      && request.resource.data.context is map
      && request.resource.data.context.keys().size() <= 20
      && (!("stack" in request.resource.data) || (request.resource.data.stack is string && request.resource.data.stack.size() <= 4000))
      && (!("source" in request.resource.data) || (request.resource.data.source is string && request.resource.data.source.size() <= 240));
    }

    function isValidStoreEventCreate() {
      return request.resource.data.keys().hasOnly([
        "type",
        "level",
        "message",
        "source",
        "timestamp",
        "sessionId",
        "customerId",
        "meta",
        "context"
      ])
      && request.resource.data.keys().hasAll([
        "type",
        "level",
        "source",
        "timestamp"
      ])
      && request.resource.data.type is string
      && request.resource.data.level is string
      && request.resource.data.source is string
      && request.resource.data.timestamp is string
      && request.resource.data.type.size() > 0
      && request.resource.data.type.size() <= 64
      && request.resource.data.level in ["debug", "info", "warn", "warning", "error"]
      && request.resource.data.source.size() > 0
      && request.resource.data.source.size() <= 120
      && request.resource.data.timestamp.size() > 0
      && request.resource.data.timestamp.size() <= 64
      && (!("message" in request.resource.data) || (request.resource.data.message is string && request.resource.data.message.size() <= 1000))
      && (!("sessionId" in request.resource.data) || (request.resource.data.sessionId is string && request.resource.data.sessionId.size() <= 160))
      && (!("customerId" in request.resource.data) || (request.resource.data.customerId is string && request.resource.data.customerId.size() <= 160))
      && (!("meta" in request.resource.data) || request.resource.data.meta is map)
      && (!("context" in request.resource.data) || (request.resource.data.context is map && request.resource.data.context.keys().size() <= 20));
    }

    function isValidLiveSessionWrite() {
      return request.resource.data.keys().hasOnly([
        "sessionId",
        "page",
        "href",
        "online",
        "customerId",
        "customerPhone",
        "device",
        "userAgent",
        "updatedAt",
        "createdAt"
      ])
      && request.resource.data.keys().hasAll([
        "sessionId",
        "updatedAt"
      ])
      && request.resource.data.sessionId is string
      && request.resource.data.sessionId.size() >= 8
      && request.resource.data.sessionId.size() <= 160
      && request.resource.data.updatedAt is string
      && request.resource.data.updatedAt.size() > 0
      && request.resource.data.updatedAt.size() <= 64
      && (!("createdAt" in request.resource.data) || (request.resource.data.createdAt is string && request.resource.data.createdAt.size() > 0 && request.resource.data.createdAt.size() <= 64))
      && (!("page" in request.resource.data) || (request.resource.data.page is string && request.resource.data.page.size() <= 240))
      && (!("href" in request.resource.data) || (request.resource.data.href is string && request.resource.data.href.size() <= 2000))
      && (!("customerId" in request.resource.data) || (request.resource.data.customerId is string && request.resource.data.customerId.size() <= 160))
      && (!("customerPhone" in request.resource.data) || (request.resource.data.customerPhone is string && request.resource.data.customerPhone.size() <= 40))
      && (!("device" in request.resource.data) || (request.resource.data.device is string && request.resource.data.device.size() <= 32))
      && (!("userAgent" in request.resource.data) || (request.resource.data.userAgent is string && request.resource.data.userAgent.size() <= 512))
      && (!("online" in request.resource.data) || request.resource.data.online is bool);
    }

    function isValidSupportThreadWrite(threadId) {
      return request.resource.data.keys().hasOnly([
        "uid",
        "status",
        "lastMessage",
        "updatedAt",
        "createdAt",
        "lastMessageAt",
        "lastSenderRole",
        "unreadForAdmin",
        "unreadForCustomer",
        "customerName",
        "customerPhone",
        "customerEmail"
      ])
      && request.resource.data.keys().hasAll([
        "uid",
        "status",
        "updatedAt"
      ])
      && request.resource.data.uid is string
      && request.resource.data.uid == threadId
      && request.resource.data.status in ["open", "closed"]
      && (request.resource.data.updatedAt is string || request.resource.data.updatedAt is timestamp)
      && (!("createdAt" in request.resource.data) || (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp))
      && (!("lastMessage" in request.resource.data) || request.resource.data.lastMessage is string)
      && (!("lastMessageAt" in request.resource.data) || (request.resource.data.lastMessageAt is string || request.resource.data.lastMessageAt is timestamp))
      && (!("lastSenderRole" in request.resource.data) || request.resource.data.lastSenderRole in ["customer", "admin"])
      && (!("unreadForAdmin" in request.resource.data) || (request.resource.data.unreadForAdmin is number && request.resource.data.unreadForAdmin >= 0))
      && (!("unreadForCustomer" in request.resource.data) || (request.resource.data.unreadForCustomer is number && request.resource.data.unreadForCustomer >= 0))
      && (!("customerName" in request.resource.data) || request.resource.data.customerName is string)
      && (!("customerPhone" in request.resource.data) || request.resource.data.customerPhone is string)
      && (!("customerEmail" in request.resource.data) || request.resource.data.customerEmail is string);
    }

    function isValidSupportMessageCreate(threadId) {
      return request.resource.data.keys().hasOnly([
        "threadId",
        "senderRole",
        "senderUid",
        "senderName",
        "message",
        "text",
        "createdAt",
        "createdAtMs"
      ])
      && request.resource.data.keys().hasAll([
        "threadId",
        "senderRole",
        "senderUid",
        "createdAt"
      ])
      && request.resource.data.threadId is string
      && request.resource.data.threadId == threadId
      && request.resource.data.senderRole in ["customer", "admin"]
      && request.resource.data.senderUid is string
      && (
        (("message" in request.resource.data) && request.resource.data.message is string && request.resource.data.message.size() > 0)
        || (("text" in request.resource.data) && request.resource.data.text is string && request.resource.data.text.size() > 0)
      )
      && (request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp)
      && (!("createdAtMs" in request.resource.data) || request.resource.data.createdAtMs is number)
      && (!("senderName" in request.resource.data) || request.resource.data.senderName is string);
    }

    function isValidProductWrite() {
      return request.resource.data.name is string
      && request.resource.data.name.size() > 0
      && request.resource.data.price is number
      && request.resource.data.price >= 0;
    }

    match /products/{productId} {
      allow read: if (resource.data.isPublished != false) || isAdmin();
      allow create, update: if isAdmin() && isValidProductWrite();
      allow delete: if isAdmin();
    }

    match /coupons/{couponId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /settings/{settingId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /suppliers/{supplierId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /orders/{orderId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow create: if isAdmin() || isValidOrderOwnerCreate();
      allow update: if isValidOrderAdminUpdate();
      allow delete: if false;
    }

    match /order_queue/{queueId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow create: if isValidOrderQueueWrite()
        && (
          isAdmin()
          || (isVerifiedUser() && request.resource.data.uid == request.auth.uid)
        );
      allow update: if isValidOrderQueueWrite()
        && (
          isAdmin()
          || (
            isVerifiedUser()
            && resource.data.uid == request.auth.uid
            && request.resource.data.uid == resource.data.uid
            && request.resource.data.idempotencyKey == resource.data.idempotencyKey
          )
        );
      allow delete: if isAdmin();
    }

    match /order_events/{eventId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow create: if isValidOrderEventWrite()
        && (
          isAdmin()
          || (isVerifiedUser() && request.resource.data.uid == request.auth.uid)
        );
      allow update, delete: if isAdmin();
    }

    match /audit_logs/{logId} {
      allow read, update, delete: if isAdmin();
      allow create: if isValidAuditLogWrite()
        && (
          isAdmin()
          || (isSignedIn() && request.resource.data.uid == request.auth.uid)
        );
    }

    match /customers/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isCustomerOwnerCreate(uid) || isCustomerAdminWrite(uid);
      allow update: if isCustomerOwnerUpdate(uid) || isCustomerAdminWrite(uid);
      allow delete: if isAdmin();
    }

    match /admins/{adminId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /analytics/{analyticsId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /logs/{logId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /errors/{errorId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /client_error_logs/{logId} {
      allow read, update, delete: if isAdmin();
      allow create: if isVerifiedUser() && isValidClientErrorCreate();
    }

    match /store_events/{eventId} {
      allow read, update, delete: if isAdmin();
      allow create: if isAdmin() || (isVerifiedUser() && isValidStoreEventCreate());
    }

    match /store_live_sessions/{sessionId} {
      allow read, delete: if isAdmin();
      allow create, update: if isAdmin()
        || (
          isSignedIn()
          && isValidLiveSessionWrite()
          && request.resource.data.sessionId == sessionId
          && (!("createdAt" in request.resource.data) || resource == null || request.resource.data.createdAt == resource.data.createdAt)
        );
    }

    match /support_threads/{uid} {
      allow read: if isOwner(uid) || isAdmin();
      allow create: if isValidSupportThreadWrite(uid)
        && (
          (isOwner(uid) && isVerifiedUser())
          || isAdmin()
        );
      allow update: if isValidSupportThreadWrite(uid)
        && (
          (isOwner(uid) && isVerifiedUser())
          || isAdmin()
        );
      allow delete: if isAdmin();

      match /messages/{messageId} {
        allow read: if isOwner(uid) || isAdmin();
        allow create: if isValidSupportMessageCreate(uid)
          && (
            (
              isOwner(uid)
              && isVerifiedUser()
              && request.resource.data.senderRole == "customer"
              && request.resource.data.senderUid == request.auth.uid
            )
            || (
              isAdmin()
              && request.resource.data.senderRole == "admin"
              && request.resource.data.senderUid == request.auth.uid
            )
          );
        allow update, delete: if isAdmin();
      }
    }

    match /sessions/{sessionId} {
      allow read, create, update, delete: if isAdmin();
    }

    match /sync/{syncId} {
      allow read, create, update, delete: if isAdmin();
    }
  }
}
