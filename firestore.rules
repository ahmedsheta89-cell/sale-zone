rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function isAdminEmail() {
      return request.auth != null
        && request.auth.token.email_verified == true
        && request.auth.token.email in ["ahmed.sheta89@gmail.com"];
    }

    function isValidOrderCreate() {
      return request.resource.data.keys().hasAll([
        "orderNumber",
        "customer",
        "items",
        "total",
        "createdAt"
      ])
      && request.resource.data.customer is map
      && request.resource.data.items is list
      && request.resource.data.items.size() > 0
      && request.resource.data.total is number;
    }

    function isValidCustomerCreate() {
      return request.resource.data.keys().hasAll([
        "name",
        "phone",
        "createdAt"
      ])
      && request.resource.data.keys().hasOnly([
        "uid",
        "name",
        "phone",
        "phoneNormalized",
        "email",
        "address",
        "password",
        "loyaltyPoints",
        "createdAt"
      ])
      && (!("uid" in request.resource.data) || request.resource.data.uid is string)
      && request.resource.data.name is string
      && request.resource.data.phone is string
      && request.resource.data.name.size() > 0
      && request.resource.data.phone.size() > 0
      && (!("phoneNormalized" in request.resource.data) || request.resource.data.phoneNormalized is string)
      && (!("email" in request.resource.data) || request.resource.data.email is string)
      && (!("address" in request.resource.data) || request.resource.data.address is string)
      && (!("password" in request.resource.data) || (request.resource.data.password is string && request.resource.data.password.size() >= 4))
      && (!("loyaltyPoints" in request.resource.data) || request.resource.data.loyaltyPoints is number);
    }

    // Same shape rules as create, but `createdAt` is optional for legacy docs.
    function isValidCustomerDocument() {
      return request.resource.data.keys().hasAll([
        "name",
        "phone"
      ])
      && request.resource.data.keys().hasOnly([
        "uid",
        "name",
        "phone",
        "phoneNormalized",
        "email",
        "address",
        "password",
        "loyaltyPoints",
        "createdAt"
      ])
      && (!("uid" in request.resource.data) || request.resource.data.uid is string)
      && request.resource.data.name is string
      && request.resource.data.phone is string
      && request.resource.data.name.size() > 0
      && request.resource.data.phone.size() > 0
      && (!("phoneNormalized" in request.resource.data) || request.resource.data.phoneNormalized is string)
      && (!("email" in request.resource.data) || request.resource.data.email is string)
      && (!("address" in request.resource.data) || request.resource.data.address is string)
      && (!("password" in request.resource.data) || (request.resource.data.password is string && request.resource.data.password.size() >= 4))
      && (!("loyaltyPoints" in request.resource.data) || request.resource.data.loyaltyPoints is number)
      && (!("createdAt" in request.resource.data) || request.resource.data.createdAt is string || request.resource.data.createdAt is timestamp);
    }

    // Allow customers (non-admin) to update ONLY their own profile in a safe way.
    // This is required to:
    // - attach `uid` to legacy customer docs
    // - keep multi-device sessions consistent
    function isCustomerSelfUpdate() {
      return request.auth != null
        && ("uid" in request.resource.data)
        && request.resource.data.uid is string
        && request.resource.data.uid == request.auth.uid
        // Prevent taking over an already-linked profile.
        && (
          (!("uid" in resource.data) || resource.data.uid == "")
          || resource.data.uid == request.auth.uid
        )
        // Phone identity must not change on self-update.
        && (!("phoneNormalized" in resource.data) || request.resource.data.phoneNormalized == resource.data.phoneNormalized)
        && (!("phone" in resource.data) || request.resource.data.phone == resource.data.phone)
        // Disallow changing sensitive/system fields from the client.
        && request.resource.data.loyaltyPoints == resource.data.loyaltyPoints
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.password == resource.data.password
        // Only allow updating profile fields + optional first-time uid attach.
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          "uid",
          "name",
          "email",
          "address",
          // Legacy docs may be missing this field; allow setting it once.
          "phoneNormalized"
        ]);
    }

    function isValidClientErrorCreate() {
      return request.resource.data.keys().hasOnly([
        "type",
        "message",
        "stack",
        "source",
        "timestamp",
        "context"
      ])
      && request.resource.data.keys().hasAll([
        "type",
        "message",
        "timestamp",
        "context"
      ])
      && request.resource.data.type is string
      && request.resource.data.type.size() > 0
      && request.resource.data.type.size() <= 100
      && request.resource.data.message is string
      && request.resource.data.message.size() > 0
      && request.resource.data.message.size() <= 500
      && (!("stack" in request.resource.data) || (request.resource.data.stack is string && request.resource.data.stack.size() <= 6000))
      && (!("source" in request.resource.data) || (request.resource.data.source is string && request.resource.data.source.size() <= 300))
      && request.resource.data.timestamp is string
      && request.resource.data.context is map
      && request.resource.data.context.keys().hasAll([
        "page",
        "href",
        "userAgent",
        "language",
        "platform",
        "online",
        "viewport"
      ])
      && request.resource.data.context.page is string
      && request.resource.data.context.href is string
      && request.resource.data.context.userAgent is string
      && request.resource.data.context.language is string
      && request.resource.data.context.platform is string
      && request.resource.data.context.online is bool
      && request.resource.data.context.viewport is map;
    }

    function isValidStoreEventCreate() {
      return request.resource.data.keys().hasOnly([
        "type",
        "level",
        "message",
        "source",
        "timestamp",
        "sessionId",
        "customerId",
        "meta",
        "context"
      ])
      && request.resource.data.keys().hasAll([
        "type",
        "level",
        "source",
        "timestamp"
      ])
      && request.resource.data.type is string
      && request.resource.data.type.size() > 0
      && request.resource.data.type.size() <= 120
      && request.resource.data.level is string
      && request.resource.data.level.size() > 0
      && request.resource.data.level.size() <= 20
      && (!("message" in request.resource.data) || request.resource.data.message is string)
      && request.resource.data.source is string
      && request.resource.data.source.size() <= 120
      && request.resource.data.timestamp is string
      && (!("sessionId" in request.resource.data) || request.resource.data.sessionId is string)
      && (!("customerId" in request.resource.data) || request.resource.data.customerId is string)
      && (!("meta" in request.resource.data) || request.resource.data.meta is map)
      && (!("context" in request.resource.data) || request.resource.data.context is map);
    }

    function isValidLiveSessionWrite() {
      return request.resource.data.keys().hasOnly([
        "sessionId",
        "page",
        "href",
        "online",
        "customerId",
        "customerPhone",
        "device",
        "userAgent",
        "updatedAt",
        "createdAt"
      ])
      && request.resource.data.keys().hasAll([
        "sessionId",
        "updatedAt"
      ])
      && request.resource.data.sessionId is string
      && request.resource.data.sessionId.size() > 0
      && request.resource.data.sessionId.size() <= 120
      && request.resource.data.updatedAt is string
      && (!("createdAt" in request.resource.data) || request.resource.data.createdAt is string)
      && (!("page" in request.resource.data) || request.resource.data.page is string)
      && (!("href" in request.resource.data) || request.resource.data.href is string)
      && (!("online" in request.resource.data) || request.resource.data.online is bool)
      && (!("customerId" in request.resource.data) || request.resource.data.customerId is string)
      && (!("customerPhone" in request.resource.data) || request.resource.data.customerPhone is string)
      && (!("device" in request.resource.data) || request.resource.data.device is string)
      && (!("userAgent" in request.resource.data) || request.resource.data.userAgent is string);
    }

    // Public readable content
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /coupons/{couponId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /settings/{settingId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isAdminEmail();
    }

    // Admin-only data
    match /orders/{orderId} {
      allow read, update, delete: if isAdmin() || isAdminEmail();
      allow create: if isAdmin() || isAdminEmail() || isValidOrderCreate();
    }

    match /customers/{customerId} {
      allow read: if true;
      allow delete: if isAdmin() || isAdminEmail();
      allow create: if isAdmin() || isAdminEmail() || isValidCustomerCreate();
      allow update: if (isAdmin() || isAdminEmail())
        || (isValidCustomerDocument() && isCustomerSelfUpdate());
    }

    match /admins/{adminId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /analytics/{analyticsId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /logs/{logId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /errors/{errorId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /client_error_logs/{logId} {
      allow read, update, delete: if isAdmin() || isAdminEmail();
      allow create: if isValidClientErrorCreate();
    }

    match /store_events/{eventId} {
      allow read, update, delete: if isAdmin() || isAdminEmail();
      allow create: if isAdmin() || isAdminEmail() || isValidStoreEventCreate();
    }

    match /store_live_sessions/{sessionId} {
      allow read, delete: if isAdmin() || isAdminEmail();
      allow create, update: if isAdmin() || isAdminEmail() || isValidLiveSessionWrite();
    }

    match /sessions/{sessionId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }

    match /sync/{syncId} {
      allow read, create, update, delete: if isAdmin() || isAdminEmail();
    }
  }
}
