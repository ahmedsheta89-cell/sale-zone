rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    function isBootstrapAdmin() {
      return request.auth != null
        && request.auth.token.email == "ahmed.sheta89@gmail.com"
        && request.auth.token.email_verified == true;
    }

    function isValidOrderCreate() {
      return request.resource.data.keys().hasAll([
        "orderNumber",
        "customer",
        "items",
        "total",
        "createdAt"
      ])
      && request.resource.data.customer is map
      && request.resource.data.items is list
      && request.resource.data.items.size() > 0
      && request.resource.data.total is number;
    }

    // Public readable content
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /coupons/{couponId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /settings/{settingId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    // Admin-only data
    match /orders/{orderId} {
      allow read, update, delete: if isAdmin() || isBootstrapAdmin();
      allow create: if isAdmin() || isBootstrapAdmin() || isValidOrderCreate();
    }

    match /customers/{customerId} {
      allow read, create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /admins/{adminId} {
      allow read, create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /analytics/{analyticsId} {
      allow read, create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /logs/{logId} {
      allow read, create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /errors/{errorId} {
      allow read, create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /sessions/{sessionId} {
      allow read, create, update, delete: if isAdmin() || isBootstrapAdmin();
    }

    match /sync/{syncId} {
      allow read, create, update, delete: if isAdmin();
    }
  }
}
