<!DOCTYPE html>
<html lang="ar" dir="rtl" data-page="store">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A1128">
    <meta name="description" content="Sale Zone Store - متجرك الأول للتسوق الفاخر">
    <meta name="firebase-app-check-site-key" content="">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" href="./icon-192.png">
    <link rel="shortcut icon" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <title>Sale Zone Store | التسوق الفاخر الذكي</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"></script>
    <!-- Error Detection System -->
    <script src="ERROR_DETECTION_SYSTEM.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="firebase-api.js"></script>
    <script src="firebase-data.js"></script>
    <script src="auth-utils.js"></script>
    <script src="security-utils.js"></script>
    <script src="enhancement-utils.js"></script>
    <script src="storage-keys.js"></script>
    <script src="REAL_TIME_SYNC.js"></script>
    <script src="smart-features.js"></script>
    <script src="advanced-features.js"></script>
    <script src="UI_COMPONENTS.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800&family=Almarai:wght@300;400;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Google Analytics -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        const analyticsHost = (window.location && window.location.hostname) || '';
        const analyticsCookieDomain = /(^|\.)github\.io$/i.test(analyticsHost)
            ? 'ahmedsheta89-cell.github.io'
            : 'auto';
        gtag('config', 'G-V3JC43VQBC', {
            cookie_domain: analyticsCookieDomain
        });
        (function loadAnalyticsScript() {
            const gaScript = document.createElement('script');
            gaScript.async = true;
            gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-V3JC43VQBC';
            gaScript.onerror = () => console.info('[INFO] Google Analytics unavailable (blocked/offline).');
            document.head.appendChild(gaScript);
        })();
    </script>
    
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F4E4BC;
            --gold-dark: #B8960C;
            --navy: #0A1128;
            --navy-light: #1A2744;
            --burgundy: #800020;
            --cream: #FAF8F3;
            --white: #FFFFFF;
            --hair-care: #B76E79;
            --skin-care: #E8A0BF;
            --baby-care: #7EC8E3;
            --supplements: #4CAF50;
            --medical: #2196F3;
            --success: #50C878;
            --error: #DC3545;
            --warning: #FFC107;
            --info: #17A2B8;
            --font-display: 'Playfair Display', serif;
            --font-arabic: 'Almarai', sans-serif;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.2);
            --shadow-gold: 0 4px 20px rgba(212,175,55,0.3);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
        body {
            font-family: var(--font-arabic);
            background-color: var(--cream);
            color: var(--navy);
            line-height: 1.7;
            overflow-x: hidden;
            text-rendering: optimizeLegibility;
            overscroll-behavior: none;
            touch-action: manipulation;
        }
        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; border: none; outline: none; font-family: var(--font-arabic); min-height: 44px; }
        input, textarea, select { font-family: var(--font-arabic); outline: none; font-size: 16px; }
        .hidden { display: none !important; }

        /* Loading Screen */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--navy), var(--navy-light));
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10000; transition: opacity 0.5s, visibility 0.5s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loading-logo { font-size: 60px; animation: float 2s ease-in-out infinite; }
        .loading-text { font-family: var(--font-display); font-size: 32px; color: var(--gold); margin-top: 20px; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(212,175,55,0.3); border-top-color: var(--gold); border-radius: 50%; margin-top: 30px; animation: spin 1s linear infinite; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes glow { 0%, 100% { text-shadow: 0 0 20px rgba(212,175,55,0.5); } 50% { text-shadow: 0 0 40px rgba(212,175,55,0.8); } }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Top Bar */
        .top-bar { padding: 12px 20px; font-size: 14px; text-align: center; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .top-bar-marquee { flex: 1; overflow: hidden; }
        .top-bar-marquee span { display: inline-block; animation: marquee 25s linear infinite; white-space: nowrap; }
        .top-bar-contact { display: flex; align-items: center; gap: 15px; }
        .top-bar-contact a { transition: var(--transition); opacity: 0.9; }
        .top-bar-contact a:hover { opacity: 1; }

        /* Header */
        .header { background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%); padding: 25px 20px; text-align: center; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(212,175,55,0.1) 0%, transparent 50%); animation: spin 30s linear infinite; }
        .header-content { position: relative; z-index: 1; }
        .logo { font-family: var(--font-display); font-size: clamp(28px, 6vw, 48px); font-weight: 700; color: var(--gold); animation: glow 3s ease-in-out infinite; margin-bottom: 8px; }
        .tagline { font-size: 14px; color: var(--gold-light); letter-spacing: 3px; text-transform: uppercase; }
        .header-divider { width: 150px; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); margin: 15px auto; }

        /* Navbar */
        .navbar { background: var(--white); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow-md); }
        .search-box { display: flex; align-items: center; background: var(--cream); border: 2px solid var(--gold); border-radius: 50px; padding: 6px 15px; flex: 1; max-width: 350px; }
        .search-box input { flex: 1; border: none; background: transparent; font-size: 14px; padding: 5px; }
        .search-box button { background: var(--gold); color: var(--white); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .search-box button:hover { background: var(--gold-dark); }

        .nav-actions { display: flex; align-items: center; gap: 10px; }
        .nav-btn { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); padding: 8px 18px; border-radius: 25px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: var(--transition); font-size: 13px; position: relative; }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-gold); }
        .cart-count, .fav-count { position: absolute; top: -6px; right: -6px; background: var(--burgundy); color: var(--white); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; }
        .loyalty-badge { background: linear-gradient(135deg, var(--burgundy), #a00030); color: var(--white); padding: 6px 14px; border-radius: 20px; display: flex; align-items: center; gap: 6px; font-weight: 600; font-size: 12px; }
        .user-btn { background: var(--navy); color: var(--gold); width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: var(--transition); }
        .user-btn:hover { transform: scale(1.1); }
        .user-menu { position: relative; }
        .user-dropdown { position: absolute; top: 100%; left: 0; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); min-width: 170px; padding: 8px 0; opacity: 0; visibility: hidden; transform: translateY(10px); transition: var(--transition); z-index: 1001; }
        .user-menu:hover .user-dropdown { opacity: 1; visibility: visible; transform: translateY(5px); }
        .user-dropdown a, .user-dropdown button { display: flex; align-items: center; gap: 8px; padding: 10px 15px; width: 100%; background: transparent; color: var(--navy); transition: var(--transition); font-size: 13px; }
        .user-dropdown a:hover, .user-dropdown button:hover { background: var(--cream); color: var(--gold-dark); }

        /* Banner Slider */
        .banner-section { position: relative; overflow: hidden; background: var(--navy); }
        .banner-slider { display: flex; transition: transform 0.5s ease; }
        .banner-slide { min-width: 100%; padding: 50px 20px; text-align: center; color: var(--white); position: relative; }
        .banner-slide::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(212,175,55,0.1), transparent); }
        .banner-content { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; }
        .banner-icon { font-size: 50px; margin-bottom: 15px; }
        .banner-title { font-family: var(--font-display); font-size: clamp(20px, 5vw, 32px); color: var(--gold); margin-bottom: 10px; }
        .banner-text { font-size: clamp(12px, 3.5vw, 16px); color: var(--gold-light); margin-bottom: 20px; }
        .banner-btn { background: var(--gold); color: var(--navy); padding: 12px 30px; border-radius: 25px; font-weight: 700; display: inline-block; transition: var(--transition); }
        .banner-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-gold); }
        .banner-dots { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .banner-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.4); cursor: pointer; transition: var(--transition); }
        .banner-dot.active { background: var(--gold); width: 25px; border-radius: 5px; }
        .banner-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: var(--white); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); font-size: 18px; }
        .banner-arrow:hover { background: var(--gold); }
        .banner-arrow.prev { right: 15px; }
        .banner-arrow.next { left: 15px; }

        /* Categories */
        .categories-section { padding: 40px 20px; background: var(--white); }
        .section-title { text-align: center; margin-bottom: 35px; }
        .section-title h2 { font-family: var(--font-display); font-size: clamp(22px, 5vw, 32px); color: var(--navy); margin-bottom: 8px; }
        .section-title .line { width: 70px; height: 3px; background: linear-gradient(90deg, var(--gold), var(--burgundy)); margin: 0 auto; border-radius: 2px; }
        .categories-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; max-width: 1000px; margin: 0 auto; }
        .category-card { background: var(--cream); border-radius: 14px; padding: 20px 12px; text-align: center; cursor: pointer; transition: var(--transition); border: 2px solid transparent; position: relative; overflow: hidden; }
        .category-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; }
        .category-card[data-category="hair-care"]::before { background: var(--hair-care); }
        .category-card[data-category="skin-care"]::before { background: var(--skin-care); }
        .category-card[data-category="baby-care"]::before { background: var(--baby-care); }
        .category-card[data-category="supplements"]::before { background: var(--supplements); }
        .category-card[data-category="medical"]::before { background: var(--medical); }
        .category-card:hover, .category-card.active { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .category-card[data-category="all"].active { border-color: var(--gold); }
        .category-card[data-category="hair-care"]:hover, .category-card[data-category="hair-care"].active { border-color: var(--hair-care); }
        .category-card[data-category="skin-care"]:hover, .category-card[data-category="skin-care"].active { border-color: var(--skin-care); }
        .category-card[data-category="baby-care"]:hover, .category-card[data-category="baby-care"].active { border-color: var(--baby-care); }
        .category-card[data-category="supplements"]:hover, .category-card[data-category="supplements"].active { border-color: var(--supplements); }
        .category-card[data-category="medical"]:hover, .category-card[data-category="medical"].active { border-color: var(--medical); }
        .category-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 28px; color: var(--white); }
        .category-card[data-category="all"] .category-icon { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); }
        .category-card[data-category="hair-care"] .category-icon { background: linear-gradient(135deg, var(--hair-care), #d4919b); }
        .category-card[data-category="skin-care"] .category-icon { background: linear-gradient(135deg, var(--skin-care), #f0c0d5); }
        .category-card[data-category="baby-care"] .category-icon { background: linear-gradient(135deg, var(--baby-care), #a8ddf0); }
        .category-card[data-category="supplements"] .category-icon { background: linear-gradient(135deg, var(--supplements), #81c784); }
        .category-card[data-category="medical"] .category-icon { background: linear-gradient(135deg, var(--medical), #64b5f6); }
        .category-name { font-size: 13px; font-weight: 700; color: var(--navy); margin-bottom: 3px; }
        .category-count { font-size: 11px; color: #888; }

        /* Filter Bar */
        .filter-bar { background: var(--white); padding: 15px 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 13px; font-weight: 600; color: var(--navy); }
        .filter-select { padding: 8px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 13px; background: var(--white); cursor: pointer; transition: var(--transition); }
        .filter-select:focus { border-color: var(--gold); }
        .filter-btn { padding: 8px 18px; border-radius: 20px; background: var(--cream); color: var(--navy); border: 2px solid #ddd; font-weight: 600; transition: var(--transition); font-size: 12px; }
        .filter-btn:hover, .filter-btn.active { background: var(--gold); color: var(--white); border-color: var(--gold); }
        .pagination-btn { min-width: 38px; height: 38px; border-radius: 10px; border: 1px solid #ddd; background: var(--white); color: var(--navy); font-weight: 700; padding: 0 10px; }
        .pagination-btn.active { background: var(--gold); color: var(--white); border-color: var(--gold-dark); }
        .pagination-btn:disabled { opacity: .5; cursor: not-allowed; }
        .price-range { display: flex; align-items: center; gap: 8px; }
        .price-input { width: 80px; padding: 8px; border: 2px solid #ddd; border-radius: 8px; font-size: 13px; text-align: center; }
        .price-input:focus { border-color: var(--gold); }

        /* Products */
        .products-section { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        .products-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }

        /* Product Card */
        .product-card { background: var(--white); border-radius: 14px; overflow: hidden; transition: var(--transition); box-shadow: var(--shadow-sm); position: relative; }
        .product-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }
        .product-badge { position: absolute; top: 10px; right: 10px; background: var(--burgundy); color: var(--white); padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; z-index: 10; }
        .product-category-badge { position: absolute; top: 10px; left: 10px; padding: 4px 8px; border-radius: 10px; font-size: 9px; font-weight: 600; color: var(--white); z-index: 10; }
        .product-category-badge.hair-care { background: var(--hair-care); }
        .product-category-badge.skin-care { background: var(--skin-care); }
        .product-category-badge.baby-care { background: var(--baby-care); }
        .product-category-badge.supplements { background: var(--supplements); }
        .product-category-badge.medical { background: var(--medical); }
        .product-fav { position: absolute; top: 10px; left: 10px; z-index: 11; background: var(--white); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); box-shadow: var(--shadow-sm); }
        .product-fav:hover { transform: scale(1.1); }
        .product-fav.active { background: var(--error); color: var(--white); }
        .product-image { width: 100%; height: 200px; overflow: hidden; position: relative; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; transition: var(--transition); }
        .product-card:hover .product-image img { transform: scale(1.08); }
        .product-actions { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; opacity: 0; transition: var(--transition); }
        .product-card:hover .product-actions { opacity: 1; }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--white); color: var(--navy); display: flex; align-items: center; justify-content: center; font-size: 14px; transition: var(--transition); box-shadow: var(--shadow-md); }
        .action-btn:hover { background: var(--gold); color: var(--white); transform: scale(1.1); }
        .product-info { padding: 15px; }
        .product-name { font-family: var(--font-display); font-size: 15px; font-weight: 600; color: var(--navy); margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        .product-desc { font-size: 11px; color: #666; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-rating { display: flex; align-items: center; gap: 5px; margin-bottom: 8px; }
        .stars { color: var(--gold); font-size: 12px; }
        .rating-count { font-size: 10px; color: #999; }
        .product-price { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .current-price { font-size: 18px; font-weight: 800; color: var(--gold-dark); }
        .old-price { font-size: 13px; color: #999; text-decoration: line-through; }
        .add-to-cart-btn { width: 100%; padding: 10px; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); border-radius: 8px; font-size: 13px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 6px; transition: var(--transition); }
        .add-to-cart-btn:hover { transform: scale(1.02); box-shadow: var(--shadow-gold); }

        /* Cart Sidebar */
        .cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; opacity: 0; visibility: hidden; transition: var(--transition); }
        .cart-overlay.active { opacity: 1; visibility: visible; }
        .cart-sidebar { position: fixed; top: 0; left: -100%; width: 100%; max-width: 400px; height: 100%; background: var(--white); z-index: 2001; transition: var(--transition); display: flex; flex-direction: column; }
        .cart-sidebar.active { left: 0; }
        .cart-header { background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: var(--white); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .cart-header h2 { font-family: var(--font-display); font-size: 20px; display: flex; align-items: center; gap: 8px; }
        .close-cart { background: rgba(255,255,255,0.1); color: var(--white); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: var(--transition); }
        .close-cart:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        .cart-items { flex: 1; overflow-y: auto; padding: 15px; }
        .cart-empty { text-align: center; padding: 40px 20px; color: #999; }
        .cart-empty-icon { font-size: 60px; margin-bottom: 12px; opacity: 0.5; }
        .cart-item { display: flex; gap: 12px; padding: 12px; background: var(--cream); border-radius: 10px; margin-bottom: 10px; }
        .cart-item-image { width: 60px; height: 60px; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
        .cart-item-image img { width: 100%; height: 100%; object-fit: cover; }
        .cart-item-details { flex: 1; }
        .cart-item-name { font-weight: 700; color: var(--navy); margin-bottom: 3px; font-size: 12px; }
        .cart-item-price { color: var(--gold-dark); font-weight: 800; font-size: 14px; margin-bottom: 6px; }
        .cart-item-controls { display: flex; align-items: center; gap: 6px; }
        .qty-btn { width: 26px; height: 26px; border-radius: 6px; background: var(--white); color: var(--navy); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; border: 1px solid #ddd; transition: var(--transition); }
        .qty-btn:hover { background: var(--gold); color: var(--white); border-color: var(--gold); }
        .qty-value { font-weight: 700; min-width: 22px; text-align: center; font-size: 13px; }
        .remove-item { background: var(--error); color: var(--white); width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: auto; transition: var(--transition); font-size: 11px; }
        .remove-item:hover { background: #c82333; transform: scale(1.1); }
        .cart-footer { padding: 18px; background: var(--cream); border-top: 2px solid var(--gold-light); }
        .coupon-section { display: flex; gap: 8px; margin-bottom: 12px; }
        .coupon-input { flex: 1; padding: 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 13px; }
        .coupon-input:focus { border-color: var(--gold); }
        .apply-coupon-btn { padding: 10px 15px; background: var(--burgundy); color: var(--white); border-radius: 8px; font-weight: 600; font-size: 12px; }
        .points-section { margin-bottom: 12px; padding: 12px; background: linear-gradient(135deg, var(--burgundy), #a00030); border-radius: 10px; color: white; }
        .points-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .points-input-group { display: flex; gap: 8px; }
        .points-input { flex: 1; padding: 8px; border-radius: 6px; border: none; font-size: 13px; }
        .points-apply-btn { padding: 8px 15px; background: white; color: var(--burgundy); border: none; border-radius: 6px; font-weight: 700; font-size: 12px; cursor: pointer; }
        .points-info { font-size: 10px; margin-top: 6px; opacity: 0.9; }
        .cart-summary { margin-bottom: 15px; }
        .summary-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
        .summary-row.total { border-top: 2px solid var(--gold); padding-top: 10px; margin-top: 6px; font-size: 17px; font-weight: 800; color: var(--navy); }
        .summary-row.discount { color: var(--success); }
        .summary-row.points-discount { color: var(--info); }
        .summary-row.loyalty { color: var(--burgundy); }
        .checkout-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); border-radius: 10px; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); }
        .checkout-btn:hover { transform: scale(1.02); box-shadow: var(--shadow-gold); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: var(--transition); -webkit-overflow-scrolling: touch; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--white); border-radius: 18px; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: var(--transition); overscroll-behavior: contain; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal.large { max-width: 700px; }
        .modal-header { background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: var(--white); padding: 20px; text-align: center; position: relative; border-radius: 18px 18px 0 0; }
        .modal-header h2 { font-family: var(--font-display); font-size: 20px; margin-bottom: 4px; }
        .modal-header p { color: var(--gold-light); font-size: 12px; }
        .close-modal { position: absolute; top: 12px; left: 12px; background: rgba(255,255,255,0.1); color: var(--white); width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: var(--transition); }
        .close-modal:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        .modal-body { padding: 22px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px; font-size: 13px; }
        .form-group label .required { color: var(--error); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 11px 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: var(--transition); }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(212,175,55,0.1); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .submit-btn { width: 100%; padding: 13px; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); border-radius: 10px; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); margin-bottom: 10px; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-gold); }
        .auth-tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 18px; }
        .auth-tab { flex: 1; padding: 10px; text-align: center; font-weight: 600; color: #999; background: transparent; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: var(--transition); font-size: 13px; }
        .auth-tab.active { color: var(--gold-dark); border-bottom-color: var(--gold); }

        /* Order Tracking */
        .tracking-section { padding: 40px 20px; max-width: 800px; margin: 0 auto; }
        .tracking-card { background: var(--white); border-radius: 16px; padding: 25px; box-shadow: var(--shadow-md); }
        .tracking-header { text-align: center; margin-bottom: 25px; }
        .tracking-number { font-family: var(--font-display); font-size: 24px; color: var(--gold-dark); margin-bottom: 5px; }
        .tracking-date { font-size: 13px; color: #666; }
        .tracking-timeline { position: relative; padding-right: 30px; }
        .tracking-timeline::before { content: ''; position: absolute; right: 10px; top: 0; bottom: 0; width: 3px; background: #e0e0e0; }
        .tracking-step { position: relative; padding-bottom: 25px; padding-right: 40px; }
        .tracking-step:last-child { padding-bottom: 0; }
        .tracking-step::before { content: ''; position: absolute; right: 0; top: 0; width: 24px; height: 24px; border-radius: 50%; background: #e0e0e0; border: 3px solid var(--white); box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: center; z-index: 1; }
        .tracking-step.completed::before { background: var(--success); }
        .tracking-step.current::before { background: var(--gold); animation: pulse 2s infinite; }
        .tracking-step-icon { position: absolute; right: 4px; top: 4px; font-size: 10px; color: var(--white); z-index: 2; }
        .tracking-step-content h4 { font-size: 14px; color: var(--navy); margin-bottom: 3px; }
        .tracking-step-content p { font-size: 12px; color: #666; }
        .tracking-step-content .time { font-size: 11px; color: #999; margin-top: 3px; }

        /* Stats Section */
        .stats-section { background: linear-gradient(135deg, var(--navy), var(--navy-light)); padding: 45px 20px; margin: 30px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto; }
        .stat-card { text-align: center; color: var(--white); }
        .stat-icon { font-size: 38px; margin-bottom: 10px; }
        .stat-number { font-family: var(--font-display); font-size: 32px; font-weight: 700; color: var(--gold); margin-bottom: 3px; }
        .stat-label { font-size: 13px; color: var(--gold-light); }

        /* Coupons */
        .coupons-section { padding: 45px 20px; background: var(--cream); }
        .coupons-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 18px; max-width: 1000px; margin: 0 auto; }
        .coupon-card { background: linear-gradient(135deg, var(--burgundy), #a00030); border-radius: 14px; padding: 20px; color: var(--white); position: relative; overflow: hidden; }
        .coupon-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%); }
        .coupon-content { position: relative; z-index: 1; }
        .coupon-code { font-family: var(--font-display); font-size: 24px; font-weight: 700; margin-bottom: 6px; letter-spacing: 2px; }
        .coupon-desc { font-size: 12px; opacity: 0.9; margin-bottom: 12px; }
        .copy-coupon-btn { background: var(--white); color: var(--burgundy); padding: 8px 18px; border-radius: 18px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: var(--transition); font-size: 12px; }
        .copy-coupon-btn:hover { transform: scale(1.05); }

        /* Footer */
        .footer { background: linear-gradient(135deg, var(--navy), #050a15); color: var(--white); padding: 45px 20px 20px; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; max-width: 1000px; margin: 0 auto 30px; }
        .footer-section h3 { font-family: var(--font-display); font-size: 18px; color: var(--gold); margin-bottom: 15px; }
        .footer-section p, .footer-section li { font-size: 12px; color: var(--gold-light); line-height: 1.8; }
        .footer-section ul { list-style: none; }
        .footer-section li { margin-bottom: 6px; }
        .footer-section a { color: var(--gold-light); transition: var(--transition); }
        .footer-section a:hover { color: var(--gold); padding-right: 5px; }
        .footer-bottom { text-align: center; padding-top: 20px; border-top: 1px solid rgba(212,175,55,0.2); }
        .footer-bottom p { color: var(--gold-light); font-size: 12px; }

        /* Chat Widget */
        .chat-widget { position: fixed; bottom: 85px; left: 20px; z-index: 1500; }
        .chat-toggle { width: 55px; height: 55px; border-radius: 50%; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: var(--shadow-gold); transition: var(--transition); }
        .chat-toggle:hover { transform: scale(1.1); }
        .chat-box { position: absolute; bottom: 70px; left: 0; width: 320px; height: 420px; background: var(--white); border-radius: 16px; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; opacity: 0; visibility: hidden; transform: translateY(20px); transition: var(--transition); }
        .chat-box.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .chat-box-header { background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: var(--white); padding: 15px; border-radius: 16px 16px 0 0; display: flex; align-items: center; gap: 10px; }
        .chat-avatar { width: 38px; height: 38px; border-radius: 50%; background: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .chat-mode-toggle { margin-right: auto; display: inline-flex; gap: 6px; }
        .chat-mode-btn { border: 1px solid rgba(255,255,255,0.35); background: transparent; color: var(--white); border-radius: 999px; padding: 4px 10px; font-size: 10px; font-weight: 700; cursor: pointer; }
        .chat-mode-btn.active { background: var(--gold); border-color: var(--gold); color: var(--navy); }
        .chat-bot-info h4 { font-size: 14px; margin-bottom: 2px; }
        .chat-bot-info span { font-size: 10px; color: var(--gold-light); display: flex; align-items: center; gap: 4px; }
        .online-dot { width: 7px; height: 7px; background: var(--success); border-radius: 50%; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .chat-message { max-width: 85%; padding: 10px 12px; border-radius: 12px; font-size: 12px; line-height: 1.5; animation: fadeIn 0.3s ease; }
        .chat-message.bot { background: var(--cream); color: var(--navy); align-self: flex-start; border-bottom-right-radius: 4px; }
        .chat-message.user { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); align-self: flex-end; border-bottom-left-radius: 4px; }
        .chat-message.meta { background: #f2f4f8; color: #555; align-self: center; border-radius: 10px; font-size: 11px; }
        .chat-input-container { padding: 12px; border-top: 1px solid #eee; display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 20px; font-size: 12px; }
        .chat-input:focus { border-color: var(--gold); }
        .chat-send { width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); display: flex; align-items: center; justify-content: center; font-size: 14px; transition: var(--transition); }
        .chat-send:hover { transform: scale(1.1); }

        /* Floating Buttons */
        .floating-buttons { position: fixed; bottom: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .float-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--white); box-shadow: var(--shadow-md); transition: var(--transition); text-decoration: none; }
        .float-btn:hover { transform: scale(1.12); }
        .whatsapp-btn { background: linear-gradient(135deg, #25D366, #128C7E); }

        /* Notifications */
        .notifications-container { position: fixed; top: 15px; right: 15px; z-index: 5000; display: flex; flex-direction: column; gap: 8px; max-width: 340px; }
        .notification { background: var(--white); padding: 12px 15px; border-radius: 10px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 10px; animation: slideIn 0.4s ease; border-right: 4px solid; }
        .notification.success { border-right-color: var(--success); }
        .notification.error { border-right-color: var(--error); }
        .notification.warning { border-right-color: var(--warning); }
        .notification.info { border-right-color: var(--info); }
        .notification-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--white); flex-shrink: 0; }
        .notification.success .notification-icon { background: var(--success); }
        .notification.error .notification-icon { background: var(--error); }
        .notification.warning .notification-icon { background: var(--warning); }
        .notification.info .notification-icon { background: var(--info); }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 700; font-size: 12px; color: var(--navy); }
        .notification-message { font-size: 11px; color: #666; }
        .notification-close { background: transparent; color: #999; font-size: 14px; padding: 5px; }

        /* Favorites Sidebar */
        .fav-sidebar { position: fixed; top: 0; right: -100%; width: 100%; max-width: 380px; height: 100%; background: var(--white); z-index: 2001; transition: var(--transition); display: flex; flex-direction: column; }
        .fav-sidebar.active { right: 0; }
        .fav-header { background: linear-gradient(135deg, var(--error), #c0392b); color: var(--white); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .fav-header h2 { font-family: var(--font-display); font-size: 20px; }
        .fav-items { flex: 1; overflow-y: auto; padding: 15px; }
        .fav-empty { text-align: center; padding: 40px 20px; color: #999; }
        .fav-item { display: flex; gap: 12px; padding: 12px; background: var(--cream); border-radius: 10px; margin-bottom: 10px; align-items: center; }
        .fav-item-image { width: 60px; height: 60px; border-radius: 8px; overflow: hidden; }
        .fav-item-image img { width: 100%; height: 100%; object-fit: cover; }
        .fav-item-details { flex: 1; }
        .fav-item-name { font-weight: 700; font-size: 13px; color: var(--navy); margin-bottom: 3px; }
        .fav-item-price { color: var(--gold-dark); font-weight: 700; font-size: 14px; }
        .fav-item-actions { display: flex; flex-direction: column; gap: 6px; }
        .fav-add-btn { padding: 8px 12px; background: var(--gold); color: var(--white); border-radius: 6px; font-size: 11px; font-weight: 600; }
        .fav-remove-btn { padding: 8px 12px; background: var(--error); color: var(--white); border-radius: 6px; font-size: 11px; }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar { gap: 8px; }
            .nav-actions { width: 100%; justify-content: space-between; }
            .nav-btn { padding: 10px 14px; font-size: 12px; }
            .logo { font-size: 32px; }
            .tagline { font-size: 11px; }
            .navbar { padding: 10px 12px; }
            .search-box { order: 3; flex: 0 0 100%; max-width: 100%; }
            .nav-btn span { display: none; }
            .loyalty-badge span:last-child { display: none; }
            .cart-sidebar, .fav-sidebar { max-width: 100%; }
            .products-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
            .product-image { height: 160px; }
            .product-name { font-size: 13px; }
            .section-title h2 { font-size: 24px; }
            .banner-title { font-size: 24px; }
            .banner-text { font-size: 14px; }
            .chat-box { width: calc(100vw - 40px); max-width: 320px; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .modal-overlay { align-items: flex-end; padding: 10px; }
            .modal { max-width: 100%; max-height: 92dvh; border-radius: 16px; }
            .modal-body { padding: 16px; }
            .close-modal { top: 10px; left: 10px; }
        }
        @media (max-width: 480px) {
            .top-bar { font-size: 12px; gap: 8px; }
            .banner-slide { padding: 40px 16px; }
            .categories-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
            .category-card { padding: 15px 8px; }
            .category-icon { width: 45px; height: 45px; font-size: 22px; }
            .category-name { font-size: 11px; }
            .products-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-number { font-size: 26px; }
            .modal-header h2 { font-size: 18px; }
            .modal-body { padding: 14px; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">🛍️</div>
        <div class="loading-text" id="loadingStoreName">Sale Zone Store</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Notifications -->
    <div class="notifications-container" id="notificationsContainer"></div>

    <!-- Top Bar -->
    <div class="top-bar" id="topBar">
        <div class="top-bar-marquee">
            <span id="topBarText">🎉 خصومات حصرية تصل إلى 50%! | 🚚 توصيل مجاني للطلبات أكثر من 500 ج.م</span>
        </div>
        <div class="top-bar-contact">
            <a href="tel:01018108979" id="topBarPhone">📞 01018108979</a>
            <a href="#" id="topBarWhatsapp" target="_blank">💬 واتساب</a>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="logo" id="storeLogo">Sale Zone Store</h1>
            <p class="tagline" id="storeTagline">التسوق الفاخر الذكي</p>
            <div class="header-divider"></div>
        </div>
    </header>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ابحث عن منتج...">
            <button onclick="searchProducts()">🔍</button>
        </div>
        <div class="nav-actions">
            <div class="loyalty-badge">
                <span>⭐</span>
                <span id="loyaltyPoints">0</span>
                <span>نقطة</span>
            </div>
            <button class="nav-btn" onclick="toggleFavorites()">
                ❤️ <span>المفضلة</span>
                <div class="fav-count" id="favCount">0</div>
            </button>
            <button class="nav-btn cart-btn" onclick="toggleCart()">
                🛒 <span>السلة</span>
                <div class="cart-count" id="cartCount">0</div>
            </button>
            <div class="user-menu">
                <button class="user-btn" id="userBtn">👤</button>
                <div class="user-dropdown">
                    <div id="guestMenu">
                        <button onclick="showAuthModal('login')">🔐 تسجيل الدخول</button>
                        <button onclick="showAuthModal('register')">📝 إنشاء حساب</button>
                    </div>
                    <div id="userMenu" class="hidden">
                        <a href="#" onclick="showProfile()">👤 حسابي</a>
                        <a href="#" onclick="showMyOrders()">📦 طلباتي</a>
                        <a href="#" onclick="showOrderTracking()">🚚 تتبع طلبي</a>
                        <a href="#" onclick="showChangePassword()">🔑 تغيير كلمة المرور</a>
                        <button onclick="logout()">🚪 تسجيل الخروج</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Banner Slider -->
    <section class="banner-section">
        <div class="banner-slider" id="bannerSlider">
            <!-- Banners will be loaded here -->
        </div>
        <div class="banner-dots" id="bannerDots"></div>
        <div class="banner-arrow prev" onclick="prevBanner()">❮</div>
        <div class="banner-arrow next" onclick="nextBanner()">❯</div>
    </section>

    <!-- Categories -->
    <section class="categories-section">
        <div class="section-title">
            <h2>تسوق حسب القسم</h2>
            <div class="line"></div>
        </div>
        <div class="categories-grid" id="categoriesGrid">
            <div class="category-card active" data-category="all" onclick="filterByCategory('all')">
                <div class="category-icon">🛍️</div>
                <div class="category-name">الكل</div>
                <div class="category-count" id="countAll">0</div>
            </div>
            <div class="category-card" data-category="hair-care" onclick="filterByCategory('hair-care')">
                <div class="category-icon">💇‍♀️</div>
                <div class="category-name">الشعر</div>
                <div class="category-count" id="countHair">0</div>
            </div>
            <div class="category-card" data-category="skin-care" onclick="filterByCategory('skin-care')">
                <div class="category-icon">🧴</div>
                <div class="category-name">البشرة</div>
                <div class="category-count" id="countSkin">0</div>
            </div>
            <div class="category-card" data-category="baby-care" onclick="filterByCategory('baby-care')">
                <div class="category-icon">👶</div>
                <div class="category-name">الطفل</div>
                <div class="category-count" id="countBaby">0</div>
            </div>
            <div class="category-card" data-category="supplements" onclick="filterByCategory('supplements')">
                <div class="category-icon">💊</div>
                <div class="category-name">المكملات</div>
                <div class="category-count" id="countSupplements">0</div>
            </div>
            <div class="category-card" data-category="medical" onclick="filterByCategory('medical')">
                <div class="category-icon">🏥</div>
                <div class="category-name">الطبي</div>
                <div class="category-count" id="countMedical">0</div>
            </div>
        </div>
    </section>

    <!-- Products -->
    <section class="products-section">
        <div class="products-header">
            <div class="section-title" style="margin-bottom: 0;">
                <h2 id="productsTitle">جميع المنتجات</h2>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <label>ترتيب:</label>
                <select class="filter-select" id="sortSelect" onchange="sortProducts(this.value)">
                    <option value="default">الافتراضي</option>
                    <option value="price-low">السعر: الأقل</option>
                    <option value="price-high">السعر: الأعلى</option>
                    <option value="rating">التقييم</option>
                    <option value="name">الاسم</option>
                </select>
            </div>
            <div class="filter-group">
                <label>المورد:</label>
                <select class="filter-select" id="supplierFilter" onchange="applyAdvancedFilters()">
                    <option value="">الكل</option>
                </select>
            </div>
            <div class="filter-group">
                <label style="display:flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="inStockOnly" onchange="applyAdvancedFilters()">
                    متاح فقط
                </label>
            </div>
            <div class="filter-group price-range">
                <label>السعر:</label>
                <input type="number" class="price-input" id="minPrice" placeholder="من" onchange="filterByPrice()">
                <span>-</span>
                <input type="number" class="price-input" id="maxPrice" placeholder="إلى" onchange="filterByPrice()">
            </div>
            <div class="filter-group">
                <button class="filter-btn" onclick="resetFilters()">🔄 إعادة تعيين</button>
            </div>
        </div>
        
        <div class="products-grid" id="productsGrid"></div>
        <div id="productsPagination" style="display:flex;justify-content:center;gap:8px;margin-top:20px;flex-wrap:wrap;"></div>
    </section>

    <!-- Stats -->
    <section class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">📦</div>
                <div class="stat-number" id="statsProducts">0</div>
                <div class="stat-label">منتج</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🛍️</div>
                <div class="stat-number" id="statsOrders">0</div>
                <div class="stat-label">طلب</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⭐</div>
                <div class="stat-number" id="statsRating">4.8</div>
                <div class="stat-label">تقييم</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-number" id="statsUsers">0</div>
                <div class="stat-label">عميل</div>
            </div>
        </div>
    </section>

    <!-- Coupons -->
    <section class="coupons-section">
        <div class="section-title">
            <h2>كوبونات الخصم</h2>
            <div class="line"></div>
        </div>
        <div class="coupons-grid" id="couponsGrid"></div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-grid">
            <div class="footer-section">
                <h3>عن المتجر</h3>
                <p id="footerAbout">Sale Zone Store - وجهتك الأولى للتسوق الفاخر والذكي.</p>
            </div>
            <div class="footer-section">
                <h3>روابط سريعة</h3>
                <ul>
                    <li><a href="#" onclick="filterByCategory('all')">جميع المنتجات</a></li>
                    <li><a href="#" onclick="toggleCart()">سلة التسوق</a></li>
                    <li><a href="#" onclick="showOrderTracking()">تتبع طلبي</a></li>
                    <li><a href="#" onclick="showAuthModal('login')">تسجيل الدخول</a></li>
                    <li><a href="ادمن_2.HTML" target="_blank">🔐 لوحة التحكم</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>تواصل معنا</h3>
                <ul>
                    <li>📞 <span id="footerPhone">01018108979</span></li>
                    <li>💬 <span id="footerWhatsapp">01018108979</span></li>
                    <li>📧 <span id="footerEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b5dcdbd3daf5c6d4d9d0cfdadbd09bd6dad8">[email&#160;protected]</a></span></li>
                    <li>📍 <span id="footerAddress">مصر</span></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>ساعات العمل</h3>
                <ul>
                    <li id="hoursWeekdays">السبت - الخميس: 9 ص - 10 م</li>
                    <li id="hoursFriday">الجمعة: 2 م - 10 م</li>
                    <li id="hoursNote">🔔 خدمة 24/7</li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p id="footerCopyright">© 2026 Sale Zone Store ❤️</p>
        </div>
    </footer>

    <!-- Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h2>🛒 سلة التسوق</h2>
            <button class="close-cart" onclick="toggleCart()">✕</button>
        </div>
        <div class="cart-items" id="cartItems">
            <div class="cart-empty">
                <div class="cart-empty-icon">🛒</div>
                <p>السلة فارغة</p>
            </div>
        </div>
        <div class="cart-footer">
            <div class="coupon-section">
                <input type="text" class="coupon-input" id="couponInput" placeholder="كود الخصم">
                <button class="apply-coupon-btn" onclick="applyCoupon()">تطبيق</button>
            </div>
            <div class="points-section hidden" id="pointsSection">
                <div class="points-header">
                    <span>💎 نقاطك:</span>
                    <strong id="availablePoints">0</strong>
                </div>
                <div class="points-input-group">
                    <input type="number" class="points-input" id="pointsToUse" placeholder="عدد النقاط">
                    <button class="points-apply-btn" onclick="applyPoints()">استبدال</button>
                </div>
                <div class="points-info" id="pointsInfo">كل 10 نقاط = 1 ج.م</div>
            </div>
            <div class="cart-summary">
                <div class="summary-row">
                    <span>المجموع:</span>
                    <span id="subtotal">0 ج.م</span>
                </div>
                <div class="summary-row discount hidden" id="discountRow">
                    <span>خصم الكوبون:</span>
                    <span id="discountAmount">- 0 ج.م</span>
                </div>
                <div class="summary-row points-discount hidden" id="pointsDiscountRow">
                    <span>خصم النقاط:</span>
                    <span id="pointsDiscountAmount">- 0 ج.م</span>
                </div>
                <div class="summary-row loyalty">
                    <span>نقاط ستكتسب:</span>
                    <span id="earnedPoints">0</span>
                </div>
                <div class="summary-row total">
                    <span>الإجمالي:</span>
                    <span id="totalAmount">0 ج.م</span>
                </div>
            </div>
            <button class="checkout-btn" onclick="showCheckout()">إتمام الطلب ✓</button>
        </div>
    </div>

    <!-- Favorites Sidebar -->
    <div class="cart-overlay" id="favOverlay" onclick="toggleFavorites()"></div>
    <div class="fav-sidebar" id="favSidebar">
        <div class="fav-header">
            <h2>❤️ المفضلة</h2>
            <button class="close-cart" onclick="toggleFavorites()">✕</button>
        </div>
        <div class="fav-items" id="favItems">
            <div class="fav-empty">
                <div class="cart-empty-icon">❤️</div>
                <p>لا توجد منتجات مفضلة</p>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal('authModal')">✕</button>
                <h2 id="authModalTitle">تسجيل الدخول</h2>
                <p>مرحباً بك</p>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">دخول</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">تسجيل</button>
                </div>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>📧 البريد الإلكتروني <span class="required">*</span></label>
                        <input type="email" id="loginIdentifier" required placeholder="user@email.com">
                    </div>
                    <div class="form-group">
                        <label>🔐 كلمة المرور <span class="required">*</span></label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="submit-btn">دخول 🔓</button>
                </form>
                <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>👤 الاسم <span class="required">*</span></label>
                        <input type="text" id="registerName" required>
                    </div>
                    <div class="form-group">
                        <label>📱 الهاتف <span class="required">*</span></label>
                        <input type="tel" id="registerPhone" required placeholder="01xxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label>📧 الإيميل <span class="required">*</span></label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>📍 العنوان <span class="required">*</span></label>
                        <textarea id="registerAddress" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>🔐 كلمة المرور <span class="required">*</span></label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label>🔐 تأكيد كلمة المرور <span class="required">*</span></label>
                        <input type="password" id="registerPasswordConfirm" required>
                    </div>
                    <button type="submit" class="submit-btn">إنشاء حساب ✓</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal('checkoutModal')">✕</button>
                <h2>إتمام الطلب</h2>
                <p>بيانات التوصيل</p>
            </div>
            <div class="modal-body">
                <form id="checkoutForm" onsubmit="handleCheckout(event)">
                    <div class="form-group">
                        <label>👤 الاسم <span class="required">*</span></label>
                        <input type="text" id="checkoutName" required>
                    </div>
                    <div class="form-group">
                        <label>📱 الهاتف <span class="required">*</span></label>
                        <input type="tel" id="checkoutPhone" required>
                    </div>
                    <div class="form-group">
                        <label>📍 العنوان <span class="required">*</span></label>
                        <textarea id="checkoutAddress" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>📝 ملاحظات</label>
                        <textarea id="checkoutNotes"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">تأكيد الطلب 📦</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Tracking Modal -->
    <div class="modal-overlay" id="trackingModal">
        <div class="modal large">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal('trackingModal')">✕</button>
                <h2>🚚 تتبع الطلب</h2>
            </div>
            <div class="modal-body" id="trackingModalBody">
                <div class="form-group">
                    <label>أدخل رقم الطلب</label>
                    <input type="text" id="trackOrderNumber" placeholder="SZ-XXXXXXXX">
                </div>
                <button class="submit-btn" onclick="trackOrder()">تتبع 🔍</button>
                <div id="trackingResult" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal large">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal('productModal')">✕</button>
                <h2>تفاصيل المنتج</h2>
            </div>
            <div class="modal-body" id="productModalBody"></div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal('passwordModal')">✕</button>
                <h2>تغيير كلمة المرور</h2>
            </div>
            <div class="modal-body">
                <form onsubmit="handleChangePassword(event)">
                    <div class="form-group">
                        <label>🔐 الحالية <span class="required">*</span></label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label>🔐 الجديدة <span class="required">*</span></label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label>🔐 تأكيد <span class="required">*</span></label>
                        <input type="password" id="confirmNewPassword" required>
                    </div>
                    <button type="submit" class="submit-btn">تغيير 🔑</button>
                </form>
            </div>
        </div>
    </div>

    <!-- My Orders Modal -->
    <div class="modal-overlay" id="ordersModal">
        <div class="modal large">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal('ordersModal')">✕</button>
                <h2>📦 طلباتي</h2>
            </div>
            <div class="modal-body" id="ordersModalBody"></div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal-overlay" id="ratingModal">
        <div class="modal">
            <div class="modal-header">
                <button class="close-modal" onclick="closeModal('ratingModal')">✕</button>
                <h2>⭐ تقييم المنتج</h2>
            </div>
            <div class="modal-body" id="ratingModalBody"></div>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <button class="chat-toggle" onclick="toggleChat()">🤖</button>
        <div class="chat-box" id="chatBox">
            <div class="chat-box-header">
                <div class="chat-avatar">🤖</div>
                <div class="chat-bot-info">
                    <h4>مساعد Sale Zone</h4>
                    <span id="chatStatusText"><span class="online-dot"></span> وضع FAQ</span>
                </div>
                <div class="chat-mode-toggle">
                    <button type="button" class="chat-mode-btn active" id="chatModeBotBtn" onclick="switchChatMode('bot')">FAQ</button>
                    <button type="button" class="chat-mode-btn" id="chatModeSupportBtn" onclick="switchChatMode('support')">دعم</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message bot">مرحباً! كيف أساعدك؟ 😊</div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="اكتب..." onkeypress="if(event.key==='Enter')sendChatMessage()">
                <button class="chat-send" onclick="sendChatMessage()">➤</button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <div class="floating-buttons">
        <a href="#" id="floatWhatsapp" target="_blank" class="float-btn whatsapp-btn">💬</a>
    </div>
    <script data-cfasync="false">
        // Cloudflare email decode script removed - not available on GitHub Pages
    </script><script>
        // ============================================
        // 🗄️ Data Store
        // ============================================
        let products = [];
        let cart = [];
        let favorites = [];
        let orders = [];
        let coupons = [];
        let banners = [];
        let users = [];
        let suppliers = [];
        let currentUser = null;
        let appliedCoupon = null;
        let usedPoints = 0;
        let pointsDiscount = 0;
        let currentCategory = 'all';
        let currentSearchQuery = '';
        let currentSearchPage = 1;
        const PAGE_SIZE = 24;
        let lastSearchResult = { items: [], total: 0, page: 1, pageSize: PAGE_SIZE, totalPages: 1 };
        let searchWorker = null;
        let searchWorkerReady = false;
        let searchRequestCounter = 0;
        const pendingSearchResolvers = new Map();
        let searchDebounceTimer = null;
        let currentBanner = 0;
        let bannerInterval;
        let liveSessionHeartbeatTimer = null;
        let authSubmitLock = false;
        let chatMode = 'bot';
        let activeSupportThread = null;
        let supportThreadUnsubscribe = null;
        let supportMessagesUnsubscribe = null;
        let supportRealtimeConnected = false;
        let supportAccess = {
            denied: false,
            reason: '',
            source: '',
            notifiedReason: ''
        };
        const SUPPORT_CHAT_MESSAGES_LIMIT = 150;
        const recentStoreEventLog = Object.create(null);
        const STORE_EVENT_THROTTLE_MS = {
            STORE_BOOT: 30000,
            STORE_DATA_SYNC: 15000
        };
        const LIVE_SESSION_HEARTBEAT_MS = 45000;
        const STORE_SESSION_KEY = 'sale_zone_live_session_id';
        const STORE_SESSION_ID = (() => {
            let existing = '';
            try { existing = sessionStorage.getItem(STORE_SESSION_KEY) || ''; } catch (_) {}
            if (existing) return existing;
            const id = `sess_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;
            try { sessionStorage.setItem(STORE_SESSION_KEY, id); } catch (_) {}
            return id;
        })();

        let storeSettings = {
            name: 'Sale Zone Store',
            tagline: 'التسوق الفاخر الذكي',
            description: '',
            whatsappNumber: '01018108979',
            topBar: { enabled: true, text: '🎉 خصومات حصرية!', bgColor: '#0A1128', textColor: '#F4E4BC' },
            contact: { phone: '01018108979', whatsapp: '01018108979', email: 'info@salezone.com', address: 'مصر' },
            footer: { about: '', workingHoursWeekdays: 'السبت - الخميس: 9 ص - 10 م', workingHoursFriday: 'الجمعة: 2 م - 10 م', workingHoursNote: '🔔 خدمة 24/7', copyright: '© 2026 Sale Zone Store ❤️' },
            loyalty: { rate: 5, pointValue: 0.1 },
            customCategories: [],
            faqIntents: [],
            chatSupport: { enableTawk: false, tawkPropertyId: '', tawkWidgetId: '' }
        };

        const defaultProducts = [
            { id: 1, name: 'شامبو كيراتين فاخر', desc: 'شامبو احترافي بالكيراتين لتنعيم الشعر', price: 189, oldPrice: 249, image: './assets/placeholder.svg', category: 'hair-care', rating: 4.8, ratingCount: 124, ratings: [] },
            { id: 2, name: 'سيروم فيتامين C', desc: 'سيروم مضاد للأكسدة للبشرة المشرقة', price: 220, oldPrice: 280, image: './assets/placeholder.svg', category: 'skin-care', rating: 4.8, ratingCount: 198, ratings: [] },
            { id: 3, name: 'زيت جوز الهند', desc: 'زيت طبيعي 100% للشعر', price: 120, oldPrice: 150, image: './assets/placeholder.svg', category: 'hair-care', rating: 4.9, ratingCount: 203, ratings: [] },
            { id: 4, name: 'كريم الترطيب المكثف', desc: 'كريم مرطب بحمض الهيالورونيك', price: 320, oldPrice: 400, image: './assets/placeholder.svg', category: 'skin-care', rating: 4.7, ratingCount: 156, ratings: [] },
            { id: 5, name: 'غسول الوجه اللطيف', desc: 'غسول رغوي للتنظيف العميق', price: 150, oldPrice: 180, image: './assets/placeholder.svg', category: 'skin-care', rating: 4.5, ratingCount: 87, ratings: [] },
            { id: 6, name: 'شامبو أطفال', desc: 'شامبو لطيف بدون دموع', price: 85, oldPrice: 110, image: './assets/placeholder.svg', category: 'baby-care', rating: 4.9, ratingCount: 245, ratings: [] },
            { id: 7, name: 'كريم حفاضات', desc: 'كريم واقي ومهدئ', price: 95, oldPrice: 120, image: './assets/placeholder.svg', category: 'baby-care', rating: 4.7, ratingCount: 167, ratings: [] },
            { id: 8, name: 'لوشن ترطيب الأطفال', desc: 'لوشن مرطب يومي', price: 75, oldPrice: 95, image: './assets/placeholder.svg', category: 'baby-care', rating: 4.8, ratingCount: 132, ratings: [] },
            { id: 9, name: 'فيتامين د3', desc: 'مكمل فيتامين د3 - 60 كبسولة', price: 220, oldPrice: 280, image: './assets/placeholder.svg', category: 'supplements', rating: 4.8, ratingCount: 312, ratings: [] },
            { id: 10, name: 'أوميغا 3', desc: 'زيت السمك - 90 كبسولة', price: 350, oldPrice: 420, image: './assets/placeholder.svg', category: 'supplements', rating: 4.7, ratingCount: 189, ratings: [] },
            { id: 11, name: 'مالتي فيتامين', desc: 'فيتامينات شاملة - 30 قرص', price: 180, oldPrice: 230, image: './assets/placeholder.svg', category: 'supplements', rating: 4.6, ratingCount: 256, ratings: [] },
            { id: 12, name: 'جهاز قياس الضغط', desc: 'جهاز رقمي دقيق', price: 450, oldPrice: 600, image: './assets/placeholder.svg', category: 'medical', rating: 4.9, ratingCount: 178, ratings: [] },
            { id: 13, name: 'جهاز قياس السكر', desc: 'جهاز + 50 شريط', price: 380, oldPrice: 480, image: './assets/placeholder.svg', category: 'medical', rating: 4.8, ratingCount: 234, ratings: [] },
            { id: 14, name: 'ترمومتر رقمي', desc: 'قياس الحرارة عن بُعد', price: 280, oldPrice: 350, image: './assets/placeholder.svg', category: 'medical', rating: 4.7, ratingCount: 145, ratings: [] }
        ];

        const defaultCoupons = [
            { id: 1, code: 'WELCOME20', desc: 'خصم 20% للعملاء الجدد', type: 'percentage', value: 20 },
            { id: 2, code: 'SAVE50', desc: 'خصم 50 جنيه', type: 'fixed', value: 50 },
            { id: 3, code: 'HEALTH15', desc: 'خصم 15%', type: 'percentage', value: 15 }
        ];

        const defaultBanners = [
            { id: 1, icon: '🎉', title: 'خصومات تصل إلى 50%', text: 'على جميع منتجات العناية بالبشرة', btn: 'تسوق الآن', category: 'skin-care' },
            { id: 2, icon: '🚚', title: 'توصيل مجاني', text: 'للطلبات أكثر من 500 جنيه', btn: 'اطلب الآن', category: 'all' },
            { id: 3, icon: '💎', title: 'نقاط الولاء', text: 'اجمع نقاط واستبدلها بخصومات', btn: 'سجل الآن', category: 'all' }
        ];

        // For emergency/dev only: add ?seed=1 to allow local demo defaults.
        const allowLocalSeedDefaults = new URLSearchParams(window.location.search).get('seed') === '1';

        function isSeedProduct(p) {
            const seedNames = new Set([
                'شامبو كيراتين فاخر', 'سيروم فيتامين C', 'زيت جوز الهند', 'كريم الترطيب المكثف',
                'غسول الوجه اللطيف', 'شامبو أطفال', 'كريم حفاضات', 'لوشن ترطيب الأطفال',
                'فيتامين د3', 'أوميغا 3', 'مالتي فيتامين', 'جهاز قياس الضغط',
                'جهاز قياس السكر', 'ترمومتر رقمي'
            ]);
            const name = String(p?.name || '').trim();
            const image = String(p?.image || '').trim();
            return seedNames.has(name) && /placeholder\.svg$/i.test(image);
        }

        function removeSeedDataIfNeeded() {
            if (allowLocalSeedDefaults) return;
            products = (products || []).filter(p => !isSeedProduct(p));
            coupons = (coupons || []).filter(c => !['WELCOME20', 'SAVE50', 'HEALTH15'].includes(String(c?.code || '').toUpperCase()));
            banners = (banners || []).filter(b => !['خصومات تصل إلى 50%', 'توصيل مجاني', 'نقاط الولاء'].includes(String(b?.title || '').trim()));
        }

        function normalizeStoreProduct(product) {
            const source = product && typeof product === 'object' ? product : {};
            const price = Number(source.price);
            const oldPrice = Number(source.oldPrice);
            const rating = Number(source.rating);
            const ratingCount = Number(source.ratingCount);
            const isPublished = source.isPublished !== false;
            const costPrice = Number.isFinite(Number(source.costPrice)) ? Number(source.costPrice) : (Number.isFinite(price) ? price : 0);
            const marginPercent = Number.isFinite(Number(source.marginPercent)) ? Number(source.marginPercent) : 0;
            const sellPrice = Number.isFinite(Number(source.sellPrice)) ? Number(source.sellPrice) : (Number.isFinite(price) ? price : 0);
            const profitValue = Number.isFinite(Number(source.profitValue)) ? Number(source.profitValue) : Number((sellPrice - costPrice).toFixed(2));
            const profitMarginActual = Number.isFinite(Number(source.profitMarginActual))
                ? Number(source.profitMarginActual)
                : (sellPrice > 0 ? Number(((profitValue / sellPrice) * 100).toFixed(2)) : 0);

            return {
                ...source,
                id: source.id != null ? String(source.id) : '',
                name: String(source.name || '').trim(),
                desc: String(source.desc || ''),
                category: String(source.category || 'supplements'),
                price: Number.isFinite(price) ? price : 0,
                oldPrice: Number.isFinite(oldPrice) ? oldPrice : null,
                image: String(source.image || './assets/placeholder.svg'),
                rating: Number.isFinite(rating) ? rating : 4.5,
                ratingCount: Number.isFinite(ratingCount) ? ratingCount : 0,
                supplierId: String(source.supplierId || ''),
                supplierName: String(source.supplierName || ''),
                supplierCode: String(source.supplierCode || ''),
                costPrice,
                marginPercent,
                sellPrice,
                profitValue,
                profitMarginActual,
                manualPriceOverride: source.manualPriceOverride === true,
                manualPriceReason: String(source.manualPriceReason || ''),
                searchTokens: Array.isArray(source.searchTokens) ? source.searchTokens : [],
                isPublished,
                visibilityState: isPublished ? 'published' : 'hidden'
            };
        }

        function normalizeStoreProducts(list) {
            return (Array.isArray(list) ? list : [])
                .map(normalizeStoreProduct)
                .filter((item) => item.name && item.price >= 0);
        }

        function getVisibleProductsList() {
            return (products || []).filter((p) => p && p.isPublished !== false);
        }

        // ============================================
        // 🚀 Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            setupAutoTooltips();
            setChatStatus('وضع FAQ', true);
            // ?? Minimal client-side error capture for mobile debugging
            window.__errors = window.__errors || [];
            window.onerror = function(message, source, lineno, colno, error) {
                window.__errors.push({
                    type: 'error',
                    message: String(message || ''),
                    source: String(source || ''),
                    line: lineno || 0,
                    col: colno || 0,
                    stack: error && error.stack ? String(error.stack) : ''
                });
            };
            window.onunhandledrejection = function(event) {
                const reason = event && event.reason ? event.reason : '';
                window.__errors.push({
                    type: 'unhandledrejection',
                    message: String(reason && reason.message ? reason.message : reason),
                    stack: reason && reason.stack ? String(reason.stack) : ''
                });
            };
            const checkAppVersionAndRefresh = async () => {
                try {
                    const res = await fetch(`./version.json?t=${Date.now()}`, { cache: 'no-store' });
                    if (!res.ok) return;
                    const data = await res.json();
                    const incomingVersion = String(data?.version || '').trim();
                    if (!incomingVersion) return;

                    const storageKey = 'salezone_app_version';
                    const currentVersion = localStorage.getItem(storageKey);
                    if (!currentVersion) {
                        localStorage.setItem(storageKey, incomingVersion);
                        return;
                    }
                    if (currentVersion !== incomingVersion) {
                        localStorage.setItem(storageKey, incomingVersion);
                        // Hard refresh on version change: clear SW caches + stale synced data.
                        try {
                            ['sale_zone_products', 'sale_zone_coupons', 'sale_zone_banners', 'sale_zone_settings', 'sale_zone_last_update', 'sale_zone_orders']
                                .forEach((k) => localStorage.removeItem(k));
                        } catch (_) {}
                        try {
                            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
                            }
                        } catch (_) {}
                        window.location.reload();
                    }
                } catch (_) {}
            };

            window.addEventListener('pageshow', (event) => {
                if (event.persisted) {
                    window.location.reload();
                }
            });

            checkAppVersionAndRefresh();
            // Periodic version check to keep mobile/PWA clients aligned without manual cache clearing.
            setInterval(checkAppVersionAndRefresh, 10 * 60 * 1000);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') checkAppVersionAndRefresh();
            });
            startLiveSessionHeartbeat();
            trackStoreEvent('STORE_BOOT', 'Store boot sequence started', 'info');
            const safeRun = (label, fn) => {
                try { fn(); }
                catch (err) {
                    console.error(`? ${label} failed`, err);
                    window.__errors.push({
                        type: 'boot',
                        message: `${label} failed`,
                        stack: err && err.stack ? String(err.stack) : String(err)
                    });
                }
            };
            // 🔧 DOM Element Safety Checks
            const criticalElements = ['bannerSlider', 'bannerDots', 'productsGrid', 'cartCount', 'loadingScreen'];
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`⚠️ Missing element: ${id}`);
                }
            });

            // ? Fast boot render with defaults (never block UI)
            safeRun('applyStoreSettings', applyStoreSettings);
            safeRun('maybeLoadTawkWidget', maybeLoadTawkWidget);
            safeRun('renderBanners', renderBanners);
            safeRun('renderSupplierFilters', renderSupplierFilters);
            safeRun('buildSearchIndexAsync', buildSearchIndexAsync);
            safeRun('runProductSearch', () => runProductSearch(1));
            safeRun('renderCoupons', renderCoupons);
            safeRun('updateCategoryCounts', updateCategoryCounts);
            safeRun('updateStats', updateStats);
            safeRun('updateCartUI', updateCartUI);
            safeRun('updateFavUI', updateFavUI);
            safeRun('checkLoggedInUser', checkLoggedInUser);
            safeRun('startBannerSlider', startBannerSlider);

            // 🛡️ Safe loading screen hide
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                }, 1000);

                // ⏱️ Auto-fallback: never keep the loading screen forever
                setTimeout(() => {
                    if (!loadingScreen.classList.contains('hidden')) {
                        loadingScreen.classList.add('hidden');
                        showToast('تم تجاوز شاشة التحميل تلقائيًا. إذا استمر الخطأ أخبرنا.', 'warning');
                    }
                }, 6000);
            }

            // ?? Load data with timeout, then re-render safely
            safeRun('loadDataWithTimeout', () => {
                loadDataWithTimeout(25000).then(() => {
                    safeRun('applyStoreSettings', applyStoreSettings);
                    safeRun('maybeLoadTawkWidget', maybeLoadTawkWidget);
                    safeRun('renderBanners', renderBanners);
                    safeRun('renderSupplierFilters', renderSupplierFilters);
                    safeRun('buildSearchIndexAsync', buildSearchIndexAsync);
                    safeRun('runProductSearch', () => runProductSearch(1));
                    safeRun('renderCoupons', renderCoupons);
                    safeRun('updateCategoryCounts', updateCategoryCounts);
                    safeRun('updateStats', updateStats);
                    safeRun('updateCartUI', updateCartUI);
                    safeRun('updateFavUI', updateFavUI);
                });
            });

            // 📱 Register Professional ServiceWorker for PWA (Auto Update)
            if ('serviceWorker' in navigator) {
                const swHost = (window.location && window.location.hostname) || '';
                const isLocalDevHost = /^(localhost|127(?:\.\d{1,3}){3}|0\.0\.0\.0|::1|\[::1\]|10(?:\.\d{1,3}){3}|192\.168(?:\.\d{1,3}){2}|172\.(1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})$/i.test(swHost) || swHost.endsWith('.local');
                const disableServiceWorker = isLocalDevHost || new URLSearchParams(window.location.search).get('nosw') === '1';

                if (disableServiceWorker) {
                    navigator.serviceWorker.getRegistrations()
                        .then(registrations => Promise.all(registrations.map(reg => reg.unregister())))
                        .then(() => {
                            console.log('Local dev mode - ServiceWorker disabled to prevent stale cache');
                        })
                        .catch(() => undefined);
                } else {
                    let swRefreshing = false;
                    const requestRefresh = () => {
                        if (swRefreshing) return;
                        swRefreshing = true;
                        window.location.reload();
                    };

                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        requestRefresh();
                    });

                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'SW_UPDATED' && navigator.serviceWorker.controller) {
                            requestRefresh();
                        }
                    });

                    navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                        .then(registration => {
                            console.log('✅ Professional ServiceWorker registered:', registration.scope);
                            console.log('🚀 PWA Features Enabled');

                            const updateNow = () => registration.update().catch(() => undefined);
                            updateNow();
                            setInterval(updateNow, 60 * 60 * 1000);
                            document.addEventListener('visibilitychange', () => {
                                if (document.visibilityState === 'visible') updateNow();
                            });

                            if (registration.waiting) {
                                registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            }

                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                if (!newWorker) return;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed') {
                                        if (registration.waiting) {
                                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                                        }
                                        if (navigator.serviceWorker.controller) {
                                            console.log('🔄 New version available! Refreshing...');
                                            requestRefresh();
                                        }
                                    }
                                });
                            });

                            // 📨 Get ServiceWorker version
                            if (registration.active) {
                                registration.active.postMessage({ type: 'GET_VERSION' }, [new MessageChannel().port1]);
                            }
                        })
                        .catch(err => {
                            console.error('❌ ServiceWorker registration failed:', err);
                            // Fallback to basic functionality
                            console.log('🔄 Fallback: Running without ServiceWorker');
                        });
                }
            } else {
                console.log('📱 ServiceWorker not supported - PWA features disabled');
            }

            // 🧪 Debug overlay (enable with ?debug=1)
            if (new URLSearchParams(window.location.search).get('debug') === '1') {
                const panel = document.createElement('div');
                panel.id = 'debugPanel';
                panel.style.cssText = [
                    'position:fixed','bottom:12px','left:12px','right:12px','z-index:99999',
                    'background:#0A1128','color:#F4E4BC','border:1px solid #D4AF37',
                    'padding:10px','border-radius:10px','font-size:13px','max-height:40vh',
                    'overflow:auto','box-shadow:0 10px 30px rgba(0,0,0,.3)'
                ].join(';');
                panel.innerHTML = '<strong>Debug (Errors)</strong><div id="debugErrors" style="margin-top:8px;white-space:pre-wrap;"></div>';
                document.body.appendChild(panel);

                const renderErrors = () => {
                    const el = document.getElementById('debugErrors');
                    if (!el) return;
                    const list = window.__errors || [];
                    if (!list.length) {
                        el.textContent = 'No errors captured.';
                        return;
                    }
                    el.textContent = JSON.stringify(list.slice(-20), null, 2);
                };
                renderErrors();
                setInterval(renderErrors, 2000);
            }
        });

        // ============================================
        // 💾 Data Management
        // ============================================
        // 🔥 Firebase + LocalStorage Hybrid Data Loading
        // ============================================
        const STORE_COLLECTION_SIGNATURES = {};

        function buildCollectionSignature(collectionKey, rows) {
            const list = Array.isArray(rows) ? rows : [];
            const first = list[0] || {};
            const last = list[list.length - 1] || {};
            return [
                collectionKey,
                list.length,
                String(first.id || ''),
                String(first.updatedAt || first.createdAt || ''),
                String(last.id || ''),
                String(last.updatedAt || last.createdAt || '')
            ].join('|');
        }

        function persistCollectionIfChanged(collectionKey, storageKey, rows) {
            const signature = buildCollectionSignature(collectionKey, rows);
            if (STORE_COLLECTION_SIGNATURES[collectionKey] === signature) return false;
            STORE_COLLECTION_SIGNATURES[collectionKey] = signature;
            setStorageData(storageKey, rows);
            return true;
        }

        function shouldPreserveLocalCustomers() {
            return false;
        }

        function mergeRemoteCustomersWithLocal() {
            return [];
        }

        async function loadData() {
            const localProducts = normalizeStoreProducts(allowLocalSeedDefaults ? [...defaultProducts] : []);
            const localCoupons = allowLocalSeedDefaults ? [...defaultCoupons] : [];
            const localBanners = allowLocalSeedDefaults ? [...defaultBanners] : [];

            const resolveList = (result, storageKey, localFallback, label) => {
                if (result.status === 'fulfilled' && Array.isArray(result.value)) {
                    const list = result.value;
                    console.log(`✅ ${label} loaded from Firebase:`, list.length);
                    return list;
                }
                if (result.status === 'rejected') {
                    console.warn(`${label} firebase read failed, fallback to localStorage:`, result.reason);
                }
                console.log(`📦 ${label} loaded from localStorage:`, localFallback.length);
                return localFallback;
            };

            try {
                if (typeof getAllProducts !== 'function') {
                    throw new Error('Firebase not available');
                }

                console.log('🔥 Loading from Firebase...');
                const productsReader = (typeof getPublishedProducts === 'function')
                    ? getPublishedProducts
                    : (typeof getAllProducts === 'function' ? getAllProducts : null);
                const [productsResult, couponsResult, bannersResult] = await Promise.allSettled([
                    (typeof productsReader === 'function' ? productsReader() : Promise.resolve(null)),
                    (typeof getCoupons === 'function' ? getCoupons() : Promise.resolve(null)),
                    (typeof getBanners === 'function' ? getBanners() : Promise.resolve(null))
                ]);

                products = normalizeStoreProducts(resolveList(productsResult, 'PRODUCTS', localProducts, 'Products'));
                coupons = resolveList(couponsResult, 'COUPONS', localCoupons, 'Coupons');
                banners = resolveList(bannersResult, 'BANNERS', localBanners, 'Banners');
                users = [];
            } catch (error) {
                console.warn('⚠️ Firebase error, using localStorage:', error);
                trackStoreEvent('DATA_SYNC_FALLBACK', 'Firebase read failed, fallback to localStorage', 'warning', {
                    error: error && error.message ? String(error.message) : String(error)
                });
                products = normalizeStoreProducts(localProducts);
                coupons = localCoupons;
                banners = localBanners;
                users = [];
            }

            // هذه البيانات دائماً من localStorage (السلة، المفضلات، إلخ)
            cart = getStorageData('CART') || [];
            favorites = (getStorageData('WISHLIST') || []).map(id => String(id));
            orders = [];
            try { removeStorageData('ORDERS'); } catch (_) {}
            
            const savedSettings = getStorageData('SETTINGS');
            if (savedSettings) storeSettings = { ...storeSettings, ...savedSettings };
            
            removeSeedDataIfNeeded();
            products = normalizeStoreProducts(products);
            suppliers = Array.from(new Map(
                products
                    .filter((item) => item && String(item.supplierId || '').trim())
                    .map((item) => [String(item.supplierId), {
                        id: String(item.supplierId || ''),
                        name: String(item.supplierName || item.supplierCode || item.supplierId || ''),
                        code: String(item.supplierCode || '')
                    }])
            ).values());

            // Firebase remains source of truth for products/coupons/banners.
            console.log('📡 Data bound to Firebase realtime source');
            updateLiveSessionState({
                customerId: currentUser && currentUser.id ? String(currentUser.id) : ''
            });
            trackStoreEvent('STORE_DATA_SYNC', 'Store data synchronized', 'info', {
                products: products.length,
                coupons: coupons.length,
                banners: banners.length,
                users: currentUser ? 1 : 0
            });
        }

        async function loadDataWithTimeout(ms = 9000) {
            let timedOut = false;
            const timer = setTimeout(() => {
                timedOut = true;
                console.warn('⏱️ loadData is taking longer than expected...');
                trackStoreEvent('DATA_SYNC_SLOW', 'loadData exceeded expected time budget', 'warning', {
                    thresholdMs: ms
                });
            }, ms);

            try {
                await loadData();
            } finally {
                clearTimeout(timer);
            }

            if (timedOut) {
                console.log('✅ loadData completed after slow start');
            }
        }

        function saveCart() { setStorageData('CART', cart); }
        function saveFavorites() { setStorageData('WISHLIST', favorites); }
        function saveOrders() { orders = []; try { removeStorageData('ORDERS'); } catch (_) {} }
        function saveUsers() {
            users = Array.isArray(users) ? users : [];
        }
        function saveProducts() { /* no-op: products are Firebase-managed */ }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                info: { bg: '#0A1128', border: '#D4AF37' },
                warning: { bg: '#2B1B00', border: '#D4AF37' },
                error: { bg: '#2B0000', border: '#D4AF37' },
                success: { bg: '#0B2B1B', border: '#D4AF37' }
            };
            const c = colors[type] || colors.info;
            toast.textContent = message;
            toast.style.cssText = [
                'position:fixed','bottom:20px','left:20px','right:20px','z-index:99999',
                'background:' + c.bg,'color:#F4E4BC','border:1px solid ' + c.border,
                'padding:12px','border-radius:10px','font-size:14px','text-align:center',
                'box-shadow:0 10px 30px rgba(0,0,0,.3)','opacity:0','transition:opacity .2s ease'
            ].join(';');
            document.body.appendChild(toast);
            requestAnimationFrame(() => { toast.style.opacity = '1'; });
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 250);
            }, 2500);
        }

        // ============================================
        // 🎨 Apply Store Settings
        // ============================================
        function applyStoreSettings() {
            document.getElementById('loadingStoreName').textContent = storeSettings.name || 'Sale Zone Store';
            document.getElementById('storeLogo').textContent = storeSettings.name || 'Sale Zone Store';
            document.getElementById('storeTagline').textContent = storeSettings.tagline || 'التسوق الفاخر الذكي';
            document.title = storeSettings.name || 'Sale Zone Store';

            const topBar = document.getElementById('topBar');
            if (storeSettings.topBar?.enabled === false) {
                topBar.style.display = 'none';
            } else {
                topBar.style.background = `linear-gradient(90deg, ${storeSettings.topBar?.bgColor || '#0A1128'}, ${storeSettings.topBar?.bgColor || '#0A1128'}dd)`;
                topBar.style.color = storeSettings.topBar?.textColor || '#F4E4BC';
                document.getElementById('topBarText').textContent = storeSettings.topBar?.text || '';
            }

            const phone = storeSettings.contact?.phone || '01018108979';
            const whatsapp = storeSettings.contact?.whatsapp || '01018108979';
            document.getElementById('topBarPhone').textContent = `📞 ${phone}`;
            document.getElementById('topBarPhone').href = `tel:${phone}`;
            document.getElementById('topBarWhatsapp').href = `https://wa.me/2${whatsapp}`;
            document.getElementById('footerAbout').textContent = storeSettings.footer?.about || storeSettings.description || '';
            document.getElementById('footerPhone').textContent = phone;
            document.getElementById('footerWhatsapp').textContent = whatsapp;
            document.getElementById('footerEmail').textContent = storeSettings.contact?.email || '';
            document.getElementById('footerAddress').textContent = storeSettings.contact?.address || '';
            document.getElementById('hoursWeekdays').textContent = storeSettings.footer?.workingHoursWeekdays || '';
            document.getElementById('hoursFriday').textContent = storeSettings.footer?.workingHoursFriday || '';
            document.getElementById('hoursNote').textContent = storeSettings.footer?.workingHoursNote || '';
            document.getElementById('footerCopyright').textContent = storeSettings.footer?.copyright || '';
            document.getElementById('floatWhatsapp').href = `https://wa.me/2${whatsapp}`;
            if (!Array.isArray(storeSettings.customCategories)) {
                storeSettings.customCategories = [];
            }
            renderDynamicCategoryCards();
        }

        function escapeHtml(value) {
            if (window.SecurityUtils && typeof window.SecurityUtils.escapeHtml === 'function') {
                return window.SecurityUtils.escapeHtml(value);
            }
            return String(value === null || value === undefined ? '' : value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getFirebaseCurrentUserSafe() {
            try {
                if (!(firebase && firebase.auth)) return null;
                const auth = firebase.auth();
                return auth && auth.currentUser ? auth.currentUser : null;
            } catch (_) {
                return null;
            }
        }

        function canWriteTelemetry(requireVerified = false) {
            const user = getFirebaseCurrentUserSafe();
            if (!user) return false;
            if (!requireVerified) return true;
            return user.emailVerified === true;
        }

        // ============================================
        // 🎠 Banner Slider
        // ============================================
        function renderBanners() {
            const slider = document.getElementById('bannerSlider');
            const dots = document.getElementById('bannerDots');
            
            // التحقق من وجود العناصر قبل استخدامها
            if (!slider || !dots) {
                console.warn('⚠️ Banner elements not found, skipping render');
                return;
            }
            
            if (banners.length === 0) {
                slider.innerHTML = '<div class="banner-slide"><div class="banner-content"><div class="banner-icon">🛍️</div><div class="banner-title">مرحباً بك</div></div></div>';
                return;
            }

            slider.innerHTML = banners.map((b) => {
                const safeIcon = escapeHtml(b && b.icon || '🎉');
                const safeTitle = escapeHtml(b && b.title || '');
                const safeText = escapeHtml(b && b.text || '');
                const safeButton = escapeHtml(b && b.btn || 'تسوق الآن');
                const safeCategory = escapeHtml(b && b.category || 'all');
                return `
                <div class="banner-slide">
                    <div class="banner-content">
                        <div class="banner-icon">${safeIcon}</div>
                        <div class="banner-title">${safeTitle}</div>
                        <div class="banner-text">${safeText}</div>
                        <a href="#" class="banner-btn" data-category="${safeCategory}" onclick="filterByCategory(this.dataset.category)">${safeButton}</a>
                    </div>
                </div>
            `;
            }).join('');

            dots.innerHTML = banners.map((_, i) => `<div class="banner-dot ${i === 0 ? 'active' : ''}" onclick="goToBanner(${i})"></div>`).join('');
        }

        function goToBanner(index) {
            currentBanner = index;
            document.getElementById('bannerSlider').style.transform = `translateX(${index * 100}%)`;
            document.querySelectorAll('.banner-dot').forEach((d, i) => d.classList.toggle('active', i === index));
        }

        function nextBanner() { goToBanner((currentBanner + 1) % banners.length); }
        function prevBanner() { goToBanner((currentBanner - 1 + banners.length) % banners.length); }
        function startBannerSlider() { bannerInterval = setInterval(nextBanner, 5000); }

        // ============================================
        // Image Sanitizer (avoid external ORB/CORS issues)
        // ============================================
        function sanitizeImageUrl(url) {
            const placeholder = './assets/placeholder.svg';
            if (!url || typeof url !== 'string') return placeholder;

            const trimmed = url.trim();
            if (trimmed.startsWith('data:')) return trimmed;
            if (trimmed.startsWith('./') || trimmed.startsWith('assets/')) return trimmed;

            try {
                const parsed = new URL(trimmed, window.location.origin);
                if (parsed.origin === window.location.origin) {
                    return parsed.pathname + parsed.search + parsed.hash;
                }
            } catch (e) {
                return placeholder;
            }

            return placeholder;
        }

        // ============================================
        // 🎴 Products
        // ============================================
        function normalizeSearchKeyword(value) {
            return String(value || '')
                .toLowerCase()
                .trim()
                .replace(/[\u064b-\u065f]/g, '')
                .replace(/[أإآ]/g, 'ا')
                .replace(/[ة]/g, 'ه')
                .replace(/[ى]/g, 'ي')
                .replace(/[^a-z0-9\u0621-\u064a\s-]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function ensureSearchWorker() {
            if (searchWorker) return;
            try {
                searchWorker = new Worker('./product-search-worker.js');
                searchWorker.onmessage = (event) => {
                    const message = event && event.data ? event.data : {};
                    if (message.type === 'built') {
                        searchWorkerReady = true;
                        return;
                    }
                    if (message.type !== 'search-result') return;
                    const requestId = String(message.requestId || '');
                    const resolver = pendingSearchResolvers.get(requestId);
                    if (!resolver) return;
                    pendingSearchResolvers.delete(requestId);
                    resolver(message.result || { items: [], total: 0, page: 1, pageSize: PAGE_SIZE, totalPages: 1 });
                };
                searchWorker.onerror = () => {
                    searchWorkerReady = false;
                };
            } catch (error) {
                console.warn('Search worker unavailable:', error);
                searchWorker = null;
                searchWorkerReady = false;
            }
        }

        function buildSearchIndexAsync() {
            ensureSearchWorker();
            if (!searchWorker) return;
            searchWorkerReady = false;
            searchWorker.postMessage({
                type: 'build',
                products: getVisibleProductsList()
            });
        }

        function searchProductsViaWorker(payload) {
            ensureSearchWorker();
            if (!searchWorker) return Promise.resolve(null);
            const requestId = `req_${Date.now()}_${++searchRequestCounter}`;
            return new Promise((resolve) => {
                pendingSearchResolvers.set(requestId, resolve);
                searchWorker.postMessage({
                    type: 'search',
                    requestId,
                    payload
                });
            });
        }

        function renderSupplierFilters() {
            const select = document.getElementById('supplierFilter');
            if (!select) return;
            const current = String(select.value || '');
            const pool = getVisibleProductsList();
            const map = new Map();
            for (const item of pool) {
                const id = String(item.supplierId || '').trim();
                if (!id) continue;
                if (!map.has(id)) {
                    map.set(id, String(item.supplierName || item.supplierCode || id));
                }
            }
            const options = Array.from(map.entries()).sort((a, b) => String(a[1]).localeCompare(String(b[1]), 'ar'));
            select.innerHTML = '<option value="">الكل</option>' + options.map(([id, name]) => (
                `<option value="${id}">${name}</option>`
            )).join('');
            if (current) select.value = current;
        }

        function renderPaginationControls(meta) {
            const pagination = document.getElementById('productsPagination');
            if (!pagination) return;
            if (!meta || Number(meta.totalPages || 1) <= 1) {
                pagination.innerHTML = '';
                return;
            }

            const page = Number(meta.page || 1);
            const totalPages = Number(meta.totalPages || 1);

            const createButton = (label, targetPage, disabled = false, active = false) => (
                `<button class="pagination-btn ${active ? 'active' : ''}" ${disabled ? 'disabled' : ''} onclick="runProductSearch(${targetPage})">${label}</button>`
            );

            const pageButtons = [];
            const start = Math.max(1, page - 2);
            const end = Math.min(totalPages, page + 2);
            for (let i = start; i <= end; i += 1) {
                pageButtons.push(createButton(String(i), i, false, i === page));
            }

            pagination.innerHTML = [
                createButton('«', 1, page <= 1),
                createButton('‹', Math.max(1, page - 1), page <= 1),
                ...pageButtons,
                createButton('›', Math.min(totalPages, page + 1), page >= totalPages),
                createButton('»', totalPages, page >= totalPages)
            ].join('');
        }

        function renderProducts(productsToRender = null) {
            if (!Array.isArray(productsToRender)) {
                buildSearchIndexAsync();
                runProductSearch(currentSearchPage || 1);
                return;
            }
            const grid = document.getElementById('productsGrid');
            const displayProducts = productsToRender;

            if (displayProducts.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><div style="font-size: 60px;">📦</div><h3 style="color: #666;">لا توجد منتجات</h3></div>';
                renderPaginationControls({ totalPages: 1, page: 1 });
                return;
            }

            grid.innerHTML = displayProducts.map((p) => {
                const safeProductId = escapeHtml(String(p && p.id || ''));
                const safeName = escapeHtml(p && p.name || '');
                const safeDesc = escapeHtml(p && p.desc || '');
                const safeImageSrc = escapeHtml(sanitizeImageUrl(p && p.image));
                const safeFallbackImage = escapeHtml(sanitizeImageUrl(''));
                const isFav = favorites.includes(String(p && p.id));
                const currentPrice = escapeHtml(Number(p && (p.sellPrice || p.price) || 0).toFixed(2));
                const oldPriceValue = Number(p && p.oldPrice);
                const hasOldPrice = Number.isFinite(oldPriceValue) && oldPriceValue > 0;
                const oldPrice = escapeHtml(hasOldPrice ? oldPriceValue.toFixed(2) : '');
                const ratingCount = escapeHtml(Number(p && p.ratingCount || 0).toFixed(0));
                const discountPercent = hasOldPrice
                    ? Math.round((1 - (Number(p && (p.sellPrice || p.price) || 0) / oldPriceValue)) * 100)
                    : 0;
                return `
                <div class="product-card">
                    ${hasOldPrice ? `<div class="product-badge">-${escapeHtml(discountPercent)}%</div>` : ''}
                    <div class="product-fav ${isFav ? 'active' : ''}" data-product-id="${safeProductId}" onclick="toggleFav(this.dataset.productId)">
                        ${isFav ? '❤️' : '🤍'}
                    </div>
                    <div class="product-image">
                        <img src="${safeImageSrc}" alt="${safeName}" onerror="this.src='${safeFallbackImage}'" loading="lazy">
                        <div class="product-actions">
                            <button class="action-btn" data-product-id="${safeProductId}" onclick="showProductDetails(this.dataset.productId)">👁️</button>
                            <button class="action-btn" data-product-id="${safeProductId}" onclick="addToCart(this.dataset.productId)">🛒</button>
                        </div>
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${safeName}</h3>
                        <p class="product-desc">${safeDesc}</p>
                        <div class="product-rating" data-product-id="${safeProductId}" onclick="showRatingModal(this.dataset.productId)">
                            <div class="stars">${getStars(p && p.rating)}</div>
                            <span class="rating-count">(${ratingCount})</span>
                        </div>
                        <div class="product-price">
                            <span class="current-price">${currentPrice} ج.م</span>
                            ${hasOldPrice ? `<span class="old-price">${oldPrice} ج.م</span>` : ''}
                        </div>
                        <button class="add-to-cart-btn" data-product-id="${safeProductId}" onclick="addToCart(this.dataset.productId)">🛒 أضف للسلة</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function getAdvancedFilters() {
            const minRaw = parseFloat(document.getElementById('minPrice')?.value);
            const maxRaw = parseFloat(document.getElementById('maxPrice')?.value);
            return {
                minPrice: Number.isFinite(minRaw) ? minRaw : null,
                maxPrice: Number.isFinite(maxRaw) ? maxRaw : null,
                supplierId: String(document.getElementById('supplierFilter')?.value || '').trim(),
                inStockOnly: document.getElementById('inStockOnly')?.checked === true
            };
        }

        function runProductSearch(page = 1) {
            renderSupplierFilters();
            const query = currentSearchQuery;
            const filters = getAdvancedFilters();
            const sort = document.getElementById('sortSelect')?.value || 'default';
            const payload = {
                query,
                filters,
                sort,
                page,
                pageSize: PAGE_SIZE,
                currentCategory
            };

            const fallbackSearch = () => {
                const normalizedQuery = normalizeSearchKeyword(query);
                const tokens = normalizedQuery ? normalizedQuery.split(' ').filter(Boolean) : [];
                let rows = getVisibleProductsList().filter((item) => {
                    if (!item) return false;
                    if (currentCategory !== 'all' && String(item.category || '') !== currentCategory) return false;
                    if (filters.supplierId && String(item.supplierId || '') !== filters.supplierId) return false;
                    if (filters.inStockOnly && Number(item.stock || 0) <= 0) return false;
                    const priceValue = Number(item.sellPrice || item.price || 0);
                    if (Number.isFinite(filters.minPrice) && priceValue < filters.minPrice) return false;
                    if (Number.isFinite(filters.maxPrice) && priceValue > filters.maxPrice) return false;
                    if (!tokens.length) return true;
                    const haystack = normalizeSearchKeyword([
                        item.name,
                        item.desc,
                        item.code,
                        item.supplierName,
                        ...(Array.isArray(item.searchTokens) ? item.searchTokens : [])
                    ].join(' '));
                    return tokens.every((token) => haystack.includes(token));
                });

                sortProducts(sort, rows, false);
                const total = rows.length;
                const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
                const safePage = Math.min(Math.max(1, page), totalPages);
                const start = (safePage - 1) * PAGE_SIZE;
                return {
                    items: rows.slice(start, start + PAGE_SIZE),
                    total,
                    page: safePage,
                    pageSize: PAGE_SIZE,
                    totalPages
                };
            };

            const applyResult = (result) => {
                lastSearchResult = result;
                currentSearchPage = Number(result.page || 1);
                renderProducts(result.items || []);
                renderPaginationControls(result);
                const titlePrefix = query ? `بحث: "${query}"` : (currentCategory === 'all' ? 'جميع المنتجات' : getCategoryName(currentCategory));
                document.getElementById('productsTitle').textContent = `${titlePrefix} (${result.total || 0})`;
            };

            if (!searchWorkerReady) {
                const localResult = fallbackSearch();
                applyResult(localResult);
                return;
            }

            searchProductsViaWorker(payload)
                .then((result) => {
                    if (!result || !Array.isArray(result.items)) {
                        applyResult(fallbackSearch());
                        return;
                    }
                    applyResult(result);
                })
                .catch(() => {
                    applyResult(fallbackSearch());
                });
        }

        function getDefaultCategoryDefinitions() {
            return [
                { id: 'all', name: 'الكل', icon: '🛍️', staticCountId: 'countAll' },
                { id: 'hair-care', name: 'الشعر', icon: '💇‍♀️', staticCountId: 'countHair' },
                { id: 'skin-care', name: 'البشرة', icon: '🧴', staticCountId: 'countSkin' },
                { id: 'baby-care', name: 'الطفل', icon: '👶', staticCountId: 'countBaby' },
                { id: 'supplements', name: 'المكملات', icon: '💊', staticCountId: 'countSupplements' },
                { id: 'medical', name: 'الطبي', icon: '🏥', staticCountId: 'countMedical' }
            ];
        }

        function sanitizeCategoryId(value) {
            const raw = String(value || '').trim().toLowerCase();
            if (!raw) return '';
            return raw.replace(/[^a-z0-9-]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
        }

        function getConfiguredCustomCategories() {
            const configured = Array.isArray(storeSettings?.customCategories) ? storeSettings.customCategories : [];
            return configured
                .map((item) => ({
                    id: sanitizeCategoryId(item && item.id),
                    name: String((item && item.name) || '').trim(),
                    icon: String((item && item.icon) || '🏷️').trim() || '🏷️'
                }))
                .filter((item) => item.id && item.name);
        }

        function getDynamicProductCategories() {
            const defaults = new Set(getDefaultCategoryDefinitions().map((item) => item.id));
            const map = new Map();
            (products || []).forEach((item) => {
                const id = sanitizeCategoryId(item && item.category);
                if (!id || defaults.has(id)) return;
                if (!map.has(id)) {
                    map.set(id, {
                        id,
                        name: String(item?.categoryName || item?.categoryLabel || item?.category || id),
                        icon: '🏷️'
                    });
                }
            });
            return Array.from(map.values());
        }

        function getAllCategoryDefinitions() {
            const map = new Map();
            getDefaultCategoryDefinitions().forEach((item) => map.set(item.id, item));
            getConfiguredCustomCategories().forEach((item) => map.set(item.id, item));
            getDynamicProductCategories().forEach((item) => {
                if (!map.has(item.id)) map.set(item.id, item);
            });
            return Array.from(map.values());
        }

        function renderDynamicCategoryCards() {
            const grid = document.getElementById('categoriesGrid');
            if (!grid) return;

            grid.querySelectorAll('.dynamic-category-card').forEach((node) => node.remove());
            const defaults = new Set(getDefaultCategoryDefinitions().map((item) => item.id));
            const customCategories = getAllCategoryDefinitions().filter((item) => !defaults.has(item.id));

            customCategories.forEach((item) => {
                const card = document.createElement('div');
                card.className = `category-card dynamic-category-card${currentCategory === item.id ? ' active' : ''}`;
                card.dataset.category = item.id;
                card.onclick = () => filterByCategory(item.id);
                card.innerHTML = `
                    <div class="category-icon">${item.icon || '🏷️'}</div>
                    <div class="category-name">${item.name}</div>
                    <div class="category-count">0</div>
                `;
                const iconElement = card.querySelector('.category-icon');
                if (iconElement) {
                    iconElement.style.background = 'linear-gradient(135deg, var(--gold), var(--gold-dark))';
                }
                grid.appendChild(card);
            });
        }

        function getCategoryName(cat) {
            const id = sanitizeCategoryId(cat);
            const found = getAllCategoryDefinitions().find((item) => item.id === id);
            return found ? found.name : cat;
        }

        function getStars(rating) {
            let stars = '';
            for (let i = 0; i < Math.floor(rating || 0); i++) stars += '⭐';
            return stars || '⭐';
        }

        function filterByCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-card').forEach(c => c.classList.toggle('active', c.dataset.category === category));
            runProductSearch(1);
        }

        function sortProducts(type, sourceRows = null, shouldRender = true) {
            if (!Array.isArray(sourceRows) && shouldRender) {
                runProductSearch(1);
                return [];
            }
            let filtered = Array.isArray(sourceRows) ? [...sourceRows] : [...(lastSearchResult.items || [])];
            switch(type) {
                case 'price-low': filtered.sort((a, b) => Number(a.sellPrice || a.price || 0) - Number(b.sellPrice || b.price || 0)); break;
                case 'price-high': filtered.sort((a, b) => Number(b.sellPrice || b.price || 0) - Number(a.sellPrice || a.price || 0)); break;
                case 'rating': filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0)); break;
                case 'name': filtered.sort((a, b) => a.name.localeCompare(b.name, 'ar')); break;
            }
            if (shouldRender) renderProducts(filtered);
            return filtered;
        }

        function filterByPrice() { runProductSearch(1); }
        function applyAdvancedFilters() { runProductSearch(1); }
        function resetFilters() {
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('supplierFilter').value = '';
            document.getElementById('inStockOnly').checked = false;
            document.getElementById('sortSelect').value = 'default';
            currentSearchQuery = '';
            document.getElementById('searchInput').value = '';
            runProductSearch(1);
        }

        function searchProducts() {
            currentSearchQuery = document.getElementById('searchInput').value.trim();
            if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                runProductSearch(1);
            }, 120);
        }

        function showProductDetails(id) {
            const p = getVisibleProductsList().find((x) => String(x.id) === String(id));
            if (!p) return;
            document.getElementById('productModalBody').innerHTML = `
                <div style="text-align: center;">
                    <img src="${sanitizeImageUrl(p.image)}" style="width: 100%; max-height: 250px; object-fit: cover; border-radius: 12px; margin-bottom: 15px;" onerror="this.src='${sanitizeImageUrl('')}'">
                    <h2 style="font-size: 20px; color: var(--navy); margin-bottom: 8px;">${p.name}</h2>
                    <p style="color: #666; margin-bottom: 15px; font-size: 13px;">${p.desc}</p>
                    <div style="margin-bottom: 15px;" onclick="showRatingModal('${p.id}')">
                        <span style="font-size: 18px;">${getStars(p.rating)}</span>
                        <span style="color: #999; font-size: 12px;">(${p.ratingCount || 0} تقييم)</span>
                    </div>
                    <div style="margin-bottom: 18px;">
                        <span style="font-size: 26px; font-weight: 800; color: var(--gold-dark);">${Number(p.sellPrice || p.price || 0).toFixed(2)} ج.م</span>
                        ${p.oldPrice ? `<span style="font-size: 16px; color: #999; text-decoration: line-through; margin-right: 10px;">${Number(p.oldPrice).toFixed(2)} ج.م</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="submit-btn" onclick="addToCart('${p.id}'); closeModal('productModal');" style="flex: 1; max-width: 200px;">🛒 أضف للسلة</button>
                        <button class="submit-btn" onclick="toggleFav('${p.id}')" style="width: 50px; background: ${favorites.includes(String(p.id)) ? 'var(--error)' : 'var(--cream)'}; color: ${favorites.includes(String(p.id)) ? 'white' : 'var(--error)'};">${favorites.includes(String(p.id)) ? '❤️' : '🤍'}</button>
                    </div>
                </div>
            `;
            openModal('productModal');
        }

        function updateCategoryCounts() {
            renderDynamicCategoryCards();
            const visibleProducts = getVisibleProductsList();
            const countAll = document.getElementById('countAll');
            if (countAll) countAll.textContent = visibleProducts.length;

            document.querySelectorAll('.category-card[data-category]').forEach((card) => {
                const categoryId = String(card.dataset.category || '');
                if (!categoryId || categoryId === 'all') return;
                const countElement = card.querySelector('.category-count');
                if (!countElement) return;
                const count = visibleProducts.filter((item) => String(item.category || '') === categoryId).length;
                countElement.textContent = String(count);
            });
        }

        function updateStats() {
            const visibleProducts = getVisibleProductsList();
            document.getElementById('statsProducts').textContent = visibleProducts.length;
            document.getElementById('statsOrders').textContent = orders.length;
            document.getElementById('statsUsers').textContent = users.length;
            if (visibleProducts.length > 0) {
                document.getElementById('statsRating').textContent = (visibleProducts.reduce((s, p) => s + (p.rating || 0), 0) / visibleProducts.length).toFixed(1);
            } else {
                document.getElementById('statsRating').textContent = '0.0';
            }
        }

        // ============================================
        // ⭐ Rating System
        // ============================================
        function showRatingModal(productId) {
            const p = getVisibleProductsList().find((x) => String(x.id) === String(productId));
            if (!p) return;
            
            document.getElementById('ratingModalBody').innerHTML = `
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 15px;">${p.name}</h3>
                    <p style="margin-bottom: 20px;">التقييم الحالي: ${getStars(p.rating)} (${p.ratingCount || 0})</p>
                    <div style="font-size: 36px; margin-bottom: 20px;" id="ratingStars">
                        ${[1,2,3,4,5].map(i => `<span style="cursor: pointer;" onclick="rateProduct('${productId}', ${i})">${i <= (p.rating || 0) ? '⭐' : '☆'}</span>`).join('')}
                    </div>
                    <p style="color: #666; font-size: 12px;">اضغط على النجوم للتقييم</p>
                </div>
            `;
            openModal('ratingModal');
        }

        function rateProduct(productId, rating) {
            if (!currentUser) {
                showNotification('error', 'خطأ', 'سجل دخول أولاً');
                showAuthModal('login');
                return;
            }

            const p = products.find(x => String(x.id) === String(productId));
            if (!p) return;
            if (p.isPublished === false) return;

            if (!p.ratings) p.ratings = [];
            const existingRating = p.ratings.find(r => r.oderId === currentUser.id);
            
            if (existingRating) {
                existingRating.value = rating;
            } else {
                p.ratings.push({ oderId: currentUser.id, value: rating });
            }

            p.ratingCount = p.ratings.length;
            p.rating = p.ratings.reduce((s, r) => s + r.value, 0) / p.ratings.length;

            saveProducts();
            buildSearchIndexAsync();
            runProductSearch(currentSearchPage);
            closeModal('ratingModal');
            showNotification('success', 'شكراً', `تم تقييم المنتج بـ ${rating} نجوم`);
        }

        // ============================================
        // ❤️ Favorites
        // ============================================
        function toggleFavorites() {
            document.getElementById('favOverlay').classList.toggle('active');
            document.getElementById('favSidebar').classList.toggle('active');
        }

        function toggleFav(id) {
            const pid = String(id);
            const idx = favorites.indexOf(pid);
            if (idx > -1) {
                favorites.splice(idx, 1);
                showNotification('info', 'تمت الإزالة', 'تم إزالة المنتج من المفضلة');
            } else {
                favorites.push(pid);
                showNotification('success', 'تمت الإضافة', 'تم إضافة المنتج للمفضلة');
            }
            saveFavorites();
            updateFavUI();
            runProductSearch(currentSearchPage);
        }

        function updateFavUI() {
            const visibleProducts = getVisibleProductsList();
            const visibleFavoriteIds = favorites.filter((favId) =>
                visibleProducts.some((p) => String(p.id) === String(favId))
            );
            document.getElementById('favCount').textContent = visibleFavoriteIds.length;
            const container = document.getElementById('favItems');
            
            if (visibleFavoriteIds.length === 0) {
                container.innerHTML = '<div class="fav-empty"><div class="cart-empty-icon">❤️</div><p>لا توجد منتجات مفضلة</p></div>';
                return;
            }

            container.innerHTML = visibleFavoriteIds.map((id) => {
                const p = visibleProducts.find((x) => String(x.id) === String(id));
                if (!p) return '';
                return `
                    <div class="fav-item">
                        <div class="fav-item-image"><img src="${sanitizeImageUrl(p.image)}" onerror="this.src='${sanitizeImageUrl('')}'"></div>
                        <div class="fav-item-details">
                            <div class="fav-item-name">${p.name}</div>
                            <div class="fav-item-price">${Number(p.sellPrice || p.price || 0).toFixed(2)} ج.م</div>
                        </div>
                        <div class="fav-item-actions">
                            <button class="fav-add-btn" onclick="addToCart('${p.id}')">🛒</button>
                            <button class="fav-remove-btn" onclick="toggleFav('${p.id}')">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // 🛒 Cart
        // ============================================
        function toggleCart() {
            document.getElementById('cartOverlay').classList.toggle('active');
            document.getElementById('cartSidebar').classList.toggle('active');
            updatePointsSection();
        }

        function addToCart(id) {
            const p = getVisibleProductsList().find((x) => x.id == id || String(x.id) === String(id));
            if (!p) return;
            const existing = cart.find(item => item.id == id || String(item.id) === String(id));
            if (existing) existing.quantity++;
            else cart.push({ id: p.id, name: p.name, price: Number(p.sellPrice || p.price || 0), image: p.image, quantity: 1 });
            saveCart();
            updateCartUI();
            showNotification('success', 'تمت الإضافة', `"${p.name}" في السلة`);
        }

        function removeFromCart(id) {
            cart = cart.filter(item => String(item.id) !== String(id));
            saveCart();
            updateCartUI();
        }

        function updateQuantity(id, change) {
            const item = cart.find(x => x.id === id);
            if (!item) return;
            item.quantity += change;
            if (item.quantity <= 0) removeFromCart(id);
            else { saveCart(); updateCartUI(); }
        }

        function updateCartUI() {
            const cartItems = document.getElementById('cartItems');
            const totalItems = cart.reduce((s, i) => s + i.quantity, 0);
            document.getElementById('cartCount').textContent = totalItems;

            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="cart-empty"><div class="cart-empty-icon">🛒</div><p>السلة فارغة</p></div>';
                updateCartSummary(0, 0);
                return;
            }

            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-image"><img src="${sanitizeImageUrl(item.image)}" onerror="this.src='${sanitizeImageUrl('')}'"></div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price} ج.م</div>
                        <div class="cart-item-controls">
                            <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                            <span class="qty-value">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                        </div>
                    </div>
                    <button class="remove-item" onclick="removeFromCart('${item.id}')">🗑️</button>
                </div>
            `).join('');

            const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let discount = 0;
            if (appliedCoupon) {
                discount = appliedCoupon.type === 'percentage' ? subtotal * (appliedCoupon.value / 100) : appliedCoupon.value;
            }
            updateCartSummary(subtotal, discount);
        }

        function updateCartSummary(subtotal, discount) {
            const totalAfterCoupon = Math.max(0, subtotal - discount);
            const total = Math.max(0, totalAfterCoupon - pointsDiscount);
            const loyaltyRate = storeSettings.loyalty?.rate || 5;
            const earnedPoints = Math.floor(total * (loyaltyRate / 100));

            document.getElementById('subtotal').textContent = `${subtotal} ج.م`;
            document.getElementById('totalAmount').textContent = `${total.toFixed(0)} ج.م`;
            document.getElementById('earnedPoints').textContent = `${earnedPoints} نقطة`;

            const discountRow = document.getElementById('discountRow');
            if (discount > 0) {
                discountRow.classList.remove('hidden');
                document.getElementById('discountAmount').textContent = `- ${discount} ج.م`;
            } else {
                discountRow.classList.add('hidden');
            }

            const pointsRow = document.getElementById('pointsDiscountRow');
            if (pointsDiscount > 0) {
                pointsRow.classList.remove('hidden');
                document.getElementById('pointsDiscountAmount').textContent = `- ${pointsDiscount.toFixed(0)} ج.م`;
            } else {
                pointsRow.classList.add('hidden');
            }

            updatePointsSection();
        }

        function applyCoupon() {
            const code = document.getElementById('couponInput').value.trim().toUpperCase();
            if (!code) { showNotification('error', 'خطأ', 'أدخل الكود'); return; }
            const coupon = coupons.find(c => c.code.toUpperCase() === code);
            if (!coupon) { showNotification('error', 'خطأ', 'كود غير صحيح'); return; }
            appliedCoupon = coupon;
            updateCartUI();
            showNotification('success', 'تم', `خصم ${coupon.type === 'percentage' ? coupon.value + '%' : coupon.value + ' ج.م'}`);
        }

        // ============================================
        // 💎 Points Redemption
        // ============================================
        function updatePointsSection() {
            const section = document.getElementById('pointsSection');
            if (!currentUser || !currentUser.loyaltyPoints || currentUser.loyaltyPoints <= 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');
            document.getElementById('availablePoints').textContent = currentUser.loyaltyPoints;
            const pointValue = storeSettings.loyalty?.pointValue || 0.1;
            document.getElementById('pointsInfo').textContent = `كل 10 نقاط = ${(10 * pointValue).toFixed(0)} ج.م`;
        }

        function applyPoints() {
            if (!currentUser) { showNotification('error', 'خطأ', 'سجل دخول'); return; }
            const points = parseInt(document.getElementById('pointsToUse').value) || 0;
            if (points <= 0) { showNotification('error', 'خطأ', 'أدخل عدد صحيح'); return; }
            if (points > currentUser.loyaltyPoints) { showNotification('error', 'خطأ', `لديك ${currentUser.loyaltyPoints} فقط`); return; }

            const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let couponDiscount = appliedCoupon ? (appliedCoupon.type === 'percentage' ? subtotal * (appliedCoupon.value / 100) : appliedCoupon.value) : 0;
            const remaining = subtotal - couponDiscount;
            const pointValue = storeSettings.loyalty?.pointValue || 0.1;
            const maxDiscount = points * pointValue;

            pointsDiscount = Math.min(maxDiscount, remaining);
            usedPoints = Math.ceil(pointsDiscount / pointValue);

            updateCartUI();
            showNotification('success', 'تم', `خصم ${pointsDiscount.toFixed(0)} ج.م`);
            document.getElementById('pointsToUse').value = '';
        }

        function resetPoints() { usedPoints = 0; pointsDiscount = 0; }

        // ============================================
        // 🎫 Coupons
        // ============================================
        function renderCoupons() {
            const grid = document.getElementById('couponsGrid');
            if (coupons.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">لا توجد كوبونات</p>';
                return;
            }
            grid.innerHTML = coupons.map((c) => {
                const safeCode = escapeHtml(c && c.code || '');
                const safeDesc = escapeHtml(c && c.desc || '');
                return `
                <div class="coupon-card">
                    <div class="coupon-content">
                        <div class="coupon-code">${safeCode}</div>
                        <p class="coupon-desc">${safeDesc}</p>
                        <button class="copy-coupon-btn" data-code="${safeCode}" onclick="copyCoupon(this.dataset.code)">📋 نسخ</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        function copyCoupon(code) {
            const normalizedCode = String(code || '').trim();
            navigator.clipboard.writeText(normalizedCode).then(() => showNotification('success', 'تم', `الكود: ${normalizedCode}`));
        }

        // ============================================
        // 🔐 Auth
        // ============================================
        function detectDeviceType() {
            const ua = String(navigator.userAgent || '').toLowerCase();
            if (ua.includes('ipad') || ua.includes('tablet')) return 'tablet';
            if (ua.includes('android') && !ua.includes('mobile')) return 'tablet';
            if (ua.includes('iphone') || ua.includes('mobile') || ua.includes('android')) return 'mobile';
            return 'desktop';
        }

        async function trackStoreEvent(type, message, level = 'info', meta = {}) {
            try {
                if (typeof addStoreEvent !== 'function') return;
                if (!canWriteTelemetry(true)) return;
                const eventType = String(type || 'STORE_EVENT');
                const throttleMs = STORE_EVENT_THROTTLE_MS[eventType] || 0;
                if (throttleMs > 0) {
                    const now = Date.now();
                    const previous = recentStoreEventLog[eventType] || 0;
                    if ((now - previous) < throttleMs) {
                        return;
                    }
                    recentStoreEventLog[eventType] = now;
                }
                await addStoreEvent({
                    type: eventType,
                    message: String(message || ''),
                    level: String(level || 'info'),
                    source: 'store',
                    sessionId: STORE_SESSION_ID,
                    customerId: currentUser && currentUser.id ? String(currentUser.id) : '',
                    meta: meta && typeof meta === 'object' ? meta : {},
                    context: {
                        page: window.location.pathname || '',
                        href: window.location.href || '',
                        userAgent: navigator.userAgent || '',
                        online: navigator.onLine,
                        viewport: { width: window.innerWidth || 0, height: window.innerHeight || 0 }
                    }
                });
            } catch (error) {
                console.warn('trackStoreEvent warning:', error && error.message ? error.message : error);
            }
        }

        async function updateLiveSessionState(extra = {}) {
            try {
                if (typeof upsertLiveSession !== 'function') return;
                if (!canWriteTelemetry(false)) return;
                await upsertLiveSession({
                    sessionId: STORE_SESSION_ID,
                    page: window.location.pathname || '',
                    href: window.location.href || '',
                    online: navigator.onLine,
                    customerId: currentUser && currentUser.id ? String(currentUser.id) : '',
                    customerPhone: currentUser && currentUser.phone ? String(currentUser.phone) : '',
                    device: detectDeviceType(),
                    userAgent: navigator.userAgent || '',
                    updatedAt: new Date().toISOString(),
                    ...(extra && typeof extra === 'object' ? extra : {})
                });
            } catch (error) {
                console.warn('updateLiveSessionState warning:', error && error.message ? error.message : error);
            }
        }

        function startLiveSessionHeartbeat() {
            if (liveSessionHeartbeatTimer) return;
            if (navigator.onLine) {
                updateLiveSessionState();
            }
            liveSessionHeartbeatTimer = setInterval(() => {
                if (!navigator.onLine) return;
                if (document.visibilityState !== 'visible') return;
                updateLiveSessionState();
            }, LIVE_SESSION_HEARTBEAT_MS);

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') updateLiveSessionState();
            });
            window.addEventListener('online', () => {
                updateLiveSessionState({ online: true });
                trackStoreEvent('NETWORK_ONLINE', 'Client back online', 'info');
            });
            window.addEventListener('offline', () => {
                updateLiveSessionState({ online: false });
                trackStoreEvent('NETWORK_OFFLINE', 'Client went offline', 'warning');
            });
            window.addEventListener('beforeunload', () => {
                if (typeof removeLiveSession === 'function') {
                    removeLiveSession(STORE_SESSION_ID).catch(() => null);
                }
            });
        }

        function normalizePhone(phone) {
            const raw = String(phone || '').trim();
            const digits = raw.replace(/[^\d]/g, '');
            if (digits.startsWith('20') && digits.length === 12) return `0${digits.slice(2)}`;
            return digits;
        }

        function normalizeCustomerCreatedAt(value) {
            if (!value) return '';
            if (typeof value === 'string') return value;
            if (value && typeof value.toDate === 'function') {
                try {
                    return value.toDate().toISOString();
                } catch (_) {
                    return '';
                }
            }
            if (value && typeof value.seconds === 'number') {
                const date = new Date(value.seconds * 1000);
                return Number.isNaN(date.getTime()) ? '' : date.toISOString();
            }
            const parsed = new Date(value);
            return Number.isNaN(parsed.getTime()) ? '' : parsed.toISOString();
        }

        function sanitizeCustomerRecord(raw, overrides = {}) {
            const source = raw && typeof raw === 'object' ? raw : {};
            const patch = overrides && typeof overrides === 'object' ? overrides : {};
            const pick = (key, fallback = '') => (key in patch ? patch[key] : source[key]) ?? fallback;
            const toText = (value, max = 300) => String(value == null ? '' : value).trim().slice(0, max);
            const normalizedPhone = normalizePhone(pick('phoneNormalized', pick('phone', '')));
            const createdAt = normalizeCustomerCreatedAt(pick('createdAt', '')) || new Date().toISOString();

            return {
                id: toText(pick('id', ''), 120),
                uid: toText(pick('uid', ''), 200),
                name: toText(pick('name', ''), 200),
                phone: toText(pick('phone', normalizedPhone), 50),
                phoneNormalized: normalizedPhone,
                email: toText(pick('email', ''), 200),
                address: toText(pick('address', ''), 500),
                loyaltyPoints: Number.isFinite(Number(pick('loyaltyPoints', 0))) ? Number(pick('loyaltyPoints', 0)) : 0,
                role: toText(pick('role', 'customer'), 20) || 'customer',
                emailVerified: pick('emailVerified', false) === true,
                status: toText(pick('status', 'active'), 50) || 'active',
                createdAt,
                updatedAt: normalizeCustomerCreatedAt(pick('updatedAt', '')) || createdAt
            };
        }

        function findUserByPhone(phone, list = users) {
            const target = normalizePhone(phone);
            return (list || []).find(u => normalizePhone(u.phone || u.phoneNormalized) === target);
        }

        function isValidCustomerPhone(phoneNormalized) {
            return /^\d{10,15}$/.test(String(phoneNormalized || ''));
        }

        function isValidCustomerPassword(password) {
            return String(password || '').trim().length >= 6;
        }

        function buildFallbackCustomerName(phoneNormalized) {
            const suffix = String(phoneNormalized || '').slice(-4) || '0000';
            return `عميل ${suffix}`;
        }

        function isEmailIdentifier(value) {
            const text = String(value || '').trim();
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(text);
        }

        async function signInCustomerAuth(email, password) {
            const normalizedEmail = String(email || '').trim().toLowerCase();
            const normalizedPassword = String(password || '');
            if (typeof loginCustomerByEmail === 'function') {
                return loginCustomerByEmail(normalizedEmail, normalizedPassword);
            }
            if (!(firebase && firebase.auth)) return null;
            return firebase.auth().signInWithEmailAndPassword(normalizedEmail, normalizedPassword);
        }

        async function registerCustomerAuth(payload = {}) {
            const profile = payload && typeof payload === 'object' ? payload : {};
            const normalizedEmail = String(profile.email || '').trim().toLowerCase();
            const normalizedPassword = String(profile.password || '');
            if (typeof registerCustomerByEmail === 'function') {
                return registerCustomerByEmail({
                    email: normalizedEmail,
                    password: normalizedPassword,
                    phone: String(profile.phone || '').trim(),
                    address: String(profile.address || '').trim(),
                    displayName: String(profile.displayName || profile.name || '').trim()
                });
            }
            if (!(firebase && firebase.auth)) return null;
            const credential = await firebase.auth().createUserWithEmailAndPassword(normalizedEmail, normalizedPassword);
            if (credential && credential.user && typeof credential.user.sendEmailVerification === 'function') {
                await credential.user.sendEmailVerification();
            }
            return credential;
        }

        function isOnlineMode() {
            return navigator.onLine !== false;
        }

        async function syncUsersFromFirebase() {
            users = [];
            return users;
        }

        function showAuthModal(tab = 'login') {
            openModal('authModal');
            switchAuthTab(tab);
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach((t, i) => t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1)));
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
            document.getElementById('authModalTitle').textContent = tab === 'login' ? 'تسجيل الدخول' : 'إنشاء حساب';
        }

        async function handleLogin(e) {
            e.preventDefault();
            if (authSubmitLock) return;
            authSubmitLock = true;
            try {
            const email = document.getElementById('loginIdentifier').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            if (!isEmailIdentifier(email)) {
                showNotification('error', 'خطأ', 'أدخل بريدًا إلكترونيًا صالحًا');
                return;
            }

            if (!isValidCustomerPassword(password)) {
                showNotification('error', 'خطأ', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return;
            }

            const authCred = await signInCustomerAuth(email, password);
            const authUser = authCred && authCred.user
                ? authCred.user
                : (firebase && firebase.auth ? firebase.auth().currentUser : null);
            if (!authUser || !authUser.uid) {
                throw new Error('تعذر إنشاء جلسة دخول');
            }

            if (typeof authUser.reload === 'function') {
                await authUser.reload();
            }
            if (typeof authUser.getIdToken === 'function') {
                await authUser.getIdToken(true).catch(() => null);
            }

            const uid = String(authUser.uid || '').trim();
            let profile = null;
            if (typeof getMyCustomerProfile === 'function') {
                profile = await getMyCustomerProfile(uid).catch(() => null);
            }

            if (!profile && typeof upsertMyCustomerProfile === 'function') {
                profile = await upsertMyCustomerProfile(uid, {
                    phone: '',
                    address: '',
                    displayName: String(authUser.displayName || email.split('@')[0] || '')
                }).catch(() => null);
            }

            currentUser = sanitizeCustomerRecord({
                id: String(profile && profile.id || uid),
                uid,
                name: String(profile && (profile.displayName || profile.name) || authUser.displayName || email.split('@')[0] || 'عميل'),
                phone: String(profile && profile.phone || ''),
                email: String(profile && profile.email || authUser.email || email),
                address: String(profile && profile.address || ''),
                loyaltyPoints: Number(profile && profile.loyaltyPoints || 0),
                createdAt: String(profile && profile.createdAt || new Date().toISOString()),
                updatedAt: String(profile && profile.updatedAt || new Date().toISOString()),
                role: String(profile && profile.role || 'customer'),
                emailVerified: authUser.emailVerified === true
            });
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUserUI();
            if (chatMode === 'support') {
                ensureSupportChatReady().catch(() => null);
            }
            closeModal('authModal');
            if (authUser.emailVerified !== true) {
                showNotification('warning', 'تم تسجيل الدخول', 'يرجى تفعيل البريد الإلكتروني قبل الشراء أو الدردشة الداخلية.');
            } else {
                showNotification('success', 'مرحباً', `أهلاً ${currentUser.name}!`);
            }
            updateLiveSessionState({
                customerId: String(currentUser.id || currentUser.uid || ''),
                customerPhone: String(currentUser.phone || '')
            });
            trackStoreEvent('LOGIN_SUCCESS', 'Customer login success', 'info', {
                customerId: String(currentUser.id || currentUser.uid || ''),
                email: String(currentUser.email || '').toLowerCase(),
                emailVerified: currentUser.emailVerified === true
            });
            users = [];
            saveUsers();
            } catch (error) {
                console.error('handleLogin error:', error);
                showNotification('error', 'فشل تسجيل الدخول', 'تحقق من البريد الإلكتروني وكلمة المرور');
                trackStoreEvent('LOGIN_FAILED', 'Customer login failed', 'warning', {
                    email: String(document.getElementById('loginIdentifier').value || '').trim().toLowerCase(),
                    error: error && error.message ? String(error.message) : String(error)
                });
            } finally {
                authSubmitLock = false;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            if (authSubmitLock) return;
            authSubmitLock = true;
            try {
            const name = document.getElementById('registerName').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const phoneNormalized = normalizePhone(phone);
            const email = document.getElementById('registerEmail').value.trim();
            const emailNormalized = email.toLowerCase();
            const address = document.getElementById('registerAddress').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerPasswordConfirm').value;

            if (!name) { showNotification('error', 'خطأ', 'الاسم مطلوب'); return; }
            if (!address) { showNotification('error', 'خطأ', 'العنوان مطلوب'); return; }
            if (!isValidCustomerPhone(phoneNormalized)) { showNotification('error', 'خطأ', 'رقم الهاتف غير صالح'); return; }
            if (!isEmailIdentifier(emailNormalized)) { showNotification('error', 'خطأ', 'البريد الإلكتروني غير صالح'); return; }
            if (!isValidCustomerPassword(password)) { showNotification('error', 'خطأ', 'كلمة المرور يجب أن تكون 6 أحرف على الأقل'); return; }
            if (password !== confirm) { showNotification('error', 'خطأ', 'كلمات المرور غير متطابقة'); return; }

            const registerResult = await registerCustomerAuth({
                email: emailNormalized,
                password,
                phone,
                address,
                displayName: name,
                name
            });
            const authUser = registerResult && registerResult.user
                ? registerResult.user
                : (registerResult && registerResult.profile && firebase && firebase.auth ? firebase.auth().currentUser : null);
            const uid = String(authUser && authUser.uid || registerResult && registerResult.profile && registerResult.profile.uid || '').trim();
            if (!uid) throw new Error('فشل إنشاء الحساب');

            let profile = registerResult && registerResult.profile ? registerResult.profile : null;
            if (!profile && typeof upsertMyCustomerProfile === 'function') {
                profile = await upsertMyCustomerProfile(uid, {
                    phone,
                    address,
                    displayName: name
                });
            }

            currentUser = sanitizeCustomerRecord({
                id: String(profile && profile.id || uid),
                uid,
                name: String(profile && (profile.displayName || profile.name) || name),
                phone: String(profile && profile.phone || phone),
                email: String(profile && profile.email || emailNormalized),
                address: String(profile && profile.address || address),
                loyaltyPoints: Number(profile && profile.loyaltyPoints || 0),
                createdAt: String(profile && profile.createdAt || new Date().toISOString()),
                updatedAt: String(profile && profile.updatedAt || new Date().toISOString()),
                role: String(profile && profile.role || 'customer'),
                emailVerified: false
            });
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            users = [];
            saveUsers();
            updateUserUI();
            closeModal('authModal');
            showNotification('success', 'تم إنشاء الحساب', 'تحقق من بريدك الإلكتروني لتفعيل الحساب قبل الشراء أو الدعم.');
            updateLiveSessionState({
                customerId: String(currentUser.id || currentUser.uid || ''),
                customerPhone: String(currentUser.phone || '')
            });
            trackStoreEvent('REGISTER_SUCCESS', 'Customer registered successfully', 'info', {
                customerId: String(currentUser.id || currentUser.uid || ''),
                email: emailNormalized
            });
            } catch (error) {
                console.error('handleRegister error:', error);
                showNotification('error', 'فشل التسجيل', 'تعذر إنشاء الحساب. تحقق من البريد الإلكتروني أو حاول لاحقًا.');
                trackStoreEvent('REGISTER_FAILED', 'Customer registration failed', 'error', {
                    email: emailNormalized,
                    error: error && error.message ? String(error.message) : String(error)
                });
            } finally {
                authSubmitLock = false;
            }
        }

        function checkLoggedInUser() {
            const saved = localStorage.getItem('currentUser');
            if (saved) {
                try {
                    currentUser = sanitizeCustomerRecord(JSON.parse(saved));
                } catch (_) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                }
            }

            const authUser = (firebase && firebase.auth && firebase.auth().currentUser)
                ? firebase.auth().currentUser
                : null;
            if (authUser && authUser.uid) {
                currentUser = sanitizeCustomerRecord({
                    ...(currentUser || {}),
                    id: String(currentUser && currentUser.id || authUser.uid),
                    uid: String(authUser.uid || ''),
                    name: String(currentUser && currentUser.name || authUser.displayName || ''),
                    email: String(authUser.email || currentUser && currentUser.email || '').toLowerCase(),
                    emailVerified: authUser.emailVerified === true
                });
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                if (typeof getMyCustomerProfile === 'function') {
                    getMyCustomerProfile(String(authUser.uid || ''))
                        .then((profile) => {
                            if (!profile) return;
                            currentUser = sanitizeCustomerRecord({
                                ...(currentUser || {}),
                                id: String(profile.id || authUser.uid),
                                uid: String(profile.uid || authUser.uid),
                                name: String(profile.displayName || profile.name || currentUser.name || ''),
                                phone: String(profile.phone || currentUser.phone || ''),
                                email: String(profile.email || currentUser.email || '').toLowerCase(),
                                address: String(profile.address || currentUser.address || ''),
                                loyaltyPoints: Number(profile.loyaltyPoints || 0),
                                createdAt: String(profile.createdAt || currentUser.createdAt || ''),
                                updatedAt: String(profile.updatedAt || currentUser.updatedAt || ''),
                                role: String(profile.role || currentUser.role || 'customer'),
                                emailVerified: authUser.emailVerified === true
                            });
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            updateUserUI();
                        })
                        .catch(() => null);
                }
            }

            updateUserUI();
            if (currentUser && chatMode === 'support') {
                ensureSupportChatReady().catch(() => null);
            }
            if (currentUser) {
                updateLiveSessionState({
                    customerId: String(currentUser.id || currentUser.uid || ''),
                    customerPhone: String(currentUser.phone || '')
                });
            }
            updateLoyaltyDisplay();
        }

        function updateUserUI() {
            document.getElementById('guestMenu').classList.toggle('hidden', !!currentUser);
            document.getElementById('userMenu').classList.toggle('hidden', !currentUser);
            document.getElementById('userBtn').textContent = currentUser ? currentUser.name.charAt(0) : '👤';
            updateLoyaltyDisplay();
        }

        function updateLoyaltyDisplay() {
            document.getElementById('loyaltyPoints').textContent = currentUser?.loyaltyPoints || 0;
        }

        function logout() {
            if (currentUser) {
                trackStoreEvent('LOGOUT', 'Customer logged out', 'info', {
                    customerId: String(currentUser.id || '')
                });
            }
            currentUser = null;
            localStorage.removeItem('currentUser');
            if (firebase && firebase.auth) {
                firebase.auth().signOut().catch(() => null);
            }
            stopSupportChatRealtime();
            if (chatMode === 'support') {
                switchChatMode('bot');
            }
            updateUserUI();
            updateLiveSessionState({ customerId: '', customerPhone: '' });
            showNotification('info', 'تم', 'تسجيل الخروج');
        }

        function showChangePassword() {
            if (!currentUser) { showAuthModal('login'); return; }
            openModal('passwordModal');
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            if (!currentUser) return;
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmNewPassword').value;
            if (newPass !== confirm) { showNotification('error', 'خطأ', 'غير متطابقة'); return; }
            if (!isValidCustomerPassword(newPass)) { showNotification('error', 'خطأ', 'كلمة المرور الجديدة قصيرة'); return; }

            try {
                if (!(firebase && firebase.auth && firebase.auth().currentUser)) {
                    throw new Error('جلسة Firebase غير متاحة');
                }
                const authUser = firebase.auth().currentUser;
                const email = String(authUser.email || currentUser.email || '').trim().toLowerCase();
                if (!email) throw new Error('البريد الإلكتروني غير متاح');
                const cred = firebase.auth.EmailAuthProvider.credential(email, current);
                await authUser.reauthenticateWithCredential(cred);
                await authUser.updatePassword(newPass);
                closeModal('passwordModal');
                showNotification('success', 'تم', 'تم تغيير كلمة المرور');
                trackStoreEvent('PASSWORD_CHANGED', 'Customer changed password', 'info', {
                    customerId: String(currentUser.id || currentUser.uid || '')
                });
            } catch (error) {
                console.error('change password firebase error:', error);
                showNotification('error', 'خطأ', 'فشل تغيير كلمة المرور. تحقق من كلمة المرور الحالية.');
                trackStoreEvent('PASSWORD_CHANGE_FAILED', 'Password change failed on server', 'error', {
                    customerId: String(currentUser && (currentUser.id || currentUser.uid) || '')
                });
            }
        }

        function showProfile() {
            if (!currentUser) return;
            showNotification('info', 'حسابي', `${currentUser.name}\n${currentUser.phone}\nنقاط: ${currentUser.loyaltyPoints || 0}`);
        }

        // ============================================
        // 📦 Checkout
        // ============================================
        async function ensureVerifiedForSensitiveAction(actionKey = 'sensitive-action') {
            if (!currentUser) {
                showNotification('error', '🔒 تسجيل الدخول مطلوب', 'يجب تسجيل الدخول أولاً');
                showLoginModal();
                return false;
            }

            try {
                if (typeof ensureEmailVerifiedOrThrow === 'function') {
                    const verifiedUser = await ensureEmailVerifiedOrThrow({ reloadUser: true });
                    currentUser.emailVerified = verifiedUser && verifiedUser.emailVerified === true;
                } else if (firebase && firebase.auth && firebase.auth().currentUser) {
                    const authUser = firebase.auth().currentUser;
                    if (typeof authUser.reload === 'function') {
                        await authUser.reload();
                    }
                    currentUser.emailVerified = authUser.emailVerified === true;
                }
            } catch (_) {
                currentUser.emailVerified = false;
            }

            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            if (currentUser.emailVerified !== true) {
                showNotification('warning', 'تفعيل البريد مطلوب', 'يجب تفعيل البريد الإلكتروني قبل إتمام الطلب أو استخدام الدعم الداخلي.');
                trackStoreEvent('EMAIL_VERIFICATION_REQUIRED', 'Blocked sensitive action before email verification', 'warning', {
                    action: String(actionKey || 'sensitive-action'),
                    customerId: String(currentUser.id || currentUser.uid || '')
                });
                return false;
            }
            return true;
        }

        async function showCheckout() {
            if (cart.length === 0) { 
                showNotification('error', 'خطأ', 'السلة فارغة'); 
                return; 
            }
            
            const verified = await ensureVerifiedForSensitiveAction('checkout-open');
            if (!verified) {
                return;
            }
            
            // Fill form with user data
            document.getElementById('checkoutName').value = currentUser.name || '';
            document.getElementById('checkoutPhone').value = currentUser.phone || '';
            document.getElementById('checkoutAddress').value = currentUser.address || '';
            openModal('checkoutModal');
        }
        
        function showLoginModal() {
            openModal('authModal');
            // Switch to login tab
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.querySelector('.auth-tab[onclick*="login"]').classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        }

        async function handleCheckout(e) {
            e.preventDefault();
            const verified = await ensureVerifiedForSensitiveAction('checkout-submit');
            if (!verified) return;

            const name = document.getElementById('checkoutName').value.trim();
            const phone = document.getElementById('checkoutPhone').value.trim();
            const address = document.getElementById('checkoutAddress').value.trim();
            const notes = document.getElementById('checkoutNotes').value.trim();

            const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
            let discount = appliedCoupon ? (appliedCoupon.type === 'percentage' ? subtotal * (appliedCoupon.value / 100) : appliedCoupon.value) : 0;
            const totalAfterCoupon = Math.max(0, subtotal - discount);
            const total = Math.max(0, totalAfterCoupon - pointsDiscount);
            const loyaltyRate = storeSettings.loyalty?.rate || 5;
            const earnedPoints = Math.floor(total * (loyaltyRate / 100));
            const nowIso = new Date().toISOString();
            const requestId = `rq_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;
            const normalizedUid = String(currentUser?.uid || currentUser?.id || '').trim();

            const order = {
                id: Date.now(),
                orderNumber: `SZ-${Date.now().toString().slice(-8)}`,
                requestId,
                idempotencyKey: `${requestId}_${normalizedUid || 'anonymous'}`,
                uid: normalizedUid,
                email: String(currentUser?.email || '').trim().toLowerCase(),
                deviceId: STORE_SESSION_ID,
                customer: { name, phone, address, notes },
                items: [...cart],
                subtotal, discount,
                couponCode: appliedCoupon?.code || null,
                usedPoints, pointsDiscount, total, earnedPoints,
                status: 'pending',
                statusHistory: [{ status: 'pending', date: nowIso, note: 'تم استلام الطلب' }],
                createdAt: nowIso
            };

            if (typeof addOrder !== 'function') {
                showNotification('error', 'تعذر إنشاء الطلب', 'خدمة الطلبات غير متاحة حالياً، حاول مرة أخرى.');
                trackStoreEvent('ORDER_API_UNAVAILABLE', 'Order API unavailable during checkout', 'error', {
                    orderNumber: order.orderNumber
                });
                return;
            }

            let addOrderResult = null;
            try {
                addOrderResult = await addOrder(order, { allowQueue: true });
                const isQueued = addOrderResult && addOrderResult.queued === true;
                if (isQueued) {
                    console.log('🟠 Order queued locally for sync:', addOrderResult.queueId || '');
                    trackStoreEvent('ORDER_QUEUED', 'Order queued locally and will sync when online', 'warning', {
                        orderNumber: order.orderNumber,
                        idempotencyKey: order.idempotencyKey,
                        queueId: addOrderResult.queueId || ''
                    });
                } else {
                    console.log('✅ Order saved to Firebase');
                    trackStoreEvent('ORDER_CREATED', 'Order saved to Firebase', 'info', {
                        orderNumber: order.orderNumber,
                        total: order.total,
                        itemsCount: order.items.length,
                        orderId: addOrderResult && addOrderResult.id ? String(addOrderResult.id) : ''
                    });
                }
            } catch (error) {
                console.error('❌ Firebase error:', error);
                showNotification('error', 'فشل حفظ الطلب', 'تعذر حفظ الطلب الآن. تأكد من الاتصال ثم حاول مرة أخرى.');
                trackStoreEvent('ORDER_SAVE_FAILED', 'Order save failed on Firebase', 'error', {
                    orderNumber: order.orderNumber,
                    error: error && error.message ? String(error.message) : String(error)
                });
                return;
            }

            // Update user points
            if (currentUser) {
                currentUser.loyaltyPoints = Math.max(0, Number(currentUser.loyaltyPoints || 0) - usedPoints + earnedPoints);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateLoyaltyDisplay();
                if (typeof upsertMyCustomerProfile === 'function') {
                    upsertMyCustomerProfile(String(currentUser.uid || currentUser.id || ''), {
                        phone: String(currentUser.phone || ''),
                        address: String(currentUser.address || ''),
                        displayName: String(currentUser.name || '')
                    }).catch(() => null);
                }
            }

            const isQueuedOrder = addOrderResult && addOrderResult.queued === true;
            if (!isQueuedOrder) {
                // Send WhatsApp notification only after confirmed Firebase write.
                sendWhatsAppNotification(order);
            }

            cart = [];
            appliedCoupon = null;
            resetPoints();
            saveCart();
            updateCartUI();
            closeModal('checkoutModal');
            toggleCart();
            updateStats();
            
            if (isQueuedOrder) {
                showNotification('warning', '📦 تم حفظ الطلب محليًا', 'سيتم إرسال الطلب تلقائيًا عند عودة الإنترنت.');
            } else {
                showNotification('success', '🎉 تم الطلب!', `رقم: ${order.orderNumber}`);
            }
            updateLiveSessionState();
            document.getElementById('checkoutForm').reset();
        }

        // ============================================
        // 📱 WhatsApp Notification
        // ============================================
        function sendWhatsAppNotification(order) {
            const whatsapp = storeSettings.contact?.whatsapp || '01018108979';
            const items = order.items.map(i => `• ${i.name} × ${i.quantity}`).join('\n');
            const message = `🛍️ *طلب جديد!*

📋 *رقم الطلب:* ${order.orderNumber}
📅 *التاريخ:* ${new Date().toLocaleDateString('ar-EG')}

👤 *العميل:* ${order.customer.name}
📱 *الهاتف:* ${order.customer.phone}
📍 *العنوان:* ${order.customer.address}

📦 *المنتجات:*
${items}

💰 *المجموع:* ${order.subtotal} ج.م
${order.couponCode ? `🎫 *كوبون:* ${order.couponCode} (-${order.discount} ج.م)` : ''}
${order.pointsDiscount > 0 ? `💎 *نقاط:* -${order.pointsDiscount} ج.م` : ''}
✅ *الإجمالي:* ${order.total} ج.م

${order.customer.notes ? `📝 *ملاحظات:* ${order.customer.notes}` : ''}`;

            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/2${whatsapp}?text=${encodedMessage}`, '_blank');
        }

        // ============================================
        // 🚚 Order Tracking
        // ============================================
        function showOrderTracking() {
            openModal('trackingModal');
            document.getElementById('trackingResult').innerHTML = '';
        }

        async function loadMyOrdersFromFirebase() {
            if (!currentUser) return [];
            const uid = String(currentUser.uid || currentUser.id || '').trim();
            if (!uid) return [];
            if (typeof getOrdersByCustomerUid !== 'function') return [];

            const remoteOrders = await getOrdersByCustomerUid(uid, 100);
            if (Array.isArray(remoteOrders) && remoteOrders.length >= 0) {
                orders = remoteOrders;
                return remoteOrders;
            }
            return [];
        }

        async function showMyOrders() {
            if (!currentUser) { showAuthModal('login'); return; }
            let myOrders = await loadMyOrdersFromFirebase();
            if (!Array.isArray(myOrders) || myOrders.length === 0) {
                myOrders = orders.filter(o => String(o.uid || '') === String(currentUser.uid || currentUser.id || ''));
            }
            
            document.getElementById('ordersModalBody').innerHTML = myOrders.length === 0 
                ? '<div style="text-align: center; padding: 30px; color: #666;"><div style="font-size: 50px;">📦</div><p>لا توجد طلبات</p></div>'
                : myOrders.reverse().map(o => `
                    <div style="background: var(--cream); border-radius: 12px; padding: 15px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong>${o.orderNumber}</strong>
                            <span class="status-badge" style="padding: 4px 10px; border-radius: 15px; font-size: 11px; background: ${o.status === 'completed' ? 'var(--success)' : o.status === 'shipped' ? 'var(--info)' : 'var(--warning)'}; color: white;">
                                ${getStatusName(o.status)}
                            </span>
                        </div>
                        <p style="font-size: 12px; color: #666;">${new Date(o.createdAt).toLocaleDateString('ar-EG')}</p>
                        <p style="font-size: 14px; font-weight: 700; color: var(--gold-dark);">${o.total} ج.م</p>
                        <button onclick="trackOrderById('${o.orderNumber}')" style="margin-top: 8px; padding: 6px 15px; background: var(--navy); color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">تتبع 🚚</button>
                    </div>
                `).join('');
            
            openModal('ordersModal');
        }

        async function trackOrder() {
            const orderNumber = document.getElementById('trackOrderNumber').value.trim();
            await trackOrderById(orderNumber, { refreshRemote: true });
        }

        async function trackOrderById(orderNumber, options = {}) {
            const refreshRemote = options && options.refreshRemote === true;
            if (refreshRemote && currentUser) {
                await loadMyOrdersFromFirebase();
            }

            const order = orders.find(o => o.orderNumber === orderNumber || o.id.toString() === orderNumber);
            
            if (!order) {
                document.getElementById('trackingResult').innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);"><div style="font-size: 40px;">❌</div><p>لم يتم العثور على الطلب</p></div>';
                return;
            }

            const statuses = [
                { key: 'pending', icon: '📋', title: 'تم استلام الطلب', desc: 'جاري مراجعة الطلب' },
                { key: 'confirmed', icon: '✅', title: 'تم تأكيد الطلب', desc: 'جاري تجهيز المنتجات' },
                { key: 'processing', icon: '📦', title: 'جاري التجهيز', desc: 'يتم تجهيز طلبك' },
                { key: 'shipped', icon: '🚚', title: 'تم الشحن', desc: 'الطلب في الطريق إليك' },
                { key: 'delivered', icon: '🎉', title: 'تم التوصيل', desc: 'تم توصيل الطلب بنجاح' },
                { key: 'completed', icon: '⭐', title: 'مكتمل', desc: 'شكراً لتسوقك معنا' }
            ];

            const currentIdx = statuses.findIndex(s => s.key === order.status);

            document.getElementById('trackingResult').innerHTML = `
                <div class="tracking-card" style="background: var(--cream); border-radius: 14px; padding: 20px;">
                    <div class="tracking-header" style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 22px; color: var(--gold-dark); font-weight: 700;">${order.orderNumber}</div>
                        <div style="font-size: 12px; color: #666;">${new Date(order.createdAt).toLocaleDateString('ar-EG')}</div>
                    </div>
                    <div class="tracking-timeline">
                        ${statuses.map((s, i) => `
                            <div style="display: flex; gap: 12px; margin-bottom: 18px; opacity: ${i <= currentIdx ? 1 : 0.4};">
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: ${i <= currentIdx ? (i === currentIdx ? 'var(--gold)' : 'var(--success)') : '#ddd'}; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; ${i === currentIdx ? 'animation: pulse 2s infinite;' : ''}">${s.icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: ${i <= currentIdx ? 'var(--navy)' : '#999'}; font-size: 13px;">${s.title}</div>
                                    <div style="font-size: 11px; color: #666;">${s.desc}</div>
                                    ${order.statusHistory?.find(h => h.status === s.key) ? `<div style="font-size: 10px; color: var(--gold-dark); margin-top: 3px;">${new Date(order.statusHistory.find(h => h.status === s.key).date).toLocaleString('ar-EG')}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            if (document.getElementById('trackingModal').classList.contains('active') === false) {
                openModal('trackingModal');
            }
        }

        function getStatusName(status) {
            const names = { pending: 'قيد المعالجة', confirmed: 'مؤكد', processing: 'جاري التجهيز', shipped: 'تم الشحن', delivered: 'تم التوصيل', completed: 'مكتمل', cancelled: 'ملغي' };
            return names[status] || status;
        }

        // ============================================
        // 💬 Chat
        // ============================================
        function getSupportErrorCode(error) {
            const rawCode = String(error && (error.code || error.errorCode) || '').trim().toLowerCase();
            if (!rawCode) return '';
            return rawCode.startsWith('firebase/') ? rawCode.slice('firebase/'.length) : rawCode;
        }

        function isSupportPermissionDenied(error) {
            if (!error) return false;
            if (error.permissionDenied === true) return true;
            const code = getSupportErrorCode(error);
            if (code === 'permission-denied' || code === 'permission_denied') return true;
            const message = String(error && (error.message || error.reason) || error || '').toLowerCase();
            return message.includes('missing or insufficient permissions')
                || message.includes('insufficient permissions')
                || message.includes('permission-denied');
        }

        function fallbackSupportChatToFaq(message = 'تم التحويل إلى وضع FAQ.') {
            stopSupportChatRealtime();
            chatMode = 'bot';
            document.getElementById('chatModeBotBtn')?.classList.add('active');
            document.getElementById('chatModeSupportBtn')?.classList.remove('active');
            setChatStatus('وضع FAQ', true);
            clearChatMessages();
            addChatMessage(String(message || 'تم التحويل إلى وضع FAQ.'), 'meta');
            addChatMessage('مرحباً! كيف أساعدك؟ 😊', 'bot');
        }

        function clearSupportAccessState() {
            supportAccess.denied = false;
            supportAccess.reason = '';
            supportAccess.source = '';
            supportAccess.notifiedReason = '';
        }

        function handleSupportAccessError(error, source = '') {
            const denied = isSupportPermissionDenied(error);
            if (!denied) return false;

            const reason = String(error && (error.message || error.reason) || error || 'unknown support access error').trim();
            const normalizedSource = String(source || 'support');
            supportAccess.denied = true;
            supportAccess.reason = reason;
            supportAccess.source = normalizedSource;
            supportRealtimeConnected = false;

            if (supportAccess.notifiedReason !== reason) {
                supportAccess.notifiedReason = reason;
                showNotification('warning', 'الدردشة الداخلية', 'تعذر الوصول للدعم الآن. تم التحويل إلى FAQ.');
            }

            console.warn(`support access denied (${normalizedSource}):`, reason);
            fallbackSupportChatToFaq('تعذر استخدام الدردشة الداخلية بسبب الصلاحيات. تم التحويل إلى FAQ.');
            return true;
        }

        function getActiveFirebaseAuthUser() {
            try {
                if (!(firebase && firebase.auth)) return null;
                const auth = firebase.auth();
                return auth && auth.currentUser ? auth.currentUser : null;
            } catch (_) {
                return null;
            }
        }

        function syncCurrentUserSupportUid(uid) {
            const normalizedUid = String(uid || '').trim();
            if (!currentUser || !normalizedUid) return;
            if (String(currentUser.uid || '').trim() === normalizedUid) return;

            currentUser = sanitizeCustomerRecord(currentUser, {
                id: currentUser && currentUser.id ? currentUser.id : '',
                uid: normalizedUid
            });
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            const currentId = String(currentUser.id || '');
            if (!currentId || !Array.isArray(users)) return;
            const userIndex = users.findIndex((userRow) => String(userRow && userRow.id || '') === currentId);
            if (userIndex === -1) return;

            users[userIndex] = sanitizeCustomerRecord(users[userIndex], {
                id: currentId,
                uid: normalizedUid
            });
            saveUsers();
        }

        function buildSupportAuthAttempts() {
            if (!currentUser) return [];
            const email = String(currentUser.email || '').trim().toLowerCase();
            return email ? [{ identifier: email }] : [];
        }

        async function waitForFirebaseAuthState(timeoutMs = 2500) {
            if (!(firebase && firebase.auth)) return null;
            const auth = firebase.auth();
            if (auth && auth.currentUser) return auth.currentUser;
            return new Promise((resolve) => {
                let settled = false;
                let unsubscribe = null;
                const finalize = (user) => {
                    if (settled) return;
                    settled = true;
                    if (typeof unsubscribe === 'function') {
                        try { unsubscribe(); } catch (_) {}
                    }
                    clearTimeout(timer);
                    resolve(user || null);
                };
                const timer = setTimeout(() => finalize(auth.currentUser || null), Math.max(300, Number(timeoutMs) || 2500));
                unsubscribe = auth.onAuthStateChanged(
                    (user) => finalize(user || auth.currentUser || null),
                    () => finalize(auth.currentUser || null)
                );
            });
        }

        function promptSupportReLogin() {
            if (typeof showAuthModal === 'function') {
                showAuthModal('login');
            }
            const preferredIdentifier = String(currentUser && currentUser.email || '').trim();
            const loginIdentifier = document.getElementById('loginIdentifier');
            if (loginIdentifier && !String(loginIdentifier.value || '').trim() && preferredIdentifier) {
                loginIdentifier.value = preferredIdentifier;
            }
        }

        function handleSupportAuthSessionRequired(authError, source = 'support') {
            const reason = String(authError && authError.message || authError || 'support auth session required').trim();
            const reasonKey = `support-auth:${source}:${reason}`;
            supportRealtimeConnected = false;
            setChatStatus('الدردشة الداخلية (غير متاحة)', false);
            if (supportAccess.notifiedReason !== reasonKey) {
                supportAccess.notifiedReason = reasonKey;
                showNotification('warning', 'الدردشة الداخلية', 'يلزم تسجيل دخول Firebase بحسابك المفعّل لاستخدام الدعم الداخلي.');
            }
            console.info(`support auth session required (${source}):`, reason);
            promptSupportReLogin();
            fallbackSupportChatToFaq('الدعم الداخلي يتطلب جلسة Firebase صالحة وبريدًا مفعلًا. سجّل الدخول ثم جرّب مرة أخرى.');
            trackStoreEvent('SUPPORT_AUTH_SESSION_REQUIRED', 'Support chat requires Firebase Auth session', 'warning', {
                customerId: String(currentUser && currentUser.id || ''),
                source: String(source || 'support'),
                reason
            });
            return true;
        }

        async function ensureSupportAuthSession() {
            if (!(firebase && firebase.auth)) {
                const unavailableError = new Error('Firebase Auth غير متاح للدردشة الداخلية.');
                unavailableError.code = 'auth/unavailable';
                throw unavailableError;
            }

            const auth = firebase.auth();
            const restoredUser = await waitForFirebaseAuthState(2500);
            const activeUid = String(
                (restoredUser && restoredUser.uid)
                || (auth && auth.currentUser && auth.currentUser.uid)
                || ''
            ).trim();
            if (!activeUid) {
                const sessionError = new Error('الدردشة الداخلية تتطلب تسجيل الدخول.');
                sessionError.code = 'auth/session-required';
                throw sessionError;
            }

            if (typeof ensureEmailVerifiedOrThrow === 'function') {
                await ensureEmailVerifiedOrThrow({ reloadUser: true });
            } else if (restoredUser && typeof restoredUser.reload === 'function') {
                await restoredUser.reload();
                if (!restoredUser.emailVerified) {
                    const verifyError = new Error('يجب تفعيل البريد الإلكتروني أولاً.');
                    verifyError.code = 'auth/email-not-verified';
                    throw verifyError;
                }
            }

            syncCurrentUserSupportUid(activeUid);
            if (currentUser) {
                currentUser.emailVerified = true;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            return activeUid;
        }

        function toggleChat() {
            const box = document.getElementById('chatBox');
            if (!box) return;
            box.classList.toggle('active');
            if (!box.classList.contains('active')) return;
            if (chatMode === 'support') {
                ensureSupportChatReady().catch((error) => {
                    console.warn('support chat init warning:', error);
                    handleSupportAccessError(error, 'toggleChat.ensureSupportChatReady');
                });
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            if (chatMode === 'support') {
                if (!currentUser) {
                    showNotification('warning', 'تنبيه', 'سجل دخول أولًا لاستخدام الدردشة الداخلية');
                    showAuthModal('login');
                    return;
                }
                await sendSupportMessageFromCustomer(msg);
                input.value = '';
                return;
            }

            addChatMessage(msg, 'user');
            input.value = '';
            setTimeout(() => addChatMessage(getBotResponse(msg), 'bot'), 600);
        }

        function addChatMessage(text, sender = 'bot') {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            const div = document.createElement('div');
            div.className = `chat-message ${sender}`;
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function clearChatMessages() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            container.innerHTML = '';
        }

        function setChatStatus(text, isOnline = true) {
            const statusEl = document.getElementById('chatStatusText');
            if (!statusEl) return;
            const dotColor = isOnline ? 'var(--success)' : 'var(--warning)';
            statusEl.innerHTML = '';
            const dot = document.createElement('span');
            dot.className = 'online-dot';
            dot.style.background = dotColor;
            statusEl.appendChild(dot);
            statusEl.appendChild(document.createTextNode(` ${String(text || '')}`));
        }

        function switchChatMode(mode) {
            const nextMode = mode === 'support' ? 'support' : 'bot';
            if (nextMode === 'support' && !currentUser) {
                showNotification('warning', 'تنبيه', 'سجل دخول أولًا لاستخدام الدردشة الداخلية');
                showAuthModal('login');
                return;
            }

            chatMode = nextMode;
            document.getElementById('chatModeBotBtn')?.classList.toggle('active', nextMode === 'bot');
            document.getElementById('chatModeSupportBtn')?.classList.toggle('active', nextMode === 'support');

            clearChatMessages();
            if (nextMode === 'bot') {
                setChatStatus('وضع FAQ', true);
                addChatMessage('مرحباً! كيف أساعدك؟ 😊', 'bot');
                disconnectSupportMessageListener();
                return;
            }

            setChatStatus('الدردشة الداخلية', supportRealtimeConnected);
            addChatMessage('جاري ربط الدردشة الداخلية...', 'meta');
            ensureSupportChatReady().catch((error) => {
                console.warn('switch support mode warning:', error);
                if (!handleSupportAccessError(error, 'switchChatMode.ensureSupportChatReady')) {
                    addChatMessage('تعذر بدء الدردشة الداخلية. حاول مرة أخرى.', 'meta');
                }
            });
        }

        function disconnectSupportMessageListener() {
            if (typeof supportMessagesUnsubscribe === 'function') {
                supportMessagesUnsubscribe();
            }
            supportMessagesUnsubscribe = null;
        }

        function disconnectSupportThreadListener() {
            if (typeof supportThreadUnsubscribe === 'function') {
                supportThreadUnsubscribe();
            }
            supportThreadUnsubscribe = null;
        }

        function stopSupportChatRealtime() {
            disconnectSupportThreadListener();
            disconnectSupportMessageListener();
            activeSupportThread = null;
            supportRealtimeConnected = false;
        }

        function subscribeSupportThreadStatus(threadId) {
            disconnectSupportThreadListener();
            if (typeof subscribeSupportThread !== 'function') return;
            supportThreadUnsubscribe = subscribeSupportThread(
                threadId,
                (thread) => {
                    if (!thread) return;
                    activeSupportThread = thread;
                    if (thread.status === 'closed' && chatMode === 'support') {
                        setChatStatus('الدردشة الداخلية (مغلقة)', false);
                    } else if (chatMode === 'support') {
                        setChatStatus('الدردشة الداخلية', supportRealtimeConnected);
                    }
                },
                (error) => {
                    console.warn('support thread listener error:', error);
                    handleSupportAccessError(error, 'subscribeSupportThreadStatus.listener');
                }
            );
        }

        function getSupportCustomerProfile(resolvedUid = '') {
            if (!currentUser) return null;
            const authUser = getActiveFirebaseAuthUser();
            const uid = String(
                resolvedUid
                || (authUser && authUser.uid)
                || currentUser.uid
                || ''
            ).trim();
            if (!uid) return null;
            return {
                uid,
                customerUid: uid,
                customerId: String(currentUser.id || ''),
                customerName: String(currentUser.name || ''),
                customerPhone: String(currentUser.phone || currentUser.phoneNormalized || ''),
                customerEmail: String(currentUser.email || '')
            };
        }

        function renderSupportMessages(messages = []) {
            clearChatMessages();
            if (!Array.isArray(messages) || !messages.length) {
                addChatMessage('لا توجد رسائل بعد. اكتب سؤالك وسيتم الرد عليك.', 'meta');
                return;
            }
            messages.forEach((row) => {
                const senderRole = String(row && row.senderRole || 'customer');
                const senderClass = senderRole === 'customer' ? 'user' : 'bot';
                const senderName = senderRole === 'admin' ? 'الدعم' : 'أنت';
                const text = String(row && row.message || '').trim();
                if (!text) return;
                addChatMessage(`${senderName}: ${text}`, senderClass);
            });
        }

        function subscribeSupportThreadMessages(threadId) {
            disconnectSupportMessageListener();
            if (typeof subscribeSupportMessages !== 'function') return;
            supportMessagesUnsubscribe = subscribeSupportMessages(
                threadId,
                async (rows) => {
                    const list = Array.isArray(rows) ? rows : [];
                    renderSupportMessages(list);
                    setChatStatus('الدردشة الداخلية', true);
                    supportRealtimeConnected = true;
                    if (typeof markSupportThreadReadByCustomer === 'function') {
                        await markSupportThreadReadByCustomer(threadId).catch(() => null);
                    }
                },
                (error) => {
                    console.warn('support messages listener error:', error);
                    supportRealtimeConnected = false;
                    setChatStatus('الدردشة الداخلية (إعادة المحاولة)', false);
                    handleSupportAccessError(error, 'subscribeSupportThreadMessages.listener');
                },
                SUPPORT_CHAT_MESSAGES_LIMIT
            );
        }

        async function ensureSupportChatReady() {
            if (chatMode !== 'support') return false;
            if (!currentUser) return false;
            if (typeof ensureSupportThreadByUid !== 'function' && typeof getOrCreateSupportThread !== 'function') {
                addChatMessage('ميزة الدردشة الداخلية غير متاحة حاليًا.', 'meta');
                return false;
            }

            let supportUid = '';
            try {
                supportUid = await ensureSupportAuthSession();
            } catch (authError) {
                handleSupportAuthSessionRequired(authError, 'ensureSupportChatReady');
                return false;
            }

            const profile = getSupportCustomerProfile(supportUid);
            if (!profile || !profile.uid) {
                addChatMessage('حسابك غير مكتمل للدردشة الداخلية. أعد تسجيل الدخول.', 'meta');
                return false;
            }

            try {
                const thread = (typeof ensureSupportThreadByUid === 'function')
                    ? await ensureSupportThreadByUid(String(profile.uid || ''), profile)
                    : await getOrCreateSupportThread(profile);
                if (!thread || !thread.id) {
                    addChatMessage('تعذر إنشاء محادثة الدعم. حاول لاحقًا.', 'meta');
                    return false;
                }

                clearSupportAccessState();
                activeSupportThread = thread;
                subscribeSupportThreadStatus(thread.id);
                subscribeSupportThreadMessages(thread.id);
                setChatStatus('الدردشة الداخلية', true);
                return true;
            } catch (error) {
                if (!handleSupportAccessError(error, 'ensureSupportChatReady.ensureSupportThreadByUid')) {
                    addChatMessage('تعذر إنشاء محادثة الدعم. حاول لاحقًا.', 'meta');
                }
                return false;
            }
        }

        async function sendSupportMessageFromCustomer(messageText) {
            const text = String(messageText || '').trim();
            if (!text) return;
            if (typeof sendSupportMessageByUid !== 'function' && typeof addSupportMessage !== 'function') {
                showNotification('error', 'خطأ', 'ميزة الدردشة الداخلية غير متاحة');
                return;
            }

            let supportUid = '';
            try {
                supportUid = await ensureSupportAuthSession();
            } catch (authError) {
                handleSupportAuthSessionRequired(authError, 'sendSupportMessageFromCustomer');
                trackStoreEvent('SUPPORT_SEND_AUTH_REQUIRED', 'Support message send requires Firebase Auth session', 'warning', {
                    customerId: String(currentUser && currentUser.id || '')
                });
                return;
            }

            if (!activeSupportThread || !activeSupportThread.id) {
                const ready = await ensureSupportChatReady();
                if (!ready) return;
            }

            const profile = getSupportCustomerProfile(supportUid);
            if (!profile) return;

            try {
                if (typeof sendSupportMessageByUid === 'function') {
                    await sendSupportMessageByUid(String(profile.uid || ''), text, {
                        senderRole: 'customer',
                        senderUid: String(profile.uid || ''),
                        senderName: String(profile.customerName || 'عميل'),
                        profile
                    });
                } else {
                    await addSupportMessage({
                        threadId: String(activeSupportThread.id || ''),
                        senderRole: 'customer',
                        senderUid: String(profile.uid || ''),
                        senderName: String(profile.customerName || 'عميل'),
                        message: text,
                        createdAt: new Date().toISOString(),
                        createdAtMs: Date.now()
                    });
                }
                trackStoreEvent('SUPPORT_MESSAGE_SENT', 'Customer sent support message', 'info', {
                    customerId: String(currentUser && currentUser.id || ''),
                    threadId: String(activeSupportThread.id || '')
                });
            } catch (error) {
                console.error('sendSupportMessageFromCustomer error:', error);
                if (!handleSupportAccessError(error, 'sendSupportMessageFromCustomer')) {
                    showNotification('error', 'خطأ', 'تعذر إرسال الرسالة. حاول مرة أخرى.');
                }
                trackStoreEvent('SUPPORT_MESSAGE_FAILED', 'Customer support message failed', 'warning', {
                    customerId: String(currentUser && currentUser.id || ''),
                    error: error && error.message ? String(error.message) : String(error)
                });
            }
        }

        function getFaqIntents() {
            const defaults = [
                { keywords: ['مرحبا', 'السلام', 'اهلا'], response: 'أهلاً! كيف أساعدك؟ 😊' },
                { keywords: ['سعر', 'تكلفة'], response: 'تقدر تستخدم البحث والفلاتر لمعرفة الأسعار بسرعة 💰' },
                { keywords: ['توصيل', 'شحن'], response: 'التوصيل مجاني فوق 500 ج.م 🚚' },
                { keywords: ['تتبع', 'طلب'], response: 'اضغط على "تتبع طلبي" من القائمة الجانبية 📦' },
                { keywords: ['خصم', 'كوبون'], response: 'لو فيه كوبونات نشطة ستظهر تلقائيًا داخل السلة 🎁' },
                { keywords: ['نقاط', 'ولاء'], response: 'تحصل على نقاط ولاء مع كل طلب حسب إعدادات المتجر 💎' }
            ];

            const configured = storeSettings && Array.isArray(storeSettings.faqIntents)
                ? storeSettings.faqIntents
                : [];
            const normalizedConfigured = configured
                .filter((item) => item && Array.isArray(item.keywords) && item.response)
                .map((item) => ({
                    keywords: item.keywords.map((keyword) => String(keyword || '').trim()).filter(Boolean),
                    response: String(item.response || '').trim()
                }))
                .filter((item) => item.keywords.length > 0 && item.response);

            return normalizedConfigured.length ? normalizedConfigured : defaults;
        }

        function getBotResponse(msg) {
            const text = normalizeSearchKeyword(msg);
            const intents = getFaqIntents();
            for (const intent of intents) {
                if ((intent.keywords || []).some((keyword) => text.includes(normalizeSearchKeyword(keyword)))) {
                    return intent.response;
                }
            }
            if (text.includes('موظف') || text.includes('بشري') || text.includes('دعم')) {
                return 'يمكنك التحويل لوضع "دعم" داخل نفس نافذة الشات للتواصل الداخلي المباشر.';
            }
            return `تواصل معنا: ${storeSettings.contact?.phone || '01018108979'} 📞`;
        }

        let tawkWidgetLoaded = false;
        function maybeLoadTawkWidget() {
            const config = storeSettings && storeSettings.chatSupport && typeof storeSettings.chatSupport === 'object'
                ? storeSettings.chatSupport
                : {};
            if (config.enableTawk !== true) return;
            if (tawkWidgetLoaded || window.Tawk_API) return;

            const propertyId = String(config.tawkPropertyId || '').trim();
            const widgetId = String(config.tawkWidgetId || '').trim();
            if (!propertyId || !widgetId) return;

            const script = document.createElement('script');
            script.async = true;
            script.src = `https://embed.tawk.to/${propertyId}/${widgetId}`;
            script.charset = 'UTF-8';
            script.setAttribute('crossorigin', '*');
            script.onload = () => { tawkWidgetLoaded = true; };
            script.onerror = () => { tawkWidgetLoaded = false; };
            document.head.appendChild(script);
        }

        // ============================================
        // 🔔 Notifications
        // ============================================
        function showNotification(type, title, message) {
            const container = document.getElementById('notificationsContainer');
            const icons = { success: '✓', error: '✕', warning: '⚠', info: 'ℹ' };
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.innerHTML = `
                <div class="notification-icon"></div>
                <div class="notification-content">
                    <div class="notification-title"></div>
                    <div class="notification-message"></div>
                </div>
                <button class="notification-close" type="button">✕</button>
            `;
            const iconNode = n.querySelector('.notification-icon');
            const titleNode = n.querySelector('.notification-title');
            const messageNode = n.querySelector('.notification-message');
            const closeBtn = n.querySelector('.notification-close');
            if (iconNode) iconNode.textContent = icons[type] || icons.info;
            if (titleNode) titleNode.textContent = String(title || '');
            if (messageNode) messageNode.textContent = String(message || '');
            if (closeBtn) closeBtn.addEventListener('click', () => n.remove());
            container.appendChild(n);
            setTimeout(() => n.remove(), 4000);

            // Browser notification
            if (type === 'success' && typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                try {
                    if (navigator.serviceWorker && navigator.serviceWorker.ready) {
                        navigator.serviceWorker.ready
                            .then((registration) => registration.showNotification(String(title || ''), {
                                body: String(message || ''),
                                tag: 'salezone-success-notification',
                                renotify: false,
                                data: { source: 'store' }
                            }))
                            .catch(() => undefined);
                    } else if (typeof window.Notification === 'function') {
                        new window.Notification(String(title || ''), { body: String(message || '') });
                    }
                } catch (_) {
                    // Ignore browser notification errors (UI notification already shown).
                }
            }
        }

        // Request notification permission only after first user gesture
        function setupNotificationPermissionRequest() {
            if (!('Notification' in window) || Notification.permission !== 'default') return;

            const requestPermission = (event) => {
                if (!event || event.isTrusted !== true) return;
                Notification.requestPermission().catch(() => undefined);
            };

            window.addEventListener('click', requestPermission, { once: true, passive: true });
            window.addEventListener('touchstart', requestPermission, { once: true, passive: true });
            window.addEventListener('keydown', requestPermission, { once: true });
        }

        setupNotificationPermissionRequest();

        // ============================================
        // 🎛️ UI Helpers
        // ============================================
        function applyAutoTooltips(root = document) {
            const scope = root && typeof root.querySelectorAll === 'function' ? root : document;
            const elements = scope.querySelectorAll('button, .btn, .action-btn, .category-card, [role="button"], a[onclick]');
            elements.forEach((el) => {
                if (!el || el.dataset.tooltipBound === '1') return;
                if (el.getAttribute('title')) {
                    el.dataset.tooltipBound = '1';
                    return;
                }
                const label = String(el.getAttribute('aria-label') || el.textContent || '')
                    .replace(/\s+/g, ' ')
                    .trim();
                if (!label) return;
                el.setAttribute('title', label.slice(0, 120));
                el.dataset.tooltipBound = '1';
            });
        }

        function setupAutoTooltips() {
            applyAutoTooltips(document);
            if (window.__STORE_TOOLTIP_OBSERVER__) return;
            const observer = new MutationObserver(() => applyAutoTooltips(document));
            observer.observe(document.body, { childList: true, subtree: true });
            window.__STORE_TOOLTIP_OBSERVER__ = observer;
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        document.querySelectorAll('.modal-overlay').forEach(o => {
            o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
                document.getElementById('cartOverlay').classList.remove('active');
                document.getElementById('cartSidebar').classList.remove('active');
                document.getElementById('favOverlay').classList.remove('active');
                document.getElementById('favSidebar').classList.remove('active');
                document.getElementById('chatBox').classList.remove('active');
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchProducts(); });
        document.getElementById('searchInput').addEventListener('input', () => searchProducts());
    </script>
</body>
</html>


